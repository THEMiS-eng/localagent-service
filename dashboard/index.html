<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#1a73e8">
<meta name="mobile-web-app-capable" content="yes">
<link rel="manifest" href="/manifest.json">
<title>LocalAgent Dashboard</title>
<style>
:root {
    --bg: #f8f9fa; --bg-light: #f1f3f4; --white: #fff;
    --border: #e0e0e0; --text: #202124; --text-sec: #5f6368;
    --blue: #1a73e8; --blue-hover: #1557b0;
    --success: #34a853; --warning: #fbbc04; --error: #ea4335;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); font-size: 14px; }

.header { position: fixed; top: 0; left: 0; right: 0; z-index: 100; height: 52px; background: var(--white); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 16px; gap: 16px; }
.logo { font-weight: 600; font-size: 16px; color: var(--blue); }
.health { display: flex; gap: 12px; margin-left: auto; font-size: 12px; align-items: center; }
.dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 4px; }
.dot.on { background: var(--success); }
.dot.off { background: var(--error); }
.dot.warn { background: var(--warning); animation: pulse 1s infinite; }
@keyframes pulse { 50% { opacity: 0.5; } }

.main { position: fixed; top: 52px; bottom: 0; left: 0; right: 0; display: grid; grid-template-columns: 1fr 380px; transition: grid-template-columns 0.3s ease; }
.main.sidebar-collapsed { grid-template-columns: 1fr 0; }

/* CHAT MODULE IFRAME */
.chat-frame { width: 100%; height: 100%; border: none; }

/* SIDEBAR */
.sidebar { overflow-y: auto; padding: 12px; background: var(--bg); transition: transform 0.3s ease, opacity 0.3s ease; }
.main.sidebar-collapsed .sidebar { transform: translateX(100%); opacity: 0; pointer-events: none; }
.proj-box { background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; padding: 14px; border-radius: 10px; margin-bottom: 12px; }
.proj-box .lbl { font-size: 10px; opacity: 0.7; text-transform: uppercase; }
.proj-box .name { font-size: 16px; font-weight: 600; margin: 2px 0; }
.proj-box .ver { font-size: 12px; opacity: 0.85; }
.proj-box .path { font-size: 10px; opacity: 0.6; margin-top: 6px; word-break: break-all; }

.tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 10px; }
.tab { padding: 8px 12px; cursor: pointer; font-size: 12px; color: var(--text-sec); border-bottom: 2px solid transparent; }
.tab:hover { color: var(--text); }
.tab.active { color: var(--blue); border-bottom-color: var(--blue); }
.tab-content { display: none; }
.tab-content.active { display: block; }

.panel { background: var(--white); border-radius: 8px; margin-bottom: 10px; overflow: hidden; }
.panel-hdr { font-size: 12px; font-weight: 500; padding: 10px 12px; background: var(--bg-light); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); cursor: pointer; }
.panel-hdr:hover { background: #e8eaed; }
.panel-hdr .cnt { background: var(--blue); color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px; }
.panel-hdr::before { content: '‚ñº'; font-size: 10px; margin-right: 8px; transition: transform 0.2s; color: var(--text-sec); }
.panel.collapsed .panel-hdr::before { transform: rotate(-90deg); }
.panel.collapsed .panel-body, .panel.collapsed .add-row { display: none; }
.panel-body { max-height: 160px; overflow-y: auto; }

.item { padding: 8px 12px; border-bottom: 1px solid var(--bg-light); font-size: 12px; display: flex; align-items: center; gap: 8px; transition: background 0.15s; }
.item:last-child { border-bottom: none; }
.item.empty { color: var(--text-sec); justify-content: center; padding: 16px; }
.item[onclick]:hover { background: var(--bg-light); }
.item .badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: #e3f2fd; color: var(--blue); font-family: monospace; }
.item .txt { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.item .prio { font-size: 10px; padding: 2px 6px; border-radius: 4px; }
.item .prio.high { background: #ffebee; color: var(--error); }
.item .prio.medium { background: #fff8e1; color: #f57c00; }
.item .prio.low { background: #e8f5e9; color: var(--success); }

.add-row { display: flex; gap: 6px; padding: 8px 12px; border-top: 1px solid var(--bg-light); }
.add-row input, .add-row select { flex: 1; padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; }
.add-row button { padding: 6px 12px; background: var(--blue); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; }
</style>
</head>
<body>
<div class="header">
    <div class="logo">ü§ñ LocalAgent</div>
    <div class="health">
        <span><span class="dot warn" id="apiDot"></span><span id="apiStatus">Connecting...</span></span>
        <span style="color:var(--text-sec)">|</span>
        <span style="cursor:pointer" onclick="showReleaseNotes()">v<span id="srvVersion">-</span></span>
        <span id="updateBadge" style="display:none;margin-left:8px;background:#ff9800;color:#fff;padding:2px 8px;border-radius:12px;font-size:11px;cursor:pointer" onclick="showUpdatePrompt()">‚¨Ü Update</span>
        <span style="color:var(--text-sec)">|</span>
        <span>API: <span id="apiKeyStatus">-</span></span>
        <span style="color:var(--text-sec)">|</span>
        <button id="sidebarToggle" onclick="toggleSidebar()" style="background:var(--bg-light);border:1px solid var(--border);border-radius:4px;padding:4px 8px;cursor:pointer;font-size:12px" title="Toggle Sidebar (Ctrl+B)">‚óÄ Panel</button>
    </div>
</div>

<div id="releaseModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:1000;justify-content:center;align-items:center">
    <div style="background:var(--white);border-radius:12px;padding:24px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto;box-shadow:0 4px 20px rgba(0,0,0,0.15)">
        <h3 style="margin:0 0 16px;color:var(--text)">üìã Release Notes</h3>
        <div id="releaseContent" style="background:var(--bg-light);padding:16px;border-radius:8px;color:var(--text);font-size:13px;max-height:400px;overflow-y:auto;white-space:pre-wrap;font-family:monospace;border:1px solid var(--border)"></div>
        <div style="margin-top:16px;text-align:right"><button onclick="document.getElementById('releaseModal').style.display='none'" style="padding:8px 16px;border:none;background:var(--blue);color:#fff;border-radius:6px;cursor:pointer">Close</button></div>
    </div>
</div>

<div id="updateModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:1000;justify-content:center;align-items:center">
    <div style="background:var(--white);border-radius:12px;padding:24px;max-width:400px;width:90%;box-shadow:0 4px 20px rgba(0,0,0,0.15)">
        <h3 style="margin:0 0 16px;color:var(--text)">‚¨ÜÔ∏è Update Available</h3>
        <p id="updateText" style="color:var(--text-sec);font-size:13px;margin-bottom:16px"></p>
        <div style="display:flex;gap:12px;justify-content:flex-end">
            <button onclick="document.getElementById('updateModal').style.display='none'" style="padding:8px 16px;border:1px solid var(--border);background:transparent;color:var(--text);border-radius:6px;cursor:pointer">Later</button>
            <button onclick="installUpdate()" style="padding:8px 16px;border:none;background:var(--success);color:#fff;border-radius:6px;cursor:pointer">Install</button>
        </div>
    </div>
</div>

<div class="main">
    <!-- CHAT MODULE (iframe) -->
    <iframe class="chat-frame" id="chatFrame" src="/modules/ai-chat-module-pro/chat-pro-standalone.html?theme=light"></iframe>
    
    <!-- SIDEBAR -->
    <div class="sidebar">
        <div class="proj-box">
            <div class="lbl">Current Project</div>
            <div class="name" id="projName">-</div>
            <div class="ver">v<span id="projVer">0.0.0</span></div>
            <div class="path" id="projPath">-</div>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="showTab('files', event)">üìÅ Files</div>
            <div class="tab" onclick="showTab('backlog', event)">üìã Backlog</div>
            <div class="tab" onclick="showTab('todo', event)">‚úÖ TODO</div>
            <div class="tab" onclick="showTab('protocol', event)">üîÑ Protocol</div>
            <div class="tab" onclick="showTab('system', event)">‚öôÔ∏è System</div>
        </div>
        
        <div class="tab-content active" id="tab-files">
            <div class="panel"><div class="panel-hdr" onclick="togglePanel(this)">Output Files <span class="cnt" id="filesCount">0</span></div><div class="panel-body" id="filesPanel"></div></div>
            <div class="panel"><div class="panel-hdr" onclick="togglePanel(this)">Snapshots <span class="cnt" id="snapshotsCount">0</span></div><div class="panel-body" id="snapshotsPanel"></div></div>
        </div>
        
        <div class="tab-content" id="tab-backlog">
            <div class="panel"><div class="panel-hdr" onclick="togglePanel(this)">Backlog <span class="cnt" id="backlogCount">0</span></div><div class="panel-body" id="backlogPanel"></div>
                <div class="add-row"><input type="text" id="newBacklog" placeholder="New task..."><select id="backlogPrio"><option value="medium">Med</option><option value="high">High</option><option value="low">Low</option></select><button onclick="addBacklog()">+</button></div>
            </div>
            <div class="panel"><div class="panel-hdr" onclick="togglePanel(this)">Changelog <span class="cnt" id="changelogCount">0</span></div><div class="panel-body" id="changelogPanel"></div></div>
        </div>
        
        <div class="tab-content" id="tab-todo">
            <div class="panel"><div class="panel-hdr" onclick="togglePanel(this)">TODO <span class="cnt" id="todoCount">0</span></div><div class="panel-body" id="todoPanel"></div>
                <div class="add-row"><input type="text" id="newTodo" placeholder="New todo..."><button onclick="addTodo()">+</button></div>
            </div>
            <div class="panel collapsed"><div class="panel-hdr" onclick="togglePanel(this)">Completed <span class="cnt" id="completedCount">0</span></div><div class="panel-body" id="completedPanel"></div></div>
            <div class="panel"><div class="panel-hdr" onclick="togglePanel(this)">Bugfixes <span class="cnt" id="bugfixCount">0</span></div><div class="panel-body" id="bugfixPanel"></div>
                <div class="add-row"><input type="text" id="newBugfix" placeholder="New bugfix..."><button onclick="addBugfix()">+</button></div>
            </div>
        </div>
        
        <div class="tab-content" id="tab-protocol">
            <div class="panel">
                <div class="panel-hdr" onclick="togglePanel(this)">
                    <span>üî¥ Live Status</span>
                    <span class="cnt" id="wsStatus">Disconnected</span>
                </div>
                <div class="panel-body" id="protocolLive" style="max-height:200px">
                    <div class="item empty">No active execution</div>
                </div>
            </div>
            <div class="panel">
                <div class="panel-hdr" onclick="togglePanel(this)">Protocol Steps <span class="cnt" id="stepsCount">13</span></div>
                <div class="panel-body" id="stepsPanel" style="max-height:300px"></div>
            </div>
            <div class="panel">
                <div class="panel-hdr" onclick="togglePanel(this)">Recent Executions <span class="cnt" id="execCount">0</span></div>
                <div class="panel-body" id="execPanel" style="max-height:200px">
                    <div class="item empty">No history</div>
                </div>
            </div>
            <div class="panel">
                <div class="panel-hdr" onclick="togglePanel(this)">Violations <span class="cnt" id="violationsCount">0</span></div>
                <div class="panel-body" id="violationsPanel" style="max-height:150px">
                    <div class="item empty">No violations</div>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="tab-system">
            <div class="panel"><div class="panel-hdr" onclick="togglePanel(this)">Constraints <span class="cnt" id="constraintsCount">0</span></div><div class="panel-body" id="constraintsPanel"></div></div>
            <div class="panel">
                <div class="panel-hdr" onclick="togglePanel(this)">
                    Errors & Learning 
                    <span class="cnt" id="errorsCount">0</span>
                </div>
                <div class="panel-body">
                    <div id="debugStats" style="padding:8px;background:var(--surface2);border-radius:6px;margin-bottom:8px;font-size:11px">
                        <span>üìä Total: <b id="statTotal">0</b></span>
                        <span style="margin-left:12px">ü§ñ Auto-fixed: <b id="statAutoFixed">0</b></span>
                        <span style="margin-left:12px">üìö Patterns: <b id="statPatterns">0</b></span>
                    </div>
                    <div id="errorsPanel"></div>
                </div>
            </div>
            <div class="panel"><div class="panel-hdr" onclick="togglePanel(this)">GitHub <span class="cnt" id="githubCount">-</span></div><div class="panel-body" id="githubPanel"></div></div>
        </div>
    </div>
</div>

<script>
const API = 'http://localhost:9998';

// ============================================================
// CONSOLE ERROR CAPTURE - Send to dashboard and backend
// ============================================================
const capturedErrors = [];
const originalConsoleError = console.error;
const originalConsoleWarn = console.warn;

console.error = function(...args) {
    originalConsoleError.apply(console, args);
    captureError('error', args.map(a => String(a)).join(' '));
};

console.warn = function(...args) {
    originalConsoleWarn.apply(console, args);
    captureError('warning', args.map(a => String(a)).join(' '));
};

window.onerror = function(message, source, lineno, colno, error) {
    captureError('error', `${message} at ${source}:${lineno}:${colno}`);
    return false;
};

window.onunhandledrejection = function(event) {
    captureError('error', `Unhandled Promise: ${event.reason}`);
};

// Listen for errors from chat iframe
window.addEventListener('message', function(event) {
    if (event.data && event.data.type === 'chat-error') {
        captureError(event.data.level, `[Chat] ${event.data.message}`);
    }
    // Refresh outputs when chat creates files
    if (event.data && event.data.type === 'files-created') {
        loadOutputs();
    }
});

function captureError(level, message) {
    const err = {
        level: level,
        message: message,
        timestamp: new Date().toISOString(),
        source: 'dashboard'
    };
    capturedErrors.push(err);
    
    // Update error count in UI
    updateErrorDisplay();
    
    // Send to backend
    fetch(`${API}/api/debug/error`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(err)
    }).catch(() => {}); // Ignore send errors
}

function updateErrorDisplay() {
    const panel = document.getElementById('errorsPanel');
    const count = document.getElementById('errorsCount');
    if (!panel || !count) return;
    
    count.textContent = capturedErrors.length;
    
    if (capturedErrors.length === 0) {
        panel.innerHTML = '<div class="item empty" style="color:var(--success)">No errors</div>';
    } else {
        panel.innerHTML = capturedErrors.slice(-10).reverse().map(e => 
            `<div class="item" style="color:${e.level === 'error' ? 'var(--error)' : 'var(--warning)'}">
                <span class="badge" style="background:${e.level === 'error' ? 'var(--error)' : 'var(--warning)'}">${e.level}</span>
                <span class="txt">${e.message.substring(0, 100)}</span>
            </div>`
        ).join('');
    }
}

// ============================================================
// UI FUNCTIONS
// ============================================================

function togglePanel(el) { 
    const panel = el.closest('.panel');
    if (!panel) return;
    panel.classList.toggle('collapsed');
    
    // Persist state in localStorage
    const panelId = panel.querySelector('.panel-body')?.id || panel.querySelector('.panel-hdr')?.textContent?.trim().split(' ')[0];
    if (panelId) {
        const collapsed = JSON.parse(localStorage.getItem('panelStates') || '{}');
        collapsed[panelId] = panel.classList.contains('collapsed');
        localStorage.setItem('panelStates', JSON.stringify(collapsed));
    }
}

function restorePanelStates() {
    const collapsed = JSON.parse(localStorage.getItem('panelStates') || '{}');
    document.querySelectorAll('.panel').forEach(panel => {
        const panelId = panel.querySelector('.panel-body')?.id || panel.querySelector('.panel-hdr')?.textContent?.trim().split(' ')[0];
        if (panelId && collapsed[panelId]) {
            panel.classList.add('collapsed');
        }
    });
}

function toggleSidebar() {
    const main = document.querySelector('.main');
    const btn = document.getElementById('sidebarToggle');
    main.classList.toggle('sidebar-collapsed');
    
    const isCollapsed = main.classList.contains('sidebar-collapsed');
    btn.textContent = isCollapsed ? '‚ñ∂ Panel' : '‚óÄ Panel';
    localStorage.setItem('sidebarCollapsed', isCollapsed);
}

function restoreSidebarState() {
    const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
    if (isCollapsed) {
        document.querySelector('.main')?.classList.add('sidebar-collapsed');
        document.getElementById('sidebarToggle').textContent = '‚ñ∂ Panel';
    }
}

// Keyboard shortcut Ctrl+B to toggle sidebar
document.addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.key === 'b') {
        e.preventDefault();
        toggleSidebar();
    }
});

function showTab(name, evt) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.getElementById('tab-' + name)?.classList.add('active');
    if (evt && evt.target) evt.target.classList.add('active');
}

async function loadHealth() {
    try {
        const r = await fetch(`${API}/api/health`);
        const d = await r.json();
        document.getElementById('apiDot').className = 'dot on';
        document.getElementById('apiStatus').textContent = 'Connected';
        document.getElementById('srvVersion').textContent = d.version || '-';
        document.getElementById('apiKeyStatus').textContent = d.api_key ? '‚úì' : '‚úó';
        document.getElementById('projName').textContent = d.project || '-';
        document.getElementById('projVer').textContent = d.project_version || '0.0.0';
        document.getElementById('projPath').textContent = d.project_path || '-';
        
        // Version comparison logic
        const updateBadge = document.getElementById('updateBadge');
        if (d.github_version && d.version) {
            if (isNewerVersion(d.github_version, d.version)) {
                // GitHub is newer -> show update available
                updateBadge.style.display = 'inline';
                updateBadge.style.background = '#ff9800';
                updateBadge.textContent = '‚¨Ü v' + d.github_version;
                updateBadge.title = 'Click to update to latest version';
                updateBadge.onclick = showUpdatePrompt;
            } else if (isNewerVersion(d.version, d.github_version)) {
                // Local is newer -> show publish prompt
                updateBadge.style.display = 'inline';
                updateBadge.style.background = 'var(--success)';
                updateBadge.textContent = '‚¨Ü Publish';
                updateBadge.title = 'Local version is ahead of GitHub. Click to publish.';
                updateBadge.onclick = showPublishPrompt;
            } else {
                // Versions are equal -> hide badge
                updateBadge.style.display = 'none';
            }
        } else {
            updateBadge.style.display = 'none';
        }
    } catch (e) {
        document.getElementById('apiDot').className = 'dot off';
        document.getElementById('apiStatus').textContent = 'Disconnected';
    }
}

function showPublishPrompt() {
    // Fetch pending TODOs to show in publish dialog
    fetch(`${API}/api/todo`)
        .then(r => r.json())
        .then(d => {
            const todos = (Array.isArray(d) ? d : d.items || []).filter(i => !i.done);
            let todoCheckboxes = '';
            if (todos.length > 0) {
                todoCheckboxes = '<div style="margin:12px 0;text-align:left"><b>Mark as done when tests pass:</b><br>' +
                    todos.map(t => `<label style="display:block;margin:4px 0;cursor:pointer"><input type="checkbox" class="publish-todo" value="${t.id}" checked> ${t.id}: ${(t.title || t.task).substring(0, 40)}</label>`).join('') +
                    '</div>';
            }
            
            document.getElementById('updateModal').style.display = 'flex';
            document.getElementById('updateText').innerHTML = 
                'Your local version (<b>v' + document.getElementById('srvVersion').textContent + '</b>) is newer than GitHub.<br>' +
                todoCheckboxes +
                '<br>Would you like to publish this version to GitHub?';
            // Change button to Publish
            const btns = document.querySelectorAll('#updateModal button');
            if (btns.length >= 2) {
                btns[1].textContent = 'Publish';
                btns[1].onclick = publishToGitHub;
            }
        })
        .catch(() => {
            document.getElementById('updateModal').style.display = 'flex';
            document.getElementById('updateText').innerHTML = 
                'Your local version (<b>v' + document.getElementById('srvVersion').textContent + '</b>) is newer than GitHub.<br><br>' +
                'Would you like to publish this version to GitHub?';
            const btns = document.querySelectorAll('#updateModal button');
            if (btns.length >= 2) {
                btns[1].textContent = 'Publish';
                btns[1].onclick = publishToGitHub;
            }
        });
}

async function publishToGitHub() {
    // Get selected TODO IDs
    const todoIds = Array.from(document.querySelectorAll('.publish-todo:checked')).map(cb => cb.value);
    
    document.getElementById('updateText').textContent = 'Publishing to GitHub...';
    try {
        const r = await fetch(`${API}/api/github/push`, { 
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ 
                target: 'service',
                create_release: true,
                message: 'Release v' + document.getElementById('srvVersion').textContent,
                todo_ids: todoIds
            })
        });
        const d = await r.json();
        if (d.success) {
            document.getElementById('updateText').innerHTML = '‚úÖ Published successfully!<br>Release: v' + document.getElementById('srvVersion').textContent;
            setTimeout(() => {
                document.getElementById('updateModal').style.display = 'none';
                loadHealth();
            }, 2000);
        } else {
            document.getElementById('updateText').textContent = '‚ùå Error: ' + (d.error || 'Unknown error');
        }
    } catch (e) {
        document.getElementById('updateText').textContent = '‚ùå Error: ' + e.message;
    }
}

// Compare semantic versions: returns true if v1 > v2
function isNewerVersion(v1, v2) {
    const parts1 = v1.split('.').map(Number);
    const parts2 = v2.split('.').map(Number);
    for (let i = 0; i < 3; i++) {
        const a = parts1[i] || 0;
        const b = parts2[i] || 0;
        if (a > b) return true;
        if (a < b) return false;
    }
    return false; // Equal versions
}
async function loadOutputs() {
    try {
        const r = await fetch(`${API}/api/outputs`);
        const d = await r.json();
        // Accept both formats: array directly or {files: [...]}
        const files = Array.isArray(d) ? d : (d.files || []);
        document.getElementById('filesCount').textContent = files.length;
        document.getElementById('filesPanel').innerHTML = files.length ? 
            files.slice(0, 10).map(f => `<div class="item"><a href="${API}/outputs/${f.name}" target="_blank" style="text-decoration:none;color:inherit;display:flex;align-items:center;gap:8px;width:100%"><span class="badge">${f.ext || 'file'}</span><span class="txt">${f.name}</span></a></div>`).join('') :
            '<div class="item empty">No files</div>';
    } catch (e) {}
}

async function loadSnapshots() {
    try {
        const r = await fetch(`${API}/api/snapshots`);
        const d = await r.json();
        const snaps = d.snapshots || [];
        document.getElementById('snapshotsCount').textContent = snaps.length;
        document.getElementById('snapshotsPanel').innerHTML = snaps.length ?
            snaps.slice(0, 5).map(s => `<div class="item"><span class="badge">v${s.version}</span><span class="txt">${s.label}</span></div>`).join('') :
            '<div class="item empty">No snapshots</div>';
    } catch (e) {}
}

async function loadBacklog() {
    try {
        const r = await fetch(`${API}/api/backlog`);
        const d = await r.json();
        const items = (d.items || d || []).filter(i => !i.done);
        document.getElementById('backlogCount').textContent = items.length;
        document.getElementById('backlogPanel').innerHTML = items.length ?
            items.map(i => `<div class="item"><span class="prio ${i.priority || 'medium'}">${(i.priority || 'med')[0].toUpperCase()}</span><span class="txt">${i.title || i.task}</span></div>`).join('') :
            '<div class="item empty">No items</div>';
    } catch (e) {}
}

async function toggleTodo(id) {
    try {
        await fetch(`${API}/api/todo/complete`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({id})
        });
        loadTodo();  // Refresh
    } catch (e) {
        console.error('Failed to toggle TODO:', e);
    }
}

async function restoreTodo(id) {
    try {
        await fetch(`${API}/api/todo/restore`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({id})
        });
        loadTodo();  // Refresh
    } catch (e) {
        console.error('Failed to restore TODO:', e);
    }
}

async function loadTodo() {
    try {
        const r = await fetch(`${API}/api/todo`);
        const d = await r.json();
        const all = (Array.isArray(d) ? d : d.items || []);
        const pending = all.filter(i => !i.done);
        const completed = all.filter(i => i.done);
        
        document.getElementById('todoCount').textContent = pending.length;
        document.getElementById('todoPanel').innerHTML = pending.length ?
            pending.map(i => `<div class="item" onclick="toggleTodo('${i.id}')" style="cursor:pointer" title="Click to mark as done"><span class="badge">${i.id}</span><span class="txt">${i.title || i.task}</span></div>`).join('') :
            '<div class="item empty">No TODOs</div>';
        
        // Also update Completed panel
        document.getElementById('completedCount').textContent = completed.length;
        document.getElementById('completedPanel').innerHTML = completed.length ?
            completed.slice(-10).reverse().map(i => `<div class="item" onclick="restoreTodo('${i.id}')" style="opacity:0.7;cursor:pointer" title="Click to restore"><span class="badge" style="background:#e8f5e9;color:#34a853">‚úì</span><span class="txt" style="text-decoration:line-through">${i.title || i.task}</span></div>`).join('') :
            '<div class="item empty">No completed items</div>';
    } catch (e) {}
}

async function loadChangelog() {
    try {
        const r = await fetch(`${API}/api/changelog`);
        const d = await r.json();
        const items = Array.isArray(d) ? d : [];
        document.getElementById('changelogCount').textContent = items.length;
        document.getElementById('changelogPanel').innerHTML = items.length ?
            items.slice(0, 10).map(i => `<div class="item"><span class="badge" style="background:#e3f2fd">v${i.version}</span><span class="txt">${i.date ? new Date(i.date).toLocaleDateString() : ''}</span></div>`).join('') :
            '<div class="item empty">No releases</div>';
    } catch (e) {}
}

async function loadBugfixes() {
    try {
        const r = await fetch(`${API}/api/bugfix/pending`);
        const d = await r.json();
        const items = d.bugfixes || [];
        document.getElementById('bugfixCount').textContent = items.length;
        document.getElementById('bugfixPanel').innerHTML = items.length ?
            items.map(i => `<div class="item"><span class="badge">${i.id}</span><span class="txt">${i.title}</span></div>`).join('') :
            '<div class="item empty">No bugfixes</div>';
    } catch (e) {}
}

async function loadConstraints() {
    try {
        const r = await fetch(`${API}/api/constraints`);
        const d = await r.json();
        const items = d.constraints || [];
        document.getElementById('constraintsCount').textContent = items.length;
        document.getElementById('constraintsPanel').innerHTML = items.length ?
            items.slice(0, 8).map(c => `<div class="item"><span class="badge">${c.id}</span><span class="txt">${c.rule}</span></div>`).join('') :
            '<div class="item empty">No constraints</div>';
    } catch (e) {}
}

async function loadErrors() {
    try {
        // Load errors
        const r = await fetch(`${API}/api/debug/errors`);
        const d = await r.json();
        const items = d.errors || [];
        document.getElementById('errorsCount').textContent = items.length;
        
        // Load debug stats
        const statsR = await fetch(`${API}/api/debug/stats`);
        const stats = await statsR.json();
        document.getElementById('statTotal').textContent = stats.total_errors || 0;
        document.getElementById('statAutoFixed').textContent = stats.auto_fixed || 0;
        document.getElementById('statPatterns').textContent = stats.learned_patterns || 0;
        
        // Display errors with actions
        if (items.length === 0) {
            document.getElementById('errorsPanel').innerHTML = '<div class="item empty" style="color:var(--success)">No errors</div>';
        } else {
            document.getElementById('errorsPanel').innerHTML = items.slice(0, 8).map(e => `
                <div class="item" style="border-left:3px solid ${e.status === 'fixed' ? 'var(--success)' : e.status === 'auto_fixed' ? 'var(--accent)' : 'var(--error)'}">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <span class="badge" style="background:${e.status === 'fixed' ? 'var(--success)' : e.status === 'auto_fixed' ? 'var(--accent)' : 'var(--error)'}">${e.status || 'new'}</span>
                        <span class="txt" style="flex:1;margin:0 8px;font-size:11px">${(e.error?.message || e.message || 'Unknown').substring(0, 60)}</span>
                        ${e.status === 'new' ? `<button onclick="autoFixError('${e.id}')" style="font-size:10px;padding:2px 6px;cursor:pointer">üîß Fix</button>` : ''}
                        ${e.github_issue ? `<a href="${e.github_issue.url}" target="_blank" style="font-size:10px">üìù #${e.github_issue.number}</a>` : ''}
                    </div>
                    ${e.known_fix ? `<div style="font-size:10px;color:var(--success);margin-top:4px">‚úÖ Known fix: ${e.known_fix.fix_description}</div>` : ''}
                </div>
            `).join('');
        }
    } catch (e) {
        console.error('loadErrors error:', e);
    }
}

async function autoFixError(errorId) {
    try {
        const btn = event.target;
        btn.disabled = true;
        btn.textContent = '‚è≥...';
        
        const r = await fetch(`${API}/api/debug/auto-fix/${errorId}`, { method: 'POST' });
        const result = await r.json();
        
        if (result.success) {
            if (result.auto_fixed) {
                btn.textContent = '‚úÖ';
                btn.style.background = 'var(--success)';
            } else {
                btn.textContent = 'üìù';
                if (result.github_issue) {
                    window.open(result.github_issue, '_blank');
                }
            }
        } else {
            btn.textContent = '‚ùå';
        }
        
        // Reload errors after a short delay
        setTimeout(loadErrors, 1000);
    } catch (e) {
        console.error('autoFixError error:', e);
    }
}

async function loadGitHub() {
    try {
        const r = await fetch(`${API}/api/github/status`);
        const d = await r.json();
        document.getElementById('githubCount').textContent = d.connected ? '‚úì' : '‚úó';
        document.getElementById('githubPanel').innerHTML = `
            <div class="item"><span class="txt">Service: ${d.repos?.service || '-'}</span></div>
            <div class="item"><span class="txt">Dashboard: ${d.repos?.dashboard || '-'}</span></div>`;
    } catch (e) {}
}

async function addBacklog() {
    const input = document.getElementById('newBacklog');
    const prio = document.getElementById('backlogPrio');
    if (!input.value.trim()) return;
    try {
        const r = await fetch(`${API}/api/backlog/add`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ title: input.value, priority: prio.value }) });
        if (!r.ok) throw new Error('Failed to add');
        input.value = ''; loadBacklog();
    } catch (e) { console.error('addBacklog error:', e); alert('Failed to add backlog item'); }
}

async function addTodo() {
    const input = document.getElementById('newTodo');
    if (!input.value.trim()) return;
    try {
        const r = await fetch(`${API}/api/todo/add`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ title: input.value }) });
        if (!r.ok) throw new Error('Failed to add');
        input.value = ''; loadTodo();
    } catch (e) { console.error('addTodo error:', e); alert('Failed to add todo item'); }
}

async function addBugfix() {
    const input = document.getElementById('newBugfix');
    if (!input.value.trim()) return;
    try {
        const r = await fetch(`${API}/api/bugfix/add`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ title: input.value }) });
        if (!r.ok) throw new Error('Failed to add');
        input.value = ''; loadBugfixes();
    } catch (e) { console.error('addBugfix error:', e); alert('Failed to add bugfix'); }
}

function showReleaseNotes() {
    document.getElementById('releaseModal').style.display = 'flex';
    document.getElementById('releaseContent').textContent = 'Loading...';
    
    const version = document.getElementById('srvVersion').textContent;
    
    // Try preview endpoint first (always works), then fallback to changelog
    fetch(`${API}/api/release-notes/preview?version=${version}`)
        .then(r => r.json())
        .then(d => { 
            if (d.notes) {
                document.getElementById('releaseContent').textContent = d.notes;
            } else {
                // Fallback: try changelog
                return fetch(`${API}/api/changelog`).then(r => r.json());
            }
        })
        .then(changelog => {
            if (changelog && Array.isArray(changelog) && changelog.length > 0) {
                // Find matching version or show latest
                const entry = changelog.find(c => c.version === version) || changelog[0];
                document.getElementById('releaseContent').textContent = entry.notes || `## v${entry.version}\n\nReleased: ${entry.date || 'Unknown'}`;
            }
        })
        .catch(() => { document.getElementById('releaseContent').textContent = 'No release notes available for this version.'; });
}

function showUpdatePrompt() {
    document.getElementById('updateModal').style.display = 'flex';
    document.getElementById('updateText').textContent = 'A new version is available. Install now?';
}

async function installUpdate() {
    document.getElementById('updateText').textContent = 'Installing...';
    try {
        await fetch(`${API}/api/update/install-from-github`, { method: 'POST' });
        document.getElementById('updateText').textContent = 'Installed! Restarting...';
        setTimeout(() => location.reload(), 3000);
    } catch (e) {
        document.getElementById('updateText').textContent = 'Error: ' + e.message;
    }
}

// Init
restoreSidebarState();  // Restore sidebar collapsed state
restorePanelStates();   // Restore collapsed panel states from localStorage
loadHealth();
loadOutputs();
loadSnapshots();
loadBacklog();
loadTodo();
loadChangelog();
loadBugfixes();
loadConstraints();
loadErrors();
loadGitHub();
loadProtocolSteps();
loadExecutionHistory();
initWebSocket();
setInterval(loadHealth, 10000);
setInterval(() => { loadOutputs(); loadSnapshots(); loadBugfixes(); }, 5000);

// Check GitHub workflow status every 30 seconds to auto-complete TODOs
setInterval(checkWorkflowStatus, 30000);

async function checkWorkflowStatus() {
    try {
        const r = await fetch(`${API}/api/github/workflow-status`);
        const d = await r.json();
        if (d.completed && d.completed.length > 0) {
            // Refresh TODO list if any TODOs were completed
            loadTodo();
        }
    } catch (e) {}
}

// ============================================================
// PROTOCOL TRACKING - WebSocket Real-time
// ============================================================

let ws = null;
let wsReconnectTimer = null;

function initWebSocket() {
    const wsUrl = API.replace('http', 'ws') + '/ws';
    try {
        ws = new WebSocket(wsUrl);
        
        ws.onopen = () => {
            document.getElementById('wsStatus').textContent = 'Connected';
            document.getElementById('wsStatus').style.background = 'var(--success)';
            
        };
        
        ws.onclose = () => {
            document.getElementById('wsStatus').textContent = 'Disconnected';
            document.getElementById('wsStatus').style.background = 'var(--error)';
            // Reconnect after 5s
            wsReconnectTimer = setTimeout(initWebSocket, 5000);
        };
        
        ws.onerror = (e) => {
            console.error('WebSocket error:', e);
        };
        
        ws.onmessage = (event) => {
            try {
                const msg = JSON.parse(event.data);
                handleProtocolMessage(msg);
            } catch (e) {
                console.error('WebSocket message parse error:', e);
            }
        };
    } catch (e) {
        console.error('WebSocket init error:', e);
        document.getElementById('wsStatus').textContent = 'Error';
    }
}

function handleProtocolMessage(msg) {
    const livePanel = document.getElementById('protocolLive');
    
    if (msg.type === 'protocol_start') {
        livePanel.innerHTML = `
            <div class="item" style="background:#e3f2fd">
                <span class="badge" style="background:var(--blue)">RUNNING</span>
                <span class="txt">${msg.todo_title || 'Executing...'}</span>
            </div>
            <div id="liveSteps"></div>`;
    }
    else if (msg.type === 'protocol_step') {
        const liveSteps = document.getElementById('liveSteps') || livePanel;
        const statusIcon = msg.status === 'success' ? '‚úÖ' : msg.status === 'failed' ? '‚ùå' : '‚è≥';
        const stepHtml = `<div class="item">
            <span style="width:24px">${statusIcon}</span>
            <span class="txt">${msg.step_name}</span>
            <span class="badge">${msg.step_id}</span>
        </div>`;
        
        if (document.getElementById('liveSteps')) {
            document.getElementById('liveSteps').innerHTML += stepHtml;
        } else {
            livePanel.innerHTML += stepHtml;
        }
    }
    else if (msg.type === 'protocol_end') {
        const statusBg = msg.status === 'success' ? 'var(--success)' : 'var(--error)';
        livePanel.innerHTML = `
            <div class="item" style="background:${msg.status === 'success' ? '#e8f5e9' : '#ffebee'}">
                <span class="badge" style="background:${statusBg}">${msg.status.toUpperCase()}</span>
                <span class="txt">${msg.todo_title || 'Completed'}</span>
            </div>
            <div class="item">
                <span class="txt">Version: ${msg.version_before || '?'} ‚Üí ${msg.version_after || '?'}</span>
            </div>`;
        
        // Refresh history
        loadExecutionHistory();
        
        // Show violations if any
        if (msg.violations && msg.violations.length > 0) {
            updateViolations(msg.violations);
        }
    }
    else if (msg.type === 'violation') {
        addViolation(msg.constraint, msg.message);
    }
}

function loadProtocolSteps() {
    // Static display of protocol steps
    const steps = [
        { id: 'STEP_01', name: 'fetch_github_version', constraint: 'ENV012' },
        { id: 'STEP_02', name: 'calculate_next_version', constraint: 'ENV012' },
        { id: 'STEP_03', name: 'create_snapshot_before', constraint: 'ENV003' },
        { id: 'STEP_04', name: 'build_claude_context', constraint: 'ENV015' },
        { id: 'STEP_05', name: 'call_claude', constraint: 'CTX001' },
        { id: 'STEP_06', name: 'validate_response', constraint: 'CTX003' },
        { id: 'STEP_07', name: 'execute_tasks', constraint: 'CTX004' },
        { id: 'STEP_08', name: 'create_snapshot_after', constraint: 'ENV014' },
        { id: 'STEP_09', name: 'git_commit', constraint: 'ENV004' },
        { id: 'STEP_10', name: 'git_push', constraint: 'ENV009' },
        { id: 'STEP_11', name: 'create_github_release', constraint: 'ENV012' },
        { id: 'STEP_12', name: 'verify_release', constraint: 'ENV013' },
        { id: 'STEP_13', name: 'mark_todo_done', constraint: '-' }
    ];
    
    const panel = document.getElementById('stepsPanel');
    panel.innerHTML = steps.map(s => `
        <div class="item">
            <span class="badge">${s.id}</span>
            <span class="txt">${s.name}</span>
            <span class="prio low">${s.constraint}</span>
        </div>
    `).join('');
}

async function loadExecutionHistory() {
    try {
        const r = await fetch(`${API}/api/protocol/history`);
        if (!r.ok) throw new Error('Not found');
        const data = await r.json();
        
        document.getElementById('execCount').textContent = data.executions?.length || 0;
        const panel = document.getElementById('execPanel');
        
        if (!data.executions || data.executions.length === 0) {
            panel.innerHTML = '<div class="item empty">No history</div>';
            return;
        }
        
        panel.innerHTML = data.executions.slice(0, 10).map(e => {
            const statusClass = e.status === 'success' ? 'low' : 'high';
            return `<div class="item">
                <span class="prio ${statusClass}">${e.status}</span>
                <span class="txt">${e.todo_title || e.execution_id}</span>
                <span class="badge">${e.github_version_after || '-'}</span>
            </div>`;
        }).join('');
    } catch (e) {
        // Endpoint might not exist yet
        document.getElementById('execPanel').innerHTML = '<div class="item empty">No history endpoint</div>';
    }
}

function updateViolations(violations) {
    const panel = document.getElementById('violationsPanel');
    document.getElementById('violationsCount').textContent = violations.length;
    
    panel.innerHTML = violations.map(v => `
        <div class="item" style="background:#ffebee">
            <span class="prio high">‚ùå</span>
            <span class="txt">${v}</span>
        </div>
    `).join('');
}

function addViolation(constraint, message) {
    const panel = document.getElementById('violationsPanel');
    const count = parseInt(document.getElementById('violationsCount').textContent) || 0;
    document.getElementById('violationsCount').textContent = count + 1;
    
    // Remove empty message if present
    if (panel.querySelector('.empty')) {
        panel.innerHTML = '';
    }
    
    panel.innerHTML += `
        <div class="item" style="background:#ffebee">
            <span class="badge" style="background:var(--error)">${constraint}</span>
            <span class="txt">${message}</span>
        </div>`;
}
</script>
</body>
</html>
