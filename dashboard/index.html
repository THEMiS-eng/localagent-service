<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#1a73e8">
<meta name="mobile-web-app-capable" content="yes">
<link rel="manifest" href="/manifest.json">
<title>LocalAgent Dashboard</title>
<style>
:root {
    --bg: #f8f9fa; --bg-light: #f1f3f4; --white: #fff;
    --border: #e0e0e0; --text: #202124; --text-sec: #5f6368;
    --blue: #1a73e8; --blue-hover: #1557b0;
    --success: #34a853; --warning: #fbbc04; --error: #ea4335;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); font-size: 14px; }

.header { position: fixed; top: 0; left: 0; right: 0; z-index: 100; height: 52px; background: var(--white); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 16px; gap: 16px; }
.logo { font-weight: 600; font-size: 16px; color: var(--blue); }
.health { display: flex; gap: 12px; margin-left: auto; font-size: 12px; align-items: center; }
.dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 4px; }
.dot.on { background: var(--success); }
.dot.off { background: var(--error); }
.dot.warn { background: var(--warning); animation: pulse 1s infinite; }
@keyframes pulse { 50% { opacity: 0.5; } }

.main { position: fixed; top: 52px; bottom: 0; left: 0; right: 0; display: grid; grid-template-columns: 1fr 380px; }

/* CHAT MODULE IFRAME */
.chat-frame { width: 100%; height: 100%; border: none; }

/* SIDEBAR */
.sidebar { overflow-y: auto; padding: 12px; background: var(--bg); }
.proj-box { background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; padding: 14px; border-radius: 10px; margin-bottom: 12px; }
.proj-box .lbl { font-size: 10px; opacity: 0.7; text-transform: uppercase; }
.proj-box .name { font-size: 16px; font-weight: 600; margin: 2px 0; }
.proj-box .ver { font-size: 12px; opacity: 0.85; }
.proj-box .path { font-size: 10px; opacity: 0.6; margin-top: 6px; word-break: break-all; }

.tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 10px; }
.tab { padding: 8px 12px; cursor: pointer; font-size: 12px; color: var(--text-sec); border-bottom: 2px solid transparent; }
.tab:hover { color: var(--text); }
.tab.active { color: var(--blue); border-bottom-color: var(--blue); }
.tab-content { display: none; }
.tab-content.active { display: block; }

.panel { background: var(--white); border-radius: 8px; margin-bottom: 10px; overflow: hidden; }
.panel-hdr { font-size: 12px; font-weight: 500; padding: 10px 12px; background: var(--bg-light); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); cursor: pointer; }
.panel-hdr:hover { background: #e8eaed; }
.panel-hdr .cnt { background: var(--blue); color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px; }
.panel-hdr::before { content: '‚ñº'; font-size: 10px; margin-right: 8px; transition: transform 0.2s; color: var(--text-sec); }
.panel.collapsed .panel-hdr::before { transform: rotate(-90deg); }
.panel.collapsed .panel-body, .panel.collapsed .add-row { display: none; }
.panel-body { max-height: 160px; overflow-y: auto; }

.item { padding: 8px 12px; border-bottom: 1px solid var(--bg-light); font-size: 12px; display: flex; align-items: center; gap: 8px; }
.item:last-child { border-bottom: none; }
.item.empty { color: var(--text-sec); justify-content: center; padding: 16px; }
.item .badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: #e3f2fd; color: var(--blue); font-family: monospace; }
.item .txt { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.item .prio { font-size: 10px; padding: 2px 6px; border-radius: 4px; }
.item .prio.high { background: #ffebee; color: var(--error); }
.item .prio.medium { background: #fff8e1; color: #f57c00; }
.item .prio.low { background: #e8f5e9; color: var(--success); }

.add-row { display: flex; gap: 6px; padding: 8px 12px; border-top: 1px solid var(--bg-light); }
.add-row input, .add-row select { flex: 1; padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; }
.add-row button { padding: 6px 12px; background: var(--blue); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; }
</style>
</head>
<body>
<div class="header">
    <div class="logo">ü§ñ LocalAgent</div>
    <div class="health">
        <span><span class="dot warn" id="apiDot"></span><span id="apiStatus">Connecting...</span></span>
        <span style="color:var(--text-sec)">|</span>
        <span style="cursor:pointer" onclick="showReleaseNotes()">v<span id="srvVersion">-</span></span>
        <span id="updateBadge" style="display:none;margin-left:8px;background:#ff9800;color:#fff;padding:2px 8px;border-radius:12px;font-size:11px;cursor:pointer" onclick="showUpdatePrompt()">‚¨Ü Update</span>
        <span style="color:var(--text-sec)">|</span>
        <span>API: <span id="apiKeyStatus">-</span></span>
    </div>
</div>

<div id="releaseModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:1000;justify-content:center;align-items:center">
    <div style="background:#1e1e1e;border-radius:12px;padding:24px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto">
        <h3 style="margin:0 0 16px;color:#fff">üìã Release Notes</h3>
        <div id="releaseContent" style="background:#2d2d2d;padding:16px;border-radius:8px;color:#ccc;font-size:13px;max-height:400px;overflow-y:auto;white-space:pre-wrap;font-family:monospace"></div>
        <div style="margin-top:16px;text-align:right"><button onclick="document.getElementById('releaseModal').style.display='none'" style="padding:8px 16px;border:none;background:#1a73e8;color:#fff;border-radius:6px;cursor:pointer">Close</button></div>
    </div>
</div>

<div id="updateModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:1000;justify-content:center;align-items:center">
    <div style="background:#1e1e1e;border-radius:12px;padding:24px;max-width:400px;width:90%">
        <h3 style="margin:0 0 16px;color:#fff">‚¨ÜÔ∏è Update Available</h3>
        <p id="updateText" style="color:#ccc;font-size:13px;margin-bottom:16px"></p>
        <div style="display:flex;gap:12px;justify-content:flex-end">
            <button onclick="document.getElementById('updateModal').style.display='none'" style="padding:8px 16px;border:1px solid #555;background:transparent;color:#fff;border-radius:6px;cursor:pointer">Later</button>
            <button onclick="installUpdate()" style="padding:8px 16px;border:none;background:#4CAF50;color:#fff;border-radius:6px;cursor:pointer">Install</button>
        </div>
    </div>
</div>

<div class="main">
    <!-- CHAT MODULE (iframe) -->
    <iframe class="chat-frame" src="/modules/ai-chat-module-pro/chat-pro-standalone.html"></iframe>
    
    <!-- SIDEBAR -->
    <div class="sidebar">
        <div class="proj-box">
            <div class="lbl">Current Project</div>
            <div class="name" id="projName">-</div>
            <div class="ver">v<span id="projVer">0.0.0</span></div>
            <div class="path" id="projPath">-</div>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="showTab('files')">üìÅ Files</div>
            <div class="tab" onclick="showTab('backlog')">üìã Backlog</div>
            <div class="tab" onclick="showTab('todo')">‚úÖ TODO</div>
            <div class="tab" onclick="showTab('system')">‚öôÔ∏è System</div>
        </div>
        
        <div class="tab-content active" id="tab-files">
            <div class="panel"><div class="panel-hdr" onclick="togglePanel(this)">Output Files <span class="cnt" id="filesCount">0</span></div><div class="panel-body" id="filesPanel"></div></div>
            <div class="panel"><div class="panel-hdr" onclick="togglePanel(this)">Snapshots <span class="cnt" id="snapshotsCount">0</span></div><div class="panel-body" id="snapshotsPanel"></div></div>
        </div>
        
        <div class="tab-content" id="tab-backlog">
            <div class="panel"><div class="panel-hdr" onclick="togglePanel(this)">Backlog <span class="cnt" id="backlogCount">0</span></div><div class="panel-body" id="backlogPanel"></div>
                <div class="add-row"><input type="text" id="newBacklog" placeholder="New task..."><select id="backlogPrio"><option value="medium">Med</option><option value="high">High</option><option value="low">Low</option></select><button onclick="addBacklog()">+</button></div>
            </div>
        </div>
        
        <div class="tab-content" id="tab-todo">
            <div class="panel"><div class="panel-hdr" onclick="togglePanel(this)">TODO <span class="cnt" id="todoCount">0</span></div><div class="panel-body" id="todoPanel"></div>
                <div class="add-row"><input type="text" id="newTodo" placeholder="New todo..."><button onclick="addTodo()">+</button></div>
            </div>
            <div class="panel"><div class="panel-hdr" onclick="togglePanel(this)">Bugfixes <span class="cnt" id="bugfixCount">0</span></div><div class="panel-body" id="bugfixPanel"></div>
                <div class="add-row"><input type="text" id="newBugfix" placeholder="New bugfix..."><button onclick="addBugfix()">+</button></div>
            </div>
        </div>
        
        <div class="tab-content" id="tab-system">
            <div class="panel"><div class="panel-hdr" onclick="togglePanel(this)">Constraints <span class="cnt" id="constraintsCount">0</span></div><div class="panel-body" id="constraintsPanel"></div></div>
            <div class="panel"><div class="panel-hdr" onclick="togglePanel(this)">Errors <span class="cnt" id="errorsCount">0</span></div><div class="panel-body" id="errorsPanel"></div></div>
            <div class="panel"><div class="panel-hdr" onclick="togglePanel(this)">GitHub <span class="cnt" id="githubCount">-</span></div><div class="panel-body" id="githubPanel"></div></div>
        </div>
    </div>
</div>

<script>
const API = 'http://localhost:9998';

function togglePanel(el) { el.closest('.panel')?.classList.toggle('collapsed'); }

function showTab(name) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.getElementById('tab-' + name).classList.add('active');
    event.target.classList.add('active');
}

async function loadHealth() {
    try {
        const r = await fetch(`${API}/api/health`);
        const d = await r.json();
        document.getElementById('apiDot').className = 'dot on';
        document.getElementById('apiStatus').textContent = 'Connected';
        document.getElementById('srvVersion').textContent = d.version || '-';
        document.getElementById('apiKeyStatus').textContent = d.api_key ? '‚úì' : '‚úó';
        document.getElementById('projName').textContent = d.project || '-';
        document.getElementById('projVer').textContent = d.project_version || '0.0.0';
        document.getElementById('projPath').textContent = d.project_path || '-';
        if (d.github_version && d.version && d.github_version !== d.version) {
            document.getElementById('updateBadge').style.display = 'inline';
            document.getElementById('updateBadge').textContent = '‚¨Ü v' + d.github_version;
        }
    } catch (e) {
        document.getElementById('apiDot').className = 'dot off';
        document.getElementById('apiStatus').textContent = 'Disconnected';
    }
}

async function loadOutputs() {
    try {
        const r = await fetch(`${API}/api/outputs`);
        const d = await r.json();
        const files = d.files || [];
        document.getElementById('filesCount').textContent = files.length;
        document.getElementById('filesPanel').innerHTML = files.length ? 
            files.slice(0, 10).map(f => `<div class="item"><span class="badge">${f.ext || 'file'}</span><span class="txt">${f.name}</span></div>`).join('') :
            '<div class="item empty">No files</div>';
    } catch (e) {}
}

async function loadSnapshots() {
    try {
        const r = await fetch(`${API}/api/snapshots`);
        const d = await r.json();
        const snaps = d.snapshots || [];
        document.getElementById('snapshotsCount').textContent = snaps.length;
        document.getElementById('snapshotsPanel').innerHTML = snaps.length ?
            snaps.slice(0, 5).map(s => `<div class="item"><span class="badge">v${s.version}</span><span class="txt">${s.label}</span></div>`).join('') :
            '<div class="item empty">No snapshots</div>';
    } catch (e) {}
}

async function loadBacklog() {
    try {
        const r = await fetch(`${API}/api/backlog`);
        const d = await r.json();
        const items = (d.items || d || []).filter(i => !i.done);
        document.getElementById('backlogCount').textContent = items.length;
        document.getElementById('backlogPanel').innerHTML = items.length ?
            items.map(i => `<div class="item"><span class="prio ${i.priority || 'medium'}">${(i.priority || 'med')[0].toUpperCase()}</span><span class="txt">${i.title || i.task}</span></div>`).join('') :
            '<div class="item empty">No items</div>';
    } catch (e) {}
}

async function loadTodo() {
    try {
        const r = await fetch(`${API}/api/todo`);
        const d = await r.json();
        const items = (Array.isArray(d) ? d : d.items || []).filter(i => !i.done);
        document.getElementById('todoCount').textContent = items.length;
        document.getElementById('todoPanel').innerHTML = items.length ?
            items.map(i => `<div class="item"><span class="badge">${i.id}</span><span class="txt">${i.title || i.task}</span></div>`).join('') :
            '<div class="item empty">No TODOs</div>';
    } catch (e) {}
}

async function loadBugfixes() {
    try {
        const r = await fetch(`${API}/api/bugfix/pending`);
        const d = await r.json();
        const items = d.bugfixes || [];
        document.getElementById('bugfixCount').textContent = items.length;
        document.getElementById('bugfixPanel').innerHTML = items.length ?
            items.map(i => `<div class="item"><span class="badge">${i.id}</span><span class="txt">${i.title}</span></div>`).join('') :
            '<div class="item empty">No bugfixes</div>';
    } catch (e) {}
}

async function loadConstraints() {
    try {
        const r = await fetch(`${API}/api/constraints`);
        const d = await r.json();
        const items = d.constraints || [];
        document.getElementById('constraintsCount').textContent = items.length;
        document.getElementById('constraintsPanel').innerHTML = items.length ?
            items.slice(0, 8).map(c => `<div class="item"><span class="badge">${c.id}</span><span class="txt">${c.rule}</span></div>`).join('') :
            '<div class="item empty">No constraints</div>';
    } catch (e) {}
}

async function loadErrors() {
    try {
        const r = await fetch(`${API}/api/debug/errors`);
        const d = await r.json();
        const items = d.errors || [];
        document.getElementById('errorsCount').textContent = items.length;
        document.getElementById('errorsPanel').innerHTML = items.length ?
            items.slice(0, 5).map(e => `<div class="item" style="color:var(--error)"><span class="txt">${e.message || e}</span></div>`).join('') :
            '<div class="item empty" style="color:var(--success)">No errors</div>';
    } catch (e) {}
}

async function loadGitHub() {
    try {
        const r = await fetch(`${API}/api/github/status`);
        const d = await r.json();
        document.getElementById('githubCount').textContent = d.connected ? '‚úì' : '‚úó';
        document.getElementById('githubPanel').innerHTML = `
            <div class="item"><span class="txt">Service: ${d.repos?.service || '-'}</span></div>
            <div class="item"><span class="txt">Dashboard: ${d.repos?.dashboard || '-'}</span></div>`;
    } catch (e) {}
}

async function addBacklog() {
    const input = document.getElementById('newBacklog');
    const prio = document.getElementById('backlogPrio');
    if (!input.value.trim()) return;
    await fetch(`${API}/api/backlog/add`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ title: input.value, priority: prio.value }) });
    input.value = ''; loadBacklog();
}

async function addTodo() {
    const input = document.getElementById('newTodo');
    if (!input.value.trim()) return;
    await fetch(`${API}/api/todo/add`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ title: input.value }) });
    input.value = ''; loadTodo();
}

async function addBugfix() {
    const input = document.getElementById('newBugfix');
    if (!input.value.trim()) return;
    await fetch(`${API}/api/bugfix/add`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ title: input.value }) });
    input.value = ''; loadBugfixes();
}

function showReleaseNotes() {
    document.getElementById('releaseModal').style.display = 'flex';
    document.getElementById('releaseContent').textContent = 'Loading...';
    fetch(`${API}/api/release-notes/github?version=${document.getElementById('srvVersion').textContent}`)
        .then(r => r.json())
        .then(d => { document.getElementById('releaseContent').textContent = d.notes || 'No notes available'; })
        .catch(() => { document.getElementById('releaseContent').textContent = 'Failed to load'; });
}

function showUpdatePrompt() {
    document.getElementById('updateModal').style.display = 'flex';
    document.getElementById('updateText').textContent = 'A new version is available. Install now?';
}

async function installUpdate() {
    document.getElementById('updateText').textContent = 'Installing...';
    try {
        await fetch(`${API}/api/update/install-from-github`, { method: 'POST' });
        document.getElementById('updateText').textContent = 'Installed! Restarting...';
        setTimeout(() => location.reload(), 3000);
    } catch (e) {
        document.getElementById('updateText').textContent = 'Error: ' + e.message;
    }
}

// Init
loadHealth();
loadOutputs();
loadSnapshots();
loadBacklog();
loadTodo();
loadBugfixes();
loadConstraints();
loadErrors();
loadGitHub();
setInterval(loadHealth, 10000);
setInterval(() => { loadOutputs(); loadSnapshots(); loadBugfixes(); }, 5000);
</script>
</body>
</html>
