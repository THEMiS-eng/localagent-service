<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THEMIS-QS v10.5.42</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
<script>
// Helper h() - convertit le format JSX compil√© {children: X} en React.createElement
function h(type, props) {
    if (!props) return React.createElement(type, null);
    var children = props.children;
    if (children === undefined) {
        return React.createElement(type, props);
    }
    var newProps = {};
    for (var key in props) {
        if (key !== 'children') newProps[key] = props[key];
    }
    if (Object.keys(newProps).length === 0) newProps = null;
    if (Array.isArray(children)) {
        return React.createElement.apply(null, [type, newProps].concat(children));
    }
    return React.createElement(type, newProps, children);
}
</script>

    <style>
/*!
 * THEMIS-QS v8.0 - Styles
 * (c) 2026 THEMIS-QS. All Rights Reserved.
 */

/* =============================================================================
   CSS VARIABLES (Design Tokens)
   ============================================================================= */

/* 
 * CRITICAL: NO EMOJIS ALLOWED IN UI
 * All icons must use SVG or icon fonts
 * Emojis break professional appearance and cross-platform consistency
 */

:root {
    /* Palette */
    --white: #ffffff;
    --gray-50: #f9fafb;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-300: #d1d5db;
    --gray-400: #9ca3af;
    --gray-500: #6b7280;
    --gray-600: #4b5563;
    --gray-700: #374151;
    --gray-800: #1f2937;
    --gray-900: #111827;
    --blue-50: #eff6ff;
    --blue-100: #dbeafe;
    --blue-200: #bfdbfe;
    --blue-500: #3b82f6;
    --blue-600: #2563eb;
    --blue-700: #1d4ed8;
    --blue-900: #1e3a8a;
    --green-50: #f0fdf4;
    --green-100: #dcfce7;
    --green-500: #22c55e;
    --green-600: #16a34a;
    --amber-50: #fffbeb;
    --amber-100: #fef3c7;
    --amber-500: #f59e0b;
    --amber-600: #d97706;
    --red-50: #fef2f2;
    --red-100: #fee2e2;
    --red-500: #ef4444;
    --red-600: #dc2626;
    --purple-50: #faf5ff;
    --purple-100: #f3e8ff;
    --purple-500: #8b5cf6;
    --purple-600: #7c3aed;

    /* Spacing */
    --space-2xs: 4px;
    --space-xs: 8px;
    --space-sm: 12px;
    --space-md: 16px;
    --space-lg: 20px;
    --space-xl: 24px;
    --space-2xl: 32px;

    /* Typography */
    --font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", system-ui, sans-serif;
    --font-mono: "SF Mono", Monaco, Consolas, monospace;
    --font-size-xs: 11px;
    --font-size-sm: 12px;
    --font-size-md: 13px;
    --font-size-base: 14px;
    --font-size-lg: 15px;
    --font-size-xl: 16px;

    /* Border & Radius */
    --radius-sm: 4px;
    --radius-md: 6px;
    --radius-lg: 8px;
    --radius-xl: 12px;
    --radius-2xl: 16px;
    --radius-full: 9999px;

    /* Shadows */
    --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
    --shadow-md: 0 4px 6px rgba(0,0,0,0.07);
    --shadow-lg: 0 10px 25px rgba(0,0,0,0.1);
    --shadow-input: 0 2px 8px rgba(0,0,0,0.08);

    /* Layout */
    --topbar-h: 52px;
    --pane-header-h: 56px;
    --pane-footer-h: 64px;
    --pane-side-w: 320px;
    --pane-collapsed-w: 48px;
    --chat-input-h: 48px;
    --chat-btn-size: 36px;
}

/* =============================================================================
   RESET & BASE
   ============================================================================= */

/* =============================================================================
   MODE SWITCHING (Search / Analysis)
   ============================================================================= */
body.mode-search .analysis-only { display: none !important; }
body.mode-search .search-only { display: flex; flex-direction: column; flex: 1; min-height: 0; }
body.mode-analysis .search-only { display: none !important; }
body.mode-analysis .analysis-only { display: block; }

/* Mode-specific visibility for flex containers */
body.mode-search .analysis-only-flex { display: none !important; }
body.mode-search .search-only-flex { display: flex; }
body.mode-analysis .search-only-flex { display: none !important; }
body.mode-analysis .analysis-only-flex { display: flex; }
body.mode-analysis .chat-input-wrapper { display: none !important; }

/* Search Active state - when search results are displayed */
body.mode-search.search-active .search-idle { display: none !important; }
body.mode-search.search-active .search-results-view { display: block; }
body.mode-search:not(.search-active) .search-results-view { display: none !important; }
body.mode-search:not(.search-active) .search-idle { display: block; }

/* Context toggle button styling based on body class */
body.mode-search .chat-btn.context-toggle {
    background: var(--white);
    color: var(--blue-600);
    border: 2px solid var(--blue-600);
}
body.mode-analysis .chat-btn.context-toggle {
    background: var(--blue-600);
    color: var(--white);
    border: 2px solid var(--blue-600);
}

/* =============================================================================
   FRAMEWORK SWITCHING (RICS / FAR / OTHER)
   ============================================================================= */
body.framework-rics .far-only { display: none !important; }
body.framework-far .rics-only { display: none !important; }

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: var(--font-family);
    font-size: var(--font-size-base);
    color: var(--gray-900);
    background: var(--gray-100);
    line-height: 1.5;
}

button {
    font-family: inherit;
    cursor: pointer;
}

input, textarea {
    font-family: inherit;
}

/* =============================================================================
   LAYOUT
   ============================================================================= */
.app {
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow: hidden;
}

.main {
    display: flex;
    flex: 1;
    overflow: hidden;
}

/* =============================================================================
   DARK MODE
   ============================================================================= */
body.dark-theme {
    --white: #1a1a2e;
    --gray-50: #16213e;
    --gray-100: #1a1a2e;
    --gray-200: #2d2d44;
    --gray-300: #3d3d5c;
    --gray-400: #6b7280;
    --gray-500: #9ca3af;
    --gray-600: #d1d5db;
    --gray-700: #e5e7eb;
    --gray-800: #f3f4f6;
    --gray-900: #f9fafb;
    --blue-50: #1e3a5f;
    --blue-100: #1e3a5f;
    --blue-600: #3b82f6;
    --blue-700: #60a5fa;
}

body.dark-theme .header {
    background: #1a1a2e;
    border-color: #2d2d44;
}

body.dark-theme .brand {
    color: #9ca3af;
}

body.dark-theme .brand strong {
    color: #f9fafb;
}

body.dark-theme .pane {
    background: #1a1a2e;
    border-color: #2d2d44;
}

body.dark-theme .pane-header,
body.dark-theme .pane-footer {
    background: #16213e;
    border-color: #2d2d44;
}

body.dark-theme .pane-title,
body.dark-theme .doc-name,
body.dark-theme .toolbox-item-name {
    color: #f9fafb;
}

body.dark-theme .pane-subtitle,
body.dark-theme .doc-meta,
body.dark-theme .toolbox-item-desc {
    color: #9ca3af;
}

body.dark-theme .vault-badge {
    background: #1e3a5f;
    color: #93c5fd;
}

body.dark-theme .evidence-badge {
    background: #064e3b;
    color: #6ee7b7;
}

body.dark-theme .doc-item:hover,
body.dark-theme .toolbox-item:hover {
    background: #2d2d44;
}

body.dark-theme .chat-input-wrapper {
    background: #1a1a2e;
    border-color: #2d2d44;
}

body.dark-theme .chat-input {
    background: #16213e;
    border-color: #2d2d44;
}

body.dark-theme .chat-input input {
    color: #f9fafb;
}

body.dark-theme .chat-input input::placeholder {
    color: #6b7280;
}

body.dark-theme .msg-assistant-bubble {
    background: #16213e;
    color: #f9fafb;
}

body.dark-theme .msg-user-bubble {
    background: #3b82f6;
}

body.dark-theme .modal {
    background: #1a1a2e;
    border-color: #2d2d44;
}

body.dark-theme .modal-header {
    background: #16213e;
    border-color: #2d2d44;
    color: #f9fafb;
}

body.dark-theme .modal-body {
    color: #e5e7eb;
}

body.dark-theme .settings-dropdown,
body.dark-theme .case-dropdown {
    background: #1a1a2e !important;
    border-color: #2d2d44 !important;
}

body.dark-theme .settings-item:hover,
body.dark-theme .case-item:hover {
    background: #2d2d44;
}

body.dark-theme .settings-label,
body.dark-theme .case-item-name {
    color: #f9fafb;
}

body.dark-theme .case-item-badge {
    background: #1e3a5f;
    color: #93c5fd;
}

body.dark-theme .dropdown-header {
    background: #16213e;
    border-color: #2d2d44;
    color: #9ca3af;
}

body.dark-theme .search-doc-item {
    background: #16213e;
    border-color: #2d2d44;
}

body.dark-theme .search-doc-item:hover {
    background: #2d2d44;
}

body.dark-theme .doc-name-search {
    color: #f9fafb;
}

body.dark-theme .time-tracker-clock {
    color: #f9fafb;
}

body.dark-theme .case-name {
    color: #f9fafb;
}

body.dark-theme .header-btn {
    border-color: #2d2d44;
    color: #9ca3af;
}

body.dark-theme .header-btn:hover {
    background: #2d2d44;
}

/* =============================================================================
   HEADER
   ============================================================================= */
.header {
    height: var(--topbar-h);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 var(--space-md);
    background: var(--white);
    border-bottom: 1px solid var(--gray-200);
}

.header-left {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    min-width: 200px;
}

.logo {
    width: 24px;
    height: 24px;
    background: var(--blue-600);
    border-radius: var(--radius-md);
}

.logo.disconnected {
    background: var(--gray-400);
}

.logo {
    cursor: pointer;
}

/* Brand Dropdown */
.brand-dropdown {
    width: 280px;
    bottom: auto !important;
    top: calc(100% + 8px);
    left: 0;
    right: auto;
    background: #ffffff !important;
    border: 1px solid #e5e7eb !important;
    border-radius: 12px;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1) !important;
    z-index: 9999 !important;
}

.brand-item {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm) var(--space-md);
    cursor: pointer;
    border-bottom: 1px solid var(--gray-100);
}

.brand-item:last-child {
    border-bottom: none;
}

.brand-item:hover {
    background: var(--gray-50);
}

.brand-item.selected {
    background: var(--blue-50);
}

.brand-logo {
    width: 32px;
    height: 32px;
    border-radius: var(--radius-md);
    flex-shrink: 0;
}

.themis-logo {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
}

.systech-logo {
    background: linear-gradient(135deg, #0f766e, #14b8a6);
}

.hka-logo {
    background: linear-gradient(135deg, #dc2626, #ef4444);
}

.dentons-logo {
    background: linear-gradient(135deg, #7c3aed, #8b5cf6);
}

.custom-logo {
    background: linear-gradient(135deg, #6b7280, #9ca3af);
    border: 2px dashed var(--gray-400);
}

.brand-info {
    flex: 1;
}

.brand-name {
    font-size: var(--font-size-sm);
    font-weight: 600;
    color: var(--gray-900);
}

.brand-desc {
    font-size: var(--font-size-xs);
    color: var(--gray-500);
}

/* =============================================================================
   WHITE LABEL THEMES
   ============================================================================= */

/* THEMIS Default - Inter/System font, Blue palette */
:root {
    --brand-primary: #3b82f6;
    --brand-secondary: #1d4ed8;
    --brand-accent: #60a5fa;
    --brand-gradient: linear-gradient(135deg, #3b82f6, #1d4ed8);
    --brand-font: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    --brand-font-size-adjust: 0px;
    /* Derived colors - light variants */
    --brand-bg-light: #eff6ff;
    --brand-bg-lighter: #f8fafc;
    --brand-border-light: #bfdbfe;
    --brand-text-on-brand: #ffffff;
}

/* =============================================================================
   SYSTECH THEME - Teal, Roboto font, +1px size
   ============================================================================= */
body.brand-systech {
    --brand-primary: #0f766e;
    --brand-secondary: #0d9488;
    --brand-accent: #14b8a6;
    --brand-gradient: linear-gradient(135deg, #0f766e, #14b8a6);
    --brand-font: 'Roboto', 'Arial', sans-serif;
    --brand-font-size-adjust: 1px;
    --brand-bg-light: #f0fdfa;
    --brand-bg-lighter: #f0fdfa;
    --brand-border-light: #99f6e4;
    --brand-text-on-brand: #ffffff;
    font-family: var(--brand-font);
}

body.brand-systech .app {
    font-size: calc(var(--font-size-base) + var(--brand-font-size-adjust));
}

body.brand-systech .logo {
    background: var(--brand-gradient);
}

body.brand-systech .brand {
    font-family: var(--brand-font);
    font-weight: 700;
    letter-spacing: 1px;
}

body.brand-systech .header {
    border-bottom: none;
}

body.brand-systech .pane-header {
    background: linear-gradient(180deg, var(--brand-bg-light), var(--white));
    border-bottom: 1px solid var(--brand-border-light);
}

body.brand-systech .pane-title {
    color: var(--brand-primary);
    font-weight: 700;
}

body.brand-systech .btn-primary {
    background: var(--brand-gradient);
}

body.brand-systech .btn-primary:hover {
    background: linear-gradient(135deg, #0d9488, #0f766e);
}

body.brand-systech .chat-btn.context-toggle.search,
body.brand-systech .chat-btn.context-toggle.analysis {
    background: var(--brand-primary);
}

body.brand-systech .case-badge {
    background: #ccfbf1;
    color: var(--brand-primary);
    font-weight: 700;
}

body.brand-systech .msg-user-bubble {
    background: var(--brand-gradient);
}

body.brand-systech .avatar-btn {
    background: var(--brand-gradient);
}

body.brand-systech .modal-header {
    background: linear-gradient(180deg, #f0fdfa, #ffffff);
    border-bottom: 2px solid var(--brand-primary);
}

body.brand-systech .modal-title {
    color: var(--brand-primary);
}

body.brand-systech .dropdown-header {
    background: #f0fdfa;
    color: var(--brand-primary);
    font-weight: 700;
}

/* Systech File Icons - Teal monochrome gradient */
body.brand-systech .file-icon,
body.brand-systech .doc-icon {
    background: var(--brand-gradient) !important;
    color: white !important;
}

body.brand-systech .file-icon.pdf { background: linear-gradient(135deg, #0f766e, #0d9488) !important; }
body.brand-systech .file-icon.docx { background: linear-gradient(135deg, #14b8a6, #2dd4bf) !important; }
body.brand-systech .file-icon.xlsx { background: linear-gradient(135deg, #0d9488, #14b8a6) !important; }
body.brand-systech .file-icon.mpp { background: linear-gradient(135deg, #5eead4, #99f6e4) !important; color: #0f766e !important; }

body.brand-systech .va-badge {
    background: var(--brand-gradient) !important;
}

body.brand-systech .toolbox-item-icon {
    background: var(--brand-gradient) !important;
}

body.brand-systech .selection-banner {
    background: linear-gradient(90deg, #f0fdfa, #ccfbf1);
    border-left: 4px solid var(--brand-primary);
}

body.brand-systech .citations {
    border-left: 3px solid var(--brand-primary);
}

body.brand-systech .citation-source {
    color: var(--brand-primary);
}

/* Systech C-pane background - subtle teal gradient texture */
body.brand-systech .pane-center {
    background: linear-gradient(180deg, #f0fdfa 0%, #ffffff 50%, #f0fdfa 100%);
}

body.brand-systech .pane-center .pane-content {
    background: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 50px,
        rgba(15, 118, 110, 0.02) 50px,
        rgba(15, 118, 110, 0.02) 100px
    );
}

body.brand-systech .chat-messages {
    background: transparent;
}

body.brand-systech #search-results {
    background: linear-gradient(135deg, rgba(240, 253, 250, 0.5), rgba(204, 251, 241, 0.3));
}

/* =============================================================================
   HKA THEME - Red, Helvetica font, base size
   ============================================================================= */
body.brand-hka {
    --brand-primary: #dc2626;
    --brand-secondary: #b91c1c;
    --brand-accent: #ef4444;
    --brand-gradient: linear-gradient(135deg, #dc2626, #991b1b);
    --brand-font: 'Helvetica Neue', 'Helvetica', 'Arial', sans-serif;
    --brand-bg-light: #fef2f2;
    --brand-bg-lighter: #fef2f2;
    --brand-border-light: #fecaca;
    --brand-text-on-brand: #ffffff;
    font-family: var(--brand-font);
}

body.brand-hka .logo {
    background: var(--brand-gradient);
}

body.brand-hka .brand {
    font-family: var(--brand-font);
    font-weight: 700;
    letter-spacing: 3px;
    text-transform: uppercase;
}

body.brand-hka .header {
    border-bottom: none;
}

body.brand-hka .pane-header {
    background: linear-gradient(180deg, var(--brand-bg-light), var(--white));
    border-bottom: 1px solid var(--brand-border-light);
}

body.brand-hka .pane-title {
    color: var(--brand-primary);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
}

body.brand-hka .btn-primary {
    background: var(--brand-gradient);
}

body.brand-hka .btn-primary:hover {
    background: linear-gradient(135deg, var(--brand-secondary), #7f1d1d);
}

body.brand-hka .case-badge {
    background: var(--brand-bg-light);
    color: var(--brand-primary);
    font-weight: 700;
    text-transform: uppercase;
}

body.brand-hka .msg-user-bubble {
    background: var(--brand-gradient);
}

body.brand-hka .avatar-btn {
    background: var(--brand-gradient);
}

body.brand-hka .modal-header {
    background: linear-gradient(180deg, #fef2f2, #ffffff);
    border-bottom: 3px solid var(--brand-primary);
}

body.brand-hka .modal-title {
    color: var(--brand-primary);
    text-transform: uppercase;
    letter-spacing: 1px;
}

body.brand-hka .dropdown-header {
    background: #fef2f2;
    color: var(--brand-primary);
    font-weight: 700;
    text-transform: uppercase;
}

/* HKA File Icons - Red monochrome gradient */
body.brand-hka .file-icon,
body.brand-hka .doc-icon {
    background: var(--brand-gradient) !important;
    color: white !important;
}

body.brand-hka .file-icon.pdf { background: linear-gradient(135deg, #991b1b, #dc2626) !important; }
body.brand-hka .file-icon.docx { background: linear-gradient(135deg, #dc2626, #ef4444) !important; }
body.brand-hka .file-icon.xlsx { background: linear-gradient(135deg, #b91c1c, #dc2626) !important; }
body.brand-hka .file-icon.mpp { background: linear-gradient(135deg, #fca5a5, #fecaca) !important; color: #991b1b !important; }

body.brand-hka .va-badge {
    background: var(--brand-gradient) !important;
}

body.brand-hka .toolbox-item-icon {
    background: var(--brand-gradient) !important;
}

body.brand-hka .selection-banner {
    background: linear-gradient(90deg, #fef2f2, #fee2e2);
    border-left: 4px solid var(--brand-primary);
}

body.brand-hka .citations {
    border-left: 3px solid var(--brand-primary);
}

body.brand-hka .citation-source {
    color: var(--brand-primary);
}

/* HKA C-pane background - warm red-tinted gradient */
body.brand-hka .pane-center {
    background: linear-gradient(180deg, #fef2f2 0%, #ffffff 50%, #fef2f2 100%);
}

body.brand-hka .pane-center .pane-content {
    background: repeating-linear-gradient(
        45deg,
        transparent,
        transparent 100px,
        rgba(220, 38, 38, 0.015) 100px,
        rgba(220, 38, 38, 0.015) 200px
    );
}

body.brand-hka .chat-messages {
    background: transparent;
}

body.brand-hka #search-results {
    background: linear-gradient(135deg, rgba(254, 242, 242, 0.5), rgba(254, 226, 226, 0.3));
}

/* =============================================================================
   DENTONS THEME - Purple, Georgia/Serif font, -1px size
   ============================================================================= */
body.brand-dentons {
    --brand-primary: #7c3aed;
    --brand-secondary: #6d28d9;
    --brand-accent: #8b5cf6;
    --brand-gradient: linear-gradient(135deg, #7c3aed, #5b21b6);
    --brand-font: 'Georgia', 'Times New Roman', serif;
    --brand-font-size-adjust: -1px;
    --brand-bg-light: #f5f3ff;
    --brand-bg-lighter: #f5f3ff;
    --brand-border-light: #ddd6fe;
    --brand-text-on-brand: #ffffff;
    font-family: var(--brand-font);
}

body.brand-dentons .app {
    font-size: calc(var(--font-size-base) + var(--brand-font-size-adjust));
}

body.brand-dentons .logo {
    background: var(--brand-gradient);
}

body.brand-dentons .brand {
    font-family: var(--brand-font);
    font-weight: 400;
    font-style: italic;
    letter-spacing: 0px;
}

body.brand-dentons .header {
    border-bottom: none;
}

body.brand-dentons .pane-header {
    background: linear-gradient(180deg, var(--brand-bg-light), var(--white));
    border-bottom: 1px solid var(--brand-border-light);
}

body.brand-dentons .pane-title {
    color: var(--brand-primary);
    font-weight: 600;
    font-family: var(--brand-font);
}

body.brand-dentons .btn-primary {
    background: var(--brand-gradient);
}

body.brand-dentons .btn-primary:hover {
    background: linear-gradient(135deg, var(--brand-secondary), #4c1d95);
}

body.brand-dentons .case-badge {
    background: var(--brand-bg-light);
    color: var(--brand-primary);
    font-weight: 600;
    font-style: italic;
}

body.brand-dentons .msg-user-bubble {
    background: var(--brand-gradient);
}

body.brand-dentons .avatar-btn {
    background: var(--brand-gradient);
}

body.brand-dentons .modal-header {
    background: linear-gradient(180deg, #f5f3ff, #ffffff);
    border-bottom: 2px solid var(--brand-primary);
}

body.brand-dentons .modal-title {
    color: var(--brand-primary);
    font-family: 'Georgia', serif;
}

body.brand-dentons .dropdown-header {
    background: #f5f3ff;
    color: var(--brand-primary);
    font-weight: 600;
    font-family: 'Georgia', serif;
}

/* Dentons File Icons - Purple monochrome gradient */
body.brand-dentons .file-icon,
body.brand-dentons .doc-icon {
    background: var(--brand-gradient) !important;
    color: white !important;
}

body.brand-dentons .file-icon.pdf { background: linear-gradient(135deg, #5b21b6, #7c3aed) !important; }
body.brand-dentons .file-icon.docx { background: linear-gradient(135deg, #7c3aed, #8b5cf6) !important; }
body.brand-dentons .file-icon.xlsx { background: linear-gradient(135deg, #6d28d9, #7c3aed) !important; }
body.brand-dentons .file-icon.mpp { background: linear-gradient(135deg, #c4b5fd, #ddd6fe) !important; color: #5b21b6 !important; }

body.brand-dentons .va-badge {
    background: var(--brand-gradient) !important;
}

body.brand-dentons .toolbox-item-icon {
    background: var(--brand-gradient) !important;
}

body.brand-dentons .selection-banner {
    background: linear-gradient(90deg, #f5f3ff, #ede9fe);
    border-left: 4px solid var(--brand-primary);
}

body.brand-dentons .citations {
    border-left: 3px solid var(--brand-primary);
}

body.brand-dentons .citation-source {
    color: var(--brand-primary);
}

/* Dentons C-pane background - elegant purple-tinted with subtle pattern */
body.brand-dentons .pane-center {
    background: linear-gradient(180deg, #f5f3ff 0%, #faf9ff 50%, #f5f3ff 100%);
}

body.brand-dentons .pane-center .pane-content {
    background: 
        radial-gradient(ellipse at 20% 30%, rgba(124, 58, 237, 0.03) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 70%, rgba(139, 92, 246, 0.03) 0%, transparent 50%);
}

body.brand-dentons .chat-messages {
    background: transparent;
}

body.brand-dentons #search-results {
    background: linear-gradient(135deg, rgba(245, 243, 255, 0.5), rgba(237, 233, 254, 0.3));
}

/* =============================================================================
   CUSTOM THEME - Gray, Monospace font
   ============================================================================= */
body.brand-custom {
    --brand-primary: #6b7280;
    --brand-secondary: #4b5563;
    --brand-accent: #9ca3af;
    --brand-gradient: linear-gradient(135deg, #6b7280, #374151);
    --brand-font: 'SF Mono', 'Monaco', 'Consolas', monospace;
    --brand-font-size-adjust: 0px;
    --brand-bg-light: #f9fafb;
    --brand-bg-lighter: #f9fafb;
    --brand-border-light: #d1d5db;
    --brand-text-on-brand: #ffffff;
    font-family: var(--brand-font);
}

body.brand-custom .logo {
    background: var(--brand-gradient);
}

body.brand-custom .brand {
    font-family: var(--brand-font);
    font-weight: 500;
    letter-spacing: 0px;
}

body.brand-custom .header {
    border-bottom: 2px dashed var(--brand-primary);
}

body.brand-custom .pane-header {
    background: linear-gradient(180deg, var(--brand-bg-light), var(--white));
    border-bottom: 1px dashed var(--brand-border-light);
}

body.brand-custom .pane-title {
    color: var(--brand-primary);
    font-family: var(--brand-font);
}

body.brand-custom .btn-primary {
    background: var(--brand-gradient);
}

body.brand-custom .case-badge {
    background: var(--brand-bg-light);
    color: var(--brand-primary);
    font-family: var(--brand-font);
}

body.brand-custom .msg-user-bubble {
    background: var(--brand-gradient);
}

body.brand-custom .avatar-btn {
    background: var(--brand-gradient);
}

body.brand-custom .modal-header {
    background: #f9fafb;
    border-bottom: 2px dashed var(--brand-primary);
}

body.brand-custom .dropdown-header {
    background: #f9fafb;
    font-family: 'SF Mono', monospace;
}

/* Custom File Icons - Gray monochrome */
body.brand-custom .file-icon,
body.brand-custom .doc-icon {
    background: var(--brand-gradient) !important;
    color: white !important;
}

body.brand-custom .va-badge {
    background: var(--brand-gradient) !important;
}

body.brand-custom .toolbox-item-icon {
    background: var(--brand-gradient) !important;
}

body.brand-custom .selection-banner {
    background: #f9fafb;
    border-left: 4px dashed var(--brand-primary);
}

/* Custom C-pane background - technical grid pattern */
body.brand-custom .pane-center {
    background: #fafafa;
}

body.brand-custom .pane-center .pane-content {
    background: 
        linear-gradient(90deg, rgba(107, 114, 128, 0.03) 1px, transparent 1px),
        linear-gradient(rgba(107, 114, 128, 0.03) 1px, transparent 1px);
    background-size: 20px 20px;
}

body.brand-custom .chat-messages {
    background: transparent;
}

body.brand-custom #search-results {
    background: rgba(249, 250, 251, 0.8);
}

/* =============================================================================
   DARK MODE + BRAND COMBINATIONS
   ============================================================================= */
body.dark-theme .brand-dropdown {
    background: #1a1a2e !important;
    border-color: #2d2d44 !important;
}

body.dark-theme .brand-item:hover {
    background: #2d2d44;
}

body.dark-theme .brand-name {
    color: #f9fafb;
}

body.dark-theme .brand-desc {
    color: #9ca3af;
}

body.dark-theme.brand-systech .pane-header {
    background: linear-gradient(180deg, #042f2e, #1a1a2e);
}

body.dark-theme.brand-systech .dropdown-header {
    background: #042f2e;
}

body.dark-theme.brand-hka .pane-header {
    background: linear-gradient(180deg, #450a0a, #1a1a2e);
}

body.dark-theme.brand-hka .dropdown-header {
    background: #450a0a;
}

body.dark-theme.brand-dentons .pane-header {
    background: linear-gradient(180deg, #2e1065, #1a1a2e);
}

body.dark-theme.brand-dentons .dropdown-header {
    background: #2e1065;
}

/* Dark mode C-pane backgrounds */
body.dark-theme.brand-systech .pane-center {
    background: linear-gradient(180deg, #042f2e 0%, #1a1a2e 50%, #042f2e 100%);
}

body.dark-theme.brand-systech .pane-center .pane-content {
    background: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 50px,
        rgba(20, 184, 166, 0.03) 50px,
        rgba(20, 184, 166, 0.03) 100px
    );
}

body.dark-theme.brand-hka .pane-center {
    background: linear-gradient(180deg, #450a0a 0%, #1a1a2e 50%, #450a0a 100%);
}

body.dark-theme.brand-hka .pane-center .pane-content {
    background: repeating-linear-gradient(
        45deg,
        transparent,
        transparent 100px,
        rgba(239, 68, 68, 0.03) 100px,
        rgba(239, 68, 68, 0.03) 200px
    );
}

body.dark-theme.brand-dentons .pane-center {
    background: linear-gradient(180deg, #2e1065 0%, #1a1a2e 50%, #2e1065 100%);
}

body.dark-theme.brand-dentons .pane-center .pane-content {
    background: 
        radial-gradient(ellipse at 20% 30%, rgba(139, 92, 246, 0.05) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 70%, rgba(167, 139, 250, 0.05) 0%, transparent 50%);
}

body.dark-theme.brand-custom .pane-center {
    background: #111111;
}

body.dark-theme.brand-custom .pane-center .pane-content {
    background: 
        linear-gradient(90deg, rgba(156, 163, 175, 0.05) 1px, transparent 1px),
        linear-gradient(rgba(156, 163, 175, 0.05) 1px, transparent 1px);
    background-size: 20px 20px;
}

/* =============================================================================
   LANDING PAGE - CASE SELECTION
   ============================================================================= */
.landing-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(180deg, #f8fafc 0%, #e2e8f0 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 20000;
    transition: opacity 0.3s ease;
}

.landing-overlay.hidden {
    opacity: 0;
    pointer-events: none;
}

.landing-modal {
    width: 100%;
    max-width: 540px;
    max-height: 85vh;
    background: var(--white);
    border-radius: 16px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.landing-header {
    padding: 28px 32px 20px;
    text-align: center;
    border-bottom: 1px solid var(--gray-100);
}

.landing-title {
    font-size: 22px;
    font-weight: 700;
    color: var(--blue-600);
    letter-spacing: 2px;
    margin: 0 0 4px;
}

.landing-subtitle {
    font-size: 13px;
    color: var(--gray-500);
    margin: 0 0 12px;
}

.landing-version {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 4px 12px;
    background: var(--gray-100);
    border-radius: var(--radius-full);
    font-size: 12px;
    color: var(--gray-600);
    cursor: pointer;
    transition: all 0.2s ease;
}

.landing-version:hover {
    background: var(--blue-100);
    color: var(--blue-700);
}

.landing-version-badge {
    padding: 2px 6px;
    background: var(--blue-600);
    color: var(--white);
    border-radius: var(--radius-sm);
    font-size: 10px;
    font-weight: 700;
}

.landing-search {
    padding: 0 32px 20px;
}

.landing-search-input-wrapper {
    position: relative;
    display: flex;
    align-items: center;
}

.landing-search-icon {
    position: absolute;
    left: 16px;
    color: var(--gray-400);
    font-size: 16px;
    pointer-events: none;
}

.landing-search-input {
    width: 100%;
    padding: 14px 80px 14px 44px;
    background: var(--gray-50);
    border: 2px solid var(--gray-200);
    border-radius: 12px;
    font-size: 15px;
    color: var(--gray-900);
    transition: all 0.2s ease;
}

.landing-search-input:focus {
    outline: none;
    border-color: var(--blue-400);
    background: var(--white);
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
}

.landing-search-input::placeholder {
    color: var(--gray-400);
}

.landing-search-shortcut {
    position: absolute;
    right: 12px;
    padding: 4px 8px;
    background: var(--gray-200);
    border-radius: 6px;
    font-size: 12px;
    font-weight: 500;
    color: var(--gray-500);
}

.landing-search-results {
    margin-top: 8px;
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid var(--gray-200);
    border-radius: 12px;
    background: var(--white);
    display: none;
}

.landing-search-results.show {
    display: block;
}

.landing-search-result-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    cursor: pointer;
    transition: background 0.15s ease;
}

.landing-search-result-item:hover {
    background: var(--blue-50);
}

.landing-search-result-item:not(:last-child) {
    border-bottom: 1px solid var(--gray-100);
}

.landing-search-highlight {
    background: var(--yellow-200);
    padding: 0 2px;
    border-radius: 2px;
}

.landing-no-results {
    padding: 16px;
    text-align: center;
    color: var(--gray-500);
    font-size: 14px;
}

/* Dark mode search */
body.dark-theme .landing-search-input {
    background: #0f172a;
    border-color: #2d2d44;
    color: var(--gray-100);
}

body.dark-theme .landing-search-input:focus {
    border-color: var(--blue-500);
    background: #1a1a2e;
}

body.dark-theme .landing-search-shortcut {
    background: #2d2d44;
    color: var(--gray-400);
}

body.dark-theme .landing-search-results {
    background: #1a1a2e;
    border-color: #2d2d44;
}

body.dark-theme .landing-search-result-item:hover {
    background: #1e3a5f;
}

body.dark-theme .landing-search-result-item:not(:last-child) {
    border-color: #2d2d44;
}

.landing-section {
    padding: 0 40px;
    flex: 1;
    overflow-y: auto;
}

.landing-section-title {
    font-size: 11px;
    font-weight: 600;
    color: var(--gray-400);
    letter-spacing: 1px;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--gray-100);
}

.landing-cases {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 24px;
}

.landing-case-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 14px;
    background: var(--gray-50);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-lg);
    cursor: pointer;
    transition: all 0.2s ease;
}

.landing-case-item:hover {
    background: var(--blue-50);
    border-color: var(--blue-200);
}

.landing-case-icon {
    width: 32px;
    height: 32px;
    background: var(--blue-100);
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--blue-600);
    font-size: 14px;
    flex-shrink: 0;
}

.landing-case-info {
    flex: 1;
    min-width: 0;
}

.landing-case-name {
    font-size: 14px;
    font-weight: 600;
    color: var(--gray-900);
    margin-bottom: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.landing-case-meta {
    font-size: 13px;
    color: var(--gray-500);
}

.landing-case-meta .warning {
    color: var(--amber-600);
}

.landing-case-arrow {
    color: var(--gray-400);
    font-size: 14px;
}

.landing-case-badge {
    padding: 3px 10px;
    background: var(--blue-100);
    color: var(--blue-700);
    font-size: 11px;
    font-weight: 700;
    border-radius: var(--radius-sm);
    letter-spacing: 0.5px;
    margin-left: auto;
    margin-right: var(--space-sm);
}

.case-item-empty {
    padding: var(--space-md);
    text-align: center;
    color: var(--gray-400);
    font-size: var(--font-size-sm);
}

/* Dark mode landing badge */
body.dark-theme .landing-case-badge {
    background: #1e3a5f;
    color: #93c5fd;
}

body.dark-theme .dropdown-search-input {
    background: #0f172a;
    border-color: #2d2d44;
    color: #f9fafb;
}

.landing-actions {
    padding: 24px 40px 40px;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.landing-action-card {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 14px 16px;
    background: var(--white);
    border: 1px dashed var(--gray-300);
    border-radius: var(--radius-lg);
    cursor: pointer;
    transition: all 0.2s ease;
}

.landing-action-card:hover {
    border-color: var(--blue-300);
    background: var(--blue-50);
}

.landing-action-icon {
    width: 40px;
    height: 40px;
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    font-weight: 400;
    flex-shrink: 0;
}

.landing-action-icon.create {
    background: var(--blue-100);
    border: 1px solid var(--blue-200);
    color: var(--blue-600);
}

.landing-action-icon.browse {
    background: var(--gray-100);
    border: 1px solid var(--gray-200);
    color: var(--gray-500);
}

.landing-action-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--gray-900);;
    margin-bottom: 4px;
}

.landing-action-desc {
    font-size: 14px;
    color: var(--gray-500);
}

/* Dark mode landing */
body.dark-theme .landing-overlay {
    background: linear-gradient(180deg, #0f172a 0%, #1e293b 100%);
}

body.dark-theme .landing-modal {
    background: #1a1a2e;
}

body.dark-theme .landing-title {
    color: var(--blue-400);
}

body.dark-theme .landing-subtitle {
    color: var(--gray-400);
}

body.dark-theme .landing-section-title {
    color: var(--gray-500);
    border-color: #2d2d44;
}

body.dark-theme .landing-case-item {
    background: #0f172a;
    border-color: #2d2d44;
}

body.dark-theme .landing-case-item:hover {
    background: #1e3a5f;
    border-color: var(--blue-700);
}

body.dark-theme .landing-case-icon {
    background: #1e3a5f;
    color: var(--blue-400);
}

body.dark-theme .landing-case-name {
    color: var(--gray-100);
}

body.dark-theme .landing-action-card {
    background: #0f172a;
    border-color: #2d2d44;
}

body.dark-theme .landing-action-card:hover {
    background: #1e3a5f;
    border-color: var(--blue-600);
}

body.dark-theme .landing-action-title {
    color: var(--gray-100);
}

/* =============================================================================
   PAGE-WIDE PROGRESS BAR
   ============================================================================= */
.page-progress {
    position: fixed;
    top: calc(var(--topbar-h) - 2px);
    left: 0;
    right: 0;
    height: 2px;
    background: transparent;
    z-index: 999999;
    pointer-events: none;
    overflow: hidden;
    display: none;
}

.page-progress.active {
    display: block;
}

.page-progress-bar {
    position: absolute;
    top: 0;
    height: 100%;
    width: 30%;
    background: #2563eb;
    animation: progress-slide 1s ease-in-out infinite;
}

@keyframes progress-slide {
    0% { left: -30%; }
    100% { left: 100%; }
}

/* =============================================================================
   NOTIFICATION BANNER (Top Bar)
   ============================================================================= */
.notification-banner {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 44px;
    display: none;
    align-items: center;
    gap: var(--space-sm);
    padding: 0 var(--space-md);
    background: var(--blue-50);
    border-bottom: 1px solid var(--blue-200);
    color: var(--blue-700);
    font-size: var(--font-size-sm);
    z-index: 99999;
    transition: transform 0.3s ease;
}

.notification-banner.show {
    display: flex;
}

.notification-banner.alert {
    background: #fee2e2;
    border-color: #fecaca;
    color: #991b1b;
}

.notification-banner.warning {
    background: #fef3c7;
    border-color: #fde68a;
    color: #92400e;
}

.notification-banner.success {
    background: #d1fae5;
    border-color: #a7f3d0;
    color: #065f46;
}

.notification-banner.loading {
    background: var(--blue-50);
    border-color: var(--blue-200);
    color: var(--blue-700);
}

/* ***************************************************************
   CONTEXT MENU (Right-click menu)
   *************************************************************** */
.context-menu {
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    min-width: 200px;
    background: var(--white);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    padding: var(--space-xs) 0;
    z-index: 99999;
}

.context-menu.hidden {
    display: none;
}

.context-menu-item {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm) var(--space-md);
    font-size: var(--font-size-sm);
    color: var(--gray-700);
    cursor: pointer;
    transition: background 0.1s;
}

.context-menu-item:hover {
    background: var(--gray-50);
}

.context-menu-icon {
    width: 20px;
    text-align: center;
}

.context-menu-divider {
    height: 1px;
    background: var(--gray-200);
    margin: var(--space-xs) 0;
}

.banner-icon {
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--blue-500);
    border-radius: var(--radius-full);
    color: var(--white);
    font-size: 11px;
    font-weight: 700;
    flex-shrink: 0;
}

.notification-banner.alert .banner-icon {
    background: #dc2626;
}

.notification-banner.warning .banner-icon {
    background: #d97706;
}

.notification-banner.success .banner-icon {
    background: #059669;
}

.banner-text {
    flex: 1;
    font-weight: 500;
}

.banner-dismiss {
    background: none;
    border: none;
    color: inherit;
    opacity: 0.6;
    cursor: pointer;
    font-size: var(--font-size-base);
    padding: 4px;
}

.banner-dismiss:hover {
    opacity: 1;
}

.banner-action {
    background: var(--blue-600);
    color: white;
    border: none;
    border-radius: 4px;
    padding: 6px 12px;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    margin-left: auto;
    margin-right: 12px;
}

.banner-action:hover {
    background: var(--blue-700);
}

.notification-banner.warning .banner-action {
    background: #d97706;
}

.notification-banner.warning .banner-action:hover {
    background: #b45309;
}

/* Dark mode banner */
body.dark-theme .notification-banner {
    background: #1e3a5f;
    border-color: #2d4a6f;
    color: #93c5fd;
}

body.dark-theme .notification-banner.alert {
    background: #450a0a;
    border-color: #7f1d1d;
    color: #fecaca;
}

body.dark-theme .notification-banner.warning {
    background: #451a03;
    border-color: #78350f;
    color: #fde68a;
}

body.dark-theme .notification-banner.success {
    background: #022c22;
    border-color: #064e3b;
    color: #a7f3d0;
}

/* =============================================================================
   NOTIFICATION CENTER (Upper Right Corner)
   ============================================================================= */
.notification-center {
    position: fixed;
    top: 60px;
    right: 16px;
    width: 320px;
    max-height: calc(100vh - 80px);
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
    z-index: 10000;
    pointer-events: none;
}

.notification-item {
    display: flex;
    align-items: flex-start;
    gap: var(--space-sm);
    padding: var(--space-sm) var(--space-md);
    background: var(--white);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    font-size: var(--font-size-sm);
    opacity: 0;
    transform: translateX(100%);
    transition: all 0.3s ease;
    pointer-events: auto;
}

.notification-item.show {
    opacity: 1;
    transform: translateX(0);
}

.notification-icon {
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-full);
    font-size: 11px;
    font-weight: 700;
    color: var(--white);
    flex-shrink: 0;
}

.notification-success .notification-icon {
    background: var(--green-500);
}

.notification-info .notification-icon {
    background: var(--blue-500);
}

.notification-warning .notification-icon {
    background: var(--amber-500);
}

.notification-error .notification-icon {
    background: var(--red-500);
}

.notification-text {
    flex: 1;
    color: var(--gray-700);
    line-height: 1.4;
}

.notification-close {
    background: none;
    border: none;
    color: var(--gray-400);
    cursor: pointer;
    font-size: var(--font-size-xs);
    padding: 2px;
    line-height: 1;
}

.notification-close:hover {
    color: var(--gray-600);
}

/* Dark mode notifications */
body.dark-theme .notification-item {
    background: #1a1a2e;
    border-color: #2d2d44;
}

body.dark-theme .notification-text {
    color: #e5e7eb;
}

body.dark-theme .notification-close {
    color: #6b7280;
}

/* Toolbox Description Tooltip (Overlay) */
.toolbox-tooltip {
    position: fixed;
    top: 120px;
    right: 280px;
    width: 260px;
    padding: var(--space-md);
    background: var(--gray-900);
    color: var(--white);
    border-radius: var(--radius-lg);
    font-size: var(--font-size-sm);
    line-height: 1.5;
    text-align: center;
    box-shadow: var(--shadow-lg);
    opacity: 0;
    transform: translateX(10px);
    transition: all 0.3s ease;
    z-index: 10000;
    pointer-events: none;
}

.toolbox-tooltip::after {
    content: '';
    position: absolute;
    top: 50%;
    right: -8px;
    transform: translateY(-50%);
    border: 8px solid transparent;
    border-left-color: var(--gray-900);
    border-right: none;
}

.toolbox-tooltip.show {
    opacity: 1;
    transform: translateX(0);
}

.toolbox-tooltip.fade-out {
    opacity: 0;
    transform: translateX(10px);
}

/* =============================================================================
   CONTEXT MENU
   ============================================================================= */
/* Case Context Menu uses the first .context-menu definition above */

/* Dark mode context menu */
body.dark-theme .context-menu {
    background: #1a1a2e;
    border-color: #2d2d44;
}

body.dark-theme .context-menu-header {
    color: #9ca3af;
    border-color: #2d2d44;
}

body.dark-theme .context-menu-item {
    color: #e5e7eb;
}

body.dark-theme .context-menu-item:hover {
    background: #2d2d44;
}

body.dark-theme .context-menu-divider {
    background: #2d2d44;
}

/* =============================================================================
   CREATE CASE MODAL
   ============================================================================= */
.modal-lg {
    max-width: 540px;
}

.modal-header-centered {
    flex-direction: column;
    align-items: center;
    text-align: center;
    padding: 28px 32px 20px;
    border-bottom: 1px solid var(--gray-100);
}

.modal-title-lg {
    font-size: 22px;
    font-weight: 700;
    color: var(--blue-600);
    letter-spacing: 2px;
    margin-bottom: 4px;
}

.modal-subtitle {
    font-size: 13px;
    color: var(--gray-500);
}

.modal-footer-centered {
    justify-content: center;
    gap: 12px;
    padding: 20px 32px;
}

.modal-copyright {
    padding: 12px 24px;
    text-align: center;
    font-size: 10px;
    color: var(--gray-400);
    letter-spacing: 1.5px;
    border-top: 1px solid var(--gray-100);
}

body.dark-theme .modal-copyright {
    color: #6b7280;
    border-color: #2d2d44;
}

.form-section {
    margin-bottom: 24px;
}

.form-label {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: var(--gray-900);
    margin-bottom: 8px;
}

.form-hint {
    font-weight: 400;
    color: var(--gray-400);
}

.form-input {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid var(--gray-200);
    border-radius: 10px;
    font-size: 15px;
    color: var(--gray-900);
    transition: all 0.2s ease;
}

.form-input:focus {
    outline: none;
    border-color: var(--blue-400);
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
}

.form-textarea {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid var(--gray-200);
    border-radius: 10px;
    font-size: 14px;
    font-family: 'SF Mono', Monaco, monospace;
    color: var(--gray-700);
    resize: vertical;
    min-height: 100px;
}

.form-textarea:focus {
    outline: none;
    border-color: var(--blue-400);
}

.form-select {
    padding: 10px 12px;
    border: 2px solid var(--gray-200);
    border-radius: 8px;
    font-size: 14px;
    color: var(--gray-700);
    background: var(--white);
    cursor: pointer;
}

.form-preview {
    margin-top: 8px;
    padding: 10px 14px;
    background: var(--gray-50);
    border-radius: 8px;
    font-size: 13px;
    color: var(--gray-500);
}

.preview-value {
    color: var(--blue-600);
    font-weight: 600;
}

/* Case ID Builder */
.case-id-builder {
    display: flex;
    gap: 8px;
}

.case-id-prefix {
    flex: 1;
    text-align: center;
    font-size: 18px;
    font-weight: 600;
}

.case-id-sep {
    width: 60px;
    text-align: center;
}

.case-id-num {
    width: 90px;
}

/* Evidence Prefix Builder */
.evidence-prefix-builder {
    display: flex;
    gap: 8px;
}

.evidence-prefix-input {
    flex: 1;
}

.separator-row {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-top: 12px;
}

.separator-label {
    font-size: 13px;
    color: var(--gray-600);
    font-weight: 500;
}

.separator-options {
    display: flex;
    gap: 4px;
}

.separator-btn {
    width: 36px;
    height: 36px;
    border: 2px solid var(--gray-200);
    border-radius: 8px;
    background: var(--white);
    font-size: 16px;
    font-weight: 600;
    color: var(--gray-600);
    cursor: pointer;
    transition: all 0.15s ease;
}

.separator-btn:hover {
    border-color: var(--blue-300);
}

.separator-btn.active {
    background: var(--blue-600);
    border-color: var(--blue-600);
    color: var(--white);
}

.digits-select {
    width: 80px;
}

/* v8.0 Compact Wizard - No Scroll */
.modal-wizard-compact {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 520px;
    max-width: 95vw;
    background: var(--white);
    border-radius: 16px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    overflow: hidden;
}

/* Compact Header */
.wizard-compact-header {
    display: flex;
    align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid var(--gray-200);
    background: var(--gray-50);
}

.wizard-compact-title {
    font-size: 15px;
    font-weight: 600;
    color: var(--gray-900);
    margin-right: 16px;
}

.wizard-compact-steps {
    display: flex;
    align-items: center;
    gap: 6px;
    flex: 1;
}

.wcs {
    font-size: 11px;
    color: var(--gray-400);
    font-weight: 500;
}

.wcs.active {
    color: var(--blue-600);
    font-weight: 600;
}

.wcs.done {
    color: var(--green-600);
}

.wcs-dot {
    width: 3px;
    height: 3px;
    background: var(--gray-300);
    border-radius: 50%;
}

.wizard-close-btn {
    width: 28px;
    height: 28px;
    border: none;
    background: transparent;
    color: var(--gray-400);
    font-size: 18px;
    cursor: pointer;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.wizard-close-btn:hover {
    background: var(--gray-100);
    color: var(--gray-600);
}

/* Compact Body */
.wizard-compact-body {
    padding: 20px;
    min-height: 280px;
}

.wizard-compact-body.hidden {
    display: none;
}

/* Mode Cards */
.wiz-mode-cards {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    padding: 20px 0;
}

.wiz-mode-card {
    position: relative;
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    background: var(--white);
    border: 2px solid var(--gray-200);
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.15s ease;
}

.wiz-mode-card:hover {
    border-color: var(--blue-300);
    background: var(--blue-50);
}

.wiz-mode-card.active {
    border-color: var(--blue-500);
    background: var(--blue-50);
}

.wiz-mode-card-icon {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--gray-500);
}

.wiz-mode-card.active .wiz-mode-card-icon {
    color: var(--blue-600);
}

.wiz-mode-card-icon svg {
    width: 28px;
    height: 28px;
}

.wiz-mode-card-content {
    display: flex;
    flex-direction: column;
}

.wiz-mode-card-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--gray-900);
}

.wiz-mode-card-desc {
    font-size: 11px;
    color: var(--gray-500);
}

/* Mode Card Tooltip */
.wiz-mode-tooltip {
    position: absolute;
    top: calc(100% + 8px);
    left: 0;
    right: 0;
    background: var(--gray-900);
    color: var(--white);
    padding: 14px 16px;
    border-radius: 10px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    opacity: 0;
    visibility: hidden;
    transform: translateY(-4px);
    transition: all 0.2s ease;
    z-index: 100;
}

.wiz-mode-tooltip::before {
    content: '';
    position: absolute;
    top: -6px;
    left: 24px;
    width: 12px;
    height: 12px;
    background: var(--gray-900);
    transform: rotate(45deg);
}

.wiz-mode-card:hover .wiz-mode-tooltip {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.wiz-tooltip-title {
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 6px;
    color: var(--white);
}

.wiz-tooltip-text {
    font-size: 11px;
    line-height: 1.5;
    color: var(--gray-300);
    margin-bottom: 10px;
}

.wiz-tooltip-steps {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 10px;
    color: var(--blue-300);
    margin-bottom: 10px;
    padding: 8px 10px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 6px;
}

.wiz-tooltip-arrow {
    color: var(--gray-500);
}

.wiz-tooltip-hint {
    font-size: 10px;
    color: var(--amber-400);
    font-style: italic;
}

/* Mode Description Container (visible after selection) */
.wiz-mode-description {
    margin-top: 16px;
    padding: 16px;
    background: var(--gray-50);
    border: 1px solid var(--gray-200);
    border-radius: 10px;
    animation: slideIn 0.2s ease;
}

.wiz-mode-description.hidden {
    display: none;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-8px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.wiz-mode-desc-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--gray-900);
    margin-bottom: 8px;
}

.wiz-mode-desc-text {
    font-size: 12px;
    line-height: 1.6;
    color: var(--gray-600);
    margin-bottom: 12px;
}

.wiz-mode-desc-steps {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
    flex-wrap: wrap;
}

.wiz-step-pill {
    padding: 4px 10px;
    background: var(--blue-100);
    color: var(--blue-700);
    font-size: 11px;
    font-weight: 500;
    border-radius: 12px;
}

.wiz-step-arrow {
    color: var(--gray-400);
    font-size: 12px;
}

.wiz-mode-desc-hint {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    color: var(--amber-600);
    padding: 8px 12px;
    background: var(--amber-50);
    border-radius: 6px;
}

.wiz-mode-desc-hint svg {
    flex-shrink: 0;
}

/* Form Fields */
.wiz-field {
    margin-bottom: 16px;
}

.wiz-label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: var(--gray-700);
    margin-bottom: 6px;
}

.wiz-req {
    color: var(--red-500);
}

.wiz-input, .wiz-select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--gray-300);
    border-radius: 8px;
    font-size: 13px;
    color: var(--gray-900);
    background: var(--white);
    transition: border-color 0.15s ease;
}

.wiz-input:focus, .wiz-select:focus {
    outline: none;
    border-color: var(--blue-500);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.wiz-input::placeholder {
    color: var(--gray-400);
}

.wiz-row-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}

/* ID Configuration Block */
.wiz-id-config {
    background: var(--gray-50);
    border: 1px solid var(--gray-200);
    border-radius: 10px;
    padding: 14px;
    margin-bottom: 14px;
}

.wiz-id-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
}

.wiz-id-title {
    font-size: 13px;
    font-weight: 600;
    color: var(--gray-800);
}

.wiz-id-toggle {
    display: flex;
    gap: 12px;
}

.wiz-radio {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 11px;
    color: var(--gray-600);
    cursor: pointer;
}

.wiz-radio input {
    cursor: pointer;
}

.wiz-id-fields {
    margin: 12px 0;
    padding: 12px;
    background: var(--white);
    border-radius: 8px;
    border: 1px solid var(--gray-200);
}

.wiz-id-fields.hidden {
    display: none;
}

.wiz-id-row {
    display: flex;
    gap: 16px;
}

.wiz-id-group {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.wiz-id-label {
    font-size: 10px;
    font-weight: 500;
    color: var(--gray-500);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.wiz-sep-btns {
    display: flex;
    gap: 4px;
}

.wiz-sep-btn {
    width: 32px;
    height: 28px;
    border: 1px solid var(--gray-300);
    background: var(--white);
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    color: var(--gray-600);
    cursor: pointer;
    transition: all 0.15s ease;
}

.wiz-sep-btn:hover {
    border-color: var(--blue-400);
}

.wiz-sep-btn.active {
    border-color: var(--blue-500);
    background: var(--blue-50);
    color: var(--blue-600);
}

.wiz-select-sm {
    padding: 6px 8px;
    border: 1px solid var(--gray-300);
    border-radius: 6px;
    font-size: 12px;
    background: var(--white);
    min-width: 60px;
}

.wiz-input-sm {
    width: 60px;
    padding: 6px 8px;
    border: 1px solid var(--gray-300);
    border-radius: 6px;
    font-size: 12px;
    text-align: center;
    font-weight: 600;
}

.wiz-id-preview {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
}

.wiz-id-preview-label {
    color: var(--gray-500);
}

.wiz-id-preview-value {
    font-weight: 600;
    color: var(--blue-600);
    background: var(--blue-50);
    padding: 2px 8px;
    border-radius: 4px;
}

.wiz-id-preview-arrow {
    color: var(--gray-400);
}

.wiz-id-preview-hint {
    color: var(--gray-400);
    font-style: italic;
}

.wiz-info-note {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 12px;
    background: var(--blue-50);
    border-radius: 8px;
    font-size: 11px;
    color: var(--blue-700);
}

/* Card Selection */
.wiz-card-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
}

.wiz-card-row-2 {
    grid-template-columns: 1fr 1fr;
}

.wiz-card {
    padding: 12px 10px;
    background: var(--white);
    border: 2px solid var(--gray-200);
    border-radius: 8px;
    cursor: pointer;
    text-align: center;
    transition: all 0.15s ease;
}

.wiz-card:hover {
    border-color: var(--blue-300);
}

.wiz-card.active {
    border-color: var(--blue-500);
    background: var(--blue-50);
}

.wiz-card-forensic.active {
    border-color: var(--amber-500);
    background: var(--amber-50);
}

.wiz-card-name {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: var(--gray-900);
}

.wiz-card-hint {
    display: block;
    font-size: 10px;
    color: var(--gray-500);
    margin-top: 2px;
}

/* Zero Trust */
.wiz-zt-banner {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 14px;
    background: linear-gradient(135deg, var(--green-50), var(--blue-50));
    border: 1px solid var(--green-200);
    border-radius: 8px;
    margin-bottom: 16px;
}

.wiz-zt-banner svg {
    color: var(--green-600);
    flex-shrink: 0;
}

.wiz-zt-text {
    display: flex;
    flex-direction: column;
}

.wiz-zt-title {
    font-size: 12px;
    font-weight: 600;
    color: var(--gray-900);
}

.wiz-zt-desc {
    font-size: 10px;
    color: var(--gray-600);
}

/* Upload Zone */
.wiz-upload-zone {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 24px;
    border: 2px dashed var(--gray-300);
    border-radius: 10px;
    background: var(--gray-50);
    cursor: pointer;
    transition: all 0.15s ease;
}

.wiz-upload-zone:hover {
    border-color: var(--blue-400);
    background: var(--blue-50);
}

.wiz-upload-zone.dragover {
    border-color: var(--blue-500);
    background: var(--blue-100);
}

.wiz-upload-zone svg {
    color: var(--gray-400);
    margin-bottom: 8px;
}

.wiz-upload-text {
    font-size: 13px;
    font-weight: 500;
    color: var(--gray-700);
}

.wiz-upload-hint {
    font-size: 11px;
    color: var(--gray-400);
    margin-top: 4px;
}

/* File List */
.wiz-file-list {
    margin-top: 12px;
    max-height: 100px;
    overflow-y: auto;
}

.wiz-file-list.hidden {
    display: none;
}

.wiz-file-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 10px;
    background: var(--white);
    border: 1px solid var(--gray-200);
    border-radius: 6px;
    margin-bottom: 4px;
}

.wiz-file-icon {
    width: 22px;
    height: 22px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    font-size: 8px;
    font-weight: 700;
    color: white;
}

.wiz-file-name {
    flex: 1;
    font-size: 12px;
    color: var(--gray-700);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.wiz-file-size {
    font-size: 10px;
    color: var(--gray-400);
}

.wiz-file-remove {
    width: 18px;
    height: 18px;
    border: none;
    background: var(--gray-100);
    border-radius: 50%;
    cursor: pointer;
    color: var(--gray-500);
    font-size: 11px;
}

.wiz-file-remove:hover {
    background: var(--red-100);
    color: var(--red-600);
}

/* Security Checks */
.wiz-security-checks {
    display: flex;
    gap: 16px;
    margin-top: 10px;
    padding: 8px 12px;
    background: var(--gray-50);
    border-radius: 6px;
}

.wiz-security-checks.hidden {
    display: none;
}

.wiz-sec-check {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    color: var(--gray-600);
}

.wiz-sec-icon {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    display: inline-block;
}

.wiz-sec-icon.pending {
    background: var(--gray-300);
}

.wiz-sec-icon.checking {
    background: var(--amber-400);
    animation: pulse 0.6s infinite;
}

.wiz-sec-icon.passed {
    background: var(--green-500);
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

/* Analysis Options */
.wiz-analysis-opts {
    display: flex;
    gap: 16px;
    margin-top: 12px;
}

.wiz-analysis-opts.hidden {
    display: none;
}

.wiz-checkbox {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    color: var(--gray-700);
    cursor: pointer;
}

/* Review Grid */
.wiz-review-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
}

.wiz-review-item {
    padding: 10px 12px;
    background: var(--gray-50);
    border-radius: 6px;
}

.wiz-review-label {
    display: block;
    font-size: 10px;
    color: var(--gray-500);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 2px;
}

.wiz-review-value {
    font-size: 13px;
    font-weight: 600;
    color: var(--gray-900);
}

.wiz-review-security {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 14px;
    padding: 10px 14px;
    background: var(--green-50);
    border: 1px solid var(--green-200);
    border-radius: 8px;
    font-size: 12px;
    color: var(--green-700);
}

.wiz-review-security.hidden {
    display: none;
}

.wiz-review-security svg {
    color: var(--green-600);
}

/* Footer */
.wizard-compact-footer {
    display: flex;
    align-items: center;
    padding: 14px 20px;
    border-top: 1px solid var(--gray-200);
    background: var(--gray-50);
}

.wiz-footer-spacer {
    flex: 1;
}

.wiz-btn {
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s ease;
}

.wiz-btn-back {
    background: transparent;
    border: 1px solid var(--gray-300);
    color: var(--gray-600);
    margin-right: auto;
}

.wiz-btn-back:hover {
    background: var(--gray-100);
}

.wiz-btn-back.hidden {
    display: none;
}

.wiz-btn-cancel {
    background: transparent;
    border: 1px solid var(--gray-300);
    color: var(--gray-600);
    margin-right: 8px;
}

.wiz-btn-cancel:hover {
    background: var(--gray-100);
}

.wiz-btn-next {
    background: var(--blue-600);
    border: none;
    color: white;
}

.wiz-btn-next:hover {
    background: var(--blue-700);
}

/* Dark mode Create Case */
body.dark-theme .modal-title-lg {
    color: var(--blue-400);
}

body.dark-theme .form-label {
    color: var(--gray-100);
}

body.dark-theme .form-input,
body.dark-theme .form-textarea,
body.dark-theme .form-select {
    background: #0f172a;
    border-color: #2d2d44;
    color: var(--gray-100);
}

body.dark-theme .form-input:focus,
body.dark-theme .form-textarea:focus {
    border-color: var(--blue-500);
}

body.dark-theme .form-preview {
    background: #0f172a;
}

body.dark-theme .separator-btn {
    background: #0f172a;
    border-color: #2d2d44;
    color: var(--gray-400);
}

body.dark-theme .separator-btn.active {
    background: var(--blue-600);
    border-color: var(--blue-600);
    color: var(--white);
}

/* =============================================================================
   RELEASE NOTES MODAL
   ============================================================================= */
.release-notes-body {
    max-height: 400px;
    overflow-y: auto;
}

.release-item {
    padding: 16px 0;
    border-bottom: 1px solid var(--gray-100);
}

.release-item:last-child {
    border-bottom: none;
}

.release-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
}

.release-version {
    padding: 4px 10px;
    background: var(--blue-600);
    color: var(--white);
    font-size: 12px;
    font-weight: 700;
    border-radius: var(--radius-sm);
}

.release-date {
    font-size: 13px;
    color: var(--gray-500);
}

.release-tag {
    padding: 2px 8px;
    font-size: 10px;
    font-weight: 600;
    border-radius: var(--radius-full);
    text-transform: uppercase;
}

.release-tag.current {
    background: var(--green-100);
    color: var(--green-700);
}

.release-section {
    margin-bottom: 12px;
}

.release-section:last-child {
    margin-bottom: 0;
}

.release-section-title {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: var(--gray-700);
    margin-bottom: 6px;
}

.release-content ul {
    margin: 0;
    padding-left: 20px;
}

.release-content li {
    font-size: 13px;
    color: var(--gray-600);
    line-height: 1.6;
}

/* Dark mode release notes */
body.dark-theme .release-item {
    border-color: #2d2d44;
}

body.dark-theme .release-section-title {
    color: #e5e7eb;
}

body.dark-theme .release-content li {
    color: #9ca3af;
}

body.dark-theme .release-tag.current {
    background: #064e3b;
    color: #6ee7b7;
}

.brand {
    font-size: var(--font-size-lg);
    font-weight: 500;
    letter-spacing: 2px;
    color: var(--gray-500);
}

.brand strong {
    color: var(--gray-900);
}

.header-center {
    flex: 1;
    display: flex;
    justify-content: center;
}

.case-selector {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-xs) var(--space-sm);
    background: transparent;
    border: none;
    border-radius: var(--radius-md);
    cursor: pointer;
    max-width: 360px;
    user-select: none;
    -webkit-user-select: none;
}

.case-selector:hover {
    background: var(--gray-100);
}

.case-name {
    font-size: var(--font-size-base);
    font-weight: 600;
    color: var(--gray-900);
    max-width: 240px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    user-select: none;
    -webkit-user-select: none;
}

.case-framework-badge {
    padding: 2px 6px;
    font-size: 9px;
    font-weight: 700;
    border-radius: 3px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    flex-shrink: 0;
}

.case-framework-badge.rics {
    background: #dbeafe;
    color: #1d4ed8;
}

.case-framework-badge.far {
    background: #fef3c7;
    color: #92400e;
}

.case-framework-badge.other {
    background: var(--gray-200);
    color: var(--gray-600);
}

.case-badge {
    padding: 2px 6px;
    background: var(--blue-100);
    color: var(--blue-700);
    font-size: 10px;
    font-weight: 700;
    border-radius: var(--radius-sm);
    white-space: nowrap;
    flex-shrink: 0;
}

.case-arrow {
    font-size: var(--font-size-xs);
    color: var(--gray-400);
}

.case-dropdown {
    width: 320px;
    max-height: 400px;
    overflow-y: auto;
}

.case-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-sm) var(--space-md);
    cursor: pointer;
    border-bottom: 1px solid var(--gray-100);
}

.case-item:hover {
    background: var(--gray-50);
}

.case-item-name {
    font-size: var(--font-size-sm);
    font-weight: 500;
    color: var(--gray-900);
    flex: 1;
}

.case-item-badge {
    padding: 2px 8px;
    background: var(--blue-100);
    color: var(--blue-700);
    font-size: 10px;
    font-weight: 700;
    border-radius: var(--radius-sm);
    letter-spacing: 0.5px;
}

.case-item-framework {
    padding: 1px 4px;
    font-size: 9px;
    font-weight: 600;
    border-radius: 3px;
    text-transform: uppercase;
    margin-left: auto;
    margin-right: var(--space-xs);
}

.case-item-framework.rics {
    background: #dbeafe;
    color: #1d4ed8;
}

.case-item-framework.far {
    background: #fef3c7;
    color: #92400e;
}

.case-item-framework.other {
    background: var(--gray-200);
    color: var(--gray-600);
}

.header-right {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    min-width: 200px;
    justify-content: flex-end;
}

.time-tracker {
    display: flex;
    align-items: center;
    gap: var(--space-2xs);
    padding: var(--space-2xs) var(--space-xs);
    background: var(--gray-100);
    border-radius: var(--radius-md);
    font-size: var(--font-size-sm);
    color: var(--gray-600);
}

.time-icon {
    font-size: var(--font-size-sm);
}

.time-display {
    font-family: var(--font-mono);
    font-size: var(--font-size-sm);
    font-weight: 500;
}

.header-btn {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-md);
    cursor: pointer;
    color: var(--gray-600);
    font-size: var(--font-size-base);
}

.header-btn:hover {
    background: var(--gray-100);
}

.avatar-btn {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--blue-600);
    border: none;
    border-radius: var(--radius-full);
    cursor: pointer;
}

.avatar-initials {
    font-size: var(--font-size-xs);
    font-weight: 700;
    color: var(--white);
}

.settings-dropdown {
    width: 200px;
    right: 0;
    left: auto;
    bottom: auto !important;
    top: calc(100% + 8px);
    background: #ffffff !important;
    border: 1px solid #e5e7eb !important;
    border-radius: 12px;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05) !important;
    z-index: 9999 !important;
}

.case-dropdown {
    bottom: auto !important;
    top: calc(100% + 8px);
    left: 50%;
    transform: translateX(-50%);
    right: auto;
    background: #ffffff !important;
    border: 1px solid #e5e7eb !important;
    border-radius: 12px;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05) !important;
    z-index: 9999 !important;
}

.settings-item {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm) var(--space-md);
    cursor: pointer;
}

.settings-item:hover {
    background: var(--gray-50);
}

.settings-icon {
    font-size: var(--font-size-base);
    width: 20px;
    text-align: center;
}

.settings-label {
    flex: 1;
    font-size: var(--font-size-sm);
    color: var(--gray-900);
}

.settings-toggle {
    font-size: var(--font-size-xs);
    font-weight: 600;
    color: var(--gray-400);
}

.settings-toggle.on {
    color: var(--blue-600);
}

.settings-divider {
    height: 1px;
    background: var(--gray-200);
    margin: var(--space-xs) 0;
}

.settings-arrow {
    color: var(--gray-400);
    font-size: var(--font-size-sm);
}

.settings-checkbox {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    font-size: var(--font-size-sm);
    color: var(--gray-700);
    cursor: pointer;
}

.settings-checkbox input {
    width: 16px;
    height: 16px;
    cursor: pointer;
}

/* Time Tracker Modal */
.time-tracker-display {
    text-align: center;
    padding: var(--space-xl) 0;
}

.time-tracker-clock {
    font-family: var(--font-mono);
    font-size: 48px;
    font-weight: 700;
    color: var(--gray-900);
    letter-spacing: 2px;
}

.time-tracker-case {
    font-size: var(--font-size-sm);
    color: var(--gray-500);
    margin-top: var(--space-xs);
}

.time-tracker-controls {
    display: flex;
    justify-content: center;
    gap: var(--space-sm);
    margin-bottom: var(--space-md);
}

/* Constraints Modal */
.modal-header-title {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    flex: 1;
}

.modal-case-name {
    font-size: var(--font-size-sm);
    font-weight: 500;
    color: var(--gray-600);
    margin-left: var(--space-md);
    padding-left: var(--space-md);
    border-left: 1px solid var(--gray-300);
}

.modal-subtitle {
    margin-left: var(--space-sm);
    padding: 2px 8px;
    background: var(--blue-100);
    color: var(--blue-700);
    font-size: var(--font-size-xs);
    font-weight: 600;
    border-radius: var(--radius-sm);
}

.constraints-info {
    padding: var(--space-md);
    background: var(--blue-50);
    border-bottom: 1px solid var(--gray-200);
}

.constraints-info p {
    margin: 0;
    font-size: var(--font-size-sm);
    color: var(--gray-600);
    line-height: 1.5;
}

.constraints-editor {
    padding: var(--space-md);
}

.constraints-textarea {
    width: 100%;
    min-height: 250px;
    padding: var(--space-md);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-md);
    font-family: var(--font-mono);
    font-size: var(--font-size-sm);
    line-height: 1.6;
    resize: vertical;
    background: var(--white);
    color: var(--gray-900);
}

.constraints-textarea:focus {
    outline: none;
    border-color: var(--blue-500);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.constraints-textarea::placeholder {
    color: var(--gray-400);
}

.constraints-templates {
    padding: var(--space-md);
    border-top: 1px solid var(--gray-200);
    background: var(--gray-50);
}

.constraints-templates-header {
    font-size: var(--font-size-xs);
    font-weight: 600;
    color: var(--gray-500);
    text-transform: uppercase;
    margin-bottom: var(--space-sm);
}

.constraints-template-list {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-xs);
}

.constraints-template-btn {
    padding: var(--space-2xs) var(--space-sm);
    background: var(--white);
    border: 1px solid var(--gray-300);
    border-radius: var(--radius-md);
    font-size: var(--font-size-xs);
    font-weight: 500;
    color: var(--gray-700);
    cursor: pointer;
}

.constraints-template-btn:hover {
    background: var(--blue-50);
    border-color: var(--blue-300);
    color: var(--blue-700);
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: var(--space-sm);
    padding: var(--space-md);
    border-top: 1px solid var(--gray-200);
    background: var(--gray-50);
}

/* Dark mode constraints */
body.dark-theme .constraints-info {
    background: #16213e;
    border-color: #2d2d44;
}

body.dark-theme .constraints-info p {
    color: #9ca3af;
}

body.dark-theme .constraints-textarea {
    background: #16213e;
    border-color: #2d2d44;
    color: #f9fafb;
}

body.dark-theme .constraints-templates {
    background: #16213e;
    border-color: #2d2d44;
}

body.dark-theme .constraints-template-btn {
    background: #1a1a2e;
    border-color: #3d3d5c;
    color: #e5e7eb;
}

body.dark-theme .constraints-template-btn:hover {
    background: #2d2d44;
    border-color: #3b82f6;
    color: #60a5fa;
}

body.dark-theme .modal-footer {
    background: #16213e;
    border-color: #2d2d44;
}

body.dark-theme .modal-case-name {
    color: #9ca3af;
    border-color: #3d3d5c;
}

/* =============================================================================
   PANES
   ============================================================================= */
.pane {
    display: flex;
    flex-direction: column;
    background: var(--white);
    overflow: visible;
    transition: width 0.2s ease;
}

.pane-left {
    width: var(--pane-side-w);
    border-right: 1px solid var(--gray-200);
    overflow: visible;
    position: relative;
}

.pane-left.collapsed {
    width: var(--pane-collapsed-w);
}

/* ***************************************************************
   SMART FOLDER TREE
   *************************************************************** */

.smart-folder-pane {
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.smart-folder-tree {
    flex: 1;
    overflow-y: auto;
    padding: 8px 0;
}

/* Folder Container */
.sf-folder {
    margin-bottom: 2px;
}

.sf-folder-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    cursor: pointer;
    user-select: none;
    transition: background 0.1s;
}

.sf-folder-header:hover {
    background: var(--gray-100);
}

.sf-folder.open > .sf-folder-header {
    background: var(--gray-50);
}

.sf-arrow {
    font-size: 8px;
    color: var(--gray-400);
    width: 12px;
    text-align: center;
    transition: transform 0.15s;
}

.sf-folder.open > .sf-folder-header > .sf-arrow {
    transform: rotate(90deg);
}

.sf-icon {
    width: 22px;
    height: 22px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 5px;
    color: white;
    flex-shrink: 0;
}

.sf-name {
    flex: 1;
    font-size: 12px;
    font-weight: 500;
    color: var(--gray-800);
}

.sf-count {
    font-size: 10px;
    font-weight: 500;
    color: var(--gray-400);
    background: var(--gray-100);
    padding: 2px 6px;
    border-radius: 10px;
    min-width: 20px;
    text-align: center;
}

.sf-count:not(:empty):not([data-count="0"]) {
    background: var(--blue-100);
    color: var(--blue-600);
}

/* Folder Children */
.sf-children {
    display: none;
    padding-left: 20px;
}

.sf-folder.open > .sf-children {
    display: block;
}

.sf-subfolder {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 5px 12px;
    cursor: pointer;
    transition: background 0.1s;
}

.sf-subfolder:hover {
    background: var(--gray-100);
}

.sf-subfolder.selected {
    background: var(--blue-50);
}

.sf-sub-icon {
    font-size: 11px;
    width: 18px;
    text-align: center;
}

.sf-sub-name {
    flex: 1;
    font-size: 11px;
    color: var(--gray-700);
}

.sf-sub-count {
    font-size: 9px;
    color: var(--gray-400);
}

/* All Documents Section */
.sf-all-docs {
    border-top: 1px solid var(--gray-200);
    margin-top: 4px;
}

.sf-all-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    cursor: pointer;
    background: var(--gray-50);
    transition: background 0.1s;
}

.sf-all-header:hover {
    background: var(--gray-100);
}

.sf-all-icon {
    font-size: 14px;
}

.sf-all-name {
    flex: 1;
    font-size: 12px;
    font-weight: 600;
    color: var(--gray-800);
}

/* Document List inside Smart Folders */
.sf-doc-list {
    max-height: 200px;
    overflow-y: auto;
}

.sf-doc-list.collapsed {
    display: none;
}

.sf-doc-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px 6px 24px;
    cursor: pointer;
    transition: background 0.1s;
}

.sf-doc-item:hover {
    background: var(--gray-100);
}

.sf-doc-item.selected {
    background: var(--blue-50);
}

.sf-doc-badge {
    font-size: 8px;
    font-weight: 700;
    padding: 2px 4px;
    border-radius: 3px;
    color: white;
    text-transform: uppercase;
}

.sf-doc-info {
    flex: 1;
    min-width: 0;
}

.sf-doc-name {
    font-size: 11px;
    font-weight: 500;
    color: var(--gray-800);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.sf-doc-meta {
    font-size: 9px;
    color: var(--gray-400);
}

.sf-doc-checkbox {
    width: 14px;
    height: 14px;
    cursor: pointer;
}

/* ***************************************************************
   FULL PAGE DROPZONE OVERLAY (L-Pane)
   Appears when dragging files over L-Pane
   *************************************************************** */

.dropzone-fullpage {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(59, 130, 246, 0.95);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
    animation: fadeIn 0.2s ease;
}

.dropzone-fullpage.hidden {
    display: none;
}

.dropzone-fullpage-content {
    text-align: center;
    color: white;
}

.dropzone-fullpage-content svg {
    margin-bottom: 16px;
    opacity: 0.9;
}

.dropzone-fullpage-title {
    display: block;
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 8px;
}

.dropzone-fullpage-hint {
    display: block;
    font-size: 12px;
    opacity: 0.8;
}

/* ***************************************************************
   CONTEXTUAL DROPZONES (C-PANE)
   Mode S = Full screen search dropzone
   Mode A = Conversation context dropzone
   *************************************************************** */

/* Full Screen DropZone (Search Mode) */
.dropzone-fullscreen {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(59, 130, 246, 0.95);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 50;
    animation: fadeIn 0.2s ease;
}

.dropzone-fullscreen.hidden {
    display: none;
}

.dropzone-fullscreen-content {
    text-align: center;
    color: white;
}

.dropzone-fullscreen-content svg {
    margin-bottom: 16px;
    opacity: 0.9;
}

.dropzone-fullscreen-title {
    display: block;
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 8px;
}

.dropzone-fullscreen-hint {
    display: block;
    font-size: 13px;
    opacity: 0.8;
}

/* Conversation DropZone (Analysis Mode) */
.dropzone-conversation {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: var(--white);
    border: 2px dashed var(--blue-400);
    border-radius: 16px;
    padding: 32px 48px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
    z-index: 50;
    animation: scaleIn 0.2s ease;
}

.dropzone-conversation.hidden {
    display: none;
}

@keyframes scaleIn {
    from {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.9);
    }
    to {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
    }
}

.dropzone-conversation-content {
    text-align: center;
}

.dropzone-conversation-content svg {
    color: var(--blue-500);
    margin-bottom: 12px;
}

.dropzone-conversation-text {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: var(--gray-800);
}

.dropzone-conversation-hint {
    display: block;
    font-size: 11px;
    color: var(--gray-500);
    margin-top: 4px;
}

/* DropZone overlay backdrop */
.dropzone-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.3);
    z-index: 40;
}

.dropzone-backdrop.hidden {
    display: none;
}

.pane-center {
    flex: 1;
    background: var(--gray-100);
    position: relative;
}

.pane-right {
    width: var(--pane-side-w);
    border-left: 1px solid var(--gray-200);
}

.pane-right.collapsed {
    width: var(--pane-collapsed-w);
}

.pane-header {
    min-height: var(--pane-header-h);
    height: var(--pane-header-h);
    display: flex;
    align-items: center;
    padding: 0 var(--space-md);
    border-bottom: 1px solid var(--gray-200);
    flex-shrink: 0;
    position: relative;
    overflow: visible;
    z-index: 100;
}

.pane-header-collapsed {
    justify-content: center;
    padding: 0;
}

.rpane-title-clickable {
    cursor: pointer;
}

.rpane-title-clickable:hover {
    background: var(--gray-50);
    border-radius: var(--radius-sm);
}

.rpane-expand-indicator {
    font-size: 10px;
    color: var(--gray-400);
    transition: transform 0.2s;
}

.rpane-expand-indicator.collapsed {
    transform: rotate(-90deg);
}

.pane-header-center {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: var(--space-sm);
    min-width: 0;
    padding-left: 28px; /* Space for collapse button */
}

.collapse-btn-edge-left {
    position: absolute;
    left: var(--space-sm);
}

.collapse-btn-edge-right {
    position: absolute;
    right: var(--space-sm);
}

.pane-title {
    font-size: var(--font-size-base);
    font-weight: 600;
    color: var(--gray-900);
}

.pane-title-row {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.vault-badge {
    padding: 2px 8px;
    background: var(--blue-100);
    color: var(--blue-700);
    font-size: 10px;
    font-weight: 700;
    border-radius: var(--radius-sm);
    letter-spacing: 0.5px;
}

.vault-selector {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: 4px 8px;
    background: transparent;
    border: none;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: background 0.2s ease;
}

.vault-selector:hover {
    background: var(--gray-100);
}

.vault-arrow {
    font-size: 8px;
    color: var(--gray-400);
    margin-left: 2px;
}

.vault-dropdown {
    position: fixed;
    min-width: 260px;
    max-height: 320px;
    overflow-y: auto;
    z-index: 10000;
    background: var(--white);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-lg);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    display: none;
}

.vault-dropdown.open {
    display: block;
}

body.dark-theme .vault-dropdown {
    background: #1a1a2e;
    border-color: #2d2d44;
}

.vault-list {
    max-height: 200px;
    overflow-y: auto;
}

.vault-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 12px;
    cursor: pointer;
    transition: background 0.15s ease;
}

.vault-item:hover {
    background: var(--blue-50);
}

.vault-item.selected {
    background: var(--blue-50);
}

.vault-item-name {
    font-size: 13px;
    font-weight: 500;
    color: var(--gray-900);
}

.vault-item-badge {
    padding: 2px 8px;
    background: var(--blue-100);
    color: var(--blue-700);
    font-size: 10px;
    font-weight: 700;
    border-radius: var(--radius-sm);
}

.vault-item-meta {
    font-size: 11px;
    color: var(--gray-500);
    margin-left: 8px;
}

/* Dark mode vault selector */
body.dark-theme .vault-selector:hover {
    background: #2d2d44;
}

body.dark-theme .vault-item:hover,
body.dark-theme .vault-item.selected {
    background: #1e3a5f;
}

body.dark-theme .vault-item-name {
    color: #f9fafb;
}

body.dark-theme .vault-item-badge {
    background: #1e3a5f;
    color: #93c5fd;
}

.dropdown-footer {
    padding: 8px;
    border-top: 1px solid var(--gray-100);
}

.dropdown-action-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    width: 100%;
    padding: 10px 12px;
    background: transparent;
    border: 1px dashed var(--gray-300);
    border-radius: var(--radius-md);
    font-size: 13px;
    font-weight: 500;
    color: var(--gray-600);
    cursor: pointer;
    transition: all 0.2s ease;
}

.dropdown-action-btn:hover {
    background: var(--blue-50);
    border-color: var(--blue-300);
    color: var(--blue-600);
}

.dropdown-action-icon {
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--gray-100);
    border-radius: var(--radius-sm);
    font-size: 14px;
    font-weight: 600;
}

.dropdown-action-btn:hover .dropdown-action-icon {
    background: var(--blue-100);
    color: var(--blue-600);
}

body.dark-theme .dropdown-footer {
    border-color: #2d2d44;
}

body.dark-theme .dropdown-action-btn {
    border-color: #3d3d5c;
    color: #9ca3af;
}

body.dark-theme .dropdown-action-btn:hover {
    background: #1e3a5f;
    border-color: #3b82f6;
    color: #93c5fd;
}

body.dark-theme .dropdown-action-icon {
    background: #2d2d44;
}

.evidence-badge {
    padding: 2px 6px;
    background: var(--green-100);
    color: var(--green-700);
    font-size: 9px;
    font-weight: 700;
    border-radius: var(--radius-sm);
    letter-spacing: 0.3px;
    flex-shrink: 0;
}

.pane-subtitle {
    font-size: var(--font-size-sm);
    color: var(--gray-500);
    margin-left: var(--space-xs);
}

.pane-content {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    min-height: 0;
}

/* =============================================================================
   SMART FOLDER NAVIGATOR (C-Pane)
   ============================================================================= */
.sf-navigator {
    padding: 16px;
    overflow-y: auto;
    flex: 1;
}

.sfn-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--gray-200);
}

.sfn-methodology {
    font-size: 12px;
    color: var(--gray-500);
}

.sfn-btn-showall {
    padding: 6px 14px;
    background: var(--white);
    border: 1px solid var(--gray-200);
    border-radius: 6px;
    font-size: 12px;
    color: var(--gray-600);
    cursor: pointer;
}

.sfn-btn-showall:hover {
    border-color: var(--blue-300);
    color: var(--blue-600);
}

.sfn-btn-showall.active {
    background: var(--blue-50);
    border-color: var(--blue-300);
    color: var(--blue-600);
}

.sfn-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

/* Phase row */
.sfn-phase {
    background: var(--white);
    border: 1px solid var(--gray-200);
    border-radius: 8px;
    overflow: hidden;
}

.sfn-phase.selected {
    border-color: var(--blue-300);
    background: var(--blue-50);
}

.sfn-phase-row {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 12px;
}

.sfn-expand-btn {
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--gray-100);
    border: 1px solid var(--gray-200);
    border-radius: 4px;
    font-size: 14px;
    color: var(--gray-500);
    cursor: pointer;
    flex-shrink: 0;
}

.sfn-expand-btn:hover {
    background: var(--gray-200);
    color: var(--gray-700);
}

.sfn-phase-info {
    flex: 1;
    cursor: pointer;
}

.sfn-phase-info:hover .sfn-phase-name {
    color: var(--blue-600);
}

.sfn-phase-name {
    font-size: 13px;
    font-weight: 500;
    color: var(--gray-800);
}

.sfn-phase.selected .sfn-phase-name {
    color: var(--blue-700);
}

.sfn-phase-count {
    font-size: 12px;
    color: var(--gray-400);
    background: var(--gray-100);
    padding: 4px 10px;
    border-radius: 12px;
    min-width: 32px;
    text-align: center;
}

.sfn-phase.selected .sfn-phase-count {
    background: var(--blue-200);
    color: var(--blue-700);
}

/* Subfolders (expanded) */
.sfn-subfolders {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 6px;
    padding: 8px 12px 12px 44px;
    background: var(--gray-50);
    border-top: 1px solid var(--gray-100);
}

.sfn-subfolder {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 10px;
    background: var(--white);
    border: 1px solid var(--gray-200);
    border-radius: 6px;
    cursor: pointer;
}

.sfn-subfolder:hover {
    border-color: var(--blue-300);
    background: var(--blue-50);
}

.sfn-subfolder.selected {
    border-color: var(--blue-400);
    background: var(--blue-100);
}

.sfn-subfolder.empty {
    opacity: 0.4;
}

.sfn-subfolder-name {
    font-size: 12px;
    color: var(--gray-700);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.sfn-subfolder.selected .sfn-subfolder-name {
    color: var(--blue-700);
    font-weight: 500;
}

.sfn-subfolder-count {
    font-size: 10px;
    color: var(--gray-400);
    background: var(--gray-100);
    padding: 2px 6px;
    border-radius: 8px;
    margin-left: 8px;
    flex-shrink: 0;
}

.sfn-subfolder.selected .sfn-subfolder-count {
    background: var(--blue-200);
    color: var(--blue-600);
}

/* =============================================================================
   SEARCH CONTEXT (C-Pane - after folder selection)
   ============================================================================= */
.search-context-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    border-bottom: 1px solid var(--gray-200);
}

.search-context-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--gray-800);
}

.search-context-back {
    padding: 6px 12px;
    background: var(--gray-100);
    border: 1px solid var(--gray-200);
    border-radius: 6px;
    font-size: 12px;
    color: var(--gray-600);
    cursor: pointer;
}

.search-context-back:hover {
    background: var(--gray-200);
}

.search-context-list {
    padding: 8px;
    overflow-y: auto;
    flex: 1;
}

.search-context-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    border-radius: 6px;
    cursor: pointer;
}

.search-context-item:hover {
    background: var(--gray-50);
}

.search-context-item.selected {
    background: var(--blue-50);
}

.search-context-checkbox {
    width: 16px;
    height: 16px;
    accent-color: var(--blue-500);
    flex-shrink: 0;
}

.search-context-icon {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    font-size: 10px;
    font-weight: 600;
    color: white;
    flex-shrink: 0;
}

.search-context-icon.pdf { background: #ef4444; }
.search-context-icon.docx { background: #3b82f6; }
.search-context-icon.xlsx { background: #22c55e; }
.search-context-icon.msg { background: #6b7280; }
.search-context-icon.mpp { background: #f59e0b; }
.search-context-icon.png, .search-context-icon.jpg { background: #8b5cf6; }

.search-context-info {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.search-context-name {
    font-size: 13px;
    font-weight: 500;
    color: var(--gray-800);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.search-context-meta {
    font-size: 11px;
    color: var(--gray-400);
}

/* Search Context Empty State */
.search-context-empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    padding: 40px;
    text-align: center;
}

.search-context-empty-icon {
    width: 48px;
    height: 48px;
    margin-bottom: 16px;
    background: var(--gray-300);
    -webkit-mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cpath d='m21 21-4.35-4.35'/%3E%3C/svg%3E") center/contain no-repeat;
    mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cpath d='m21 21-4.35-4.35'/%3E%3C/svg%3E") center/contain no-repeat;
}

.search-context-empty-title {
    font-size: 14px;
    font-weight: 500;
    color: var(--gray-700);
    margin-bottom: 4px;
}

.search-context-empty-hint {
    font-size: 12px;
    color: var(--gray-400);
}

/* C-Pane Folders Button */
.cpane-folders-btn {
    padding: 4px 10px;
    background: var(--gray-100);
    border: 1px solid var(--gray-200);
    border-radius: 4px;
    font-size: 11px;
    font-weight: 500;
    color: var(--gray-600);
    cursor: pointer;
}

.cpane-folders-btn:hover {
    background: var(--blue-50);
    border-color: var(--blue-200);
    color: var(--blue-600);
}

/* =============================================================================
   L-PANE FILTER INDICATOR
   ============================================================================= */
.lpane-select-all {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 11px;
    color: var(--gray-600);
    cursor: pointer;
    padding: 4px 8px;
    background: var(--gray-50);
    border-radius: 4px;
    flex-shrink: 0;
}

.lpane-select-all:hover {
    background: var(--gray-100);
}

.lpane-select-all input {
    margin: 0;
}

.cpane-select-all {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 11px;
    color: var(--gray-500);
    cursor: pointer;
    flex-shrink: 0;
    margin-left: auto;
}

.cpane-select-all input {
    width: 18px;
    height: 18px;
    cursor: pointer;
    accent-color: var(--blue-500);
    margin: 0;
    order: 2;
}

.cpane-select-all span {
    order: 1;
}

.cpane-framework-badge {
    font-size: 10px;
    font-weight: 600;
    background: var(--blue-600);
    color: var(--white);
    padding: 2px 8px;
    border-radius: 4px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.cpane-workspace {
    font-size: 11px;
    color: var(--gray-400);
    font-style: italic;
}

.cpane-selection {
    font-size: 11px;
    color: var(--gray-500);
}

.lpane-filter-indicator {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 4px 8px;
    background: var(--blue-50);
    border: 1px solid var(--blue-200);
    border-radius: var(--radius-md);
    margin-left: var(--space-sm);
}

.lpane-filter-name {
    font-size: 11px;
    color: var(--blue-700);
    font-weight: 500;
    white-space: nowrap;
    max-width: 150px;
    overflow: hidden;
    text-overflow: ellipsis;
}

.lpane-filter-clear {
    background: none;
    border: none;
    color: var(--blue-500);
    cursor: pointer;
    font-size: 12px;
    padding: 0 2px;
    line-height: 1;
}

.lpane-filter-clear:hover {
    color: var(--blue-700);
}

.pane-footer {
    min-height: var(--pane-footer-h);
    height: var(--pane-footer-h);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-xs) var(--space-md);
    border-top: 1px solid var(--gray-200);
    flex-shrink: 0;
    overflow: visible;
}

.pane-footer-collapsed {
    padding: var(--space-xs);
}

.pane-footer-link {
    cursor: pointer;
    text-align: center;
}

.pane-footer-link:hover {
    color: var(--blue-600);
}

/* Collapsed pane icons */
.collapsed-icons {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: var(--space-xs);
    gap: var(--space-xs);
}

/* =============================================================================
   COLLAPSE BUTTON
   ============================================================================= */
.collapse-btn {
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--white);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-md);
    color: var(--gray-500);
    font-size: var(--font-size-lg);
}

.collapse-btn:hover {
    background: var(--gray-50);
}

/* =============================================================================
   MINI ICON
   ============================================================================= */
.mini-icon {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-md);
    font-size: var(--font-size-xs);
    font-weight: 700;
    color: var(--white);
    cursor: pointer;
}

.mini-icon.blue { background: var(--blue-500); }
.mini-icon.green { background: var(--green-500); }
.mini-icon.amber { background: var(--amber-500); }
.mini-icon.red { background: var(--red-500); }
.mini-icon.purple { background: var(--purple-500); }
.mini-icon.gray { background: var(--gray-500); }

/* =============================================================================
   FILE ICON
   ============================================================================= */
.file-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 44px;
    height: 44px;
    border-radius: var(--radius-md);
    font-size: 11px;
    font-weight: 700;
    color: var(--white);
    flex-shrink: 0;
}

.file-icon.pdf { background: var(--red-500); }
.file-icon.docx { background: var(--blue-500); }
.file-icon.xlsx { background: var(--green-500); }
.file-icon.mpp { background: var(--amber-500); }
.file-icon.msg { background: var(--gray-500); }
.file-icon.png { background: var(--purple-500); }
.file-icon.jpg { background: var(--purple-500); }
.file-icon.jpeg { background: var(--purple-500); }
.file-icon.xer { background: var(--orange-500); }
.file-icon.pptx { background: var(--orange-500); }

/* =============================================================================
   DOCUMENT LIST - Format: [Badge] [Info] [Checkbox]
   ============================================================================= */
.doc-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    border-bottom: 1px solid var(--gray-100);
    cursor: pointer;
}

.doc-item:hover {
    background: var(--gray-50);
}

.doc-item.selected {
    background: var(--blue-50);
}

.doc-checkbox {
    width: 18px;
    height: 18px;
    cursor: pointer;
    accent-color: var(--blue-500);
    flex-shrink: 0;
}

.doc-info {
    flex: 1;
    min-width: 0;
}

.doc-name {
    font-size: 13px;
    font-weight: 500;
    color: var(--gray-800);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    margin-bottom: 2px;
}

.doc-meta {
    display: flex;
    align-items: center;
    gap: 8px;
}

.doc-meta .evidence-badge {
    padding: 2px 6px;
    background: var(--blue-100);
    color: var(--blue-600);
    font-size: 10px;
    font-weight: 600;
    border-radius: 4px;
}

.doc-meta .doc-size {
    font-size: 11px;
    color: var(--gray-400);
}

/* =============================================================================
   FULL TEXT SEARCH RESULTS
   ============================================================================= */
.fulltext-result {
    padding: 12px 16px;
    border-bottom: 1px solid var(--gray-100);
    cursor: pointer;
}

.fulltext-result:hover {
    background: var(--gray-50);
}

.fulltext-result-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 6px;
}

.file-icon-sm {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    border-radius: 4px;
    font-size: 8px;
    font-weight: 700;
    color: var(--white);
    flex-shrink: 0;
}

.file-icon-sm.pdf { background: var(--red-500); }
.file-icon-sm.docx { background: var(--blue-500); }
.file-icon-sm.xlsx { background: var(--green-500); }
.file-icon-sm.msg { background: var(--gray-500); }
.file-icon-sm.png, .file-icon-sm.jpg { background: var(--purple-500); }

.fulltext-result-file {
    font-size: 12px;
    font-weight: 500;
    color: var(--gray-700);
}

.fulltext-result-page {
    font-size: 10px;
    color: var(--gray-400);
    background: var(--gray-100);
    padding: 2px 6px;
    border-radius: 4px;
}

.fulltext-result-snippet {
    font-size: 13px;
    color: var(--gray-600);
    line-height: 1.5;
}

.fulltext-result-snippet mark {
    background: var(--yellow-200);
    padding: 0 2px;
    border-radius: 2px;
}

.search-empty {
    padding: 40px;
    text-align: center;
}

.search-empty-icon {
    font-size: 32px;
    margin-bottom: 12px;
}

.search-empty-text {
    font-size: 14px;
    color: var(--gray-500);
}

/* =============================================================================
   L-PANE TREE VIEW (folders + docs)
   ============================================================================= */
.tree-folder {
    margin-bottom: 4px;
}

.tree-folder-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background: var(--gray-100);
    border-bottom: 1px solid var(--gray-200);
    position: sticky;
    top: 0;
    z-index: 1;
}

.tree-folder-icon {
    width: 16px;
    height: 16px;
    background: var(--gray-500);
    -webkit-mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'%3E%3Cpath d='M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2v11z'/%3E%3C/svg%3E") center/contain no-repeat;
    mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'%3E%3Cpath d='M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2v11z'/%3E%3C/svg%3E") center/contain no-repeat;
    flex-shrink: 0;
}

.tree-folder-name {
    flex: 1;
    font-size: 12px;
    font-weight: 600;
    color: var(--gray-700);
}

.tree-folder-count {
    font-size: 10px;
    color: var(--gray-400);
    background: var(--gray-200);
    padding: 2px 6px;
    border-radius: 8px;
}

.tree-folder-docs {
    /* Docs are indented under folder */
}

/* =============================================================================
   TOOLBOX (R-Pane)
   ============================================================================= */
.toolbox-description {
    padding: 12px;
    margin: 12px;
    background: var(--gray-50);
    border-radius: 8px;
    font-size: 12px;
    color: var(--gray-500);
    line-height: 1.5;
    text-align: center;
}

.toolbox-section {
    padding: 8px 16px;
}

.toolbox-section-title {
    font-size: 11px;
    font-weight: 600;
    color: var(--gray-500);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
    padding-left: 4px;
}

.toolbox-divider {
    height: 1px;
    background: var(--gray-200);
    margin: 12px 16px;
}

.tools-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
}

.tool-item {
    flex-direction: column;
    text-align: center;
    padding: 12px;
    background: var(--white);
    border: 1px solid var(--gray-200);
    border-radius: 8px;
}

.tool-item:hover {
    border-color: var(--blue-300);
    background: var(--blue-50);
}

.tool-item .toolbox-item-icon {
    margin-bottom: 6px;
}

.tool-item .toolbox-item-info {
    text-align: center;
}

.tool-item .toolbox-item-name {
    font-size: 12px;
    font-weight: 500;
    color: var(--gray-700);
}

.tool-item .toolbox-item-desc {
    display: none;
}

.outputs-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.output-item {
    position: relative;
    background: var(--white);
    border: 1px solid var(--gray-200);
    border-radius: 8px;
    padding: 10px 12px;
}

.output-item:hover {
    border-color: var(--gray-300);
}

.output-item .toolbox-item-name {
    font-size: 13px;
    font-weight: 500;
    color: var(--gray-800);
}

.output-item .toolbox-item-desc {
    font-size: 11px;
    color: var(--gray-400);
}

.output-item.empty .toolbox-item-desc {
    font-style: italic;
}

.output-badge {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    padding: 2px 8px;
    background: var(--green-100);
    color: var(--green-700);
    font-size: 10px;
    font-weight: 600;
    border-radius: 4px;
}

.toolbox-title {
    font-size: var(--font-size-sm);
    font-weight: 600;
    color: var(--gray-500);
    margin-bottom: var(--space-sm);
}

.toolbox-item {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm) var(--space-md);
    margin-bottom: var(--space-xs);
    background: var(--gray-50);
    border-radius: var(--radius-md);
    cursor: pointer;
}

.toolbox-item:hover {
    background: var(--gray-100);
}

.toolbox-item-icon {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-sm);
    font-size: var(--font-size-xs);
    font-weight: 700;
    color: var(--white);
}

.toolbox-item-info {
    flex: 1;
}

.toolbox-item-name {
    font-size: var(--font-size-sm);
    font-weight: 500;
    color: var(--gray-900);
}

.toolbox-item-desc {
    font-size: var(--font-size-xs);
    color: var(--gray-400);
}

/* =============================================================================
   SELECTION BANNER - OVERLAY (not push)
   ============================================================================= */
/* =============================================================================
   SELECTION BANNER - MUST BE OVERLAY (NEVER PUSH CONTENT)
   CRITICAL: Do not change position to relative/static - it must float!
   ============================================================================= */
.selection-banner {
    position: absolute !important;
    top: 12px !important;
    left: 12px !important;
    right: 12px !important;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-sm) var(--space-md);
    background: var(--blue-50);
    border: 1px solid var(--blue-200);
    border-radius: var(--radius-lg);
    z-index: 100 !important;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);
    pointer-events: auto;
}

/* CRITICAL: Analysis container must be position:relative for banner overlay */
.analysis-only-flex {
    position: relative !important;
}

.selection-banner-text {
    font-size: var(--font-size-md);
    color: var(--blue-600);
}

/* =============================================================================
   CHAT MESSAGES
   ============================================================================= */
.chat-messages {
    display: flex;
    flex-direction: column;
    padding: var(--space-md);
}

/* System message */
.msg-system {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-xs);
    padding: var(--space-xs) var(--space-md);
    margin: var(--space-xs) 0;
}

.msg-system-label {
    font-size: var(--font-size-sm);
    font-weight: 500;
    color: var(--gray-400);
}

.msg-system-content {
    font-size: var(--font-size-sm);
    color: var(--gray-400);
}

.msg-system-time {
    font-size: var(--font-size-xs);
    color: var(--gray-400);
}

/* User message */
.msg-user {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    max-width: 85%;
    align-self: flex-end;
    margin-bottom: var(--space-md);
    margin-top: var(--space-lg);
    position: relative;
}

.msg-user-bubble {
    padding: var(--space-sm) var(--space-md);
    background: var(--blue-600);
    color: var(--white);
    border-radius: var(--radius-xl);
    border-bottom-right-radius: var(--radius-sm);
    font-size: var(--font-size-base);
    line-height: 1.5;
}

.msg-user-bubble.tagged {
    border-left: 3px solid var(--amber-500);
}

.msg-user-meta {
    margin-top: var(--space-2xs);
    font-size: var(--font-size-xs);
    color: var(--gray-400);
}

/* Assistant message */
.msg-assistant {
    display: flex;
    flex-direction: column;
    max-width: 90%;
    align-self: flex-start;
    margin-bottom: var(--space-md);
    margin-top: var(--space-lg);
    position: relative;
}

.msg-assistant-header {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    margin-bottom: var(--space-2xs);
}

.msg-assistant-bubble {
    padding: var(--space-md);
    background: var(--white);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-xl);
    border-bottom-left-radius: var(--radius-sm);
}

.msg-assistant-bubble.tagged {
    border-color: var(--amber-500);
    border-left: 3px solid var(--amber-500);
}

.msg-assistant-content {
    font-size: var(--font-size-base);
    line-height: 1.6;
    color: var(--gray-900);
    white-space: pre-wrap;
}

.msg-assistant-meta {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    margin-top: var(--space-2xs);
    font-size: var(--font-size-xs);
    color: var(--gray-400);
}

/* VA Badge */
.va-badge {
    display: inline-flex;
    align-items: center;
    padding: 3px 8px;
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
    font-weight: 700;
    color: var(--white);
}

/* Tag badge */
.tag-badge {
    padding: 2px 6px;
    border-radius: var(--radius-sm);
    font-size: var(--font-size-xs);
    font-weight: 700;
    background: var(--amber-100);
    color: var(--amber-600);
    border: 1px solid var(--amber-500);
}

/* Citations */
.citations {
    margin-top: var(--space-sm);
    padding-top: var(--space-sm);
    border-top: 1px solid var(--gray-200);
}

.citations-title {
    font-size: var(--font-size-xs);
    font-weight: 600;
    color: var(--gray-400);
    margin-bottom: var(--space-2xs);
}

.citation {
    display: flex;
    align-items: flex-start;
    gap: var(--space-xs);
    padding: var(--space-xs);
    margin-top: var(--space-xs);
    background: var(--gray-50);
    border-radius: var(--radius-sm);
    border-left: 3px solid var(--blue-600);
    font-size: var(--font-size-xs);
    cursor: pointer;
}

.citation-source {
    color: var(--blue-600);
    font-weight: 500;
}

.citation-text {
    color: var(--gray-500);
    font-style: italic;
}

/* Flags */
.flag {
    margin-top: var(--space-sm);
    padding: var(--space-xs);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
    border-left: 3px solid;
}

.flag.warning {
    background: var(--amber-50);
    border-color: var(--amber-500);
    color: var(--amber-600);
}

.flag.discrepancy {
    background: var(--red-50);
    border-color: var(--red-500);
    color: var(--red-600);
}

.flag.suggestion {
    background: var(--blue-50);
    border-color: var(--blue-500);
    color: var(--blue-600);
}

/* Hover actions */
.msg-hover-actions {
    position: absolute;
    top: 0;
    right: 8px;
    display: none;
    gap: var(--space-2xs);
    background: var(--white);
    padding: var(--space-2xs) var(--space-xs);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-lg);
    border: 1px solid var(--gray-200);
    z-index: 100;
}

/* Show more button */
.show-more-btn {
    display: block;
    margin-top: var(--space-sm);
    padding: 0;
    background: none;
    border: none;
    color: var(--blue-600);
    font-size: var(--font-size-sm);
    font-weight: 500;
    cursor: pointer;
}

.show-more-btn:hover {
    text-decoration: underline;
}

.msg-user:hover .msg-hover-actions,
.msg-assistant:hover .msg-hover-actions,
.msg-hover-actions:hover {
    display: flex;
}

.msg-assistant .msg-hover-actions {
    right: auto;
    left: 8px;
}

.hover-action-btn {
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--white);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-sm);
    color: var(--gray-500);
    font-size: var(--font-size-xs);
}

.hover-action-btn:hover {
    background: var(--gray-50);
}

.hover-action-btn.active {
    background: var(--blue-600);
    color: var(--white);
    border-color: var(--blue-600);
}

/* Search highlights */
.highlight-match {
    background: #fef08a;
    padding: 1px 2px;
    border-radius: 2px;
}

.highlight-typo {
    background: #bfdbfe;
    padding: 1px 2px;
    border-radius: 2px;
}

/* Search document items */
.search-doc-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    margin-bottom: 8px;
    background: #fff;
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-lg);
    cursor: pointer;
    position: relative;
}

.search-doc-item.tagged {
    border-color: var(--amber-500);
}

.search-doc-item:hover {
    background: var(--gray-50);
}

.search-doc-item .doc-hover-actions {
    position: absolute;
    top: 0;
    right: 8px;
    display: none;
    gap: var(--space-2xs);
    background: var(--white);
    padding: var(--space-2xs) var(--space-xs);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-lg);
    border: 1px solid var(--gray-200);
    z-index: 100;
}

.search-doc-item:hover .doc-hover-actions,
.search-doc-item .doc-hover-actions:hover {
    display: flex;
}

.doc-tag-badge {
    position: absolute;
    top: 8px;
    left: 8px;
    background: var(--amber-100);
    color: var(--amber-600);
    font-size: 10px;
    font-weight: 700;
    padding: 2px 6px;
    border-radius: 4px;
}

.doc-icon {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-sm);
    font-size: var(--font-size-xs);
    font-weight: 700;
    color: white;
    flex-shrink: 0;
}

.doc-details {
    flex: 1;
}

.doc-name-search {
    font-size: 14px;
    font-weight: 500;
    color: var(--gray-900);
}

.doc-meta-search {
    font-size: 12px;
    color: var(--gray-400);
}

/* =============================================================================
   CHAT INPUT
   ============================================================================= */
.chat-input-wrapper {
    height: var(--pane-footer-h);
    min-height: var(--pane-footer-h);
    display: flex;
    align-items: center;
    padding: 0 var(--space-md);
    background: var(--white);
    border-top: 1px solid var(--gray-200);
    flex-shrink: 0;
}

.chat-input {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    flex: 1;
    height: var(--chat-input-h);
    padding: 0 var(--space-sm);
    background: var(--white);
    border: 2px solid var(--gray-200);
    border-radius: var(--radius-2xl);
    box-shadow: var(--shadow-input);
}

.chat-input input {
    flex: 1;
    height: 100%;
    border: none;
    background: transparent;
    font-size: var(--font-size-base);
    color: var(--gray-900);
    outline: none;
}

.chat-input input::placeholder {
    color: var(--gray-400);
}

.chat-clear-btn {
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    background: var(--gray-200);
    color: var(--gray-500);
    border-radius: 50%;
    font-size: 10px;
    cursor: pointer;
    flex-shrink: 0;
}

.chat-clear-btn:hover {
    background: var(--gray-300);
    color: var(--gray-700);
}

.chat-btns {
    display: flex;
    align-items: center;
    gap: 3px;
}

.chat-btn {
    width: var(--chat-btn-size);
    height: var(--chat-btn-size);
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-md);
    background: transparent;
    border: none;
    color: var(--gray-500);
    font-size: var(--font-size-sm);
}

.chat-btn:hover {
    background: var(--gray-100);
}

.chat-btn.active {
    background: var(--blue-600);
    color: var(--white);
}

.chat-btn.context-toggle {
    font-weight: 700;
}

.chat-btn.context-toggle.search {
    background: var(--blue-600);
    color: var(--white);
}

.chat-btn.context-toggle.analysis {
    background: var(--white);
    color: var(--blue-600);
    border: 2px solid var(--blue-600);
}

.chat-divider {
    width: 1px;
    height: 24px;
    background: var(--gray-200);
    margin: 0 var(--space-2xs);
}

/* =============================================================================
   DROPDOWNS
   ============================================================================= */
.dropdown {
    position: relative;
}

.dropdown-menu {
    position: absolute;
    top: calc(100% + 8px);
    left: 0;
    background: var(--white);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    z-index: 1000;
    display: none;
    min-width: 280px;
}

.dropdown-menu.open, .dropdown-menu.show {
    display: block;
}

.dropdown-search {
    padding: var(--space-sm);
    border-bottom: 1px solid var(--gray-100);
}

.dropdown-search-input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-md);
    font-size: var(--font-size-sm);
    color: var(--gray-900);
}

.dropdown-search-input:focus {
    outline: none;
    border-color: var(--blue-400);
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
}

.dropdown-search-input::placeholder {
    color: var(--gray-400);
}

.dropdown-header {
    padding: var(--space-sm) var(--space-md);
    border-bottom: 1px solid var(--gray-200);
    font-size: var(--font-size-sm);
    font-weight: 600;
    color: var(--gray-900);
}

.dropdown-section {
    border-bottom: 1px solid var(--gray-200);
}

.dropdown-section:last-child {
    border-bottom: none;
}

.dropdown-section-header {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-sm) var(--space-md);
    background: var(--gray-50);
    cursor: pointer;
}

.dropdown-section-arrow {
    font-size: var(--font-size-xs);
    color: var(--gray-400);
}

.dropdown-section-title {
    flex: 1;
    font-size: var(--font-size-sm);
    font-weight: 600;
    color: var(--gray-900);
}

.dropdown-section-add {
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: none;
    color: var(--gray-400);
    font-size: var(--font-size-lg);
}

.dropdown-section-add:hover {
    color: var(--gray-600);
}

.dropdown-section-content {
    display: none;
}

.dropdown-section-content.open {
    display: block;
}

.dropdown-item {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-xs) var(--space-md);
    cursor: pointer;
}

.dropdown-item:hover {
    background: var(--gray-50);
}

.dropdown-item.selected {
    background: var(--blue-50);
}

.dropdown-item-icon {
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-sm);
    font-size: var(--font-size-xs);
    font-weight: 700;
    color: var(--white);
}

.dropdown-item-info {
    flex: 1;
}

.dropdown-item-name {
    font-size: var(--font-size-sm);
    font-weight: 500;
    color: var(--gray-900);
}

.dropdown-item-name.selected {
    color: var(--blue-600);
}

.dropdown-item-desc {
    font-size: var(--font-size-xs);
    color: var(--gray-400);
}

/* Favorites dropdown */
.favorites-dropdown {
    width: 320px;
    max-height: 300px;
    overflow-y: auto;
}

.favorite-item {
    padding: var(--space-xs) var(--space-md);
    cursor: pointer;
    border-bottom: 1px solid var(--gray-100);
}

.favorite-item:hover {
    background: var(--gray-50);
}

.favorite-text {
    font-size: var(--font-size-sm);
    color: var(--gray-900);
}

.favorite-category {
    font-size: var(--font-size-xs);
    color: var(--gray-400);
}

/* VA dropdown */
.va-dropdown {
    width: 280px;
    max-height: 400px;
    overflow-y: auto;
}

/* =============================================================================
   MODALS
   ============================================================================= */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 25000;
}

.modal-overlay.open {
    display: flex;
}

.modal {
    width: 100%;
    max-width: 540px;
    max-height: 85vh;
    background: var(--white);
    border-radius: 16px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.modal-header {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 28px 32px 20px;
    border-bottom: 1px solid var(--gray-200);
    text-align: center;
    position: relative;
}

.modal-title {
    font-size: 22px;
    font-weight: 700;
    color: var(--brand-primary, var(--blue-600));
    letter-spacing: 2px;
    text-transform: uppercase;
}

.modal-subtitle {
    font-size: 13px;
    color: var(--gray-500);
    margin-top: 4px;
}

.modal-close {
    position: absolute;
    top: 16px;
    right: 16px;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: none;
    border-radius: var(--radius-sm);
    color: var(--gray-500);
    font-size: 18px;
    cursor: pointer;
}

.modal-close:hover {
    background: var(--gray-100);
}

.modal-body {
    flex: 1;
    overflow-y: auto;
    padding: var(--space-lg);
}

.modal-footer {
    display: flex;
    justify-content: center;
    gap: var(--space-sm);
    padding: 20px 32px;
    border-top: 1px solid var(--gray-200);
}

.modal-copyright {
    text-align: center;
    padding: 12px;
    font-size: 10px;
    letter-spacing: 1.5px;
    color: var(--gray-400);
    border-top: 1px solid var(--gray-100);
}

/* Form elements */
.form-group {
    margin-bottom: var(--space-md);
}

.form-label {
    display: block;
    font-size: var(--font-size-sm);
    font-weight: 500;
    color: var(--gray-900);
    margin-bottom: var(--space-xs);
}

.form-input {
    width: 100%;
    padding: var(--space-xs);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-base);
}

.form-input:focus {
    outline: none;
    border-color: var(--blue-500);
}

.form-textarea {
    width: 100%;
    padding: var(--space-xs);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-base);
    resize: vertical;
}

/* =============================================================================
   BUTTONS
   ============================================================================= */
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-xs);
    height: 36px;
    padding: 0 var(--space-md);
    border-radius: var(--radius-md);
    font-size: var(--font-size-sm);
    font-weight: 500;
    cursor: pointer;
    border: none;
}

.btn-primary {
    background: var(--blue-600);
    color: var(--white);
}

.btn-primary:hover {
    background: var(--blue-700);
}

.btn-secondary {
    background: transparent;
    color: var(--gray-700);
    border: 1px solid var(--gray-200);
}

.btn-secondary:hover {
    background: var(--gray-50);
}

.btn-ghost {
    background: transparent;
    color: var(--gray-500);
}

.btn-ghost:hover {
    background: var(--gray-100);
}

.btn-sm {
    height: 28px;
    padding: 0 var(--space-sm);
    font-size: var(--font-size-xs);
}

/* =============================================================================
   UTILITIES
   ============================================================================= */
.hidden {
    display: none !important;
}

.text-muted {
    color: var(--gray-400);
}

.text-sm {
    font-size: var(--font-size-sm);
}

.text-xs {
    font-size: var(--font-size-xs);
}

/* =============================================================================
   v9.0 REACT ADDITIONS
   ============================================================================= */

/* Uniform Item System */
.item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 14px;
    margin-bottom: 6px;
    background: var(--gray-50);
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.15s;
}
.item:hover { background: var(--gray-100); }
.item.selected { background: var(--blue-50); border: 1px solid var(--blue-200); }

.item-icon {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--blue-100);
    color: var(--blue-600);
    border-radius: 8px;
    flex-shrink: 0;
}
.item-icon svg { width: 18px; height: 18px; stroke-width: 2; }
.item-icon.folder { background: var(--blue-100); color: var(--blue-600); }
.item-icon.file { background: var(--gray-100); color: var(--gray-600); }
.item-icon.file.pdf { background: #fee2e2; color: #dc2626; }
.item-icon.file.docx { background: #dbeafe; color: #2563eb; }
.item-icon.file.xlsx { background: #dcfce7; color: #16a34a; }
.item-icon.file.mpp { background: #f3e8ff; color: #7c3aed; }
.item-icon.file.msg { background: #cffafe; color: #0891b2; }
.item-icon.tool { background: var(--blue-100); color: var(--blue-600); }
.item-icon.output { background: var(--green-100); color: var(--green-600); }

.item-info { flex: 1; min-width: 0; }
.item-name { font-size: 13px; font-weight: 500; color: var(--gray-800); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.item-desc { font-size: 11px; color: var(--gray-400); }
.item-badge { padding: 2px 6px; background: var(--gray-100); color: var(--gray-500); font-size: 9px; font-weight: 600; border-radius: 4px; }
.item-badge.count { min-width: 20px; text-align: center; }
.item-badge.count.active { background: var(--blue-100); color: var(--blue-600); }
.item-check { width: 16px; height: 16px; accent-color: var(--blue-600); }

/* Mini Icons */
.mini-icon {
    width: 32px; height: 32px;
    display: flex; align-items: center; justify-content: center;
    border-radius: 6px; font-size: 11px; font-weight: 700;
    color: white; cursor: pointer;
}
.mini-icon svg { width: 16px; height: 16px; }
.mini-icon.blue { background: var(--blue-500); }
.mini-icon.green { background: var(--green-500); }

/* Header Buttons */
.header-btn {
    width: 32px; height: 32px;
    display: flex; align-items: center; justify-content: center;
    background: transparent; border: 1px solid var(--gray-200);
    border-radius: 6px; cursor: pointer; color: var(--gray-600);
}
.header-btn:hover { background: var(--gray-100); }
.header-btn svg { width: 16px; height: 16px; }

/* Framework Badge */
.framework-badge {
    padding: 4px 10px; font-size: 11px; font-weight: 700;
    border-radius: 6px; text-transform: uppercase;
}
.framework-badge.rics { background: #dbeafe; color: #1d4ed8; }
.framework-badge.far { background: #fef3c7; color: #92400e; }
.framework-badge.fidic { background: #e0e7ff; color: #3730a3; }
.framework-badge.nec { background: #fce7f3; color: #9d174d; }
.framework-badge.custom { background: #f3f4f6; color: #374151; }

/* Dropdown Menus */
.dropdown { position: relative; }
.dropdown-menu {
    display: none; position: absolute;
    top: calc(100% + 8px); left: 0;
    min-width: 280px; background: white;
    border: 1px solid var(--gray-200);
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    z-index: 1000; overflow: hidden;
}
.dropdown-menu.show { display: block; }
.dropdown-menu.settings-dropdown { right: 0; left: auto; min-width: 220px; }
.dropdown-search { padding: 12px; border-bottom: 1px solid var(--gray-100); }
.dropdown-search-input {
    width: 100%; padding: 10px 14px;
    border: 1px solid var(--gray-200); border-radius: 8px;
    font-size: 13px; outline: none;
}
.dropdown-header {
    padding: 10px 16px; font-size: 11px; font-weight: 600;
    color: var(--gray-400); text-transform: uppercase;
}
.dropdown-footer { padding: 10px; border-top: 1px solid var(--gray-100); }
.dropdown-action-btn {
    display: flex; align-items: center; gap: 10px;
    width: 100%; padding: 10px 14px;
    background: transparent; border: 1px dashed var(--gray-300);
    border-radius: 8px; font-size: 13px; font-weight: 500;
    color: var(--gray-600); cursor: pointer;
}
.dropdown-action-btn:hover { background: var(--blue-50); border-color: var(--blue-300); color: var(--blue-600); }
.dropdown-action-icon {
    width: 22px; height: 22px;
    display: flex; align-items: center; justify-content: center;
    background: var(--gray-100); border-radius: 6px;
}

/* Vault Items */
.vault-item {
    display: flex; align-items: center; gap: 8px;
    padding: 10px 14px; cursor: pointer;
}
.vault-item:hover { background: var(--blue-50); }
.vault-item.selected { background: var(--blue-50); }
.vault-item-name { font-size: 13px; font-weight: 500; color: var(--gray-900); }
.vault-item-meta { font-size: 11px; color: var(--gray-500); margin-left: auto; margin-right: 8px; }
.vault-item-badge { padding: 2px 8px; background: var(--blue-100); color: var(--blue-700); font-size: 10px; font-weight: 700; border-radius: 4px; }
.vault-badge { padding: 4px 10px; background: var(--blue-100); color: var(--blue-700); font-size: 11px; font-weight: 700; border-radius: 6px; }

/* Case Items */
.case-item { display: flex; align-items: center; gap: 10px; padding: 12px 16px; cursor: pointer; }
.case-item:hover { background: var(--gray-50); }
.case-item-name { flex: 1; font-size: 13px; font-weight: 500; color: var(--gray-800); }
.case-id-badge { padding: 4px 10px; background: var(--blue-100); color: var(--blue-700); font-size: 11px; font-weight: 700; border-radius: 6px; }
.evidence-id-badge { padding: 2px 6px; background: #f3e8ff; color: #7c3aed; font-size: 9px; font-weight: 700; border-radius: 4px; }

/* Settings Menu */
.settings-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; cursor: pointer; }
.settings-item:hover { background: var(--gray-50); }
.settings-icon { width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; color: var(--gray-500); }
.settings-icon svg { width: 16px; height: 16px; }
.settings-label { flex: 1; font-size: 13px; color: var(--gray-700); }
.settings-toggle { font-size: 11px; font-weight: 600; color: var(--gray-400); }
.settings-divider { height: 1px; background: var(--gray-100); margin: 8px 0; }

/* C-Pane Header */
.cpane-header-content { display: flex; align-items: center; gap: 10px; flex: 1; }
.cpane-workspace { font-size: 12px; color: var(--gray-400); font-style: italic; }
.cpane-selection { font-size: 12px; color: var(--gray-500); cursor: pointer; padding: 4px 8px; border-radius: 4px; }
.cpane-selection:hover { background: var(--gray-100); }

/* Chat Buttons */
.chat-btns { display: flex; align-items: center; gap: 4px; }
.chat-btn {
    width: 36px; height: 36px;
    display: flex; align-items: center; justify-content: center;
    background: transparent; border: none; border-radius: 8px;
    color: var(--gray-500); font-size: 13px; font-weight: 600; cursor: pointer;
}
.chat-btn:hover { background: var(--gray-100); }
.chat-btn svg { width: 18px; height: 18px; }
.chat-btn.context-toggle { width: 36px; height: 36px; border-radius: 8px; font-weight: 700; }
.chat-btn.context-toggle.search { background: white; color: var(--blue-600); border: 2px solid var(--blue-600); }
.chat-btn.context-toggle.analysis { background: var(--blue-600); color: white; border: 2px solid var(--blue-600); }
.chat-divider { width: 1px; height: 24px; background: var(--gray-200); margin: 0 4px; }

/* Section Headers */
.section-header {
    font-size: 10px; font-weight: 600; color: var(--gray-400);
    text-transform: uppercase; letter-spacing: 0.5px;
    padding: 12px 16px 8px;
}

/* Items List & Children */
.items-list { padding: 0 12px; overflow-y: auto; flex: 1; }
.item-children { padding-left: 48px; display: none; }
.item-children.open { display: block; }

/* Modal System */
.modal-overlay {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    display: none; align-items: center; justify-content: center;
    z-index: 10000;
}
.modal-overlay.open { display: flex; }
.modal {
    background: white; border-radius: 16px;
    max-width: 500px; width: 90%;
    max-height: 90vh; overflow: hidden;
    box-shadow: 0 25px 50px rgba(0,0,0,0.25);
}
.modal-lg { max-width: 700px; }
.modal-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 16px 20px; border-bottom: 1px solid var(--gray-200);
}
.modal-title { font-size: 16px; font-weight: 600; color: var(--gray-900); }
.modal-close {
    width: 28px; height: 28px;
    display: flex; align-items: center; justify-content: center;
    background: var(--gray-100); border: none; border-radius: 6px;
    font-size: 16px; color: var(--gray-500); cursor: pointer;
}
.modal-close:hover { background: var(--gray-200); }
.modal-body { padding: 20px; max-height: 60vh; overflow-y: auto; }
.modal-footer { padding: 16px 20px; border-top: 1px solid var(--gray-200); display: flex; gap: 8px; justify-content: flex-end; }
.modal-copyright { padding: 12px 20px; font-size: 11px; color: var(--gray-400); text-align: center; border-top: 1px solid var(--gray-100); }

/* Landing Overlay */
.landing-overlay {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(15, 23, 42, 0.8);
    display: flex; align-items: center; justify-content: center;
    z-index: 99999;
}
.landing-overlay.hidden { display: none; }
.landing-modal {
    background: white; border-radius: 20px;
    width: 480px; max-width: 90%; padding: 32px;
    box-shadow: 0 25px 50px rgba(0,0,0,0.3);
}
.landing-header { text-align: center; margin-bottom: 24px; }
.landing-title { font-size: 28px; font-weight: 300; letter-spacing: 4px; color: var(--gray-800); margin: 0; }
.landing-subtitle { font-size: 13px; color: var(--gray-500); margin-top: 4px; }
.landing-version {
    display: inline-flex; align-items: center; gap: 8px;
    margin-top: 12px; padding: 6px 12px;
    background: var(--gray-50); border-radius: 20px;
    font-size: 11px; color: var(--gray-500); cursor: pointer;
}
.landing-version:hover { background: var(--gray-100); }
.landing-version-badge { background: var(--blue-600); color: white; padding: 2px 8px; border-radius: 4px; font-weight: 700; }
.landing-search { margin-bottom: 24px; }
.landing-search-input {
    width: 100%; padding: 14px 16px;
    border: 1px solid var(--gray-200); border-radius: 12px;
    font-size: 14px; outline: none;
}
.landing-search-input:focus { border-color: var(--blue-500); }
.landing-section { margin-bottom: 24px; }
.landing-section-title { font-size: 11px; font-weight: 600; color: var(--gray-400); text-transform: uppercase; margin-bottom: 12px; }
.landing-cases { display: flex; flex-direction: column; gap: 8px; }
.landing-case-item {
    display: flex; align-items: center; gap: 12px;
    padding: 12px 16px; background: var(--gray-50);
    border-radius: 10px; cursor: pointer;
}
.landing-case-item:hover { background: var(--gray-100); }
.landing-case-info { flex: 1; }
.landing-case-name { font-size: 14px; font-weight: 500; color: var(--gray-800); }
.landing-case-meta { font-size: 11px; color: var(--gray-500); }
.landing-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
.landing-action-card {
    display: flex; align-items: center; gap: 12px;
    padding: 16px; background: var(--gray-50);
    border: 1px dashed var(--gray-300); border-radius: 12px; cursor: pointer;
}
.landing-action-card:hover { background: var(--blue-50); border-color: var(--blue-300); }
.landing-action-icon {
    width: 40px; height: 40px;
    display: flex; align-items: center; justify-content: center;
    background: var(--gray-200); border-radius: 10px;
    font-size: 20px; font-weight: 300;
}
.landing-action-icon.create { background: var(--blue-100); color: var(--blue-600); }
.landing-action-icon.browse { background: var(--green-100); color: var(--green-600); }
.landing-action-title { font-size: 13px; font-weight: 600; color: var(--gray-800); }
.landing-action-desc { font-size: 11px; color: var(--gray-500); }

/* Wizard */
.modal-wizard-compact { max-width: 560px; }
.wizard-compact-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 16px 20px; background: var(--gray-50); border-bottom: 1px solid var(--gray-200);
}
.wizard-compact-title { font-size: 15px; font-weight: 600; color: var(--gray-800); }
.wizard-compact-steps { display: flex; align-items: center; gap: 8px; }
.wcs { font-size: 11px; color: var(--gray-400); padding: 4px 8px; border-radius: 4px; }
.wcs.active { background: var(--blue-100); color: var(--blue-600); font-weight: 600; }
.wcs.done { color: var(--green-600); }
.wcs-dot { width: 4px; height: 4px; background: var(--gray-300); border-radius: 50%; }
.wizard-close-btn {
    width: 28px; height: 28px;
    display: flex; align-items: center; justify-content: center;
    background: transparent; border: none;
    font-size: 20px; color: var(--gray-400); cursor: pointer;
}
.wizard-compact-body { padding: 24px; }
.wizard-compact-body.hidden { display: none; }
.wizard-compact-footer {
    display: flex; align-items: center; justify-content: space-between;
    padding: 16px 20px; background: var(--gray-50); border-top: 1px solid var(--gray-200);
}
.wiz-mode-cards { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.wiz-mode-card {
    padding: 20px; border: 2px solid var(--gray-200);
    border-radius: 12px; cursor: pointer; text-align: center;
}
.wiz-mode-card:hover { border-color: var(--blue-300); background: var(--blue-50); }
.wiz-mode-card.selected { border-color: var(--blue-500); background: var(--blue-50); }
.wiz-mode-card-icon { margin-bottom: 12px; }
.wiz-mode-card-icon svg { width: 32px; height: 32px; color: var(--blue-600); }
.wiz-mode-card-title { font-size: 14px; font-weight: 600; color: var(--gray-800); display: block; }
.wiz-mode-card-desc { font-size: 11px; color: var(--gray-500); }
.wiz-field { margin-bottom: 16px; }
.wiz-label { display: block; font-size: 12px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px; }
.wiz-req { color: var(--red-500); }
.wiz-input {
    width: 100%; padding: 10px 14px;
    border: 1px solid var(--gray-200); border-radius: 8px;
    font-size: 13px; outline: none;
}
.wiz-input:focus { border-color: var(--blue-500); }
.wiz-select {
    width: 100%; padding: 10px 14px;
    border: 1px solid var(--gray-200); border-radius: 8px;
    font-size: 13px; background: white;
}

/* Evidence Modal */
.evidence-stats {
    display: grid; grid-template-columns: repeat(3, 1fr);
    gap: 12px; margin-bottom: 24px;
}
.evidence-stat {
    padding: 16px; background: var(--gray-50);
    border-radius: 8px; text-align: center;
}
.evidence-stat-value { font-size: 20px; font-weight: 700; color: var(--blue-600); display: block; }
.evidence-stat-label { font-size: 11px; color: var(--gray-500); }
.evidence-list { border: 1px solid var(--gray-200); border-radius: 8px; overflow: hidden; }
.evidence-item {
    display: flex; align-items: center; gap: 12px;
    padding: 10px 16px; border-bottom: 1px solid var(--gray-100);
    transition: background 0.15s;
}
.evidence-item:hover { background: var(--gray-50); }
.evidence-item:last-child { border-bottom: none; }
.evidence-item.selected { background: var(--blue-50); }
.evidence-item:hover .add-tag-btn { opacity: 1 !important; }
.evidence-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--gray-200); }
.evidence-dot.active { background: var(--green-500); }

/* Time Tracker */
.time-tracker-display { text-align: center; padding: 24px 0; }
.time-tracker-clock { font-size: 48px; font-weight: 200; color: var(--gray-800); font-family: monospace; }
.time-tracker-case { font-size: 13px; color: var(--gray-500); margin-top: 8px; }
.time-tracker-controls { display: flex; gap: 12px; justify-content: center; margin-top: 16px; }

/* Buttons */
.btn {
    padding: 10px 20px; border-radius: 8px;
    font-size: 13px; font-weight: 600; cursor: pointer; border: none;
}
.btn-primary { background: var(--blue-600); color: white; }
.btn-primary:hover { background: var(--blue-700); }
.btn-secondary { background: var(--gray-100); color: var(--gray-700); }
.btn-secondary:hover { background: var(--gray-200); }
.btn-sm { padding: 6px 12px; font-size: 12px; }
.btn-ghost { background: transparent; color: var(--gray-600); }

/* Progress Bar & Notifications */
.page-progress {
    position: fixed; top: 50px; left: 0; right: 0;
    height: 2px; background: transparent;
    z-index: 999999; overflow: hidden; display: none;
}
.page-progress.active { display: block; }
.page-progress-bar {
    position: absolute; top: 0; height: 100%;
    width: 30%; background: var(--blue-600);
    animation: progress-slide 1s ease-in-out infinite;
}
@keyframes progress-slide { 0% { left: -30%; } 100% { left: 100%; } }

.notification-banner {
    position: fixed; top: 0; left: 0; right: 0;
    height: 44px; display: none; align-items: center; gap: 12px;
    padding: 0 16px; background: var(--blue-50);
    border-bottom: 1px solid var(--blue-200);
    color: var(--blue-700); font-size: 13px; z-index: 99999;
}
.notification-banner.show { display: flex; }
.notification-banner.success { background: #d1fae5; border-color: #a7f3d0; color: #065f46; }
.notification-banner.warning { background: #fef3c7; border-color: #fde68a; color: #92400e; }
.notification-banner.alert { background: #fee2e2; border-color: #fecaca; color: #991b1b; }
.banner-icon {
    width: 20px; height: 20px;
    display: flex; align-items: center; justify-content: center;
    background: var(--blue-500); border-radius: 50%;
    color: white; font-size: 11px; font-weight: 700;
}
.banner-text { flex: 1; font-weight: 500; }
.banner-action { background: var(--blue-600); color: white; border: none; border-radius: 4px; padding: 6px 12px; font-size: 11px; font-weight: 600; cursor: pointer; }
.banner-dismiss { background: none; border: none; color: inherit; opacity: 0.6; cursor: pointer; font-size: 16px; }

.notification-center {
    position: fixed; top: 60px; right: 16px;
    width: 320px; display: flex; flex-direction: column; gap: 12px;
    z-index: 10001; pointer-events: none;
}
.notification-item {
    display: flex; align-items: flex-start; gap: 12px;
    padding: 12px 16px; background: white;
    border: 1px solid var(--gray-200); border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    pointer-events: auto;
}
.notification-icon {
    width: 20px; height: 20px;
    display: flex; align-items: center; justify-content: center;
    border-radius: 50%; color: white; font-size: 11px; font-weight: 700;
}
.notification-item.success .notification-icon { background: var(--green-500); }
.notification-item.info .notification-icon { background: var(--blue-500); }
.notification-item.warning .notification-icon { background: var(--amber-500); }
.notification-item.error .notification-icon { background: var(--red-500); }
.notification-text { flex: 1; font-size: 13px; color: var(--gray-700); }
.notification-close { background: none; border: none; color: var(--gray-400); cursor: pointer; font-size: 14px; }
/* Wizard Mode Description */
.wiz-mode-description {
    margin-top: 16px;
    padding: 16px;
    background: var(--gray-50);
    border: 1px solid var(--gray-200);
    border-radius: 10px;
}
.wiz-mode-desc-title { font-size: 14px; font-weight: 600; color: var(--gray-900); margin-bottom: 8px; }
.wiz-mode-desc-text { font-size: 12px; line-height: 1.6; color: var(--gray-600); margin-bottom: 12px; }
.wiz-mode-desc-steps { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
.wiz-step-pill { padding: 4px 10px; background: var(--blue-100); color: var(--blue-700); font-size: 11px; font-weight: 500; border-radius: 12px; }
.wiz-step-arrow { color: var(--gray-400); font-size: 12px; }
.wiz-mode-desc-hint {
    display: flex; align-items: center; gap: 6px;
    font-size: 11px; color: #d97706;
    padding: 8px 12px; background: #fef3c7; border-radius: 6px;
}

/* ID Configuration */
.wiz-id-config { background: var(--gray-50); border: 1px solid var(--gray-200); border-radius: 10px; padding: 14px; margin-bottom: 14px; }
.wiz-id-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
.wiz-id-title { font-size: 13px; font-weight: 600; color: var(--gray-800); }
.wiz-id-toggle { display: flex; gap: 12px; }
.wiz-radio { display: flex; align-items: center; gap: 4px; font-size: 12px; color: var(--gray-600); cursor: pointer; }
.wiz-id-fields { margin-bottom: 12px; }
.wiz-id-row { display: flex; gap: 12px; align-items: flex-end; }
.wiz-id-group { flex: 1; }
.wiz-id-label { display: block; font-size: 10px; color: var(--gray-500); margin-bottom: 4px; }
.wiz-sep-btns { display: flex; gap: 4px; }
.wiz-sep-btn {
    width: 32px; height: 32px;
    display: flex; align-items: center; justify-content: center;
    border: 1px solid var(--gray-300); border-radius: 6px;
    background: white; font-size: 14px; cursor: pointer;
}
.wiz-sep-btn:hover { border-color: var(--blue-300); }
.wiz-sep-btn.active { background: var(--blue-100); border-color: var(--blue-500); color: var(--blue-700); }
.wiz-select-sm { padding: 6px 8px; border: 1px solid var(--gray-300); border-radius: 6px; font-size: 12px; }
.wiz-input-sm { width: 60px; padding: 6px 8px; border: 1px solid var(--gray-300); border-radius: 6px; font-size: 12px; text-align: center; }
.wiz-id-preview { display: flex; align-items: center; gap: 8px; padding-top: 10px; border-top: 1px solid var(--gray-200); }
.wiz-id-preview-label { font-size: 11px; color: var(--gray-500); }
.wiz-id-preview-value { font-size: 13px; font-weight: 600; color: var(--gray-900); font-family: monospace; }
.wiz-id-preview-arrow { color: var(--gray-400); }
.wiz-id-preview-hint { font-size: 10px; color: var(--gray-400); margin-left: auto; }
.wiz-info-note {
    display: flex; align-items: center; gap: 8px;
    padding: 10px 12px; background: var(--blue-50); border-radius: 8px;
    font-size: 11px; color: var(--blue-700);
}
.wiz-row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

/* Card Row */
.wiz-card-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
.wiz-card {
    padding: 12px; border: 2px solid var(--gray-200); border-radius: 10px;
    cursor: pointer; text-align: center; transition: all 0.15s;
}
.wiz-card:hover { border-color: var(--blue-300); }
.wiz-card.active { border-color: var(--blue-500); background: var(--blue-50); }
.wiz-card-name { display: block; font-size: 13px; font-weight: 600; color: var(--gray-800); }
.wiz-card-hint { display: block; font-size: 10px; color: var(--gray-500); margin-top: 2px; }

/* Upload Zone */
.wiz-zt-banner {
    display: flex; align-items: center; gap: 12px;
    padding: 12px 16px; background: #d1fae5; border-radius: 10px; margin-bottom: 16px;
}
.wiz-zt-text { flex: 1; }
.wiz-zt-title { display: block; font-size: 13px; font-weight: 600; color: #065f46; }
.wiz-zt-desc { display: block; font-size: 11px; color: #047857; }
.wiz-upload-zone {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    padding: 32px; border: 2px dashed var(--gray-300); border-radius: 12px;
    cursor: pointer; transition: all 0.15s;
}
.wiz-upload-zone:hover { border-color: var(--blue-400); background: var(--blue-50); }
.wiz-upload-text { font-size: 13px; font-weight: 500; color: var(--gray-700); margin-top: 8px; }
.wiz-upload-hint { font-size: 11px; color: var(--gray-400); }

/* Review Grid */
.wiz-review-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.wiz-review-item { display: flex; justify-content: space-between; padding: 8px 12px; background: var(--gray-50); border-radius: 6px; }
.wiz-review-label { font-size: 12px; color: var(--gray-500); }
.wiz-review-value { font-size: 12px; font-weight: 600; color: var(--gray-900); }
    </style>
</head>
<body class="mode-analysis framework-rics">
    <div id="root"></div>
    <script type="text/javascript">
var ThemisApp = (() => {
  var __require = /* @__PURE__ */ ((x) => typeof require !== "undefined" ? require : typeof Proxy !== "undefined" ? new Proxy(x, {
    get: (a, b) => (typeof require !== "undefined" ? require : a)[b]
  }) : x)(function(x) {
    if (typeof require !== "undefined") return require.apply(this, arguments);
    throw Error('Dynamic require of "' + x + '" is not supported');
  });

  // themis.jsx
  var { useState, createContext, useContext, useEffect, useRef, useCallback } = React;
  var API_BASE = "http://localhost:9998/themis";
  var WS_URL = "ws://localhost:9998/themis/ws";
  var ThemisAPI = {
    // Health check with 2s timeout
    health: async function() {
      try {
        const controller = new AbortController();
        setTimeout(() => controller.abort(), 2e3);
        const res = await fetch(API_BASE + "/api/health", { signal: controller.signal });
        return res.ok;
      } catch (e) {
        return false;
      }
    },
    // Health with full data (version, uptime, etc.)
    healthFull: async function() {
      try {
        const controller = new AbortController();
        setTimeout(() => controller.abort(), 2e3);
        const res = await fetch(API_BASE + "/api/health", { signal: controller.signal });
        if (res.ok) return await res.json();
        return null;
      } catch (e) {
        return null;
      }
    },
    // Service Control (launchd)
    service: {
      status: () => fetch(API_BASE + "/api/service/status").then((r) => r.ok ? r.json() : null).catch(() => null),
      start: () => fetch(API_BASE + "/api/service/control", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: "start" })
      }).then((r) => r.ok ? r.json() : null).catch(() => null),
      stop: () => fetch(API_BASE + "/api/service/control", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: "stop" })
      }).then((r) => r.ok ? r.json() : null).catch(() => null),
      restart: () => fetch(API_BASE + "/api/service/control", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: "restart" })
      }).then((r) => r.ok ? r.json() : null).catch(() => null),
      logs: (lines = 50) => fetch(API_BASE + "/api/service/logs?lines=" + lines).then((r) => r.ok ? r.json() : null).catch(() => null)
    },
    // Cases (SAD 9.2)
    cases: {
      list: () => fetch(API_BASE + "/api/cases").then((r) => r.ok ? r.json() : null).catch(() => null),
      get: (id) => fetch(API_BASE + "/api/cases/" + id).then((r) => r.ok ? r.json() : null).catch(() => null),
      create: (data) => fetch(API_BASE + "/api/cases", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      }).then((r) => r.ok ? r.json() : null).catch(() => null),
      update: (id, data) => fetch(API_BASE + "/api/cases/" + id, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      }).then((r) => r.ok ? r.json() : null).catch(() => null),
      archive: (id) => fetch(API_BASE + "/api/cases/" + id, { method: "DELETE" }).then((r) => r.ok).catch(() => false),
      open: (id) => fetch(API_BASE + "/api/cases/" + id + "/open", { method: "POST" }).then((r) => r.ok ? r.json() : null).catch(() => null),
      close: (id) => fetch(API_BASE + "/api/cases/" + id + "/close", { method: "POST" }).then((r) => r.ok).catch(() => false),
      search: (q) => fetch(API_BASE + "/api/cases/search?q=" + encodeURIComponent(q)).then((r) => r.ok ? r.json() : null).catch(() => null)
    },
    // Evidence (SAD 9.3)
    evidence: {
      list: (caseId) => fetch(API_BASE + "/api/evidence?case_id=" + caseId).then((r) => r.ok ? r.json() : null).catch(() => null),
      get: (id) => fetch(API_BASE + "/api/evidence/" + id).then((r) => r.ok ? r.json() : null).catch(() => null),
      upload: (caseId, file, onProgress) => new Promise((resolve) => {
        const formData = new FormData();
        formData.append("file", file);
        formData.append("case_id", caseId);
        const xhr = new XMLHttpRequest();
        xhr.upload.onprogress = (e) => e.lengthComputable && onProgress && onProgress(Math.round(e.loaded / e.total * 100));
        xhr.onload = () => xhr.status < 300 ? resolve(JSON.parse(xhr.responseText)) : resolve(null);
        xhr.onerror = () => resolve(null);
        xhr.open("POST", API_BASE + "/api/evidence/upload");
        xhr.send(formData);
      }),
      validate: (id, action) => fetch(API_BASE + "/api/evidence/" + id + "/validate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(action)
      }).then((r) => r.ok ? r.json() : null).catch(() => null),
      remove: (id) => fetch(API_BASE + "/api/evidence/" + id, { method: "DELETE" }).then((r) => r.ok).catch(() => false),
      download: (id) => fetch(API_BASE + "/api/evidence/" + id + "/content").then((r) => r.ok ? r.blob() : null).catch(() => null),
      provenance: (id) => fetch(API_BASE + "/api/evidence/" + id + "/provenance").then((r) => r.ok ? r.json() : null).catch(() => null)
    },
    // ============================================================
    // SERVICE WORKER API (LocalAgent v3 on port 9999)
    // ============================================================
    serviceWorker: {
      health: () => fetch("http://localhost:9998/api/health", { signal: AbortSignal.timeout(2000) }).then((r) => r.ok ? r.json() : null).catch(() => null),
      releases: (owner, repo) => fetch(`http://localhost:9998/api/github/releases/${owner}/${repo}`).then((r) => r.ok ? r.json() : null).catch(() => null),
      updateCheck: (appId, currentVersion) => fetch(`http://localhost:9998/api/update/check?app_id=${appId}&current_version=${currentVersion}`).then((r) => r.ok ? r.json() : null).catch(() => null),
      installUpdate: (appId) => fetch("http://localhost:9998/api/update/install", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ app_id: appId })
      }).then((r) => r.ok ? r.json() : null).catch(() => null)
    },
    // LocalAgent API (lint, whisper, publish)
    localAgent: {
      health: () => fetch("http://localhost:9998/api/health", { signal: AbortSignal.timeout(2000) }).then((r) => r.ok ? r.json() : null).catch(() => null),
      lint: (prompt) => fetch("http://localhost:9998/api/lint", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompt })
      }).then((r) => r.ok ? r.json() : null).catch(() => null),
      whisper: (audioBlob) => {
        const formData = new FormData();
        formData.append("audio", audioBlob, "recording.webm");
        return fetch("http://localhost:9998/api/whisper/transcribe", {
          method: "POST",
          body: formData
        }).then((r) => r.ok ? r.json() : null).catch(() => null);
      },
      publish: (version, notes) => fetch("http://localhost:9998/api/deploy/release", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ version, notes })
      }).then((r) => r.ok ? r.json() : null).catch(() => null)
    },
    // Tags (SAD 17.4 - Native macOS Tags)
    tags: {
      get: (evidenceId) => fetch(API_BASE + "/api/tags/" + evidenceId).then((r) => r.ok ? r.json() : null).catch(() => null),
      add: (evidenceId, namespace, value) => fetch(API_BASE + "/api/tags/" + evidenceId + "?namespace=" + namespace + "&value=" + encodeURIComponent(value), { method: "POST" }).then((r) => r.ok ? r.json() : null).catch(() => null),
      remove: (evidenceId, namespace, value) => fetch(API_BASE + "/api/tags/" + evidenceId + "/" + namespace + "/" + encodeURIComponent(value), { method: "DELETE" }).then((r) => r.ok).catch(() => false)
    },
    // Frameworks (SAD 13 - Tier 2 Complete)
    frameworks: {
      list: () => fetch(API_BASE + "/api/frameworks").then((r) => r.ok ? r.json() : null).catch(() => null),
      get: (id) => fetch(API_BASE + "/api/frameworks/" + id).then((r) => r.ok ? r.json() : null).catch(() => null),
      folders: (id) => fetch(API_BASE + "/api/frameworks/" + id + "/folders").then((r) => r.ok ? r.json() : null).catch(() => null)
    },
    // Folders / Smart Folders (SAD 9.4)
    folders: {
      tree: (caseId) => fetch(API_BASE + "/api/folders?case_id=" + caseId).then((r) => r.ok ? r.json() : null).catch(() => null),
      contents: (path) => fetch(API_BASE + "/api/folders/" + encodeURIComponent(path)).then((r) => r.ok ? r.json() : null).catch(() => null),
      add: (path, evidenceId) => fetch(API_BASE + "/api/folders/" + encodeURIComponent(path) + "/add", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ evidence_id: evidenceId })
      }).then((r) => r.ok).catch(() => false),
      remove: (path, evidenceId) => fetch(API_BASE + "/api/folders/" + encodeURIComponent(path) + "/remove", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ evidence_id: evidenceId })
      }).then((r) => r.ok).catch(() => false),
      search: (query, caseId) => fetch(API_BASE + "/api/folders/search?q=" + encodeURIComponent(query) + "&case_id=" + caseId).then((r) => r.ok ? r.json() : null).catch(() => null)
    },
    // Search (SAD 17.4 - Spotlight + Tags)
    search: {
      evidence: (query, caseId) => fetch(API_BASE + "/api/search/evidence?q=" + encodeURIComponent(query) + "&case_id=" + caseId).then((r) => r.ok ? r.json() : null).catch(() => null),
      byTag: (namespace, value, caseId) => fetch(API_BASE + "/api/search/tag?namespace=" + namespace + "&value=" + encodeURIComponent(value) + "&case_id=" + caseId).then((r) => r.ok ? r.json() : null).catch(() => null),
      byType: (docType, caseId) => fetch(API_BASE + "/api/search/type?type=" + docType + "&case_id=" + caseId).then((r) => r.ok ? r.json() : null).catch(() => null),
      byValidation: (status, caseId) => fetch(API_BASE + "/api/search/validation?status=" + status + "&case_id=" + caseId).then((r) => r.ok ? r.json() : null).catch(() => null),
      track: (query, results) => fetch(API_BASE + "/api/search/track", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ query, results })
      }).then((r) => r.ok ? r.json() : null).catch(() => null),
      history: (hash) => fetch(API_BASE + "/api/search/history/" + hash).then((r) => r.ok ? r.json() : null).catch(() => null),
      clearHistory: (hash) => fetch(API_BASE + "/api/search/history/" + hash, { method: "DELETE" }).then((r) => r.ok).catch(() => false)
    },
    // Context / Conversation (SAD 17.4)
    context: {
      create: (conversationId, filePaths) => fetch(API_BASE + "/api/context/conversation", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ conversation_id: conversationId, file_paths: filePaths })
      }).then((r) => r.ok ? r.json() : null).catch(() => null),
      get: (conversationId) => fetch(API_BASE + "/api/context/conversation/" + conversationId).then((r) => r.ok ? r.json() : null).catch(() => null),
      add: (conversationId, evidenceId) => fetch(API_BASE + "/api/context/conversation/" + conversationId + "/add", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ evidence_id: evidenceId })
      }).then((r) => r.ok).catch(() => false)
    },
    // Analysis (SAD 9.5)
    analysis: {
      extract: (caseId, evidenceIds) => fetch(API_BASE + "/api/analysis/extract", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ case_id: caseId, evidence_ids: evidenceIds })
      }).then((r) => r.ok ? r.json() : null).catch(() => null),
      facts: (caseId) => fetch(API_BASE + "/api/analysis/facts?case_id=" + caseId).then((r) => r.ok ? r.json() : null).catch(() => null),
      chronology: (caseId) => fetch(API_BASE + "/api/analysis/chronology?case_id=" + caseId).then((r) => r.ok ? r.json() : null).catch(() => null),
      delay: (request) => fetch(API_BASE + "/api/analysis/delay", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(request)
      }).then((r) => r.ok ? r.json() : null).catch(() => null),
      methods: () => fetch(API_BASE + "/api/analysis/methods").then((r) => r.ok ? r.json() : null).catch(() => null)
    },
    // Outputs (SAD 9.6)
    outputs: {
      generate: (request) => fetch(API_BASE + "/api/outputs/generate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(request)
      }).then((r) => r.ok ? r.json() : null).catch(() => null),
      list: (caseId) => fetch(API_BASE + "/api/outputs?case_id=" + caseId).then((r) => r.ok ? r.json() : null).catch(() => null),
      get: (id) => fetch(API_BASE + "/api/outputs/" + id).then((r) => r.ok ? r.json() : null).catch(() => null),
      download: (id) => fetch(API_BASE + "/api/outputs/" + id + "/download").then((r) => r.ok ? r.blob() : null).catch(() => null),
      provenance: (id) => fetch(API_BASE + "/api/outputs/" + id + "/provenance").then((r) => r.ok ? r.json() : null).catch(() => null)
    },
    // Settings (SAD 9.7)
    settings: {
      get: () => fetch(API_BASE + "/api/settings").then((r) => r.ok ? r.json() : null).catch(() => null),
      update: (data) => fetch(API_BASE + "/api/settings", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      }).then((r) => r.ok ? r.json() : null).catch(() => null),
      modules: () => fetch(API_BASE + "/api/settings/modules").then((r) => r.ok ? r.json() : null).catch(() => null),
      toggleModule: (name, enabled) => fetch(API_BASE + "/api/settings/modules/" + name, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ enabled })
      }).then((r) => r.ok ? r.json() : null).catch(() => null)
    },
    // Case Law (SAD 9.x - Optional Module)
    caselaw: {
      search: (query) => fetch(API_BASE + "/api/caselaw/search?q=" + encodeURIComponent(query)).then((r) => r.ok ? r.json() : null).catch(() => null),
      getCitation: (ref) => fetch(API_BASE + "/api/caselaw/" + encodeURIComponent(ref)).then((r) => r.ok ? r.json() : null).catch(() => null),
      precedents: (caseId) => fetch(API_BASE + "/api/caselaw/precedents?case_id=" + caseId).then((r) => r.ok ? r.json() : null).catch(() => null)
    },
    // MLX Feeder (SAD 9.x - AI Classification)
    mlx: {
      stats: () => fetch(API_BASE + "/api/mlx-feeder/stats").then((r) => r.ok ? r.json() : null).catch(() => null),
      consent: () => fetch(API_BASE + "/api/mlx-feeder/consent").then((r) => r.ok ? r.json() : null).catch(() => null),
      grantConsent: () => fetch(API_BASE + "/api/mlx-feeder/consent", { method: "POST" }).then((r) => r.ok ? r.json() : null).catch(() => null)
    },
    // VSP - Validated Source Protocol (SAD - Forensic Provenance)
    vsp: {
      evidenceChain: (id) => fetch(API_BASE + "/api/evidence/" + id + "/provenance").then((r) => r.ok ? r.json() : null).catch(() => null),
      outputChain: (id) => fetch(API_BASE + "/api/outputs/" + id + "/provenance").then((r) => r.ok ? r.json() : null).catch(() => null)
    },
    // Chat / AI (SAD 9.8)
    chat: {
      send: (message, caseId, context) => fetch(API_BASE + "/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message, case_id: caseId, context })
      }).then((r) => r.ok ? r.json() : null).catch(() => null),
      history: (caseId) => fetch(API_BASE + "/api/chat/history?case_id=" + caseId).then((r) => r.ok ? r.json() : null).catch(() => null)
    },
    // =========================================================================
    // FIX7: NEW BACKEND FEATURES - SAD v8.0.19 routes_v8.py
    // =========================================================================
    // Zero Trust Import Pipeline (FEATURE_SPEC ¬ß13)
    zeroTrust: {
      upload: (caseId, vaultId, file, onProgress) => new Promise((resolve) => {
        const formData = new FormData();
        formData.append("file", file);
        const xhr = new XMLHttpRequest();
        xhr.upload.onprogress = (e) => e.lengthComputable && onProgress && onProgress(Math.round(e.loaded / e.total * 100));
        xhr.onload = () => xhr.status < 300 ? resolve(JSON.parse(xhr.responseText)) : resolve(null);
        xhr.onerror = () => resolve(null);
        xhr.open("POST", API_BASE + "/api/import/files?case_id=" + caseId + "&vault_id=" + vaultId);
        xhr.send(formData);
      }),
      status: (importId) => fetch(API_BASE + "/api/import/" + importId).then((r) => r.ok ? r.json() : null).catch(() => null),
      progress: (importId) => fetch(API_BASE + "/api/import/" + importId + "/progress").then((r) => r.ok ? r.json() : null).catch(() => null),
      cancel: (importId) => fetch(API_BASE + "/api/import/" + importId, { method: "DELETE" }).then((r) => r.ok ? r.json() : null).catch(() => null),
      config: {
        get: (caseId) => fetch(API_BASE + "/api/import/config?case_id=" + caseId).then((r) => r.ok ? r.json() : null).catch(() => null),
        update: (caseId, config) => fetch(API_BASE + "/api/import/config?case_id=" + caseId, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(config)
        }).then((r) => r.ok ? r.json() : null).catch(() => null)
      }
    },
    // Quarantine Management (FEATURE_SPEC ¬ß13)
    quarantine: {
      list: () => fetch(API_BASE + "/api/quarantine").then((r) => r.ok ? r.json() : null).catch(() => null),
      get: (id) => fetch(API_BASE + "/api/quarantine/" + id).then((r) => r.ok ? r.json() : null).catch(() => null),
      delete: (id) => fetch(API_BASE + "/api/quarantine/" + id, { method: "DELETE" }).then((r) => r.ok ? r.json() : null).catch(() => null),
      retry: (id) => fetch(API_BASE + "/api/quarantine/" + id + "/retry", { method: "POST" }).then((r) => r.ok ? r.json() : null).catch(() => null)
    },
    // SCL Protocol (FEATURE_SPEC ¬ß2-¬ß9)
    scl: {
      principles: () => fetch(API_BASE + "/api/scl/principles").then((r) => r.ok ? r.json() : null).catch(() => null),
      principle: (number) => fetch(API_BASE + "/api/scl/principles/" + number).then((r) => r.ok ? r.json() : null).catch(() => null),
      compliance: (caseId, flags) => {
        const params = new URLSearchParams({ case_id: caseId, ...flags });
        return fetch(API_BASE + "/api/scl/compliance?" + params).then((r) => r.ok ? r.json() : null).catch(() => null);
      },
      recordCategories: () => fetch(API_BASE + "/api/scl/record-categories").then((r) => r.ok ? r.json() : null).catch(() => null),
      suggestCategory: (docType) => fetch(API_BASE + "/api/scl/record-categories/suggest?document_type=" + encodeURIComponent(docType)).then((r) => r.ok ? r.json() : null).catch(() => null)
    },
    // Risk Events (FEATURE_SPEC ¬ß6)
    events: {
      create: (caseId, event) => fetch(API_BASE + "/api/events?case_id=" + caseId, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(event)
      }).then((r) => r.ok ? r.json() : null).catch(() => null),
      list: (caseId) => fetch(API_BASE + "/api/events?case_id=" + caseId).then((r) => r.ok ? r.json() : null).catch(() => null),
      classify: (description, source) => fetch(API_BASE + "/api/events/classify?description=" + encodeURIComponent(description) + "&source=" + encodeURIComponent(source || "")).then((r) => r.ok ? r.json() : null).catch(() => null),
      concurrent: (caseId) => fetch(API_BASE + "/api/events/concurrent?case_id=" + caseId).then((r) => r.ok ? r.json() : null).catch(() => null)
    },
    // Notices (FEATURE_SPEC ¬ß5)
    notices: {
      create: (caseId, notice) => fetch(API_BASE + "/api/notices?case_id=" + caseId, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(notice)
      }).then((r) => r.ok ? r.json() : null).catch(() => null),
      list: (caseId, status, noticeType) => {
        let url = API_BASE + "/api/notices?case_id=" + caseId;
        if (status) url += "&status=" + status;
        if (noticeType) url += "&notice_type=" + noticeType;
        return fetch(url).then((r) => r.ok ? r.json() : null).catch(() => null);
      },
      overdue: (caseId) => fetch(API_BASE + "/api/notices/overdue?case_id=" + caseId).then((r) => r.ok ? r.json() : null).catch(() => null),
      upcoming: (caseId, daysAhead) => fetch(API_BASE + "/api/notices/upcoming?case_id=" + caseId + "&days_ahead=" + (daysAhead || 7)).then((r) => r.ok ? r.json() : null).catch(() => null)
    },
    // Concurrency Analysis (FEATURE_SPEC ¬ß8)
    concurrency: {
      analyze: (caseId, request) => fetch(API_BASE + "/api/analysis/concurrency?case_id=" + caseId, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(request)
      }).then((r) => r.ok ? r.json() : null).catch(() => null)
    },
    // R&O Assessment (FEATURE_SPEC ¬ß9)
    roAssessment: {
      generate: (caseId, request) => fetch(API_BASE + "/api/ro-assessment?case_id=" + caseId, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(request)
      }).then((r) => r.ok ? r.json() : null).catch(() => null),
      get: (assessmentId) => fetch(API_BASE + "/api/ro-assessment/" + assessmentId).then((r) => r.ok ? r.json() : null).catch(() => null)
    },
    // Extended Framework Service
    frameworkExt: {
      supported: () => fetch(API_BASE + "/api/framework/supported").then((r) => r.ok ? r.json() : null).catch(() => null),
      folders: (framework, phase) => {
        let url = API_BASE + "/api/framework/folders?framework=" + framework;
        if (phase) url += "&phase=" + phase;
        return fetch(url).then((r) => r.ok ? r.json() : null).catch(() => null);
      },
      documentTypes: (framework) => fetch(API_BASE + "/api/framework/document-types?framework=" + (framework || "rics")).then((r) => r.ok ? r.json() : null).catch(() => null),
      delayMethods: (methodology) => fetch(API_BASE + "/api/framework/delay-methods?methodology=" + (methodology || "combined")).then((r) => r.ok ? r.json() : null).catch(() => null),
      crossReference: () => fetch(API_BASE + "/api/framework/delay-methods/cross-reference").then((r) => r.ok ? r.json() : null).catch(() => null),
      detect: (text) => fetch(API_BASE + "/api/framework/detect", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text })
      }).then((r) => r.ok ? r.json() : null).catch(() => null),
      validateMethod: (methodId, flags) => {
        const params = new URLSearchParams({ method_id: methodId, ...flags });
        return fetch(API_BASE + "/api/framework/validate-method?" + params, { method: "POST" }).then((r) => r.ok ? r.json() : null).catch(() => null);
      }
    }
  };
  var ThemisWS = class {
    constructor() {
      this.ws = null;
      this.handlers = /* @__PURE__ */ new Map();
      this.reqId = 0;
      this.pending = /* @__PURE__ */ new Map();
      this.connected = false;
    }
    connect(caseId) {
      return new Promise((resolve) => {
        if (this.ws && this.ws.readyState === WebSocket.OPEN) {
          resolve(this);
          return;
        }
        try {
          this.ws = new WebSocket(WS_URL + "?case_id=" + caseId);
          this.ws.onopen = () => {
            this.connected = true;
            resolve(this);
          };
          this.ws.onerror = () => {
            this.connected = false;
            resolve(this);
          };
          this.ws.onclose = () => {
            this.connected = false;
          };
          this.ws.onmessage = (e) => this._handle(JSON.parse(e.data));
          setTimeout(() => resolve(this), 3e3);
        } catch (err) {
          resolve(this);
        }
      });
    }
    disconnect() {
      if (this.ws) this.ws.close();
      this.ws = null;
      this.connected = false;
    }
    _handle(msg) {
      if (msg.id && this.pending.has(msg.id)) {
        const p = this.pending.get(msg.id);
        this.pending.delete(msg.id);
        msg.error ? p.reject(msg.error) : p.resolve(msg.result);
      } else if (msg.method && this.handlers.has(msg.method)) {
        this.handlers.get(msg.method)(msg.params);
      }
    }
    on(method, handler) {
      this.handlers.set(method, handler);
      return () => this.handlers.delete(method);
    }
    off(method) {
      this.handlers.delete(method);
    }
    send(method, params) {
      return new Promise((resolve) => {
        if (!this.ws || this.ws.readyState !== WebSocket.OPEN) {
          resolve(null);
          return;
        }
        const id = ++this.reqId;
        this.pending.set(id, { resolve, reject: () => resolve(null) });
        this.ws.send(JSON.stringify({ jsonrpc: "2.0", method, params: params || {}, id }));
        setTimeout(() => {
          if (this.pending.has(id)) {
            this.pending.delete(id);
            resolve(null);
          }
        }, 3e4);
      });
    }
    // Convenience methods for common operations
    chat(message, context) {
      return this.send("chat.send", { message, context });
    }
    validateEvidence(evidenceId, action) {
      return this.send("evidence.validate", { evidence_id: evidenceId, action });
    }
    runAnalysis(type, params) {
      return this.send("analysis.run", { type, params });
    }
    search(query, caseId) {
      return this.send("search.query", { query, case_id: caseId });
    }
  };
  var themisWS = new ThemisWS();
  var Icons = {
    Folder: () => h("svg", { viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", children: h("path", { d: "M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" }) }),
    FolderOpen: () => h("svg", { viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", children: [
      h("path", { d: "M5 19a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h4l2 2h9a2 2 0 0 1 2 2v1" }),
      h("path", { d: "M5 19h14a2 2 0 0 0 2-2v-5a2 2 0 0 0-2-2H9a2 2 0 0 0-2 2v5a2 2 0 0 1-2 2z" })
    ] }),
    File: () => h("svg", { viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", children: [
      h("path", { d: "M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" }),
      h("polyline", { points: "14 2 14 8 20 8" })
    ] }),
    Clock: () => h("svg", { viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", children: [
      h("circle", { cx: "12", cy: "12", r: "10" }),
      h("polyline", { points: "12 6 12 12 16 14" })
    ] }),
    Calculator: () => h("svg", { viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", children: [
      h("rect", { x: "4", y: "2", width: "16", height: "20", rx: "2" }),
      h("line", { x1: "8", y1: "6", x2: "16", y2: "6" })
    ] }),
    Search: () => h("svg", { viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", children: [
      h("circle", { cx: "11", cy: "11", r: "8" }),
      h("line", { x1: "21", y1: "21", x2: "16.65", y2: "16.65" })
    ] }),
    Calendar: () => h("svg", { viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", children: [
      h("rect", { x: "3", y: "4", width: "18", height: "18", rx: "2" }),
      h("line", { x1: "16", y1: "2", x2: "16", y2: "6" }),
      h("line", { x1: "8", y1: "2", x2: "8", y2: "6" }),
      h("line", { x1: "3", y1: "10", x2: "21", y2: "10" })
    ] }),
    Scale: () => h("svg", { viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", children: [
      h("path", { d: "M16 16l3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1z" }),
      h("path", { d: "M2 16l3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1z" }),
      h("path", { d: "M7 21h10" }),
      h("path", { d: "M12 3v18" })
    ] }),
    BarChart: () => h("svg", { viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", children: [
      h("line", { x1: "12", y1: "20", x2: "12", y2: "10" }),
      h("line", { x1: "18", y1: "20", x2: "18", y2: "4" }),
      h("line", { x1: "6", y1: "20", x2: "6", y2: "16" })
    ] }),
    ChevronRight: () => h("svg", { viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", children: h("polyline", { points: "9 18 15 12 9 6" }) }),
    ChevronLeft: () => h("svg", { viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", children: h("polyline", { points: "15 18 9 12 15 6" }) }),
    Plus: () => h("svg", { viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", children: [
      h("line", { x1: "12", y1: "5", x2: "12", y2: "19" }),
      h("line", { x1: "5", y1: "12", x2: "19", y2: "12" })
    ] }),
    Star: () => h("svg", { viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", children: h("polygon", { points: "12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" }) }),
    Hash: () => h("svg", { viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", children: [
      h("line", { x1: "4", y1: "9", x2: "20", y2: "9" }),
      h("line", { x1: "4", y1: "15", x2: "20", y2: "15" }),
      h("line", { x1: "10", y1: "3", x2: "8", y2: "21" }),
      h("line", { x1: "16", y1: "3", x2: "14", y2: "21" })
    ] }),
    Download: () => h("svg", { viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", children: [
      h("path", { d: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" }),
      h("polyline", { points: "7 10 12 15 17 10" }),
      h("line", { x1: "12", y1: "15", x2: "12", y2: "3" })
    ] }),
    ArrowRight: () => h("svg", { viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", children: [
      h("line", { x1: "5", y1: "12", x2: "19", y2: "12" }),
      h("polyline", { points: "12 5 19 12 12 19" })
    ] }),
    Share: () => h("svg", { viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", children: [
      h("path", { d: "M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8" }),
      h("polyline", { points: "16 6 12 2 8 6" }),
      h("line", { x1: "12", y1: "2", x2: "12", y2: "15" })
    ] }),
    Sort: () => h("svg", { viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", children: [
      h("line", { x1: "4", y1: "6", x2: "20", y2: "6" }),
      h("line", { x1: "4", y1: "12", x2: "14", y2: "12" }),
      h("line", { x1: "4", y1: "18", x2: "8", y2: "18" })
    ] }),
    Settings: () => h("svg", { viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", children: [
      h("circle", { cx: "12", cy: "12", r: "3" }),
      h("path", { d: "M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" })
    ] }),
    Circle: () => h("svg", { viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", children: h("circle", { cx: "12", cy: "12", r: "10" }) }),
    Moon: () => h("svg", { viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", children: h("path", { d: "M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" }) }),
    Power: () => h("svg", { viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", children: [
      h("path", { d: "M18.36 6.64a9 9 0 1 1-12.73 0" }),
      h("line", { x1: "12", y1: "2", x2: "12", y2: "12" })
    ] }),
    Zap: () => h("svg", { viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "1.5", children: h("path", { d: "M13 2L3 14h9l-1 8 10-12h-9l1-8z" }) }),
    Grid: () => h("svg", { viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "1.5", children: [
      h("rect", { x: "3", y: "3", width: "18", height: "18", rx: "2" }),
      h("path", { d: "M3 9h18M9 21V9" })
    ] }),
    Send: () => h("svg", { viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", children: [
      h("line", { x1: "22", y1: "2", x2: "11", y2: "13" }),
      h("polygon", { points: "22 2 15 22 11 13 2 9 22 2" })
    ] })
  };
  var CASES = [
    {
      id: "CASE-2026-0001",
      name: "Brussels American School Phase 2",
      framework: "RICS",
      methodology: "AACE",
      jurisdiction: "US_FEDERAL",
      validation_mode: "forensic",
      date: "2026-01-10",
      client: "USACE - US Army Corps of Engineers",
      contract: "W912GB-17-C-0018",
      id_config: {
        case: { prefix: "CASE", separator: "-", digits: 4 },
        vault: { prefix: "V", separator: "-", digits: 4 },
        evidence: { prefix: "EV", separator: "-", digits: 3 }
      }
    },
    {
      id: "C-0013",
      name: "DoD Facility REA - Fort Bragg",
      framework: "FAR",
      methodology: "AACE",
      jurisdiction: "US_FEDERAL",
      validation_mode: "forensic",
      date: "2024-01-08",
      id_config: {
        case: { prefix: "C", separator: "-", digits: 4 },
        vault: { prefix: "V", separator: "-", digits: 4 },
        evidence: { prefix: "EX", separator: "-", digits: 4 }
      }
    },
    {
      id: "BAS-0009",
      name: "Smith v. Anderson",
      framework: "RICS",
      methodology: "SCL",
      jurisdiction: "UK",
      validation_mode: "case_control",
      date: "2024-01-05",
      id_config: {
        case: { prefix: "BAS", separator: "-", digits: 4 },
        vault: { prefix: "V", separator: "-", digits: 4 },
        evidence: { prefix: "A", separator: "-", digits: 3 }
      }
    }
  ];
  var VAULTS = [
    { id: "V-0001", name: "Primary Vault", files: 9, case_id: "CASE-2026-0001" },
    { id: "V-0002", name: "Correspondence", files: 12, case_id: "CASE-2026-0001" },
    { id: "V-0003", name: "Financial Records", files: 8, case_id: "CASE-2026-0001" }
  ];
  var BRANDS = [
    { id: "themis", name: "THEMIS-QS", desc: "Default", color: "#3b82f6" },
    { id: "systech", name: "Systech Law", desc: "Construction Law Specialists", color: "#0f766e" },
    { id: "hka", name: "HKA", desc: "Global Risk & Disputes", color: "#dc2626" },
    { id: "dentons", name: "Dentons", desc: "Global Law Firm", color: "#7c3aed" },
    { id: "custom", name: "Your Brand", desc: "Custom White Label", color: "#6b7280" }
  ];
  var FRAMEWORK_INFO = {
    RICS: { id: "rics", name: "RICS QS Pathway", version: "Aug 2018", folderCount: 66, phases: 6 },
    FAR: { id: "far", name: "FAR/DFARS", version: "Current", folderCount: 52, phases: 6 },
    FIDIC: { id: "fidic", name: "FIDIC", version: "2017", folderCount: 48, phases: 5 },
    NEC: { id: "nec", name: "NEC4", version: "2017", folderCount: 42, phases: 5 },
    CUSTOM: { id: "custom", name: "Custom", version: "User-defined", folderCount: 6, phases: 6 }
  };
  var RICS_FOLDERS = [
    // Phase 1: Pre-Contract (12 folders)
    { id: "rics-1-01", path: "[1] Pre-Contract/Tender Documents", name: "Tender Documents", phase: 1, phaseName: "Pre-Contract", count: 0 },
    { id: "rics-1-02", path: "[1] Pre-Contract/Contract Documents", name: "Contract Documents", phase: 1, phaseName: "Pre-Contract", count: 0 },
    { id: "rics-1-03", path: "[1] Pre-Contract/Specifications", name: "Specifications", phase: 1, phaseName: "Pre-Contract", count: 0 },
    { id: "rics-1-04", path: "[1] Pre-Contract/Drawings", name: "Drawings", phase: 1, phaseName: "Pre-Contract", count: 0 },
    { id: "rics-1-05", path: "[1] Pre-Contract/Bills of Quantities", name: "Bills of Quantities", phase: 1, phaseName: "Pre-Contract", count: 0 },
    { id: "rics-1-06", path: "[1] Pre-Contract/Schedules of Rates", name: "Schedules of Rates", phase: 1, phaseName: "Pre-Contract", count: 0 },
    { id: "rics-1-07", path: "[1] Pre-Contract/Pre-Contract Minutes", name: "Pre-Contract Minutes", phase: 1, phaseName: "Pre-Contract", count: 0 },
    { id: "rics-1-08", path: "[1] Pre-Contract/Due Diligence", name: "Due Diligence", phase: 1, phaseName: "Pre-Contract", count: 0 },
    { id: "rics-1-09", path: "[1] Pre-Contract/Risk Register", name: "Risk Register", phase: 1, phaseName: "Pre-Contract", count: 0 },
    { id: "rics-1-10", path: "[1] Pre-Contract/Programme (Tender)", name: "Programme (Tender)", phase: 1, phaseName: "Pre-Contract", count: 0 },
    { id: "rics-1-11", path: "[1] Pre-Contract/Method Statement", name: "Method Statement", phase: 1, phaseName: "Pre-Contract", count: 0 },
    { id: "rics-1-12", path: "[1] Pre-Contract/Sub-Contract Enquiries", name: "Sub-Contract Enquiries", phase: 1, phaseName: "Pre-Contract", count: 0 },
    // Phase 2: Construction (18 folders)
    { id: "rics-2-01", path: "[2] Construction/Correspondence/Client", name: "Correspondence - Client", phase: 2, phaseName: "Construction", count: 0 },
    { id: "rics-2-02", path: "[2] Construction/Correspondence/Contractor", name: "Correspondence - Contractor", phase: 2, phaseName: "Construction", count: 0 },
    { id: "rics-2-03", path: "[2] Construction/Correspondence/Sub-Contractors", name: "Correspondence - Sub-Contractors", phase: 2, phaseName: "Construction", count: 0 },
    { id: "rics-2-04", path: "[2] Construction/Instructions", name: "Instructions", phase: 2, phaseName: "Construction", count: 0 },
    { id: "rics-2-05", path: "[2] Construction/Variations", name: "Variations", phase: 2, phaseName: "Construction", count: 0 },
    { id: "rics-2-06", path: "[2] Construction/Programme Updates", name: "Programme Updates", phase: 2, phaseName: "Construction", count: 0 },
    { id: "rics-2-07", path: "[2] Construction/Progress Reports", name: "Progress Reports", phase: 2, phaseName: "Construction", count: 0 },
    { id: "rics-2-08", path: "[2] Construction/Site Diaries", name: "Site Diaries", phase: 2, phaseName: "Construction", count: 0 },
    { id: "rics-2-09", path: "[2] Construction/Meeting Minutes", name: "Meeting Minutes", phase: 2, phaseName: "Construction", count: 0 },
    { id: "rics-2-10", path: "[2] Construction/RFIs", name: "RFIs", phase: 2, phaseName: "Construction", count: 0 },
    { id: "rics-2-11", path: "[2] Construction/Submittals", name: "Submittals", phase: 2, phaseName: "Construction", count: 0 },
    { id: "rics-2-12", path: "[2] Construction/Quality Records", name: "Quality Records", phase: 2, phaseName: "Construction", count: 0 },
    { id: "rics-2-13", path: "[2] Construction/H&S Records", name: "H&S Records", phase: 2, phaseName: "Construction", count: 0 },
    { id: "rics-2-14", path: "[2] Construction/Photographs", name: "Photographs", phase: 2, phaseName: "Construction", count: 0 },
    { id: "rics-2-15", path: "[2] Construction/Interim Valuations", name: "Interim Valuations", phase: 2, phaseName: "Construction", count: 0 },
    { id: "rics-2-16", path: "[2] Construction/Payment Certificates", name: "Payment Certificates", phase: 2, phaseName: "Construction", count: 0 },
    { id: "rics-2-17", path: "[2] Construction/Daywork Records", name: "Daywork Records", phase: 2, phaseName: "Construction", count: 0 },
    { id: "rics-2-18", path: "[2] Construction/Resource Records", name: "Resource Records", phase: 2, phaseName: "Construction", count: 0 },
    // Phase 3: Claims (18 folders)
    { id: "rics-3-01", path: "[3] Claims/EOT/Notices", name: "EOT - Notices", phase: 3, phaseName: "Claims", count: 0 },
    { id: "rics-3-02", path: "[3] Claims/EOT/Particulars", name: "EOT - Particulars", phase: 3, phaseName: "Claims", count: 0 },
    { id: "rics-3-03", path: "[3] Claims/EOT/Assessment", name: "EOT - Assessment", phase: 3, phaseName: "Claims", count: 0 },
    { id: "rics-3-04", path: "[3] Claims/EOT/Response", name: "EOT - Response", phase: 3, phaseName: "Claims", count: 0 },
    { id: "rics-3-05", path: "[3] Claims/L&E/Notices", name: "L&E - Notices", phase: 3, phaseName: "Claims", count: 0 },
    { id: "rics-3-06", path: "[3] Claims/L&E/Particulars", name: "L&E - Particulars", phase: 3, phaseName: "Claims", count: 0 },
    { id: "rics-3-07", path: "[3] Claims/L&E/Valuation", name: "L&E - Valuation", phase: 3, phaseName: "Claims", count: 0 },
    { id: "rics-3-08", path: "[3] Claims/L&E/Response", name: "L&E - Response", phase: 3, phaseName: "Claims", count: 0 },
    { id: "rics-3-09", path: "[3] Claims/Variations/Notices", name: "Variations - Notices", phase: 3, phaseName: "Claims", count: 0 },
    { id: "rics-3-10", path: "[3] Claims/Variations/Quotations", name: "Variations - Quotations", phase: 3, phaseName: "Claims", count: 0 },
    { id: "rics-3-11", path: "[3] Claims/Variations/Assessment", name: "Variations - Assessment", phase: 3, phaseName: "Claims", count: 0 },
    { id: "rics-3-12", path: "[3] Claims/Delay Analysis", name: "Delay Analysis", phase: 3, phaseName: "Claims", count: 0 },
    { id: "rics-3-13", path: "[3] Claims/Disruption Analysis", name: "Disruption Analysis", phase: 3, phaseName: "Claims", count: 0 },
    { id: "rics-3-14", path: "[3] Claims/Quantum Analysis", name: "Quantum Analysis", phase: 3, phaseName: "Claims", count: 0 },
    { id: "rics-3-15", path: "[3] Claims/Expert Reports", name: "Expert Reports", phase: 3, phaseName: "Claims", count: 0 },
    { id: "rics-3-16", path: "[3] Claims/Supporting Documents", name: "Supporting Documents", phase: 3, phaseName: "Claims", count: 0 },
    { id: "rics-3-17", path: "[3] Claims/Schedules", name: "Schedules", phase: 3, phaseName: "Claims", count: 0 },
    { id: "rics-3-18", path: "[3] Claims/Scott Schedule", name: "Scott Schedule", phase: 3, phaseName: "Claims", count: 0 },
    // Phase 4: Post-Contract (8 folders)
    { id: "rics-4-01", path: "[4] Post-Contract/Practical Completion", name: "Practical Completion", phase: 4, phaseName: "Post-Contract", count: 0 },
    { id: "rics-4-02", path: "[4] Post-Contract/Defects List", name: "Defects List", phase: 4, phaseName: "Post-Contract", count: 0 },
    { id: "rics-4-03", path: "[4] Post-Contract/Final Account", name: "Final Account", phase: 4, phaseName: "Post-Contract", count: 0 },
    { id: "rics-4-04", path: "[4] Post-Contract/As-Built Drawings", name: "As-Built Drawings", phase: 4, phaseName: "Post-Contract", count: 0 },
    { id: "rics-4-05", path: "[4] Post-Contract/O&M Manuals", name: "O&M Manuals", phase: 4, phaseName: "Post-Contract", count: 0 },
    { id: "rics-4-06", path: "[4] Post-Contract/Warranties", name: "Warranties", phase: 4, phaseName: "Post-Contract", count: 0 },
    { id: "rics-4-07", path: "[4] Post-Contract/Release of Retention", name: "Release of Retention", phase: 4, phaseName: "Post-Contract", count: 0 },
    { id: "rics-4-08", path: "[4] Post-Contract/Final Certificate", name: "Final Certificate", phase: 4, phaseName: "Post-Contract", count: 0 },
    // Phase 5: Dispute Resolution (6 folders)
    { id: "rics-5-01", path: "[5] Dispute/Negotiation", name: "Negotiation", phase: 5, phaseName: "Dispute Resolution", count: 0 },
    { id: "rics-5-02", path: "[5] Dispute/Mediation", name: "Mediation", phase: 5, phaseName: "Dispute Resolution", count: 0 },
    { id: "rics-5-03", path: "[5] Dispute/Adjudication", name: "Adjudication", phase: 5, phaseName: "Dispute Resolution", count: 0 },
    { id: "rics-5-04", path: "[5] Dispute/Arbitration", name: "Arbitration", phase: 5, phaseName: "Dispute Resolution", count: 0 },
    { id: "rics-5-05", path: "[5] Dispute/Litigation", name: "Litigation", phase: 5, phaseName: "Dispute Resolution", count: 0 },
    { id: "rics-5-06", path: "[5] Dispute/Expert Determination", name: "Expert Determination", phase: 5, phaseName: "Dispute Resolution", count: 0 },
    // Phase 6: Deliverables (4 folders)
    { id: "rics-6-01", path: "[6] Deliverables/Statement of Facts", name: "Statement of Facts", phase: 6, phaseName: "Deliverables", count: 0 },
    { id: "rics-6-02", path: "[6] Deliverables/Chronology", name: "Chronology", phase: 6, phaseName: "Deliverables", count: 0 },
    { id: "rics-6-03", path: "[6] Deliverables/Narrative", name: "Narrative", phase: 6, phaseName: "Deliverables", count: 0 },
    { id: "rics-6-04", path: "[6] Deliverables/Reports", name: "Reports", phase: 6, phaseName: "Deliverables", count: 0 }
  ];
  var FAR_FOLDERS = [
    // Phase 1: Contract (10 folders)
    { id: "far-1-01", path: "[1] Contract/Solicitation", name: "Solicitation", phase: 1, phaseName: "Contract", farRef: "FAR Part 15", count: 0 },
    { id: "far-1-02", path: "[1] Contract/Proposal", name: "Proposal", phase: 1, phaseName: "Contract", count: 0 },
    { id: "far-1-03", path: "[1] Contract/Award Documents", name: "Award Documents", phase: 1, phaseName: "Contract", count: 0 },
    { id: "far-1-04", path: "[1] Contract/Modifications", name: "Modifications", phase: 1, phaseName: "Contract", farRef: "FAR 43", count: 0 },
    { id: "far-1-05", path: "[1] Contract/Task Orders", name: "Task Orders", phase: 1, phaseName: "Contract", count: 0 },
    { id: "far-1-06", path: "[1] Contract/Delivery Orders", name: "Delivery Orders", phase: 1, phaseName: "Contract", count: 0 },
    { id: "far-1-07", path: "[1] Contract/Options", name: "Options", phase: 1, phaseName: "Contract", count: 0 },
    { id: "far-1-08", path: "[1] Contract/Subcontracts", name: "Subcontracts", phase: 1, phaseName: "Contract", count: 0 },
    { id: "far-1-09", path: "[1] Contract/Teaming Agreements", name: "Teaming Agreements", phase: 1, phaseName: "Contract", count: 0 },
    { id: "far-1-10", path: "[1] Contract/NDAs", name: "NDAs", phase: 1, phaseName: "Contract", count: 0 },
    // Phase 2: Claims - REA (12 folders)
    { id: "far-2-01", path: "[2] Claims-REA/Notices", name: "REA Notices", phase: 2, phaseName: "Claims - REA", farRef: "FAR 33.201", count: 0 },
    { id: "far-2-02", path: "[2] Claims-REA/Basis of Claim", name: "Basis of Claim", phase: 2, phaseName: "Claims - REA", count: 0 },
    { id: "far-2-03", path: "[2] Claims-REA/Cost Analysis", name: "Cost Analysis", phase: 2, phaseName: "Claims - REA", count: 0 },
    { id: "far-2-04", path: "[2] Claims-REA/Schedule Analysis", name: "Schedule Analysis", phase: 2, phaseName: "Claims - REA", count: 0 },
    { id: "far-2-05", path: "[2] Claims-REA/Quantum", name: "Quantum", phase: 2, phaseName: "Claims - REA", count: 0 },
    { id: "far-2-06", path: "[2] Claims-REA/Supporting Docs", name: "Supporting Docs", phase: 2, phaseName: "Claims - REA", count: 0 },
    { id: "far-2-07", path: "[2] Claims-REA/Government Response", name: "Government Response", phase: 2, phaseName: "Claims - REA", count: 0 },
    { id: "far-2-08", path: "[2] Claims-REA/Negotiations", name: "Negotiations", phase: 2, phaseName: "Claims - REA", count: 0 },
    { id: "far-2-09", path: "[2] Claims-REA/Settlement", name: "Settlement", phase: 2, phaseName: "Claims - REA", count: 0 },
    { id: "far-2-10", path: "[2] Claims-REA/DCAA Audit", name: "DCAA Audit", phase: 2, phaseName: "Claims - REA", count: 0 },
    { id: "far-2-11", path: "[2] Claims-REA/Legal Review", name: "Legal Review", phase: 2, phaseName: "Claims - REA", count: 0 },
    { id: "far-2-12", path: "[2] Claims-REA/Final Determination", name: "Final Determination", phase: 2, phaseName: "Claims - REA", count: 0 },
    // Phase 3: Claims - CDA (8 folders)
    { id: "far-3-01", path: "[3] Claims-CDA/Claim Certification", name: "Claim Certification", phase: 3, phaseName: "Claims - CDA", farRef: "FAR 33.206", count: 0 },
    { id: "far-3-02", path: "[3] Claims-CDA/CO Final Decision", name: "CO Final Decision", phase: 3, phaseName: "Claims - CDA", count: 0 },
    { id: "far-3-03", path: "[3] Claims-CDA/ASBCA Filings", name: "ASBCA Filings", phase: 3, phaseName: "Claims - CDA", count: 0 },
    { id: "far-3-04", path: "[3] Claims-CDA/Discovery", name: "Discovery", phase: 3, phaseName: "Claims - CDA", count: 0 },
    { id: "far-3-05", path: "[3] Claims-CDA/Expert Reports", name: "Expert Reports", phase: 3, phaseName: "Claims - CDA", count: 0 },
    { id: "far-3-06", path: "[3] Claims-CDA/Hearing Documents", name: "Hearing Documents", phase: 3, phaseName: "Claims - CDA", count: 0 },
    { id: "far-3-07", path: "[3] Claims-CDA/Board Decision", name: "Board Decision", phase: 3, phaseName: "Claims - CDA", count: 0 },
    { id: "far-3-08", path: "[3] Claims-CDA/Appeal", name: "Appeal", phase: 3, phaseName: "Claims - CDA", count: 0 },
    // Phase 4: Contemporary Records (15 folders)
    { id: "far-4-01", path: "[4] Records/Correspondence", name: "Correspondence", phase: 4, phaseName: "Contemporary Records", count: 0 },
    { id: "far-4-02", path: "[4] Records/Meeting Minutes", name: "Meeting Minutes", phase: 4, phaseName: "Contemporary Records", count: 0 },
    { id: "far-4-03", path: "[4] Records/Daily Reports", name: "Daily Reports", phase: 4, phaseName: "Contemporary Records", count: 0 },
    { id: "far-4-04", path: "[4] Records/Progress Reports", name: "Progress Reports", phase: 4, phaseName: "Contemporary Records", count: 0 },
    { id: "far-4-05", path: "[4] Records/Schedule Updates", name: "Schedule Updates", phase: 4, phaseName: "Contemporary Records", count: 0 },
    { id: "far-4-06", path: "[4] Records/Change Orders", name: "Change Orders", phase: 4, phaseName: "Contemporary Records", count: 0 },
    { id: "far-4-07", path: "[4] Records/RFIs", name: "RFIs", phase: 4, phaseName: "Contemporary Records", count: 0 },
    { id: "far-4-08", path: "[4] Records/Technical Submittals", name: "Technical Submittals", phase: 4, phaseName: "Contemporary Records", count: 0 },
    { id: "far-4-09", path: "[4] Records/Quality Records", name: "Quality Records", phase: 4, phaseName: "Contemporary Records", count: 0 },
    { id: "far-4-10", path: "[4] Records/Inspection Reports", name: "Inspection Reports", phase: 4, phaseName: "Contemporary Records", count: 0 },
    { id: "far-4-11", path: "[4] Records/Test Results", name: "Test Results", phase: 4, phaseName: "Contemporary Records", count: 0 },
    { id: "far-4-12", path: "[4] Records/Photos-Videos", name: "Photos/Videos", phase: 4, phaseName: "Contemporary Records", count: 0 },
    { id: "far-4-13", path: "[4] Records/Invoices", name: "Invoices", phase: 4, phaseName: "Contemporary Records", count: 0 },
    { id: "far-4-14", path: "[4] Records/Payment Records", name: "Payment Records", phase: 4, phaseName: "Contemporary Records", count: 0 },
    { id: "far-4-15", path: "[4] Records/Personnel Records", name: "Personnel Records", phase: 4, phaseName: "Contemporary Records", count: 0 },
    // Phase 5: Deliverables (3 folders)
    { id: "far-5-01", path: "[5] Deliverables/REA Package", name: "REA Package", phase: 5, phaseName: "Deliverables", count: 0 },
    { id: "far-5-02", path: "[5] Deliverables/Schedule Analysis", name: "Schedule Analysis", phase: 5, phaseName: "Deliverables", count: 0 },
    { id: "far-5-03", path: "[5] Deliverables/Quantum Exhibits", name: "Quantum Exhibits", phase: 5, phaseName: "Deliverables", count: 0 },
    // Phase X: Not Specified (4 folders)
    { id: "far-x-01", path: "[X] Other/Miscellaneous", name: "Miscellaneous", phase: 6, phaseName: "Not Specified", count: 0 },
    { id: "far-x-02", path: "[X] Other/Reference Materials", name: "Reference Materials", phase: 6, phaseName: "Not Specified", count: 0 },
    { id: "far-x-03", path: "[X] Other/Working Papers", name: "Working Papers", phase: 6, phaseName: "Not Specified", count: 0 },
    { id: "far-x-04", path: "[X] Other/Archive", name: "Archive", phase: 6, phaseName: "Not Specified", count: 0 }
  ];
  var DEFAULT_FOLDERS = [
    { id: "pre", path: "/Pre-Contract", name: "Pre-Contract", desc: "Tender & Contract docs", count: 12, phase: 1, phaseName: "Pre-Contract" },
    { id: "con", path: "/Construction", name: "Construction", desc: "Progress & Site records", count: 45, phase: 2, phaseName: "Construction" },
    { id: "clm", path: "/Claims", name: "Claims", desc: "Delay & Quantum", count: 28, phase: 3, phaseName: "Claims" },
    { id: "pst", path: "/Post-Contract", name: "Post-Contract", desc: "Final account", count: 8, phase: 4, phaseName: "Post-Contract" },
    { id: "dsp", path: "/Dispute", name: "Dispute", desc: "Resolution docs", count: 15, phase: 5, phaseName: "Dispute" },
    { id: "del", path: "/Deliverables", name: "Deliverables", desc: "Reports & Outputs", count: 12, phase: 6, phaseName: "Deliverables" }
  ];
  var getFrameworkFolders = (framework) => {
    switch (framework?.toUpperCase()) {
      case "RICS":
        return RICS_FOLDERS;
      case "FAR":
        return FAR_FOLDERS;
      default:
        return DEFAULT_FOLDERS;
    }
  };
  var getPhases = (folders) => {
    const phases = [];
    const seen = /* @__PURE__ */ new Set();
    for (const f of folders) {
      if (!seen.has(f.phase)) {
        seen.add(f.phase);
        phases.push({ number: f.phase, name: f.phaseName });
      }
    }
    return phases.sort((a, b) => a.number - b.number);
  };
  var TOOLS = [
    { id: "delay", name: "Delay Analysis", desc: "Critical path method", Icon: Icons.Clock },
    { id: "quantum", name: "Quantum", desc: "Damages calculation", Icon: Icons.Calculator },
    { id: "review", name: "Doc Review", desc: "AI-assisted review", Icon: Icons.Search },
    { id: "timeline", name: "Timeline", desc: "Event chronology", Icon: Icons.Calendar },
    { id: "compare", name: "Compare", desc: "Version diff", Icon: Icons.Scale },
    { id: "extract", name: "Extract", desc: "Tables & data", Icon: Icons.BarChart }
  ];
  var DOCS = [
    { id: 1, name: "Contract Agreement.pdf", desc: "2.4 MB * Jan 15", type: "pdf", folder: "pre", selected: true, pages: 48 },
    { id: 2, name: "Progress Report #12.docx", desc: "156 KB * Feb 20", type: "docx", folder: "con", selected: true, pages: 12 },
    { id: 3, name: "Variation Order VO-003.pdf", desc: "89 KB * Mar 10", type: "pdf", folder: "clm", selected: true, pages: 8 },
    { id: 4, name: "Site Correspondence.msg", desc: "45 KB * Mar 15", type: "msg", folder: "con", selected: false, pages: null },
    { id: 5, name: "Delay Analysis.xlsx", desc: "1.2 MB * Apr 01", type: "xlsx", folder: "clm", selected: true, pages: null },
    { id: 6, name: "Programme Rev 3.mpp", desc: "3.8 MB * Apr 10", type: "mpp", folder: "con", selected: true, pages: null }
  ];
  var EVIDENCE = [
    {
      id: "EV-001",
      case_id: "CASE-2026-0001",
      vault_id: "V-0001",
      filename: "A4_Master_Reference_Annexes_Summary_with_Attachments__5_.pdf",
      name: "A4 Master Reference Annexes Summary.pdf",
      file_type: "pdf",
      type: "pdf",
      file_size: 55028,
      size: 55028,
      hash_sha256: "a3f2b8c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2",
      mlx_classification: "EXPERT_REPORT",
      mlx_confidence: 0.96,
      human_classification: "EXPERT_REPORT",
      classification_status: "human_validated",
      extracted_date: "2025-12-22",
      extracted_parties: ["USACE", "HKA"],
      extracted_amounts: [],
      suggested_folders: ["/Expert Reports"],
      assigned_folders: ["/Expert Reports"],
      folder: "expert",
      tags: ["THEMIS:case:CASE-2026-0001", "THEMIS:type:EXPERT_REPORT", "THEMIS:valid:confirmed", "THEMIS:fw:RICS", "THEMIS:meth:AACE"],
      upload_timestamp: "2026-01-10T10:00:00Z",
      validated_at: "2026-01-10T10:30:00Z",
      vsp_signature: "ed25519:a1b2c3d4e5f6",
      validation: "confirmed",
      selected: false,
      pages: 6,
      preview: null
    },
    {
      id: "EV-002",
      case_id: "CASE-2026-0001",
      vault_id: "V-0001",
      filename: "Contract_Agreement_v2.pdf",
      name: "Contract Agreement v2.pdf",
      file_type: "pdf",
      type: "pdf",
      file_size: 55028,
      size: 55028,
      hash_sha256: "b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5",
      mlx_classification: "CONTRACT",
      mlx_confidence: 0.94,
      human_classification: "CONTRACT",
      classification_status: "human_validated",
      extracted_date: "2017-03-15",
      extracted_parties: ["USACE", "Contractor"],
      extracted_amounts: [],
      suggested_folders: ["/Pre-Contract"],
      assigned_folders: ["/Pre-Contract"],
      folder: "pre",
      tags: ["THEMIS:case:CASE-2026-0001", "THEMIS:type:CONTRACT", "THEMIS:valid:confirmed", "THEMIS:fw:RICS"],
      upload_timestamp: "2026-01-10T11:00:00Z",
      validated_at: "2026-01-10T11:30:00Z",
      vsp_signature: "ed25519:b2c3d4e5f6a7",
      validation: "confirmed",
      selected: false,
      pages: 6,
      preview: null
    },
    {
      id: "EV-003",
      case_id: "CASE-2026-0001",
      vault_id: "V-0001",
      filename: "Delay_Analysis_Issue_3.pdf",
      name: "Delay Analysis Issue 3.pdf",
      file_type: "pdf",
      type: "pdf",
      file_size: 55028,
      size: 55028,
      hash_sha256: "c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6",
      mlx_classification: "EXPERT_REPORT",
      mlx_confidence: 0.92,
      human_classification: "EXPERT_REPORT",
      classification_status: "human_validated",
      extracted_date: "2025-12-22",
      extracted_parties: ["HKA"],
      extracted_amounts: [],
      suggested_folders: ["/Expert Reports"],
      assigned_folders: ["/Expert Reports"],
      folder: "expert",
      tags: ["THEMIS:case:CASE-2026-0001", "THEMIS:type:EXPERT_REPORT", "THEMIS:valid:confirmed", "THEMIS:fw:RICS", "THEMIS:meth:AACE"],
      upload_timestamp: "2026-01-11T09:00:00Z",
      validated_at: "2026-01-11T09:30:00Z",
      vsp_signature: "ed25519:c3d4e5f6a7b8",
      validation: "confirmed",
      selected: false,
      pages: 6,
      preview: null
    },
    {
      id: "EV-004",
      case_id: "CASE-2026-0001",
      vault_id: "V-0001",
      filename: "Delay_Analysis_Issue_8.pdf",
      name: "Delay Analysis Issue 8.pdf",
      file_type: "pdf",
      type: "pdf",
      file_size: 55028,
      size: 55028,
      hash_sha256: "d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7",
      mlx_classification: "EXPERT_REPORT",
      mlx_confidence: 0.91,
      human_classification: "EXPERT_REPORT",
      classification_status: "human_validated",
      extracted_date: "2025-12-22",
      extracted_parties: ["HKA"],
      extracted_amounts: [],
      suggested_folders: ["/Expert Reports"],
      assigned_folders: ["/Expert Reports"],
      folder: "expert",
      tags: ["THEMIS:case:CASE-2026-0001", "THEMIS:type:EXPERT_REPORT", "THEMIS:valid:confirmed", "THEMIS:fw:RICS", "THEMIS:meth:AACE"],
      upload_timestamp: "2026-01-11T10:00:00Z",
      validated_at: "2026-01-11T10:30:00Z",
      vsp_signature: "ed25519:d4e5f6a7b8c9",
      validation: "confirmed",
      selected: false,
      pages: 6,
      preview: null
    },
    {
      id: "EV-005",
      case_id: "CASE-2026-0001",
      vault_id: "V-0001",
      filename: "HKA_Expert_Report_Final.pdf",
      name: "HKA Expert Report Final.pdf",
      file_type: "pdf",
      type: "pdf",
      file_size: 55028,
      size: 55028,
      hash_sha256: "e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8",
      mlx_classification: "EXPERT_REPORT",
      mlx_confidence: 0.97,
      human_classification: null,
      classification_status: "mlx_suggested",
      extracted_date: "2025-12-22",
      extracted_parties: ["HKA"],
      extracted_amounts: [],
      suggested_folders: ["/Expert Reports"],
      assigned_folders: [],
      folder: "expert",
      tags: ["THEMIS:case:CASE-2026-0001", "THEMIS:type:EXPERT_REPORT", "THEMIS:valid:pending", "THEMIS:fw:RICS"],
      upload_timestamp: "2026-01-12T09:00:00Z",
      validated_at: null,
      vsp_signature: "ed25519:e5f6a7b8c9d0",
      validation: "pending",
      selected: false,
      pages: 6,
      preview: null
    },
    {
      id: "EV-006",
      case_id: "CASE-2026-0001",
      vault_id: "V-0001",
      filename: "Programme_Schedule_Rev3.pdf",
      name: "Programme Schedule Rev3.pdf",
      file_type: "pdf",
      type: "pdf",
      file_size: 55028,
      size: 55028,
      hash_sha256: "f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9",
      mlx_classification: "PROGRAMME",
      mlx_confidence: 0.95,
      human_classification: "PROGRAMME",
      classification_status: "human_validated",
      extracted_date: "2022-12-01",
      extracted_parties: [],
      extracted_amounts: [],
      suggested_folders: ["/Programme"],
      assigned_folders: ["/Programme"],
      folder: "prog",
      tags: ["THEMIS:case:CASE-2026-0001", "THEMIS:type:PROGRAMME", "THEMIS:valid:confirmed", "THEMIS:fw:RICS"],
      upload_timestamp: "2026-01-12T14:00:00Z",
      validated_at: "2026-01-12T14:30:00Z",
      vsp_signature: "ed25519:f6a7b8c9d0e1",
      validation: "confirmed",
      selected: false,
      pages: 6,
      preview: null
    },
    {
      id: "EV-007",
      case_id: "CASE-2026-0001",
      vault_id: "V-0001",
      filename: "RFI_Response_Summary.pdf",
      name: "RFI Response Summary.pdf",
      file_type: "pdf",
      type: "pdf",
      file_size: 55028,
      size: 55028,
      hash_sha256: "a9b0c1d2e3f4a5b6c7d8e9f0a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0",
      mlx_classification: "CORRESPONDENCE",
      mlx_confidence: 0.89,
      human_classification: "CORRESPONDENCE",
      classification_status: "human_validated",
      extracted_date: "2022-06-15",
      extracted_parties: ["USACE", "Contractor"],
      extracted_amounts: [],
      suggested_folders: ["/Correspondence"],
      assigned_folders: ["/Correspondence"],
      folder: "corr",
      tags: ["THEMIS:case:CASE-2026-0001", "THEMIS:type:CORRESPONDENCE", "THEMIS:valid:confirmed", "THEMIS:fw:RICS"],
      upload_timestamp: "2026-01-13T09:00:00Z",
      validated_at: "2026-01-13T09:30:00Z",
      vsp_signature: "ed25519:a7b8c9d0e1f2",
      validation: "confirmed",
      selected: false,
      pages: 6,
      preview: null
    },
    {
      id: "EV-008",
      case_id: "CASE-2026-0001",
      vault_id: "V-0001",
      filename: "Site_Meeting_Minutes_15.pdf",
      name: "Site Meeting Minutes #15.pdf",
      file_type: "pdf",
      type: "pdf",
      file_size: 55028,
      size: 55028,
      hash_sha256: "b0c1d2e3f4a5b6c7d8e9f0a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1",
      mlx_classification: "MINUTES",
      mlx_confidence: 0.93,
      human_classification: "MINUTES",
      classification_status: "human_validated",
      extracted_date: "2021-11-08",
      extracted_parties: ["USACE", "Contractor", "Architect"],
      extracted_amounts: [],
      suggested_folders: ["/Minutes"],
      assigned_folders: ["/Minutes"],
      folder: "min",
      tags: ["THEMIS:case:CASE-2026-0001", "THEMIS:type:MINUTES", "THEMIS:valid:confirmed", "THEMIS:fw:RICS"],
      upload_timestamp: "2026-01-14T10:00:00Z",
      validated_at: "2026-01-14T10:30:00Z",
      vsp_signature: "ed25519:b8c9d0e1f2a3",
      validation: "confirmed",
      selected: false,
      pages: 6,
      preview: null
    },
    {
      id: "EV-009",
      case_id: "CASE-2026-0001",
      vault_id: "V-0001",
      filename: "Variation_Order_VO-007.pdf",
      name: "Variation Order VO-007.pdf",
      file_type: "pdf",
      type: "pdf",
      file_size: 55028,
      size: 55028,
      hash_sha256: "c1d2e3f4a5b6c7d8e9f0a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2",
      mlx_classification: "VARIATION",
      mlx_confidence: 0.88,
      human_classification: null,
      classification_status: "mlx_suggested",
      extracted_date: "2022-03-20",
      extracted_parties: ["USACE", "Contractor"],
      extracted_amounts: [{ value: 125e3, currency: "USD" }],
      suggested_folders: ["/Variations"],
      assigned_folders: [],
      folder: "var",
      tags: ["THEMIS:case:CASE-2026-0001", "THEMIS:type:VARIATION", "THEMIS:valid:rejected", "THEMIS:fw:RICS"],
      upload_timestamp: "2026-01-15T09:00:00Z",
      validated_at: null,
      vsp_signature: "ed25519:c9d0e1f2a3b4",
      validation: "rejected",
      selected: false,
      pages: 6,
      preview: null
    }
  ];
  var OUTPUTS = [
    { id: 1, name: "Delay Report v2.pdf", desc: "Apr 12 * Complete", type: "pdf" },
    { id: 2, name: "Quantum Schedule.xlsx", desc: "Apr 11 * Complete", type: "xlsx" },
    { id: 3, name: "Timeline Export.pdf", desc: "Apr 10 * Complete", type: "pdf" }
  ];
  var AppContext = createContext();
  var useApp = () => useContext(AppContext);
  var AppProvider = ({ children }) => {
    const [state, setState] = useState({
      // =====================================================================
      // VERSION & UPDATE STATE (Service Worker Integration)
      // =====================================================================
      appVersion: "loading...",  // Will be fetched from API
      updateInfo: { update_available: false, can_publish: false, github_version: null },
      localAgentConnected: false,
      lintSuggestions: [],
      releases: [],
      serviceWorkerConnected: false,
      // UI State
      showLanding: true,
      mode: "analysis",
      theme: "light",
      leftCollapsed: false,
      rightCollapsed: false,
      showTagLabels: true,
      showEvidenceIds: false,
      // Hide by default for minimalist UI
      // Backend Connection (SAD v8.0.18)
      backendConnected: false,
      wsConnected: false,
      // Dropdowns
      caseDropdownOpen: false,
      settingsDropdownOpen: false,
      vaultDropdownOpen: false,
      brandDropdownOpen: false,
      // Brand
      currentBrand: BRANDS[0],
      // Modals
      activeModal: null,
      // 'evidence', 'time-tracker', 'create-case', 'create-vault', 'constraints', 'release-notes'
      modalFromLanding: false,
      // Data
      currentCase: CASES[0],
      currentVault: VAULTS[0],
      vaults: VAULTS,
      documents: DOCS,
      evidence: EVIDENCE,
      // THEMIS-tagged files
      expandedFolders: /* @__PURE__ */ new Set(["rics-2-08"]),
      // Default expanded folder
      // Framework Folders (SAD Section 13)
      folders: getFrameworkFolders(CASES[0]?.framework),
      // Dynamic based on case framework
      folderPhases: getPhases(getFrameworkFolders(CASES[0]?.framework)),
      // Phase headers
      expandedPhases: /* @__PURE__ */ new Set([1, 2, 3]),
      // Which phases are expanded in LeftPane
      // Smart Folder Contents (T2.3)
      folderContents: {},
      // { folderId: [evidence] } - cached folder contents from API
      folderContentsLoading: {},
      // { folderId: boolean }
      activeFolderId: null,
      // Currently selected folder for filtering
      // File Manager State
      uploadQueue: [],
      // Files pending Zero Trust validation
      uploadProgress: {},
      // { fileId: percentage }
      // TIER 3: Zero Trust Pipeline State
      ztPipeline: {
        staging: [],
        validated: [],
        rejected: []
      },
      tier3Reports: {
        preliminary: {},
        roReport: null,
        analysisResults: {}
      },
      provenanceChains: {},
      // =====================================================================
      // FIX7: NEW STATES for backend features (routes_v8.py)
      // =====================================================================
      // Zero Trust Import Pipeline Status
      activeImports: {},
      // { importId: { status, stage, progress, file, vsp_hash } }
      importConfig: null,
      // Current import configuration
      // Quarantine Management
      quarantineEntries: [],
      // Files in quarantine
      quarantineLoading: false,
      // SCL Protocol (22 Core Principles)
      sclPrinciples: [],
      // All 22 principles
      sclCompliance: null,
      // Current case compliance assessment
      sclRecordCategories: [],
      // 6 record categories
      // Risk Events (FEATURE_SPEC ¬ß6)
      riskEvents: [],
      // Case risk events
      riskEventsLoading: false,
      // Notices (FEATURE_SPEC ¬ß5)
      notices: [],
      // Case notices
      noticesOverdue: [],
      // Overdue notices
      noticesUpcoming: [],
      // Upcoming deadlines
      noticesLoading: false,
      // Concurrency Analysis (FEATURE_SPEC ¬ß8)
      concurrencyResult: null,
      // Last analysis result
      concurrencyLoading: false,
      // R&O Assessments (FEATURE_SPEC ¬ß9)
      roAssessments: [],
      // Generated assessments
      roAssessmentsLoading: false,
      // Extended Framework Data
      frameworkSupported: null,
      // { frameworks, methodologies }
      delayMethods: [],
      // Available delay methods
      methodCrossRef: [],
      // SCL ‚Üî AACE cross-references
      // Active Panel for new features
      activeProtocolPanel: null,
      // 'scl', 'events', 'notices', 'ro', 'concurrency', 'quarantine'
      // =====================================================================
      // Wizard
      wizardStep: 0,
      wizardMode: null,
      // 'quick' or 'full'
      // Progress & Notifications
      progressActive: false,
      banner: { show: true, type: "info", message: "THEMIS-QS v10.5.42", action: "Release Notes" },
      notifications: [
        { id: 1, type: "success", message: "Ready  -  checking backend..." }
      ],
      // Search State (SAD 17.4 - T2.1)
      searchQuery: "",
      searchResults: [],
      searchLoading: false,
      searchHistory: [],
      // Recent searches with hash for reproducibility
      searchHighlightEnabled: true,
      // T2.5: Enable search highlighting
      // Time Tracker
      timeRunning: true,
      timeSeconds: 3661,
      // Messages & Streaming
      messages: [
        { id: 1, role: "user", content: "Analyze the delay events in the construction phase", timestamp: "10:30" },
        { id: 2, role: "assistant", va: "DA", content: "Based on the uploaded documents, I identified 3 primary delay events:\n\n1. Weather delays (14 days)\n2. Design changes (21 days)\n3. Material shortages (8 days)\n\nTotal critical path delay: 43 days", timestamp: "10:31" }
      ],
      streamingMessage: null,
      // Preview Modals (Draggable/Resizable document previews)
      openPreviews: [],
      // [{ id, evidenceId, name, type, x, y, width, height, zIndex, minimized }]
      previewZCounter: 100
      // Z-index counter for bringing to front
    });
    useEffect(() => {
      const connectWS = async () => {
        if (state.backendConnected && state.currentCase && !state.wsConnected) {
          console.log("[THEMIS] Auto-connecting WebSocket for case:", state.currentCase.id);
          await themisWS.connect(state.currentCase.id);
          setState((s) => ({ ...s, wsConnected: themisWS.connected }));
          if (themisWS.connected) {
            console.log("[THEMIS] WebSocket connected");
          }
        }
      };
      connectWS();
    }, [state.backendConnected, state.currentCase?.id]);
    // =====================================================================
    // SERVICE WORKER: Check for updates from GitHub via LocalAgent
    // =====================================================================
    useEffect(() => {
// Fetch version from API first, then check for updates
const initializeApp = async () => {
  let currentVersion = "10.5.7";  // Fallback
  
  // 1. Fetch version from API
  try {
    const resp = await fetch("http://localhost:9998/api/app");
    if (resp.ok) {
      const data = await resp.json();
      if (data.version) {
        currentVersion = data.version;
        setState((s) => ({ ...s, appVersion: data.version }));
        console.log("[THEMIS] Version loaded from API:", data.version);
      }
    }
  } catch (e) {
    console.warn("[THEMIS] Could not fetch version from API, using fallback");
    setState((s) => ({ ...s, appVersion: currentVersion }));
  }
  
  // 2. Now check for updates with the correct version
  try {
    // Check LocalAgent health first
    const laHealth = await ThemisAPI.localAgent.health();
    if (laHealth) {
      setState((s) => ({ ...s, localAgentConnected: true, serviceWorkerConnected: true }));
    }
    
    // Check service worker health
    const swHealth = await ThemisAPI.serviceWorker.health();
    let serviceWorkerOk = false;
    if (swHealth) {
      setState((s) => ({ ...s, serviceWorkerConnected: true }));
      serviceWorkerOk = true;
    } else {
      console.log("[THEMIS] Service Worker not available, using local changelog only");
    }
    
    // Fetch releases from GitHub via service worker (if available)
    let allReleases = [];
    if (serviceWorkerOk) {
      const releasesData = await ThemisAPI.serviceWorker.releases("THEMiS-eng", "themis-qs");
      allReleases = releasesData && releasesData.releases ? releasesData.releases : [];
    }
    
    // Always fetch local changelog
    try {
      const localChangelog = await fetch("http://localhost:9998/api/changelog").then(r => r.ok ? r.json() : null);
      if (localChangelog && localChangelog.releases && localChangelog.releases.length > 0) {
        // Merge local releases that are not on GitHub
        const githubVersions = new Set(allReleases.map(r => r.tag.replace("v", "")));
        const localOnly = localChangelog.releases.filter(r => !githubVersions.has(r.version));
        if (localOnly.length > 0) {
          console.log("[THEMIS] Adding " + localOnly.length + " local releases");
          allReleases = [...localOnly, ...allReleases];
        }
      }
    } catch (e) {
      console.log("[THEMIS] Could not fetch local changelog:", e);
    }
    
    if (allReleases.length > 0) {
      setState((s) => ({ ...s, releases: allReleases }));
      
      // Check if update available OR can publish
      // Use GitHub latest for comparison (not local)
      const githubReleases = allReleases.filter(r => !r.local);
      const latest = githubReleases[0];
      if (latest) {
        const latestVersion = latest.tag.replace("v", "");
        const versionTuple = (v) => v.split(".").map((x) => parseInt(x) || 0);
        const latestTuple = versionTuple(latestVersion);
        const currentTuple = versionTuple(currentVersion);
        
        let comparison = 0; // 0=equal, 1=update available, -1=can publish
        for (let i = 0; i < 3; i++) {
          if (latestTuple[i] > currentTuple[i]) { comparison = 1; break; }
          if (latestTuple[i] < currentTuple[i]) { comparison = -1; break; }
        }
        
        if (comparison === 1) {
          // GitHub is newer - update available
          console.log("[THEMIS] Update available: v" + currentVersion + " -> v" + latestVersion);
          setState((s) => ({
            ...s,
            updateInfo: {
              update_available: true,
              can_publish: false,
              current_version: currentVersion,
              latest_version: latestVersion,
              github_version: latestVersion,
              release_notes: latest.body,
              html_url: latest.html_url,
              assets: latest.assets
            },
            banner: { show: true, type: "warning", message: "Update available: v" + latestVersion, action: "Install Update" },
            notifications: [...s.notifications, { id: Date.now(), type: "info", message: "Update available: v" + latestVersion }]
          }));
        } else if (comparison === -1) {
          // Local is newer - can publish
          console.log("[THEMIS] Can publish: v" + currentVersion + " (GitHub: v" + latestVersion + ")");
          setState((s) => ({
            ...s,
            updateInfo: {
              update_available: false,
              can_publish: true,
              current_version: currentVersion,
              github_version: latestVersion
            },
            banner: { show: true, type: "info", message: "Ready to publish v" + currentVersion, action: "Publish" }
          }));
        }
      }
    }
  } catch (e) {
    console.warn("[THEMIS] Error checking updates:", e);
  }
};

initializeApp();
    }, []);
    useEffect(() => {
      document.body.className = `mode-${state.mode} framework-${state.currentCase?.framework?.toLowerCase() || "rics"}`;
    }, []);
    useEffect(() => {
      let wasConnected = false;
      let checkCount = 0;
      let intervalId = null;
      const checkBackend = async () => {
        checkCount++;
        const ok = await ThemisAPI.health();
        setState((s) => {
          if (checkCount === 1) {
            if (ok) {
              console.log("[THEMIS] Backend connected");
              return {
                ...s,
                backendConnected: true,
                notifications: [...s.notifications, { id: Date.now(), type: "success", message: "Backend connected via LocalAgent" }]
              };
            } else {
              console.log("[THEMIS] Backend offline - will retry");
              return {
                ...s,
                backendConnected: false,
                notifications: [...s.notifications, { id: Date.now(), type: "warning", message: "Backend offline - retrying every 5s..." }]
              };
            }
          }
          if (ok && !wasConnected) {
            console.log("[THEMIS] Backend connected");
            return {
              ...s,
              backendConnected: ok,
              notifications: [...s.notifications, { id: Date.now(), type: "success", message: "Backend connected via LocalAgent" }]
            };
          } else if (!ok && wasConnected) {
            console.log("[THEMIS] Backend disconnected");
            return {
              ...s,
              backendConnected: ok,
              wsConnected: false,
              notifications: [...s.notifications, { id: Date.now(), type: "warning", message: "Backend connection lost" }]
            };
          }
          return { ...s, backendConnected: ok };
        });
        wasConnected = ok;
        const newInterval = ok ? 3e4 : 5e3;
        if (intervalId) {
          clearInterval(intervalId);
          intervalId = setInterval(checkBackend, newInterval);
        }
      };
      checkBackend();
      intervalId = setInterval(checkBackend, 5e3);
      return () => clearInterval(intervalId);
    }, []);
    useEffect(() => {
      if (state.notifications.length > 0) {
        const timer = setTimeout(() => {
          setState((s) => ({
            ...s,
            notifications: s.notifications.slice(1)
            // Remove oldest
          }));
        }, 5e3);
        return () => clearTimeout(timer);
      }
    }, [state.notifications]);
    useEffect(() => {
      themisWS.on("evidence.uploaded", (p) => {
        setState((s) => ({
          ...s,
          notifications: [...s.notifications, { id: Date.now(), type: "success", message: `${p.name || "File"} uploaded` }]
        }));
      });
      themisWS.on("evidence.classified", (p) => {
        setState((s) => ({
          ...s,
          evidence: s.evidence.map(
            (e) => e.id === p.evidence_id ? { ...e, mlx_classification: p.classification, mlx_confidence: p.confidence } : e
          ),
          notifications: [...s.notifications, { id: Date.now(), type: "info", message: `${p.evidence_id} classified: ${p.classification}` }]
        }));
      });
      themisWS.on("evidence.validated", (p) => {
        setState((s) => ({
          ...s,
          evidence: s.evidence.map(
            (e) => e.id === p.evidence_id ? { ...e, validation: p.status } : e
          ),
          notifications: [...s.notifications, { id: Date.now(), type: "success", message: `${p.evidence_id} ${p.status}` }]
        }));
      });
      themisWS.on("folder.update", (p) => {
        setState((s) => ({
          ...s,
          notifications: [...s.notifications, { id: Date.now(), type: "info", message: `Folder ${p.folder_path} updated` }]
        }));
      });
      themisWS.on("tag.added", (p) => {
        setState((s) => ({
          ...s,
          evidence: s.evidence.map(
            (e) => e.id === p.evidence_id ? { ...e, tags: [...e.tags || [], p.tag] } : e
          ),
          notifications: [...s.notifications, { id: Date.now(), type: "info", message: `Tag added: ${p.tag}` }]
        }));
      });
      themisWS.on("tag.removed", (p) => {
        setState((s) => ({
          ...s,
          evidence: s.evidence.map(
            (e) => e.id === p.evidence_id ? { ...e, tags: (e.tags || []).filter((t) => t !== p.tag) } : e
          )
        }));
      });
      themisWS.on("chat.chunk", (p) => {
        setState((s) => ({ ...s, streamingMessage: (s.streamingMessage || "") + p.chunk }));
      });
      themisWS.on("chat.complete", (p) => {
        setState((s) => ({
          ...s,
          messages: [...s.messages, {
            id: Date.now(),
            role: "assistant",
            va: "AI",
            content: s.streamingMessage || p.content,
            timestamp: (/* @__PURE__ */ new Date()).toLocaleTimeString("en-US", { hour: "2-digit", minute: "2-digit" })
          }],
          streamingMessage: null
        }));
      });
      themisWS.on("analysis.progress", (p) => {
        setState((s) => ({
          ...s,
          progressActive: true,
          banner: { show: true, type: "info", message: `Analysis: ${p.stage} (${p.progress}%)`, action: null }
        }));
      });
      themisWS.on("analysis.complete", (p) => {
        setState((s) => ({
          ...s,
          progressActive: false,
          banner: { show: true, type: "success", message: "Analysis complete", action: "View Results" },
          notifications: [...s.notifications, { id: Date.now(), type: "success", message: "Analysis completed" }]
        }));
      });
      themisWS.on("analysis.error", (p) => {
        setState((s) => ({
          ...s,
          progressActive: false,
          banner: { show: true, type: "error", message: `Analysis failed: ${p.error}`, action: "Retry" },
          notifications: [...s.notifications, { id: Date.now(), type: "error", message: `Analysis error: ${p.error}` }]
        }));
      });
      themisWS.on("output.progress", (p) => {
        setState((s) => ({
          ...s,
          progressActive: true,
          banner: { show: true, type: "info", message: `Generating output: ${p.stage} (${p.progress}%)`, action: null }
        }));
      });
      themisWS.on("output.complete", (p) => {
        setState((s) => ({
          ...s,
          progressActive: false,
          banner: { show: true, type: "success", message: "Output ready", action: "Download" },
          notifications: [...s.notifications, { id: Date.now(), type: "success", message: "Output generated" }]
        }));
      });
      themisWS.on("search.results", (p) => {
        setState((s) => ({
          ...s,
          notifications: [...s.notifications, { id: Date.now(), type: "info", message: `Found ${p.count} results` }]
        }));
      });
      themisWS.on("vsp.record", (p) => {
        setState((s) => ({
          ...s,
          notifications: [...s.notifications, { id: Date.now(), type: "info", message: `VSP: ${p.action} recorded` }]
        }));
      });
      themisWS.on("service.started", (p) => {
        setState((s) => ({
          ...s,
          progressActive: false,
          notifications: [...s.notifications, { id: Date.now(), type: "success", message: `${p.service || "Service"} started` }]
        }));
      });
      themisWS.on("service.stopped", (p) => {
        setState((s) => ({
          ...s,
          progressActive: false,
          notifications: [...s.notifications, { id: Date.now(), type: "info", message: `${p.service || "Service"} stopped` }]
        }));
      });
      themisWS.on("service.error", (p) => {
        setState((s) => ({
          ...s,
          progressActive: false,
          notifications: [...s.notifications, { id: Date.now(), type: "error", message: `Service error: ${p.error}` }]
        }));
      });
      themisWS.on("system.notification", (p) => {
        setState((s) => ({
          ...s,
          notifications: [...s.notifications, { id: Date.now(), type: p.type || "info", message: p.message }]
        }));
      });
      themisWS.on("system.progress", (p) => {
        setState((s) => ({
          ...s,
          progressActive: p.active !== false,
          banner: p.message ? { show: true, type: "info", message: p.message, action: null } : s.banner
        }));
      });
      return () => {
        themisWS.off("evidence.uploaded");
        themisWS.off("evidence.classified");
        themisWS.off("evidence.validated");
        themisWS.off("folder.update");
        themisWS.off("tag.added");
        themisWS.off("tag.removed");
        themisWS.off("chat.chunk");
        themisWS.off("chat.complete");
        themisWS.off("analysis.progress");
        themisWS.off("analysis.complete");
        themisWS.off("analysis.error");
        themisWS.off("output.progress");
        themisWS.off("output.complete");
        themisWS.off("search.results");
        themisWS.off("vsp.record");
        themisWS.off("service.started");
        themisWS.off("service.stopped");
        themisWS.off("service.error");
        themisWS.off("system.notification");
        themisWS.off("system.progress");
      };
    }, []);
    const actions = {
      // Landing & Case
      closeLanding: () => setState((s) => ({ ...s, showLanding: false })),
      exitLanding: () => setState((s) => ({ ...s, showLanding: false })),
      selectCase: async (c) => {
        const frameworkFolders = getFrameworkFolders(c.framework);
        const phases = getPhases(frameworkFolders);
        setState((s) => ({
          ...s,
          currentCase: c,
          showLanding: false,
          caseDropdownOpen: false,
          folders: frameworkFolders,
          folderPhases: phases,
          expandedPhases: /* @__PURE__ */ new Set([1, 2, 3])
          // Reset expanded phases
        }));
        document.body.className = `mode-${state.mode} framework-${c.framework?.toLowerCase() || "rics"}`;
        
        // Sync case context to PromptLinter for skill context injection
        if (typeof PromptLinter !== 'undefined' && PromptLinter.setCaseContext) {
          PromptLinter.setCaseContext(c).then(() => {
            console.log("[THEMIS] Case context synced to PromptLinter:", c.id);
          });
        }
        
        if (state.backendConnected) {
          await ThemisAPI.cases.open(c.id);
          await themisWS.connect(c.id);
          setState((s) => ({ ...s, wsConnected: themisWS.connected }));
          const apiEvidence = await ThemisAPI.evidence.list(c.id);
          if (apiEvidence) setState((s) => ({ ...s, evidence: apiEvidence }));
          const folderTree = await ThemisAPI.folders.tree(c.id);
          if (folderTree && folderTree.folders) {
            console.log("[THEMIS] Loaded", folderTree.folders.length, "folders from backend");
            setState((s) => ({
              ...s,
              folders: folderTree.folders,
              folderPhases: folderTree.phases || phases
            }));
          }
        }
      },
      // Mode & Theme
      toggleMode: () => {
        setState((s) => {
          const newMode = s.mode === "analysis" ? "search" : "analysis";
          document.body.className = `mode-${newMode} framework-${s.currentCase?.framework?.toLowerCase() || "rics"}`;
          return { ...s, mode: newMode };
        });
      },
      setMode: (newMode) => {
        setState((s) => {
          document.body.className = `mode-${newMode} framework-${s.currentCase?.framework?.toLowerCase() || "rics"}`;
          return { ...s, mode: newMode };
        });
        // Expose for iframe communication
        window.__themisMode = newMode;
      },
      toggleTheme: () => {
        const newTheme = state.theme === "light" ? "dark" : "light";
        if (newTheme === "dark") {
          document.body.classList.add("dark-theme");
        } else {
          document.body.classList.remove("dark-theme");
        }
        setState((s) => ({ ...s, theme: newTheme }));
      },
      toggleTagLabels: () => setState((s) => ({ ...s, showTagLabels: !s.showTagLabels })),
      toggleEvidenceIds: () => setState((s) => ({ ...s, showEvidenceIds: !s.showEvidenceIds })),
      // Panes
      toggleLeft: () => setState((s) => ({ ...s, leftCollapsed: !s.leftCollapsed })),
      toggleRight: () => setState((s) => ({ ...s, rightCollapsed: !s.rightCollapsed })),
      // Folder Phases (SAD Section 13 - Tier 2 Complete)
      togglePhase: (phaseNum) => setState((s) => {
        const next = new Set(s.expandedPhases);
        next.has(phaseNum) ? next.delete(phaseNum) : next.add(phaseNum);
        return { ...s, expandedPhases: next };
      }),
      // =================================================================
      // SMART FOLDERS (SAD 9.4 - T2.3)
      // =================================================================
      // Toggle folder expansion and load contents from API
      toggleFolder: async (folderId) => {
        const isExpanding = !state.expandedFolders.has(folderId);
        setState((s) => {
          const next = new Set(s.expandedFolders);
          next.has(folderId) ? next.delete(folderId) : next.add(folderId);
          return { ...s, expandedFolders: next, activeFolderId: isExpanding ? folderId : null };
        });
        if (isExpanding && state.backendConnected) {
          const folder = state.folders.find((f) => f.id === folderId);
          if (folder && folder.path) {
            setState((s) => ({
              ...s,
              folderContentsLoading: { ...s.folderContentsLoading, [folderId]: true }
            }));
            try {
              const contents = await ThemisAPI.folders.contents(folder.path);
              setState((s) => ({
                ...s,
                folderContents: { ...s.folderContents, [folderId]: contents || [] },
                folderContentsLoading: { ...s.folderContentsLoading, [folderId]: false }
              }));
            } catch (err) {
              console.error("[Folders] Error loading contents:", err);
              setState((s) => ({
                ...s,
                folderContentsLoading: { ...s.folderContentsLoading, [folderId]: false }
              }));
            }
          }
        }
      },
      // Select folder to filter evidence in CenterPane
      selectFolder: (folderId) => {
        setState((s) => ({ ...s, activeFolderId: folderId }));
      },
      // Clear folder filter
      clearFolderFilter: () => {
        setState((s) => ({ ...s, activeFolderId: null }));
      },
      toggleDoc: (id) => setState((s) => ({
        ...s,
        documents: s.documents.map((d) => d.id === id ? { ...d, selected: !d.selected } : d)
      })),
      toggleSelectAll: () => setState((s) => {
        const allSelected = s.documents.every((d) => d.selected);
        return { ...s, documents: s.documents.map((d) => ({ ...d, selected: !allSelected })) };
      }),
      // =================================================================
      // EVIDENCE / FILE MANAGEMENT (SAD v8.0.14 Compliant)
      // =================================================================
      // Toggle evidence selection
      toggleEvidence: (id) => setState((s) => ({
        ...s,
        evidence: s.evidence.map((e) => e.id === id ? { ...e, selected: !e.selected } : e)
      })),
      // Select/deselect all evidence
      toggleSelectAllEvidence: () => setState((s) => {
        const allSelected = s.evidence.every((e) => e.selected);
        return { ...s, evidence: s.evidence.map((e) => ({ ...e, selected: !allSelected })) };
      }),
      // Add files to upload queue (Zero Trust pending)
      queueFilesForUpload: (files) => {
        const newFiles = Array.from(files).map((f, i) => ({
          id: `zt-${Date.now()}-${i}`,
          file: f,
          name: f.name,
          size: f.size,
          type: f.name.split(".").pop().toLowerCase(),
          status: "staging",
          progress: 0,
          vspHash: null,
          error: null
        }));
        setState((s) => ({
          ...s,
          ztPipeline: { ...s.ztPipeline, staging: [...s.ztPipeline.staging, ...newFiles] },
          uploadQueue: [...s.uploadQueue, ...newFiles],
          progressActive: true,
          notifications: [...s.notifications, { id: Date.now(), type: "info", message: `${files.length} file(s) in Zero Trust staging` }]
        }));
        newFiles.forEach((f) => actions.ztValidate(f.id));
      },
      ztValidate: async (fileId) => {
        const file = state.ztPipeline.staging.find((f) => f.id === fileId);
        if (!file) return;
        setState((s) => ({ ...s, uploadQueue: s.uploadQueue.map((f) => f.id === fileId ? { ...f, status: "validating" } : f) }));
        for (let p = 25; p <= 100; p += 25) {
          await new Promise((r) => setTimeout(r, 150));
          setState((s) => ({ ...s, uploadQueue: s.uploadQueue.map((f) => f.id === fileId ? { ...f, progress: p } : f) }));
        }
        const vspHash = "sha256:" + Array.from({ length: 16 }, () => Math.floor(Math.random() * 16).toString(16)).join("");
        setState((s) => ({
          ...s,
          ztPipeline: {
            ...s.ztPipeline,
            staging: s.ztPipeline.staging.filter((f) => f.id !== fileId),
            validated: [...s.ztPipeline.validated, { ...file, status: "validated", vspHash }]
          },
          uploadQueue: s.uploadQueue.map((f) => f.id === fileId ? { ...f, status: "validated", progress: 100 } : f),
          notifications: [...s.notifications, { id: Date.now(), type: "success", message: `${file.name} validated` }]
        }));
        await actions.ztCommit(fileId);
      },
      ztCommit: async (fileId) => {
        const file = state.ztPipeline.validated.find((f) => f.id === fileId);
        if (!file) return;
        const docId = `DOC-${String(state.evidence.length + 1).padStart(3, "0")}`;
        const evidenceData = {
          id: docId,
          case_id: state.currentCase?.id,
          vault_id: state.currentVault?.id,
          filename: file.name,
          name: file.name,
          file_type: file.type,
          type: file.type,
          file_size: file.size,
          size: file.size,
          hash_sha256: file.vspHash,
          mlx_classification: "PENDING",
          mlx_confidence: null,
          human_classification: null,
          classification_status: "pending",
          extracted_date: null,
          extracted_parties: [],
          extracted_amounts: [],
          suggested_folders: [],
          assigned_folders: ["/Inbox"],
          upload_timestamp: (/* @__PURE__ */ new Date()).toISOString(),
          validated_at: null,
          vsp_signature: file.vspHash,
          folder: "inbox",
          tags: [`THEMIS:case:${state.currentCase?.id}`, "THEMIS:valid:pending"],
          selected: false,
          validation: "pending"
        };
        if (state.backendConnected && state.currentCase) {
          const result = await ThemisAPI.evidence.upload(state.currentCase.id, file.file, () => {
          });
          if (result) {
            evidenceData.id = result.id;
            evidenceData.hash_sha256 = result.hash_sha256 || file.vspHash;
          }
        }
        setState((s) => ({
          ...s,
          ztPipeline: { ...s.ztPipeline, validated: s.ztPipeline.validated.filter((f) => f.id !== fileId) },
          uploadQueue: s.uploadQueue.filter((f) => f.id !== fileId),
          evidence: [...s.evidence, evidenceData],
          provenanceChains: { ...s.provenanceChains, [evidenceData.id]: [{ action: "uploaded", ts: file.addedAt, hash: file.vspHash }, { action: "validated", ts: (/* @__PURE__ */ new Date()).toISOString() }] },
          progressActive: s.uploadQueue.length > 1,
          notifications: [...s.notifications, { id: Date.now(), type: "success", message: `${docId} committed to vault` }]
        }));
        actions.genPrelimReport(evidenceData.id);
      },
      genPrelimReport: (evidenceId) => {
        const ev = state.evidence.find((e) => e.id === evidenceId);
        if (!ev) return;
        const report = { evidenceId, generatedAt: (/* @__PURE__ */ new Date()).toISOString(), classification: ev.type === "pdf" ? "DOCUMENT" : "DATA", risks: [{ id: "R1", desc: "Needs review", severity: "low" }], opportunities: [{ id: "O1", desc: "May support claim", impact: "medium" }] };
        setState((s) => ({ ...s, tier3Reports: { ...s.tier3Reports, preliminary: { ...s.tier3Reports.preliminary, [evidenceId]: report } } }));
        actions.updateRoReport();
      },
      updateRoReport: () => {
        const allPrelim = Object.values(state.tier3Reports.preliminary);
        const risks = allPrelim.flatMap((p) => p.risks || []);
        const opps = allPrelim.flatMap((p) => p.opportunities || []);
        setState((s) => ({ ...s, tier3Reports: { ...s.tier3Reports, roReport: { caseId: state.currentCase?.id, generatedAt: (/* @__PURE__ */ new Date()).toISOString(), risks, opportunities: opps, summary: { totalRisks: risks.length, totalOpportunities: opps.length } } } }));
      },
      verifyProvenance: async (evidenceIds) => {
        for (const id of evidenceIds) {
          const ev = state.evidence.find((e) => e.id === id);
          if (ev && ev.hash_sha256) {
            setState((s) => ({ ...s, notifications: [...s.notifications, { id: Date.now(), type: "success", message: `${id} provenance verified` }] }));
          }
        }
      },
      // Update upload progress
      updateUploadProgress: (fileId, progress, status) => setState((s) => ({
        ...s,
        uploadQueue: s.uploadQueue.map((f) => f.id === fileId ? { ...f, progress, status } : f)
      })),
      // Complete upload - move from queue to evidence
      completeUpload: (fileId, evidenceData) => setState((s) => ({
        ...s,
        uploadQueue: s.uploadQueue.filter((f) => f.id !== fileId),
        evidence: [...s.evidence, evidenceData]
      })),
      // Remove from upload queue
      cancelUpload: (fileId) => setState((s) => ({
        ...s,
        uploadQueue: s.uploadQueue.filter((f) => f.id !== fileId)
      })),
      // Remove evidence from vault
      removeEvidence: async (ids) => {
        if (state.backendConnected) {
          for (const id of ids) {
            await ThemisAPI.evidence.remove(id);
          }
        }
        setState((s) => ({
          ...s,
          evidence: s.evidence.filter((e) => !ids.includes(e.id)),
          notifications: [...s.notifications, { id: Date.now(), type: "info", message: `${ids.length} evidence item(s) removed` }]
        }));
      },
      // Add tag to evidence (SAD v8.0.14: POST /api/tags/{evidence_id})
      addTag: (evidenceId, tag) => setState((s) => ({
        ...s,
        evidence: s.evidence.map(
          (e) => e.id === evidenceId && !e.tags.includes(tag) ? { ...e, tags: [...e.tags, tag] } : e
        )
      })),
      // Remove tag from evidence (SAD v8.0.14: DELETE /api/tags/{evidence_id}/{tag})
      removeTag: (evidenceId, tag) => setState((s) => ({
        ...s,
        evidence: s.evidence.map(
          (e) => e.id === evidenceId ? { ...e, tags: e.tags.filter((t) => t !== tag) } : e
        )
      })),
      // Update validation status (SAD v8.0.14: THEMIS:valid:{status})
      setValidation: async (evidenceId, status) => {
        if (state.backendConnected) {
          await ThemisAPI.evidence.validate(evidenceId, { status });
        }
        setState((s) => ({
          ...s,
          evidence: s.evidence.map((e) => {
            if (e.id !== evidenceId) return e;
            const newTags = e.tags.filter((t) => !t.startsWith("THEMIS:valid:"));
            newTags.push(`THEMIS:valid:${status}`);
            return { ...e, tags: newTags, validation: status };
          })
        }));
      },
      // Bulk tag operation
      bulkAddTag: (ids, tag) => setState((s) => ({
        ...s,
        evidence: s.evidence.map(
          (e) => ids.includes(e.id) && !e.tags.includes(tag) ? { ...e, tags: [...e.tags, tag] } : e
        )
      })),
      // Replace all evidence with new files (for new case)
      replaceEvidence: (newEvidence) => setState((s) => ({
        ...s,
        evidence: newEvidence
      })),
      // Add evidence files
      addEvidence: (newFiles) => setState((s) => ({
        ...s,
        evidence: [...s.evidence, ...newFiles]
      })),
      // Move evidence to folder (updates THEMIS:folder tag)
      moveToFolder: async (ids, folderPath) => {
        if (state.backendConnected) {
          for (const id of ids) {
            await ThemisAPI.folders.add(folderPath, id);
          }
        }
        setState((s) => ({
          ...s,
          evidence: s.evidence.map((e) => {
            if (!ids.includes(e.id)) return e;
            const newTags = e.tags.filter((t) => !t.startsWith("THEMIS:folder:"));
            newTags.push(`THEMIS:folder:${folderPath}`);
            return { ...e, tags: newTags, folder: folderPath };
          })
        }));
      },
      // Vault
      selectVault: (v) => setState((s) => ({ ...s, currentVault: v, vaultDropdownOpen: false })),
      // Dropdowns
      toggleCaseDropdown: () => setState((s) => ({ ...s, caseDropdownOpen: !s.caseDropdownOpen, settingsDropdownOpen: false, vaultDropdownOpen: false, brandDropdownOpen: false })),
      toggleSettingsDropdown: () => setState((s) => ({ ...s, settingsDropdownOpen: !s.settingsDropdownOpen, caseDropdownOpen: false, vaultDropdownOpen: false, brandDropdownOpen: false })),
      toggleVaultDropdown: () => setState((s) => ({ ...s, vaultDropdownOpen: !s.vaultDropdownOpen, caseDropdownOpen: false, settingsDropdownOpen: false, brandDropdownOpen: false })),
      toggleBrandDropdown: () => setState((s) => ({ ...s, brandDropdownOpen: !s.brandDropdownOpen, caseDropdownOpen: false, settingsDropdownOpen: false, vaultDropdownOpen: false })),
      selectBrand: (b) => {
        document.body.className = `mode-${state.mode} brand-${b.id}`;
        setState((s) => ({ ...s, currentBrand: b, brandDropdownOpen: false }));
      },
      closeDropdowns: () => setState((s) => ({ ...s, caseDropdownOpen: false, settingsDropdownOpen: false, vaultDropdownOpen: false, brandDropdownOpen: false })),
      // Modals
      openModal: (name) => setState((s) => ({
        ...s,
        activeModal: name,
        modalFromLanding: s.showLanding,
        // Remember if opened from landing
        showLanding: false,
        // Hide landing when opening any modal
        caseDropdownOpen: false,
        settingsDropdownOpen: false,
        vaultDropdownOpen: false,
        brandDropdownOpen: false
      })),
      closeModal: () => setState((s) => ({
        ...s,
        activeModal: null,
        wizardStep: 0,
        wizardMode: null,
        showLanding: s.modalFromLanding && s.activeModal !== "create-case" ? true : s.showLanding,
        // Return to landing if came from there (except after case creation)
        modalFromLanding: false
      })),
      // =================================================================
      // PREVIEW MODALS (Draggable/Resizable Document Previews)
      // =================================================================
      // Open a new preview modal for an evidence item
      openPreview: (evidenceId) => {
        const ev = state.evidence.find((e) => e.id === evidenceId);
        if (!ev) return;
        if (state.openPreviews.find((p) => p.evidenceId === evidenceId)) {
          actions.bringPreviewToFront(evidenceId);
          return;
        }
        const offset = state.openPreviews.length * 30;
        const newPreview = {
          id: `preview-${Date.now()}`,
          evidenceId,
          name: ev.name || ev.filename,
          type: ev.type || ev.file_type,
          x: 100 + offset,
          y: 100 + offset,
          width: 650,
          height: 500,
          zIndex: state.previewZCounter + 1,
          minimized: false,
          loading: true
        };
        setState((s) => ({
          ...s,
          openPreviews: [...s.openPreviews, newPreview],
          previewZCounter: s.previewZCounter + 1
        }));
        if (state.backendConnected) {
          ThemisAPI.evidence.get(evidenceId).then((data) => {
            setState((s) => ({
              ...s,
              openPreviews: s.openPreviews.map(
                (p) => p.evidenceId === evidenceId ? { ...p, loading: false, data } : p
              )
            }));
          });
        } else {
          setState((s) => ({
            ...s,
            openPreviews: s.openPreviews.map(
              (p) => p.evidenceId === evidenceId ? { ...p, loading: false } : p
            )
          }));
        }
      },
      // Close a preview modal
      closePreview: (evidenceId) => setState((s) => ({
        ...s,
        openPreviews: s.openPreviews.filter((p) => p.evidenceId !== evidenceId)
      })),
      // Close all preview modals
      closeAllPreviews: () => setState((s) => ({
        ...s,
        openPreviews: []
      })),
      // Bring a preview to front (update z-index)
      bringPreviewToFront: (evidenceId) => setState((s) => ({
        ...s,
        previewZCounter: s.previewZCounter + 1,
        openPreviews: s.openPreviews.map(
          (p) => p.evidenceId === evidenceId ? { ...p, zIndex: s.previewZCounter + 1 } : p
        )
      })),
      // Update preview position (drag)
      updatePreviewPosition: (evidenceId, x, y) => setState((s) => ({
        ...s,
        openPreviews: s.openPreviews.map(
          (p) => p.evidenceId === evidenceId ? { ...p, x, y } : p
        )
      })),
      // Update preview size (resize)
      updatePreviewSize: (evidenceId, width, height) => setState((s) => ({
        ...s,
        openPreviews: s.openPreviews.map(
          (p) => p.evidenceId === evidenceId ? { ...p, width, height } : p
        )
      })),
      // Toggle minimize
      togglePreviewMinimize: (evidenceId) => setState((s) => ({
        ...s,
        openPreviews: s.openPreviews.map(
          (p) => p.evidenceId === evidenceId ? { ...p, minimized: !p.minimized } : p
        )
      })),
      // Tile all previews (arrange side by side)
      tilePreviews: () => {
        const count = state.openPreviews.length;
        if (count === 0) return;
        const screenW = window.innerWidth - 100;
        const screenH = window.innerHeight - 150;
        const cols = Math.ceil(Math.sqrt(count));
        const rows = Math.ceil(count / cols);
        const tileW = Math.floor(screenW / cols);
        const tileH = Math.floor(screenH / rows);
        setState((s) => ({
          ...s,
          openPreviews: s.openPreviews.map((p, i) => ({
            ...p,
            x: 50 + i % cols * tileW,
            y: 100 + Math.floor(i / cols) * tileH,
            width: tileW - 10,
            height: tileH - 10,
            minimized: false
          }))
        }));
      },
      // Wizard
      setWizardMode: (mode) => setState((s) => ({ ...s, wizardMode: mode })),
      nextWizardStep: () => setState((s) => ({ ...s, wizardStep: s.wizardStep + 1 })),
      prevWizardStep: () => setState((s) => ({ ...s, wizardStep: Math.max(0, s.wizardStep - 1) })),
      // Banner & Notifications
      dismissBanner: () => setState((s) => ({ ...s, banner: { ...s.banner, show: false } })),
      dismissNotification: (id) => setState((s) => ({ ...s, notifications: s.notifications.filter((n) => n.id !== id) })),
      addNotification: (type, message) => setState((s) => ({
        ...s,
        notifications: [...s.notifications, { id: Date.now(), type, message }]
      })),
      addMessage: (role, content, options = {}) => setState((s) => ({
        ...s,
        messages: [...s.messages, { 
          id: Date.now(), 
          role, 
          content, 
          va: options.va || (role === "assistant" ? "DA" : null),
          timestamp: new Date().toLocaleTimeString(),
          ...options 
        }]
      })),
      // Time Tracker
      toggleTimer: () => setState((s) => ({ ...s, timeRunning: !s.timeRunning })),
      resetTimer: () => setState((s) => ({ ...s, timeSeconds: 0, timeRunning: false })),
      // =================================================================
      // SEARCH (SAD 17.4 - T2.1)
      // =================================================================
      // Execute search - full text or by specific criteria
      executeSearch: async (query, options = {}) => {
        if (!query?.trim()) return;
        setState((s) => ({ ...s, searchQuery: query, searchLoading: true }));
        try {
          let results = null;
          const caseId = state.currentCase?.id;
          if (state.backendConnected) {
            if (options.type === "tag") {
              results = await ThemisAPI.search.byTag(options.namespace, options.value, caseId);
            } else if (options.type === "doctype") {
              results = await ThemisAPI.search.byType(options.docType, caseId);
            } else if (options.type === "validation") {
              results = await ThemisAPI.search.byValidation(options.status, caseId);
            } else {
              results = await ThemisAPI.search.evidence(query, caseId);
            }
            if (results && results.length > 0) {
              const searchHash = await ThemisAPI.search.track(query, results.map((r) => r.id));
              if (searchHash) {
                setState((s) => ({
                  ...s,
                  searchHistory: [...s.searchHistory.slice(-19), { query, hash: searchHash.hash, count: results.length, timestamp: (/* @__PURE__ */ new Date()).toISOString() }]
                }));
              }
            }
          } else {
            const q = query.toLowerCase();
            results = state.evidence.filter(
              (e) => e.name?.toLowerCase().includes(q) || (e.tags || []).some((t) => t.toLowerCase().includes(q))
            );
          }
          setState((s) => ({
            ...s,
            searchResults: results || [],
            searchLoading: false,
            notifications: [...s.notifications, {
              id: Date.now(),
              type: results?.length > 0 ? "success" : "info",
              message: results?.length > 0 ? `Found ${results.length} results` : "No results found"
            }]
          }));
          return results;
        } catch (err) {
          console.error("[Search] Error:", err);
          setState((s) => ({
            ...s,
            searchLoading: false,
            notifications: [...s.notifications, { id: Date.now(), type: "error", message: "Search failed" }]
          }));
          return null;
        }
      },
      // Clear search results
      clearSearch: () => setState((s) => ({
        ...s,
        searchQuery: "",
        searchResults: [],
        searchLoading: false
      })),
      // Replay a previous search by hash (SAD 17.4.4)
      replaySearch: async (hash) => {
        if (!state.backendConnected) return null;
        setState((s) => ({ ...s, searchLoading: true }));
        const results = await ThemisAPI.search.history(hash);
        setState((s) => ({
          ...s,
          searchResults: results || [],
          searchLoading: false
        }));
        return results;
      },
      // =================================================================
      // FIX7: NEW ACTIONS for backend features (routes_v8.py)
      // =================================================================
      // Set active protocol panel
      setActiveProtocolPanel: (panel) => setState((s) => ({ ...s, activeProtocolPanel: panel })),
      // -----------------------------------------------------------------
      // ZERO TRUST IMPORT (FEATURE_SPEC ¬ß13)
      // -----------------------------------------------------------------
      // Upload via Zero Trust pipeline (5-stage validation)
      zeroTrustUpload: async (file) => {
        if (!state.backendConnected || !state.currentCase || !state.currentVault) {
          actions.addNotification("warning", "Backend not connected or no case/vault selected");
          return null;
        }
        const importId = `imp-${Date.now()}`;
        setState((s) => ({
          ...s,
          activeImports: {
            ...s.activeImports,
            [importId]: { status: "pending", stage: "quarantine", progress: 0, file: file.name }
          }
        }));
        try {
          const result = await ThemisAPI.zeroTrust.upload(
            state.currentCase.id,
            state.currentVault.id,
            file,
            (progress) => {
              setState((s) => ({
                ...s,
                activeImports: {
                  ...s.activeImports,
                  [importId]: { ...s.activeImports[importId], progress }
                }
              }));
            }
          );
          if (result) {
            setState((s) => ({
              ...s,
              activeImports: {
                ...s.activeImports,
                [result.import_id]: {
                  status: result.status,
                  stage: result.stage,
                  progress: result.stage_progress,
                  file: file.name,
                  evidenceId: result.evidence_id,
                  vspHash: result.vsp_hash
                }
              },
              notifications: [...s.notifications, {
                id: Date.now(),
                type: result.status === "complete" ? "success" : "info",
                message: `Import ${result.import_id}: ${result.stage} (${result.stage_progress}%)`
              }]
            }));
            return result;
          }
        } catch (err) {
          console.error("[ZeroTrust] Upload error:", err);
          actions.addNotification("error", `Import failed: ${err.message}`);
        }
        return null;
      },
      // Poll import progress
      pollImportProgress: async (importId) => {
        if (!state.backendConnected) return null;
        const progress = await ThemisAPI.zeroTrust.progress(importId);
        if (progress) {
          setState((s) => ({
            ...s,
            activeImports: {
              ...s.activeImports,
              [importId]: {
                ...s.activeImports[importId],
                ...progress.stages,
                currentStage: progress.current_stage,
                progress: progress.progress
              }
            }
          }));
        }
        return progress;
      },
      // Cancel import
      cancelImport: async (importId) => {
        if (!state.backendConnected) return false;
        const result = await ThemisAPI.zeroTrust.cancel(importId);
        if (result) {
          setState((s) => {
            const { [importId]: removed, ...rest } = s.activeImports;
            return { ...s, activeImports: rest };
          });
          actions.addNotification("info", `Import ${importId} cancelled`);
        }
        return !!result;
      },
      // Load import config
      loadImportConfig: async () => {
        if (!state.backendConnected || !state.currentCase) return null;
        const config = await ThemisAPI.zeroTrust.config.get(state.currentCase.id);
        if (config) setState((s) => ({ ...s, importConfig: config }));
        return config;
      },
      // -----------------------------------------------------------------
      // QUARANTINE MANAGEMENT (FEATURE_SPEC ¬ß13)
      // -----------------------------------------------------------------
      loadQuarantine: async () => {
        if (!state.backendConnected) return null;
        setState((s) => ({ ...s, quarantineLoading: true }));
        const entries = await ThemisAPI.quarantine.list();
        setState((s) => ({
          ...s,
          quarantineEntries: entries || [],
          quarantineLoading: false
        }));
        return entries;
      },
      deleteQuarantineEntry: async (id) => {
        if (!state.backendConnected) return false;
        const result = await ThemisAPI.quarantine.delete(id);
        if (result) {
          setState((s) => ({
            ...s,
            quarantineEntries: s.quarantineEntries.filter((e) => e.quarantine_id !== id),
            notifications: [...s.notifications, { id: Date.now(), type: "success", message: "Quarantine entry deleted" }]
          }));
        }
        return !!result;
      },
      retryQuarantineImport: async (id) => {
        if (!state.backendConnected) return null;
        const result = await ThemisAPI.quarantine.retry(id);
        if (result) {
          actions.addNotification("info", `Retry requested for ${id}`);
        }
        return result;
      },
      // -----------------------------------------------------------------
      // SCL PROTOCOL (FEATURE_SPEC ¬ß2-¬ß9)
      // -----------------------------------------------------------------
      loadSCLPrinciples: async () => {
        if (!state.backendConnected) return null;
        const principles = await ThemisAPI.scl.principles();
        if (principles) setState((s) => ({ ...s, sclPrinciples: principles }));
        return principles;
      },
      loadSCLCompliance: async (flags = {}) => {
        if (!state.backendConnected || !state.currentCase) return null;
        const compliance = await ThemisAPI.scl.compliance(state.currentCase.id, flags);
        if (compliance) setState((s) => ({ ...s, sclCompliance: compliance }));
        return compliance;
      },
      loadRecordCategories: async () => {
        if (!state.backendConnected) return null;
        const categories = await ThemisAPI.scl.recordCategories();
        if (categories) setState((s) => ({ ...s, sclRecordCategories: categories }));
        return categories;
      },
      suggestRecordCategory: async (docType) => {
        if (!state.backendConnected) return null;
        return await ThemisAPI.scl.suggestCategory(docType);
      },
      // -----------------------------------------------------------------
      // RISK EVENTS (FEATURE_SPEC ¬ß6)
      // -----------------------------------------------------------------
      loadRiskEvents: async () => {
        if (!state.backendConnected || !state.currentCase) return null;
        setState((s) => ({ ...s, riskEventsLoading: true }));
        const events = await ThemisAPI.events.list(state.currentCase.id);
        setState((s) => ({
          ...s,
          riskEvents: events || [],
          riskEventsLoading: false
        }));
        return events;
      },
      createRiskEvent: async (eventData) => {
        if (!state.backendConnected || !state.currentCase) return null;
        const event = await ThemisAPI.events.create(state.currentCase.id, eventData);
        if (event) {
          setState((s) => ({
            ...s,
            riskEvents: [...s.riskEvents, event],
            notifications: [...s.notifications, { id: Date.now(), type: "success", message: "Risk event created" }]
          }));
        }
        return event;
      },
      classifyRiskEvent: async (description, source) => {
        if (!state.backendConnected) return null;
        return await ThemisAPI.events.classify(description, source);
      },
      loadConcurrentEvents: async () => {
        if (!state.backendConnected || !state.currentCase) return null;
        return await ThemisAPI.events.concurrent(state.currentCase.id);
      },
      // -----------------------------------------------------------------
      // NOTICES (FEATURE_SPEC ¬ß5)
      // -----------------------------------------------------------------
      loadNotices: async (status, noticeType) => {
        if (!state.backendConnected || !state.currentCase) return null;
        setState((s) => ({ ...s, noticesLoading: true }));
        const notices = await ThemisAPI.notices.list(state.currentCase.id, status, noticeType);
        setState((s) => ({
          ...s,
          notices: notices || [],
          noticesLoading: false
        }));
        return notices;
      },
      createNotice: async (noticeData) => {
        if (!state.backendConnected || !state.currentCase) return null;
        const notice = await ThemisAPI.notices.create(state.currentCase.id, noticeData);
        if (notice) {
          setState((s) => ({
            ...s,
            notices: [...s.notices, notice],
            notifications: [...s.notifications, { id: Date.now(), type: "success", message: "Notice created" }]
          }));
        }
        return notice;
      },
      loadOverdueNotices: async () => {
        if (!state.backendConnected || !state.currentCase) return null;
        const overdue = await ThemisAPI.notices.overdue(state.currentCase.id);
        if (overdue) setState((s) => ({ ...s, noticesOverdue: overdue }));
        return overdue;
      },
      loadUpcomingNotices: async (daysAhead = 7) => {
        if (!state.backendConnected || !state.currentCase) return null;
        const upcoming = await ThemisAPI.notices.upcoming(state.currentCase.id, daysAhead);
        if (upcoming) setState((s) => ({ ...s, noticesUpcoming: upcoming }));
        return upcoming;
      },
      // -----------------------------------------------------------------
      // CONCURRENCY ANALYSIS (FEATURE_SPEC ¬ß8)
      // -----------------------------------------------------------------
      runConcurrencyAnalysis: async (request) => {
        if (!state.backendConnected || !state.currentCase) return null;
        setState((s) => ({ ...s, concurrencyLoading: true }));
        const result = await ThemisAPI.concurrency.analyze(state.currentCase.id, request);
        setState((s) => ({
          ...s,
          concurrencyResult: result,
          concurrencyLoading: false,
          notifications: result ? [...s.notifications, { id: Date.now(), type: "success", message: "Concurrency analysis complete" }] : s.notifications
        }));
        return result;
      },
      // -----------------------------------------------------------------
      // R&O ASSESSMENT (FEATURE_SPEC ¬ß9)
      // -----------------------------------------------------------------
      generateROAssessment: async (title, riskEventIds = [], noticeIds = []) => {
        if (!state.backendConnected || !state.currentCase) return null;
        setState((s) => ({ ...s, roAssessmentsLoading: true }));
        const assessment = await ThemisAPI.roAssessment.generate(state.currentCase.id, {
          title,
          risk_event_ids: riskEventIds,
          notice_ids: noticeIds
        });
        if (assessment) {
          setState((s) => ({
            ...s,
            roAssessments: [...s.roAssessments, assessment],
            roAssessmentsLoading: false,
            notifications: [...s.notifications, { id: Date.now(), type: "success", message: "R&O Assessment generated" }]
          }));
        } else {
          setState((s) => ({ ...s, roAssessmentsLoading: false }));
        }
        return assessment;
      },
      loadROAssessment: async (assessmentId) => {
        if (!state.backendConnected) return null;
        return await ThemisAPI.roAssessment.get(assessmentId);
      },
      // -----------------------------------------------------------------
      // EXTENDED FRAMEWORK SERVICE
      // -----------------------------------------------------------------
      loadFrameworkSupported: async () => {
        if (!state.backendConnected) return null;
        const data = await ThemisAPI.frameworkExt.supported();
        if (data) setState((s) => ({ ...s, frameworkSupported: data }));
        return data;
      },
      loadDelayMethods: async (methodology = "combined") => {
        if (!state.backendConnected) return null;
        const methods = await ThemisAPI.frameworkExt.delayMethods(methodology);
        if (methods) setState((s) => ({ ...s, delayMethods: methods }));
        return methods;
      },
      loadMethodCrossRef: async () => {
        if (!state.backendConnected) return null;
        const xref = await ThemisAPI.frameworkExt.crossReference();
        if (xref) setState((s) => ({ ...s, methodCrossRef: xref }));
        return xref;
      },
      detectFramework: async (text) => {
        if (!state.backendConnected) return null;
        return await ThemisAPI.frameworkExt.detect(text);
      },
      validateDelayMethod: async (methodId, flags) => {
        if (!state.backendConnected) return null;
        return await ThemisAPI.frameworkExt.validateMethod(methodId, flags);
      },
      // =====================================================================
      // UPDATE ACTIONS (Service Worker Integration)
      // =====================================================================
      installUpdate: async () => {
        if (!state.updateInfo.update_available) return { success: false, error: "No update available" };
        setState((s) => ({ ...s, notifications: [...s.notifications, { id: Date.now(), type: "info", message: "Installing update..." }] }));
        try {
          const result = await ThemisAPI.serviceWorker.installUpdate("themis");
          if (result && result.success) {
            setState((s) => ({ ...s, notifications: [...s.notifications, { id: Date.now(), type: "success", message: `Updated to v${result.new_version}! Reloading...` }] }));
            setTimeout(() => window.location.reload(), 2000);
            return result;
          } else {
            setState((s) => ({ ...s, notifications: [...s.notifications, { id: Date.now(), type: "error", message: `Update failed: ${result?.error || "Unknown error"}` }] }));
            return result;
          }
        } catch (e) {
          setState((s) => ({ ...s, notifications: [...s.notifications, { id: Date.now(), type: "error", message: `Update failed: ${e}` }] }));
          return { success: false, error: String(e) };
        }
      },
      publishRelease: async (version, notes) => {
        if (!state.updateInfo.can_publish) return { success: false, error: "Nothing to publish" };
        setState((s) => ({ ...s, notifications: [...s.notifications, { id: Date.now(), type: "info", message: "Publishing release..." }] }));
        try {
          const result = await ThemisAPI.localAgent.publish(version || state.appVersion, notes || "");
          if (result && result.success) {
            setState((s) => ({
              ...s,
              updateInfo: { ...s.updateInfo, can_publish: false },
              banner: { show: true, type: "success", message: "Release published!", action: null },
              notifications: [...s.notifications, { id: Date.now(), type: "success", message: `Published v${version || state.appVersion}!` }]
            }));
            return result;
          } else {
            setState((s) => ({ ...s, notifications: [...s.notifications, { id: Date.now(), type: "error", message: `Publish failed: ${result?.error || "Unknown"}` }] }));
            return result;
          }
        } catch (e) {
          setState((s) => ({ ...s, notifications: [...s.notifications, { id: Date.now(), type: "error", message: `Publish failed: ${e}` }] }));
          return { success: false, error: String(e) };
        }
      },
      // Progress Bar control
      setProgressActive: (active) => {
        setState((s) => ({ ...s, progressActive: active }));
      }
      // =================================================================
    };
    // Expose setMode for iframe communication
    window.__themisSetMode = actions.setMode;
    
    return h(AppContext.Provider, { value: { ...state, ...actions, cases: CASES, brands: BRANDS, frameworkInfo: FRAMEWORK_INFO, getFrameworkFolders }, children });
  };
  var Item = ({ icon, iconType, name, desc, badge, idBadge, selected, checkbox, onClick }) => h("div", { className: `item ${selected ? "selected" : ""}`, onClick, children: [
    h("div", { className: `item-icon ${iconType || ""}`, children: icon }),
    h("div", { className: "item-info", children: [
      h("div", { className: "item-name", children: [
        name,
        idBadge && h("span", { className: "evidence-id-badge", style: { marginLeft: "8px", padding: "1px 6px", background: "#f3e8ff", color: "#7c3aed", fontSize: "9px", fontWeight: 700, borderRadius: "4px" }, children: idBadge })
      ] }),
      desc && h("div", { className: "item-desc", children: desc })
    ] }),
    badge !== void 0 && h("span", { className: `item-badge count ${badge > 0 ? "active" : ""}`, children: badge }),
    checkbox && h("input", { type: "checkbox", className: "item-check", checked: selected, readOnly: true })
  ] });
  var LandingOverlay = () => {
    const { showLanding, closeLanding, selectCase, openModal, cases, appVersion, updateInfo, releases } = useApp();
    if (!showLanding) return null;
    const latestRelease = releases && releases[0];
    const releaseDate = latestRelease ? latestRelease.published_at?.split("T")[0] : "2026-01-31";
    return h("div", { className: "landing-overlay", children: h("div", { className: "landing-modal", children: [
      h("div", { className: "landing-header", children: [
        h("h1", { className: "landing-title", children: "T H E M i S - QS" }),
        h("p", { className: "landing-subtitle", children: "Digital File Analyser" }),
        h("div", { className: "landing-version", onClick: () => openModal("release-notes"), children: [
          h("span", { className: "landing-version-badge", children: `v${appVersion}` }),
          updateInfo.update_available && h("span", { className: "landing-update-badge", style: { background: "#ea4335", color: "white", padding: "2px 8px", borderRadius: "10px", marginLeft: "8px", fontSize: "0.8em", animation: "pulse 2s infinite" }, children: `v${updateInfo.latest_version} available` }),
          h("span", { children: releaseDate })
        ] })
      ] }),
      h("div", { className: "landing-search", children: h("input", { type: "text", className: "landing-search-input", placeholder: "Search all cases..." }) }),
      h("div", { className: "landing-section", children: [
        h("div", { className: "landing-section-title", children: "RECENT CASES" }),
        h("div", { className: "landing-cases", children: cases.map((c) => h("div", { className: "landing-case-item", onClick: () => selectCase(c), children: [
          h("div", { className: "landing-case-info", children: [
            h("div", { className: "landing-case-name", children: c.name }),
            h("div", { className: "landing-case-meta", children: c.date })
          ] }),
          h("span", { className: `framework-badge sm ${c.framework.toLowerCase()}`, children: c.framework }),
          h("span", { className: "case-id-badge", children: c.id })
        ] }, c.id)) })
      ] }),
      h("div", { className: "landing-actions", children: [
        h("div", { className: "landing-action-card", onClick: () => openModal("create-case"), children: [
          h("div", { className: "landing-action-icon create", children: "+" }),
          h("div", { children: [
            h("div", { className: "landing-action-title", children: "Create New Case" }),
            h("div", { className: "landing-action-desc", children: "Start fresh analysis" })
          ] })
        ] }),
        h("div", { className: "landing-action-card", onClick: closeLanding, children: [
          h("div", { className: "landing-action-icon browse" }),
          h("div", { children: [
            h("div", { className: "landing-action-title", children: "Browse All Cases" }),
            h("div", { className: "landing-action-desc", children: "Open folder browser" })
          ] })
        ] })
      ] }),
      h("div", { className: "modal-copyright", children: "T H E M i S - QS   (c) 2026" })
    ] }) });
  };
  var Modal = ({ id, title, children, large }) => {
    const { activeModal, closeModal } = useApp();
    if (activeModal !== id) return null;
    return h("div", { className: "modal-overlay open", onClick: closeModal, children: h("div", { className: `modal ${large ? "modal-lg" : ""}`, onClick: (e) => e.stopPropagation(), children: [
      h("div", { className: "modal-header", children: [
        h("span", { className: "modal-title", children: title }),
        h("button", { className: "modal-close", onClick: closeModal, children: "x" })
      ] }),
      children,
      h("div", { className: "modal-copyright", children: "T H E M i S - QS   (c) 2026" })
    ] }) });
  };
  var PreviewModal = ({ preview }) => {
    const { closePreview, bringPreviewToFront, updatePreviewPosition, updatePreviewSize, togglePreviewMinimize } = useApp();
    const [isDragging, setIsDragging] = useState(false);
    const [isResizing, setIsResizing] = useState(false);
    const [dragOffset, setDragOffset] = useState({ x: 0, y: 0 });
    const modalRef = useRef(null);
    const handleMouseDown = (e) => {
      if (e.target.closest(".preview-resize-handle") || e.target.closest(".preview-controls")) return;
      bringPreviewToFront(preview.evidenceId);
      setIsDragging(true);
      setDragOffset({
        x: e.clientX - preview.x,
        y: e.clientY - preview.y
      });
    };
    const handleMouseMove = useCallback((e) => {
      if (isDragging) {
        updatePreviewPosition(
          preview.evidenceId,
          Math.max(0, e.clientX - dragOffset.x),
          Math.max(0, e.clientY - dragOffset.y)
        );
      }
      if (isResizing) {
        const rect = modalRef.current?.getBoundingClientRect();
        if (rect) {
          updatePreviewSize(
            preview.evidenceId,
            Math.max(300, e.clientX - rect.left),
            Math.max(200, e.clientY - rect.top)
          );
        }
      }
    }, [isDragging, isResizing, dragOffset, preview.evidenceId]);
    const handleMouseUp = useCallback(() => {
      setIsDragging(false);
      setIsResizing(false);
    }, []);
    useEffect(() => {
      if (isDragging || isResizing) {
        window.addEventListener("mousemove", handleMouseMove);
        window.addEventListener("mouseup", handleMouseUp);
        return () => {
          window.removeEventListener("mousemove", handleMouseMove);
          window.removeEventListener("mouseup", handleMouseUp);
        };
      }
    }, [isDragging, isResizing, handleMouseMove, handleMouseUp]);
    const typeColors = {
      CONTRACT: "#3b82f6",
      PHOTO: "#22c55e",
      CORRESPONDENCE: "#f59e0b",
      FINANCIAL: "#8b5cf6",
      PROGRAMME: "#06b6d4",
      VARIATION: "#ef4444",
      MINUTES: "#6b7280",
      TECHNICAL: "#ec4899"
    };
    const typeColor = typeColors[preview.type] || "#6b7280";
    return h(
      "div",
      {
        ref: modalRef,
        className: "preview-modal",
        style: {
          position: "fixed",
          left: preview.x,
          top: preview.y,
          width: preview.minimized ? 280 : preview.width,
          height: preview.minimized ? 40 : preview.height,
          zIndex: preview.zIndex,
          background: "white",
          borderRadius: "12px",
          boxShadow: "0 25px 50px -12px rgba(0,0,0,0.25), 0 0 0 1px rgba(0,0,0,0.05)",
          display: "flex",
          flexDirection: "column",
          overflow: "hidden",
          userSelect: isDragging ? "none" : "auto"
        },
        onMouseDown: () => bringPreviewToFront(preview.evidenceId),
        children: [
          h(
            "div",
            {
              className: "preview-header",
              onMouseDown: handleMouseDown,
              style: {
                padding: "10px 12px",
                background: "linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%)",
                borderBottom: "1px solid #e2e8f0",
                display: "flex",
                alignItems: "center",
                gap: "10px",
                cursor: isDragging ? "grabbing" : "grab",
                flexShrink: 0
              },
              children: [
                h("div", { style: {
                  padding: "3px 8px",
                  background: typeColor,
                  color: "white",
                  fontSize: "10px",
                  fontWeight: 700,
                  borderRadius: "4px",
                  textTransform: "uppercase"
                }, children: preview.type || "DOC" }),
                h("div", { style: {
                  flex: 1,
                  fontSize: "13px",
                  fontWeight: 600,
                  color: "#1e293b",
                  whiteSpace: "nowrap",
                  overflow: "hidden",
                  textOverflow: "ellipsis"
                }, children: preview.name }),
                h("div", { className: "preview-controls", style: { display: "flex", gap: "6px" }, children: [
                  h(
                    "button",
                    {
                      onClick: () => togglePreviewMinimize(preview.evidenceId),
                      style: {
                        width: "24px",
                        height: "24px",
                        border: "none",
                        borderRadius: "6px",
                        background: "#fef3c7",
                        color: "#d97706",
                        cursor: "pointer",
                        fontSize: "14px",
                        display: "flex",
                        alignItems: "center",
                        justifyContent: "center"
                      },
                      title: preview.minimized ? "Restore" : "Minimize",
                      children: preview.minimized ? "\u25A1" : "\u2212"
                    }
                  ),
                  h(
                    "button",
                    {
                      onClick: () => closePreview(preview.evidenceId),
                      style: {
                        width: "24px",
                        height: "24px",
                        border: "none",
                        borderRadius: "6px",
                        background: "#fee2e2",
                        color: "#dc2626",
                        cursor: "pointer",
                        fontSize: "14px",
                        display: "flex",
                        alignItems: "center",
                        justifyContent: "center"
                      },
                      title: "Close",
                      children: "\xD7"
                    }
                  )
                ] })
              ]
            }
          ),
          !preview.minimized && h("div", { style: { flex: 1, overflow: "auto", position: "relative" }, children: [
            preview.loading ? h("div", { style: {
              display: "flex",
              alignItems: "center",
              justifyContent: "center",
              height: "100%",
              color: "#94a3b8"
            }, children: "Loading preview..." }) : h(
              "img",
              {
                src: `${API_BASE}/api/evidence/${preview.evidenceId}/quicklook`,
                alt: preview.name,
                style: {
                  width: "100%",
                  height: "100%",
                  objectFit: "contain",
                  background: "#f8fafc"
                },
                onError: (e) => {
                  e.target.style.display = "none";
                  e.target.nextSibling.style.display = "flex";
                }
              }
            ),
            h("div", { style: {
              display: "none",
              alignItems: "center",
              justifyContent: "center",
              height: "100%",
              flexDirection: "column",
              gap: "12px",
              color: "#64748b",
              background: "#f8fafc"
            }, children: [
              h("div", { style: {
                width: "80px",
                height: "80px",
                background: `${typeColor}20`,
                borderRadius: "16px",
                display: "flex",
                alignItems: "center",
                justifyContent: "center",
                fontSize: "24px",
                fontWeight: 700,
                color: typeColor
              }, children: (preview.type || "DOC").substring(0, 3) }),
              h("div", { style: { fontSize: "14px", fontWeight: 500 }, children: preview.name }),
              h("div", { style: { fontSize: "12px" }, children: "Preview not available" })
            ] })
          ] }),
          !preview.minimized && h(
            "div",
            {
              className: "preview-resize-handle",
              onMouseDown: (e) => {
                e.stopPropagation();
                setIsResizing(true);
                bringPreviewToFront(preview.evidenceId);
              },
              style: {
                position: "absolute",
                right: 0,
                bottom: 0,
                width: "20px",
                height: "20px",
                cursor: "nwse-resize",
                background: "linear-gradient(135deg, transparent 50%, #cbd5e1 50%)",
                borderRadius: "0 0 12px 0"
              }
            }
          )
        ]
      }
    );
  };
  var PreviewContainer = () => {
    const { openPreviews, tilePreviews, closeAllPreviews } = useApp();
    if (openPreviews.length === 0) return null;
    return h(React.Fragment, { children: [
      openPreviews.length > 1 && h("div", { style: {
        position: "fixed",
        bottom: "20px",
        left: "50%",
        transform: "translateX(-50%)",
        background: "white",
        padding: "8px 16px",
        borderRadius: "12px",
        boxShadow: "0 10px 25px rgba(0,0,0,0.15)",
        display: "flex",
        gap: "12px",
        alignItems: "center",
        zIndex: 9999
      }, children: [
        h("span", { style: { fontSize: "12px", color: "#64748b", fontWeight: 500 }, children: [
          openPreviews.length,
          " previews open"
        ] }),
        h(
          "button",
          {
            onClick: tilePreviews,
            style: {
              padding: "6px 12px",
              background: "#3b82f6",
              color: "white",
              border: "none",
              borderRadius: "6px",
              fontSize: "12px",
              fontWeight: 600,
              cursor: "pointer"
            },
            children: "Tile All"
          }
        ),
        h(
          "button",
          {
            onClick: closeAllPreviews,
            style: {
              padding: "6px 12px",
              background: "#fee2e2",
              color: "#dc2626",
              border: "none",
              borderRadius: "6px",
              fontSize: "12px",
              fontWeight: 600,
              cursor: "pointer"
            },
            children: "Close All"
          }
        )
      ] }),
      openPreviews.map((preview) => h(PreviewModal, { preview }, preview.id))
    ] });
  };
  var EvidenceModal = () => {
    const { documents } = useApp();
    const selected = documents.filter((d) => d.selected).length;
    const total = documents.length;
    const types = new Set(documents.map((d) => d.type)).size;
    return h(Modal, { id: "evidence", title: "Evidence Inventory", children: [
      h("div", { className: "modal-body", children: [
        h("div", { className: "evidence-stats", children: [
          h("div", { className: "evidence-stat", children: [
            h("span", { className: "evidence-stat-value", children: total }),
            h("span", { className: "evidence-stat-label", children: "Total Documents" })
          ] }),
          h("div", { className: "evidence-stat", children: [
            h("span", { className: "evidence-stat-value", style: { color: "#22c55e" }, children: selected }),
            h("span", { className: "evidence-stat-label", children: "In Context" })
          ] }),
          h("div", { className: "evidence-stat", children: [
            h("span", { className: "evidence-stat-value", style: { color: "#f59e0b" }, children: types }),
            h("span", { className: "evidence-stat-label", children: "Document Types" })
          ] })
        ] }),
        h("div", { style: { fontSize: "12px", fontWeight: 600, marginBottom: "8px" }, children: "Document Inventory" }),
        h("div", { className: "evidence-list", children: documents.map((doc) => h("div", { className: `evidence-item ${doc.selected ? "selected" : ""}`, children: [
          h("div", { className: `item-icon file ${doc.type}`, style: { width: 28, height: 28, fontSize: 10 }, children: doc.type.toUpperCase() }),
          h("div", { className: "item-info", children: [
            h("div", { className: "item-name", children: doc.name }),
            h("div", { className: "item-desc", children: doc.pages ? `${doc.pages} pages` : "" })
          ] }),
          h("div", { className: `evidence-dot ${doc.selected ? "active" : ""}` })
        ] }, doc.id)) })
      ] }),
      h("div", { className: "modal-footer", children: [
        h("button", { className: "btn btn-secondary btn-sm", children: "Print" }),
        h("button", { className: "btn btn-primary btn-sm", children: "Send" })
      ] })
    ] });
  };
  var TimeTrackerModal = () => {
    const { timeSeconds, timeRunning, toggleTimer, resetTimer, currentCase } = useApp();
    const hours = Math.floor(timeSeconds / 3600);
    const minutes = Math.floor(timeSeconds % 3600 / 60);
    const seconds = timeSeconds % 60;
    const timeStr = `${String(hours).padStart(2, "0")}:${String(minutes).padStart(2, "0")}:${String(seconds).padStart(2, "0")}`;
    return h(Modal, { id: "time-tracker", title: "Time Tracker", children: h("div", { className: "modal-body", children: [
      h("div", { className: "time-tracker-display", children: [
        h("div", { className: "time-tracker-clock", children: timeStr }),
        h("div", { className: "time-tracker-case", children: currentCase.name })
      ] }),
      h("div", { className: "time-tracker-controls", children: [
        h("button", { className: "btn btn-primary", onClick: toggleTimer, children: timeRunning ? "Stop" : "Start" }),
        h("button", { className: "btn btn-secondary", onClick: resetTimer, children: "Reset" })
      ] })
    ] }) });
  };
  var CreateCaseWizard = () => {
    const { activeModal, closeModal, addNotification, selectCase, exitLanding, replaceEvidence, backendConnected } = useApp();
    const [step, setStep] = useState(0);
    const [mode, setMode] = useState(null);
    const [caseName, setCaseName] = useState("");
    const [jurisdiction, setJurisdiction] = useState("");
    const [claimant, setClaimant] = useState("");
    const [respondent, setRespondent] = useState("");
    const [framework, setFramework] = useState("RICS");
    const [methodology, setMethodology] = useState("SCL");
    const [validationMode, setValidationMode] = useState("CASE_CONTROL");
    const [creating, setCreating] = useState(false);
    const [caseIdCustom, setCaseIdCustom] = useState(false);
    const [caseSep, setCaseSep] = useState("-");
    const [caseDigits, setCaseDigits] = useState("4");
    const [casePrefix, setCasePrefix] = useState("C");
    const [vaultIdCustom, setVaultIdCustom] = useState(false);
    const [vaultSep, setVaultSep] = useState("-");
    const [vaultDigits, setVaultDigits] = useState("4");
    const [vaultPrefix, setVaultPrefix] = useState("V");
    const [evidenceIdCustom, setEvidenceIdCustom] = useState(false);
    const [evidenceSep, setEvidenceSep] = useState("-");
    const [evidenceDigits, setEvidenceDigits] = useState("3");
    const [evidencePrefix, setEvidencePrefix] = useState("DOC");
    const [uploadedFiles, setUploadedFiles] = useState([]);
    const [dragOver, setDragOver] = useState(false);
    const wizardFileInputRef = React.useRef(null);
    if (activeModal !== "create-case") return null;
    const steps = mode === "quick" ? ["Mode", "Case", "IDs", "Review"] : ["Mode", "Case", "IDs", "Framework", "Docs", "Review"];
    const getIdPreview = (prefix, sep, digits) => prefix + sep + "0".repeat(parseInt(digits) - 1) + "1";
    const canProceed = () => {
      if (step === 0) return mode !== null;
      if (step === 1) return caseName.trim().length > 0;
      return true;
    };
    const nextStep = () => {
      if (canProceed()) setStep((s) => s + 1);
    };
    const prevStep = () => setStep((s) => Math.max(0, s - 1));
    const resetWizard = () => {
      setStep(0);
      setMode(null);
      setCaseName("");
      setUploadedFiles([]);
      setCreating(false);
    };
    const finishWizard = async () => {
      setCreating(true);
      const caseData = {
        name: caseName || "New Case",
        framework,
        methodology,
        jurisdiction,
        claimant,
        respondent,
        validation_mode: validationMode,
        id_config: {
          case: { prefix: casePrefix, separator: caseSep, digits: parseInt(caseDigits) },
          vault: { prefix: vaultPrefix, separator: vaultSep, digits: parseInt(vaultDigits) },
          evidence: { prefix: evidencePrefix, separator: evidenceSep, digits: parseInt(evidenceDigits) }
        }
      };
      let newCase;
      if (backendConnected) {
        newCase = await ThemisAPI.cases.create(caseData);
        if (!newCase) {
          addNotification("error", "Failed to create case on backend");
          newCase = { id: getIdPreview(casePrefix, caseSep, caseDigits), name: caseData.name, framework, date: (/* @__PURE__ */ new Date()).toISOString().split("T")[0] };
        }
      } else {
        newCase = { id: getIdPreview(casePrefix, caseSep, caseDigits), name: caseData.name, framework, date: (/* @__PURE__ */ new Date()).toISOString().split("T")[0] };
      }
      const newEvidence = uploadedFiles.map((f, i) => ({
        id: `ev-${Date.now()}-${i}`,
        name: f.name,
        type: f.type,
        size: f.size,
        date: (/* @__PURE__ */ new Date()).toISOString().split("T")[0],
        validation: "pending",
        tags: [
          `THEMIS:case:${newCase.id}`,
          `THEMIS:type:${f.type.toUpperCase()}`,
          `THEMIS:valid:pending`
        ],
        selected: false
      }));
      if (backendConnected && uploadedFiles.length > 0) {
        for (const f of uploadedFiles) {
          await ThemisAPI.evidence.upload(newCase.id, f.file, null);
        }
      }
      if (newEvidence.length > 0) {
        replaceEvidence(newEvidence);
      }
      addNotification("success", `Case "${newCase.name}" created with ${uploadedFiles.length} files!`);
      selectCase(newCase);
      resetWizard();
      closeModal();
      exitLanding();
    };
    const handleClose = () => {
      resetWizard();
      closeModal();
    };
    const handleWizardFiles = (files) => {
      const validExtensions = ["pdf", "docx", "xlsx", "png", "jpg", "jpeg", "tiff", "doc", "xls", "msg", "mpp"];
      const filesArray = Array.from(files);
      const validFiles = filesArray.filter((f) => {
        const ext = f.name.split(".").pop().toLowerCase();
        return validExtensions.includes(ext) && !f.name.startsWith(".");
      });
      const newFiles = validFiles.map((f, i) => ({
        id: `wiz-${Date.now()}-${i}`,
        name: f.name,
        size: f.size,
        type: f.name.split(".").pop().toLowerCase(),
        status: "ready",
        file: f
      }));
      setUploadedFiles(newFiles);
      if (newFiles.length > 0) {
        addNotification("success", `${newFiles.length} file${newFiles.length > 1 ? "s" : ""} selected`);
      } else if (filesArray.length > 0) {
        addNotification("warning", "No valid files found in selection");
      }
    };
    const removeWizardFile = (id) => setUploadedFiles((prev) => prev.filter((f) => f.id !== id));
    const formatFileSize = (bytes) => bytes < 1024 * 1024 ? (bytes / 1024).toFixed(1) + " KB" : (bytes / (1024 * 1024)).toFixed(1) + " MB";
    const getFileIcon = (type) => {
      const icons = { pdf: "", docx: "", doc: "", xlsx: "", xls: "", png: "-", jpg: "-", jpeg: "-", tiff: "-", msg: "", mpp: "..." };
      return icons[type] || "";
    };
    const modeDesc = {
      quick: { title: "Quick Create Mode", text: "Creates a case with minimal setup. Configure Case ID, Vault ID, and Evidence ID formats, then go straight to review.", steps: ["Case Name", "ID Config", "Review"], hint: "Best for: Rapid case creation with default framework settings" },
      full: { title: "Full Setup Mode", text: "Complete case configuration including framework selection, methodology, validation mode, and initial document import.", steps: ["Case Info", "ID Config", "Framework", "Documents", "Review"], hint: "Best for: New matters requiring specific framework configuration" }
    };
    const IdConfig = ({ title, isCustom, setCustom, sep, setSep, digits, setDigits, prefix, setPrefix, hint }) => h("div", { className: "wiz-id-config", children: [
      h("div", { className: "wiz-id-header", children: [
        h("span", { className: "wiz-id-title", children: title }),
        h("div", { className: "wiz-id-toggle", children: [
          h("label", { className: "wiz-radio", children: [
            h("input", { type: "radio", checked: !isCustom, onChange: () => setCustom(false) }),
            " Default"
          ] }),
          h("label", { className: "wiz-radio", children: [
            h("input", { type: "radio", checked: isCustom, onChange: () => setCustom(true) }),
            " Customize"
          ] })
        ] })
      ] }),
      isCustom && h("div", { className: "wiz-id-fields", children: h("div", { className: "wiz-id-row", children: [
        h("div", { className: "wiz-id-group", children: [
          h("span", { className: "wiz-id-label", children: "Separator" }),
          h("div", { className: "wiz-sep-btns", children: ["-", "/", ".", "_"].map((s) => h("button", { className: `wiz-sep-btn ${sep === s ? "active" : ""}`, onClick: () => setSep(s), children: s }, s)) })
        ] }),
        h("div", { className: "wiz-id-group", children: [
          h("span", { className: "wiz-id-label", children: "Digits" }),
          h("select", { className: "wiz-select-sm", value: digits, onChange: (e) => setDigits(e.target.value), children: [
            h("option", { value: "3", children: "3" }),
            h("option", { value: "4", children: "4" }),
            h("option", { value: "5", children: "5" })
          ] })
        ] }),
        h("div", { className: "wiz-id-group", children: [
          h("span", { className: "wiz-id-label", children: "Prefix" }),
          h("input", { type: "text", className: "wiz-input-sm", value: prefix, onChange: (e) => setPrefix(e.target.value), maxLength: 5 })
        ] })
      ] }) }),
      h("div", { className: "wiz-id-preview", children: [
        h("span", { className: "wiz-id-preview-label", children: "Preview:" }),
        h("span", { className: "wiz-id-preview-value", children: getIdPreview(prefix, sep, digits) }),
        h("span", { className: "wiz-id-preview-arrow", children: "->" }),
        h("span", { className: "wiz-id-preview-value", children: getIdPreview(prefix, sep, digits).slice(0, -1) + "2" }),
        hint && h("span", { className: "wiz-id-preview-hint", children: [
          "(",
          hint,
          ")"
        ] })
      ] })
    ] });
    const CardRow = ({ options, value, onChange, cols = 3 }) => h("div", { className: "wiz-card-row", style: { gridTemplateColumns: `repeat(${cols}, 1fr)` }, children: options.map((opt) => h("div", { className: `wiz-card ${value === opt.value ? "active" : ""}`, onClick: () => onChange(opt.value), children: [
      h("span", { className: "wiz-card-name", children: opt.name }),
      h("span", { className: "wiz-card-hint", children: opt.hint })
    ] }, opt.value)) });
    return h("div", { className: "modal-overlay open", onClick: handleClose, children: h("div", { className: "modal modal-wizard-compact", onClick: (e) => e.stopPropagation(), children: [
      h("div", { className: "wizard-compact-header", children: [
        h("div", { className: "wizard-compact-title", children: "Create New Case" }),
        h("div", { className: "wizard-compact-steps", children: steps.map((s, i) => h(React.Fragment, { children: [
          h("span", { className: `wcs ${i === step ? "active" : ""} ${i < step ? "done" : ""}`, children: s }),
          i < steps.length - 1 && h("span", { className: "wcs-dot" })
        ] }, s)) }),
        h("button", { className: "wizard-close-btn", onClick: handleClose, children: "-" })
      ] }),
      step === 0 && h("div", { className: "wizard-compact-body", children: [
        h("div", { className: "wiz-mode-cards", children: [
          h("div", { className: `wiz-mode-card ${mode === "quick" ? "selected" : ""}`, onClick: () => setMode("quick"), children: [
            h("div", { className: "wiz-mode-card-icon", children: h(Icons.Zap, {}) }),
            h("div", { className: "wiz-mode-card-content", children: [
              h("span", { className: "wiz-mode-card-title", children: "Quick Create" }),
              h("span", { className: "wiz-mode-card-desc", children: "Name + ID configuration only" })
            ] })
          ] }),
          h("div", { className: `wiz-mode-card ${mode === "full" ? "selected" : ""}`, onClick: () => setMode("full"), children: [
            h("div", { className: "wiz-mode-card-icon", children: h(Icons.Grid, {}) }),
            h("div", { className: "wiz-mode-card-content", children: [
              h("span", { className: "wiz-mode-card-title", children: "Full Setup" }),
              h("span", { className: "wiz-mode-card-desc", children: "Framework, methodology & documents" })
            ] })
          ] })
        ] }),
        mode && h("div", { className: "wiz-mode-description", children: [
          h("div", { className: "wiz-mode-desc-title", children: modeDesc[mode].title }),
          h("div", { className: "wiz-mode-desc-text", children: modeDesc[mode].text }),
          h("div", { className: "wiz-mode-desc-steps", children: modeDesc[mode].steps.map((s, i) => h(React.Fragment, { children: [
            h("span", { className: "wiz-step-pill", children: s }),
            i < modeDesc[mode].steps.length - 1 && h("span", { className: "wiz-step-arrow", children: "->" })
          ] }, s)) }),
          h("div", { className: "wiz-mode-desc-hint", children: [
            h("svg", { viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "1.5", width: "14", height: "14", children: [
              h("circle", { cx: "12", cy: "12", r: "10" }),
              h("path", { d: "M12 16v-4M12 8h.01" })
            ] }),
            h("span", { children: modeDesc[mode].hint })
          ] })
        ] })
      ] }),
      step === 1 && h("div", { className: "wizard-compact-body", children: [
        h("div", { className: "wiz-field", children: [
          h("label", { className: "wiz-label", children: [
            "Case Name ",
            h("span", { className: "wiz-req", children: "*" })
          ] }),
          h("input", { type: "text", className: "wiz-input", placeholder: "e.g., Smith v. Anderson Construction", value: caseName, onChange: (e) => setCaseName(e.target.value), autoFocus: true })
        ] }),
        h("div", { className: "wiz-field", children: [
          h("label", { className: "wiz-label", children: [
            "Jurisdiction ",
            h("span", { className: "wiz-req", children: "*" })
          ] }),
          h("select", { className: "wiz-select", value: jurisdiction, onChange: (e) => setJurisdiction(e.target.value), children: [
            h("option", { value: "", children: "Select..." }),
            h("option", { value: "UK", children: "United Kingdom" }),
            h("option", { value: "US", children: "United States" }),
            h("option", { value: "EU", children: "European Union" }),
            h("option", { value: "INTL", children: "International (FIDIC)" }),
            h("option", { value: "OTHER", children: "Other" })
          ] })
        ] }),
        h(IdConfig, { title: "Case ID", isCustom: caseIdCustom, setCustom: setCaseIdCustom, sep: caseSep, setSep: setCaseSep, digits: caseDigits, setDigits: setCaseDigits, prefix: casePrefix, setPrefix: setCasePrefix })
      ] }),
      step === 2 && h("div", { className: "wizard-compact-body", children: [
        h(IdConfig, { title: "Vault ID", isCustom: vaultIdCustom, setCustom: setVaultIdCustom, sep: vaultSep, setSep: setVaultSep, digits: vaultDigits, setDigits: setVaultDigits, prefix: vaultPrefix, setPrefix: setVaultPrefix, hint: "per case" }),
        h(IdConfig, { title: "Evidence ID", isCustom: evidenceIdCustom, setCustom: setEvidenceIdCustom, sep: evidenceSep, setSep: setEvidenceSep, digits: evidenceDigits, setDigits: setEvidenceDigits, prefix: evidencePrefix, setPrefix: setEvidencePrefix, hint: "per vault" }),
        h("div", { className: "wiz-info-note", children: [
          h("svg", { viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "1.5", width: "16", height: "16", children: [
            h("circle", { cx: "12", cy: "12", r: "10" }),
            h("path", { d: "M12 16v-4M12 8h.01" })
          ] }),
          h("span", { children: "ID formats enable collaboration & conversion tables" })
        ] })
      ] }),
      step === 3 && mode === "full" && h("div", { className: "wizard-compact-body", children: [
        h("div", { className: "wiz-field", children: [
          h("label", { className: "wiz-label", children: "Parties" }),
          h("div", { className: "wiz-row-2", children: [
            h("input", { type: "text", className: "wiz-input", placeholder: "Claimant", value: claimant, onChange: (e) => setClaimant(e.target.value) }),
            h("input", { type: "text", className: "wiz-input", placeholder: "Respondent", value: respondent, onChange: (e) => setRespondent(e.target.value) })
          ] })
        ] }),
        h("div", { className: "wiz-field", children: [
          h("label", { className: "wiz-label", children: "Framework" }),
          h(CardRow, { value: framework, onChange: setFramework, options: [{ value: "RICS", name: "RICS", hint: "UK/Intl   66 folders" }, { value: "FAR", name: "FAR/DFARS", hint: "US Federal   52 folders" }, { value: "FIDIC", name: "FIDIC", hint: "International Contracts" }, { value: "NEC", name: "NEC", hint: "Engineering Contracts" }, { value: "CUSTOM", name: "+ Custom", hint: "User-defined" }], cols: 5 })
        ] }),
        h("div", { className: "wiz-field", children: [
          h("label", { className: "wiz-label", children: "Delay Methodology" }),
          h(CardRow, { value: methodology, onChange: setMethodology, options: [{ value: "SCL", name: "SCL Protocol", hint: "2nd Edition" }, { value: "AACE", name: "AACE 29R-03", hint: "9 MIPs" }, { value: "COMBINED", name: "Combined", hint: "SCL + AACE" }] })
        ] }),
        h("div", { className: "wiz-field", children: [
          h("label", { className: "wiz-label", children: "Validation Mode" }),
          h(CardRow, { value: validationMode, onChange: setValidationMode, cols: 2, options: [{ value: "CASE_CONTROL", name: "Project Control", hint: "Proactive   Flexible" }, { value: "FORENSIC", name: "Forensic", hint: "Dispute   Audit trail" }] })
        ] })
      ] }),
      step === 4 && mode === "full" && h("div", { className: "wizard-compact-body", children: [
        h("div", { className: "wiz-zt-banner", children: [
          h("svg", { viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "1.5", width: "20", height: "20", children: [
            h("path", { d: "M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" }),
            h("path", { d: "M9 12l2 2 4-4" })
          ] }),
          h("div", { className: "wiz-zt-text", children: [
            h("span", { className: "wiz-zt-title", children: "Zero Trust Import" }),
            h("span", { className: "wiz-zt-desc", children: "Files verified before vault migration" })
          ] })
        ] }),
        h("div", { style: { marginBottom: "16px" }, children: [
          h("div", { style: { fontSize: "11px", fontWeight: 600, color: "#374151", marginBottom: "8px" }, children: "SOURCE REPOSITORY" }),
          h("div", { style: { display: "flex", gap: "8px" }, children: [
            h(
              "input",
              {
                ref: wizardFileInputRef,
                type: "file",
                webkitdirectory: "",
                directory: "",
                multiple: true,
                hidden: true,
                onChange: (e) => handleWizardFiles(e.target.files)
              }
            ),
            h(
              "button",
              {
                onClick: () => wizardFileInputRef.current?.click(),
                style: {
                  flex: 1,
                  display: "flex",
                  alignItems: "center",
                  gap: "8px",
                  padding: "12px 16px",
                  background: uploadedFiles.length > 0 ? "#eff6ff" : "#f9fafb",
                  border: uploadedFiles.length > 0 ? "2px solid #3b82f6" : "1px solid #e5e7eb",
                  borderRadius: "8px",
                  cursor: "pointer",
                  textAlign: "left"
                },
                children: [
                  h("span", { style: { fontSize: "20px" } }),
                  h("div", { children: [
                    h("div", { style: { fontSize: "12px", fontWeight: 500 }, children: uploadedFiles.length > 0 ? `${uploadedFiles.length} files selected` : "Select Folder" }),
                    h("div", { style: { fontSize: "10px", color: "#6b7280" }, children: uploadedFiles.length > 0 ? "Click to change" : "Browse local files" })
                  ] }),
                  uploadedFiles.length > 0 && h("span", { style: { marginLeft: "auto", color: "#22c55e" }, children: "[ok]" })
                ]
              }
            ),
            h(
              "button",
              {
                style: { flex: 1, display: "flex", alignItems: "center", gap: "8px", padding: "12px 16px", background: "#f9fafb", border: "1px solid #e5e7eb", borderRadius: "8px", cursor: "not-allowed", textAlign: "left", opacity: 0.5 },
                title: "Coming soon",
                disabled: true,
                children: [
                  h("span", { style: { fontSize: "20px" } }),
                  h("div", { children: [
                    h("div", { style: { fontSize: "12px", fontWeight: 500 }, children: "Cloud Storage" }),
                    h("div", { style: { fontSize: "10px", color: "#6b7280" }, children: "iCloud, Dropbox, Google" })
                  ] })
                ]
              }
            )
          ] })
        ] }),
        h(
          "div",
          {
            className: `wiz-upload-zone ${dragOver ? "dragover" : ""}`,
            onDragOver: (e) => {
              e.preventDefault();
              setDragOver(true);
            },
            onDragLeave: () => setDragOver(false),
            onDrop: (e) => {
              e.preventDefault();
              setDragOver(false);
              handleWizardFiles(e.dataTransfer.files);
            },
            style: { cursor: "default" },
            children: [
              h("svg", { viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "1.5", width: "28", height: "28", children: [
                h("path", { d: "M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4" }),
                h("polyline", { points: "17 8 12 3 7 8" }),
                h("line", { x1: "12", y1: "3", x2: "12", y2: "15" })
              ] }),
              h("span", { className: "wiz-upload-text", children: "Or drop files here" }),
              h("span", { className: "wiz-upload-hint", children: "PDF, DOCX, XLSX, PNG, JPG, TIFF" })
            ]
          }
        ),
        uploadedFiles.length > 0 && h("div", { style: { marginTop: "16px", border: "1px solid #e5e7eb", borderRadius: "8px", overflow: "hidden" }, children: [
          h("div", { style: { padding: "8px 12px", background: "#f9fafb", borderBottom: "1px solid #e5e7eb", fontSize: "11px", fontWeight: 600, color: "#6b7280" }, children: [
            uploadedFiles.length,
            " FILE",
            uploadedFiles.length > 1 ? "S" : "",
            " QUEUED"
          ] }),
          h("div", { style: { maxHeight: "150px", overflow: "auto" }, children: uploadedFiles.map((file) => h("div", { style: { display: "flex", alignItems: "center", gap: "10px", padding: "8px 12px", borderBottom: "1px solid #f3f4f6" }, children: [
            h("span", { style: { fontSize: "18px" }, children: getFileIcon(file.type) }),
            h("div", { style: { flex: 1, minWidth: 0 }, children: [
              h("div", { style: { fontSize: "12px", fontWeight: 500, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }, children: file.name }),
              h("div", { style: { fontSize: "10px", color: "#9ca3af" }, children: formatFileSize(file.size) })
            ] }),
            h("span", { style: { fontSize: "10px", color: "#22c55e", fontWeight: 500 }, children: "Ready" }),
            h("button", { onClick: (e) => {
              e.stopPropagation();
              removeWizardFile(file.id);
            }, style: { background: "none", border: "none", color: "#9ca3af", cursor: "pointer", fontSize: "16px" }, children: "-" })
          ] }, file.id)) })
        ] }),
        h("div", { style: { marginTop: "12px", padding: "10px 12px", background: "#f0fdf4", borderRadius: "8px", border: "1px solid #bbf7d0", display: "flex", alignItems: "center", gap: "8px" }, children: [
          h("span", { style: { color: "#22c55e", fontSize: "16px" }, children: "[ok]" }),
          h("span", { style: { fontSize: "11px", color: "#166534" }, children: uploadedFiles.length > 0 ? `${uploadedFiles.length} files ready for Zero Trust validation. Click Continue to review and create your case.` : "Select a folder or skip this step. You can add documents later." })
        ] })
      ] }),
      step === steps.length - 1 && h("div", { className: "wizard-compact-body", children: h("div", { className: "wiz-review-grid", children: [
        h("div", { className: "wiz-review-item", children: [
          h("span", { className: "wiz-review-label", children: "Case Name" }),
          h("span", { className: "wiz-review-value", children: caseName || "-" })
        ] }),
        h("div", { className: "wiz-review-item", children: [
          h("span", { className: "wiz-review-label", children: "Case ID" }),
          h("span", { className: "wiz-review-value", children: getIdPreview(casePrefix, caseSep, caseDigits) })
        ] }),
        h("div", { className: "wiz-review-item", children: [
          h("span", { className: "wiz-review-label", children: "Vault ID" }),
          h("span", { className: "wiz-review-value", children: getIdPreview(vaultPrefix, vaultSep, vaultDigits) })
        ] }),
        h("div", { className: "wiz-review-item", children: [
          h("span", { className: "wiz-review-label", children: "Evidence ID" }),
          h("span", { className: "wiz-review-value", children: getIdPreview(evidencePrefix, evidenceSep, evidenceDigits) })
        ] }),
        mode === "full" && h(React.Fragment, { children: [
          h("div", { className: "wiz-review-item", children: [
            h("span", { className: "wiz-review-label", children: "Framework" }),
            h("span", { className: "wiz-review-value", children: framework })
          ] }),
          h("div", { className: "wiz-review-item", children: [
            h("span", { className: "wiz-review-label", children: "Methodology" }),
            h("span", { className: "wiz-review-value", children: methodology })
          ] }),
          h("div", { className: "wiz-review-item", children: [
            h("span", { className: "wiz-review-label", children: "Mode" }),
            h("span", { className: "wiz-review-value", children: validationMode === "FORENSIC" ? "Forensic" : "Project Control" })
          ] }),
          h("div", { className: "wiz-review-item", children: [
            h("span", { className: "wiz-review-label", children: "Documents" }),
            h("span", { className: "wiz-review-value", style: { color: uploadedFiles.length > 0 ? "#22c55e" : "#9ca3af" }, children: [
              uploadedFiles.length,
              " file",
              uploadedFiles.length !== 1 ? "s" : "",
              " queued"
            ] })
          ] })
        ] })
      ] }) }),
      h("div", { className: "wizard-compact-footer", children: [
        step > 0 && h("button", { className: "btn btn-secondary", onClick: prevStep, children: "Back" }),
        h("div", { style: { flex: 1 } }),
        h("button", { className: "btn btn-secondary", onClick: handleClose, children: "Cancel" }),
        step < steps.length - 1 ? h("button", { className: "btn btn-primary", onClick: nextStep, disabled: !canProceed(), style: { opacity: canProceed() ? 1 : 0.5 }, children: "Continue" }) : h("button", { className: "btn btn-primary", onClick: finishWizard, children: "Create Case" })
      ] })
    ] }) });
  };
  var CreateVaultModal = () => {
    const { closeModal, addNotification, backendConnected, currentCase } = useApp();
    const [vaultName, setVaultName] = useState("");
    const [vaultDesc, setVaultDesc] = useState("");
    const [creating, setCreating] = useState(false);
    const createVault = async () => {
      if (!vaultName.trim()) {
        addNotification("warning", "Please enter a vault name");
        return;
      }
      setCreating(true);
      if (backendConnected && currentCase) {
        const result = await ThemisAPI.folders.add(vaultName, null);
        if (result) {
          addNotification("success", `Vault "${vaultName}" created successfully!`);
        } else {
          addNotification("error", "Failed to create vault on backend");
        }
      } else {
        addNotification("success", `Vault "${vaultName}" created successfully!`);
      }
      setCreating(false);
      setVaultName("");
      setVaultDesc("");
      closeModal();
    };
    return h(Modal, { id: "create-vault", title: "Create New Vault", children: [
      h("div", { className: "modal-body", children: [
        h("div", { className: "wiz-field", children: [
          h("label", { className: "wiz-label", children: [
            "Vault Name ",
            h("span", { className: "wiz-req", children: "*" })
          ] }),
          h("input", { type: "text", className: "wiz-input", placeholder: "e.g., Expert Reports", value: vaultName, onChange: (e) => setVaultName(e.target.value) })
        ] }),
        h("div", { className: "wiz-field", children: [
          h("label", { className: "wiz-label", children: "Description" }),
          h("input", { type: "text", className: "wiz-input", placeholder: "Optional description...", value: vaultDesc, onChange: (e) => setVaultDesc(e.target.value) })
        ] })
      ] }),
      h("div", { className: "modal-footer", children: [
        h("button", { className: "btn btn-secondary", onClick: closeModal, children: "Cancel" }),
        h("button", { className: "btn btn-primary", onClick: createVault, disabled: creating, children: creating ? "Creating..." : "Create Vault" })
      ] })
    ] });
  };
  var ReleaseNotesModal = () => {
    const { releases, appVersion, updateInfo, installUpdate } = useApp();
    const [installing, setInstalling] = useState(false);
    const [installResult, setInstallResult] = useState(null);
    
    const handleInstall = async () => {
      setInstalling(true);
      setInstallResult(null);
      const result = await installUpdate();
      setInstalling(false);
      if (result && result.success) {
        setInstallResult({ success: true, version: result.new_version });
      } else {
        setInstallResult({ success: false, error: result?.error || "Unknown error" });
      }
    };
    
    const renderMarkdown = (text) => {
      if (!text) return "";
      return text.replace(/^### (.+)$/gm, "<h4>$1</h4>").replace(/^## (.+)$/gm, "<h3>$1</h3>").replace(/^- (.+)$/gm, "<li>$1</li>").replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>").replace(/\n\n/g, "<br><br>");
    };
    
    return h(Modal, { id: "release-notes", title: "Release Notes", large: true, children: h("div", { className: "modal-body", children: [
      h("div", { style: { padding: "16px", marginBottom: "16px", background: updateInfo.update_available ? "#fef3c7" : "#f0fdf4", borderRadius: "8px", display: "flex", justifyContent: "space-between", alignItems: "center" }, children: [
        h("div", { children: [
          h("div", { style: { fontWeight: 600, marginBottom: "4px" }, children: ["Installed: v", appVersion] }),
          updateInfo.update_available && h("div", { style: { color: "#92400e", fontSize: "13px" }, children: ["Update available: v", updateInfo.latest_version] })
        ] }),
        updateInfo.update_available && !installing && !installResult && h("button", { onClick: handleInstall, style: { padding: "10px 20px", background: "#2563eb", color: "white", border: "none", borderRadius: "6px", fontWeight: 600, cursor: "pointer" }, children: "Install Update" }),
        installing && h("div", { style: { textAlign: "center" }, children: [h("span", { style: { fontSize: "1.5em", animation: "spin 1s linear infinite", display: "inline-block" }, children: "\u2699\uFE0F" }), h("div", { style: { fontSize: "12px", marginTop: "4px" }, children: "Installing..." })] }),
        installResult && installResult.success && h("div", { style: { color: "#166534", fontWeight: 600 }, children: ["\u2705 Updated to v", installResult.version, "! Reloading..."] }),
        installResult && !installResult.success && h("div", { style: { color: "#dc2626" }, children: ["\u274C ", installResult.error] })
      ] }),
      releases && releases.length > 0 ? releases.slice(0, 15).map((r, i) => h("div", { style: { padding: "16px 0", borderBottom: "1px solid #e5e7eb" }, children: [
        h("div", { style: { display: "flex", gap: "12px", alignItems: "center", marginBottom: "12px" }, children: [
          h("span", { style: { padding: "4px 10px", background: i === 0 ? "#2563eb" : "#6b7280", color: "white", fontSize: "12px", fontWeight: 700, borderRadius: "4px" }, children: r.tag }),
          h("span", { style: { fontSize: "13px", color: "#6b7280" }, children: r.published_at ? r.published_at.split("T")[0] : "" }),
          r.local && h("span", { style: { padding: "2px 8px", background: "#fef3c7", color: "#92400e", fontSize: "10px", fontWeight: 600, borderRadius: "20px" }, children: "LOCAL" }),
          i === 0 && r.tag.replace("v", "") === appVersion && h("span", { style: { padding: "2px 8px", background: "#d1fae5", color: "#065f46", fontSize: "10px", fontWeight: 600, borderRadius: "20px" }, children: "CURRENT" })
        ] }),
        h("div", { style: { fontSize: "12px", fontWeight: 600, color: "#111827", marginBottom: "6px" }, children: r.name }),
        r.body && h("div", { style: { fontSize: "13px", color: "#6b7280", lineHeight: "1.6" }, dangerouslySetInnerHTML: { __html: renderMarkdown(r.body) } })
      ] }, r.tag)) : h("div", { style: { textAlign: "center", color: "#6b7280", padding: "40px" }, children: "Loading releases..." })
    ] }) });
  };
  var EvidenceInventoryModal = () => {
    const { activeModal, closeModal, evidence, toggleEvidence, toggleSelectAllEvidence, openModal } = useApp();
    const [inventoryFilter, setInventoryFilter] = useState("all");
    const [inventorySearch, setInventorySearch] = useState("");
    if (activeModal !== "evidence-inventory") return null;
    const selectedCount = evidence.filter((e) => e.selected).length;
    const typeStats = {
      pdf: evidence.filter((e) => e.type === "pdf").length,
      docx: evidence.filter((e) => e.type === "docx").length,
      xlsx: evidence.filter((e) => e.type === "xlsx").length,
      mpp: evidence.filter((e) => e.type === "mpp").length,
      msg: evidence.filter((e) => e.type === "msg").length
    };
    const filteredEvidence = evidence.filter((e) => inventoryFilter === "all" || e.type === inventoryFilter).filter((e) => !inventorySearch || e.name.toLowerCase().includes(inventorySearch.toLowerCase()));
    const getTypeColor = (type) => {
      const colors = { pdf: "#ef4444", docx: "#3b82f6", xlsx: "#22c55e", mpp: "#8b5cf6", msg: "#f59e0b" };
      return colors[type] || "#6b7280";
    };
    return h(Modal, { id: "evidence-inventory", title: "Evidence Inventory", large: true, children: h("div", { style: { display: "flex", flexDirection: "column", gap: "16px" }, children: [
      h("div", { style: { display: "flex", gap: "12px", flexWrap: "wrap" }, children: [
        h("div", { style: { flex: 1, minWidth: "120px", padding: "12px", background: "#eff6ff", borderRadius: "8px", textAlign: "center" }, children: [
          h("div", { style: { fontSize: "24px", fontWeight: 700, color: "#1d4ed8" }, children: evidence.length }),
          h("div", { style: { fontSize: "11px", color: "#6b7280" }, children: "Total Files" })
        ] }),
        h("div", { style: { flex: 1, minWidth: "120px", padding: "12px", background: "#f0fdf4", borderRadius: "8px", textAlign: "center" }, children: [
          h("div", { style: { fontSize: "24px", fontWeight: 700, color: "#16a34a" }, children: selectedCount }),
          h("div", { style: { fontSize: "11px", color: "#6b7280" }, children: "In Context" })
        ] }),
        h("div", { style: { flex: 1, minWidth: "120px", padding: "12px", background: "#fefce8", borderRadius: "8px", textAlign: "center" }, children: [
          h("div", { style: { fontSize: "24px", fontWeight: 700, color: "#ca8a04" }, children: evidence.filter((e) => e.validation === "pending").length }),
          h("div", { style: { fontSize: "11px", color: "#6b7280" }, children: "Pending Review" })
        ] }),
        h("div", { style: { flex: 1, minWidth: "120px", padding: "12px", background: "#f0fdf4", borderRadius: "8px", textAlign: "center" }, children: [
          h("div", { style: { fontSize: "24px", fontWeight: 700, color: "#16a34a" }, children: evidence.filter((e) => e.validation === "confirmed").length }),
          h("div", { style: { fontSize: "11px", color: "#6b7280" }, children: "Validated" })
        ] })
      ] }),
      h("div", { style: { display: "flex", gap: "8px", flexWrap: "wrap" }, children: [
        h(
          "button",
          {
            onClick: () => setInventoryFilter("all"),
            style: {
              padding: "6px 14px",
              borderRadius: "20px",
              fontSize: "12px",
              fontWeight: 500,
              background: inventoryFilter === "all" ? "#3b82f6" : "#f3f4f6",
              color: inventoryFilter === "all" ? "white" : "#374151",
              border: "none",
              cursor: "pointer"
            },
            children: [
              "All (",
              evidence.length,
              ")"
            ]
          }
        ),
        Object.entries(typeStats).filter(([, count]) => count > 0).map(([type, count]) => h(
          "button",
          {
            onClick: () => setInventoryFilter(type),
            style: {
              padding: "6px 14px",
              borderRadius: "20px",
              fontSize: "12px",
              fontWeight: 500,
              background: inventoryFilter === type ? getTypeColor(type) : "#f3f4f6",
              color: inventoryFilter === type ? "white" : "#374151",
              border: "none",
              cursor: "pointer",
              display: "flex",
              alignItems: "center",
              gap: "6px"
            },
            children: [
              h("span", { style: { width: "8px", height: "8px", borderRadius: "50%", background: inventoryFilter === type ? "white" : getTypeColor(type) } }),
              type.toUpperCase(),
              " (",
              count,
              ")"
            ]
          },
          type
        ))
      ] }),
      h(
        "input",
        {
          type: "text",
          placeholder: "Search files...",
          value: inventorySearch,
          onChange: (e) => setInventorySearch(e.target.value),
          style: {
            padding: "10px 14px",
            borderRadius: "8px",
            border: "1px solid #d1d5db",
            fontSize: "13px",
            width: "100%"
          }
        }
      ),
      h("div", { style: { maxHeight: "400px", overflowY: "auto", border: "1px solid #e5e7eb", borderRadius: "8px" }, children: h("table", { style: { width: "100%", borderCollapse: "collapse", fontSize: "12px" }, children: [
        h("thead", { children: h("tr", { style: { background: "#f9fafb", position: "sticky", top: 0 }, children: [
          h("th", { style: { padding: "10px", textAlign: "left", borderBottom: "1px solid #e5e7eb", width: "40px" }, children: h("input", { type: "checkbox", checked: selectedCount === evidence.length, onChange: toggleSelectAllEvidence }) }),
          h("th", { style: { padding: "10px", textAlign: "left", borderBottom: "1px solid #e5e7eb" }, children: "Name" }),
          h("th", { style: { padding: "10px", textAlign: "center", borderBottom: "1px solid #e5e7eb", width: "60px" }, children: "Type" }),
          h("th", { style: { padding: "10px", textAlign: "center", borderBottom: "1px solid #e5e7eb", width: "80px" }, children: "Status" }),
          h("th", { style: { padding: "10px", textAlign: "right", borderBottom: "1px solid #e5e7eb", width: "80px" }, children: "Size" })
        ] }) }),
        h("tbody", { children: filteredEvidence.map((doc) => h(
          "tr",
          {
            style: { cursor: "pointer", background: doc.selected ? "#eff6ff" : "" },
            onClick: () => toggleEvidence(doc.id),
            children: [
              h("td", { style: { padding: "10px", borderBottom: "1px solid #f3f4f6" }, children: h("input", { type: "checkbox", checked: doc.selected, onChange: () => {
              } }) }),
              h("td", { style: { padding: "10px", borderBottom: "1px solid #f3f4f6", fontWeight: doc.selected ? 600 : 400 }, children: doc.name }),
              h("td", { style: { padding: "10px", borderBottom: "1px solid #f3f4f6", textAlign: "center" }, children: h("span", { style: {
                padding: "2px 8px",
                borderRadius: "4px",
                fontSize: "10px",
                fontWeight: 600,
                background: `${getTypeColor(doc.type)}20`,
                color: getTypeColor(doc.type)
              }, children: doc.type?.toUpperCase() }) }),
              h("td", { style: { padding: "10px", borderBottom: "1px solid #f3f4f6", textAlign: "center" }, children: h("span", { style: {
                width: "8px",
                height: "8px",
                borderRadius: "50%",
                display: "inline-block",
                background: doc.validation === "confirmed" ? "#22c55e" : doc.validation === "rejected" ? "#ef4444" : "#eab308"
              } }) }),
              h("td", { style: { padding: "10px", borderBottom: "1px solid #f3f4f6", textAlign: "right", color: "#6b7280" }, children: doc.size ? (doc.size / 1024).toFixed(0) + " KB" : "-" })
            ]
          },
          doc.id
        )) })
      ] }) }),
      h("div", { style: { display: "flex", justifyContent: "space-between", alignItems: "center", paddingTop: "8px", borderTop: "1px solid #e5e7eb" }, children: [
        h("span", { style: { fontSize: "12px", color: "#6b7280" }, children: [
          filteredEvidence.length,
          " files shown"
        ] }),
        h("div", { style: { display: "flex", gap: "8px" }, children: [
          h("button", { className: "btn btn-ghost", onClick: () => openModal("file-manager"), children: "Open File Manager" }),
          h("button", { className: "btn btn-primary", onClick: closeModal, children: "Done" })
        ] })
      ] })
    ] }) });
  };
  var DashboardModal = () => {
    const { activeModal, closeModal, messages, backendConnected, wsConnected, addNotification, setProgressActive } = useApp();
    const [expanded, setExpanded] = useState(true);
    const [vspExpanded, setVspExpanded] = useState(false);
    const [apiExpanded, setApiExpanded] = useState(false);
    const [logsExpanded, setLogsExpanded] = useState(false);
    const [checking, setChecking] = useState(false);
    const [modules, setModules] = useState(null);
    const [apiEndpoints, setApiEndpoints] = useState([]);
    const [logs, setLogs] = useState([]);
    const [healthMetrics, setHealthMetrics] = useState({ uptime: 0, requests: 0, errors: 0, avgLatency: 0, version: null });
    const [sessionStart] = useState(Date.now());
    const [sessionTime, setSessionTime] = useState("0m 0s");
    const [services, setServices] = useState({
      // Core Services
      spotlight: { active: true, selected: false, status: "ready", safeguards: { timeout: 5e3, rateLimit: 10, concurrent: 3 } },
      convert: { active: true, selected: false, status: "ready" },
      websocket: { active: false, selected: false, status: "stopped", clients: 0 },
      // MLX Services
      mlx: { active: false, selected: false, status: "stopped", model: "MLX Llama 3.2" },
      // Analysis Services
      analysis: { active: true, selected: false, status: "ready" },
      delay: { active: true, selected: false, status: "ready" },
      quantum: { active: true, selected: false, status: "ready" },
      // VSP Services
      vsp: { active: true, selected: false, status: "ready" },
      timestamp: { active: true, selected: false, status: "ready" },
      forensic: { active: false, selected: false, status: "stopped" },
      // RAG Services
      rag: { active: false, selected: false, status: "stopped" },
      embeddings: { active: false, selected: false, status: "stopped" },
      // Protocol Services
      scl: { active: true, selected: false, status: "ready" },
      events: { active: true, selected: false, status: "ready" },
      notices: { active: true, selected: false, status: "ready" },
      quarantine: { active: true, selected: false, status: "ready" }
    });
    useEffect(() => {
      const timer = setInterval(() => {
        const elapsed = Math.floor((Date.now() - sessionStart) / 1e3);
        const mins = Math.floor(elapsed / 60);
        const secs = elapsed % 60;
        setSessionTime(`${mins}m ${secs}s`);
      }, 1e3);
      return () => clearInterval(timer);
    }, [sessionStart]);
    useEffect(() => {
      if (activeModal === "dashboard" && backendConnected) {
        fetchFullStatus();
      }
    }, [activeModal, backendConnected]);
    useEffect(() => {
      setServices((s) => ({
        ...s,
        websocket: { ...s.websocket, active: wsConnected, status: wsConnected ? "ready" : "stopped" }
      }));
    }, [wsConnected]);
    const fetchFullStatus = async () => {
      setChecking(true);
      try {
        const data = await ThemisAPI.settings.get();
        if (data && data.modules) {
          setModules(data.modules);
          setServices((s) => ({
            ...s,
            spotlight: {
              ...s.spotlight,
              active: data.modules.spotlight?.enabled ?? true,
              status: data.modules.spotlight?.status ?? "ready",
              safeguards: data.modules.spotlight?.safeguards ?? s.spotlight.safeguards
            },
            convert: { ...s.convert, active: data.modules.converters?.enabled ?? true, status: data.modules.converters?.status ?? "ready" },
            ai: { ...s.ai, active: data.modules.ai?.enabled ?? false, status: data.modules.ai?.status ?? "stopped", model: data.modules.ai?.model ?? "MLX Llama 3.2" },
            rag: { ...s.rag, active: data.modules.rag?.enabled ?? false, status: data.modules.rag?.status ?? "stopped" },
            forensic: { ...s.forensic, active: data.modules.forensic?.enabled ?? false, status: data.modules.forensic?.status ?? "stopped" }
          }));
        }
        const endpoints = await fetchApiEndpoints();
        setApiEndpoints(endpoints);
        const health = await ThemisAPI.healthFull();
        if (health) {
          setHealthMetrics({
            uptime: health.uptime || 0,
            requests: health.requests || 0,
            errors: health.errors || 0,
            avgLatency: health.avg_latency || 0,
            version: health.version || null
          });
        }
      } catch (err) {
        console.error("[Dashboard] Error fetching status:", err);
      }
      setChecking(false);
    };
    const fetchApiEndpoints = async () => {
      const endpoints = [
        { path: "/health", method: "GET", category: "System", status: "ok" },
        { path: "/api/v1/cases", method: "GET", category: "Cases", status: "ok" },
        { path: "/api/v1/evidence", method: "GET", category: "Evidence", status: "ok" },
        { path: "/api/v1/search", method: "POST", category: "Search", status: "ok" },
        { path: "/api/v1/analysis", method: "POST", category: "Analysis", status: "ok" },
        { path: "/api/v1/folders", method: "GET", category: "Folders", status: "ok" },
        { path: "/ws", method: "WS", category: "WebSocket", status: wsConnected ? "ok" : "warn" },
        // FIX7 endpoints
        { path: "/api/v1/zero-trust/upload", method: "POST", category: "Zero Trust", status: "ok" },
        { path: "/api/v1/scl/principles", method: "GET", category: "SCL Protocol", status: "ok" },
        { path: "/api/v1/events", method: "GET", category: "Risk Events", status: "ok" },
        { path: "/api/v1/notices", method: "GET", category: "Notices", status: "ok" },
        { path: "/api/v1/quarantine", method: "GET", category: "Quarantine", status: "ok" },
        { path: "/api/v1/ro-assessment", method: "POST", category: "R&O", status: "ok" }
      ];
      return endpoints;
    };
    if (activeModal !== "dashboard") return null;
    const toggleService = (id) => setServices((s) => ({ ...s, [id]: { ...s[id], selected: !s[id].selected } }));
    const handleStart = async () => {
      if (!backendConnected) {
        addNotification("error", "Backend offline - cannot start services");
        return;
      }
      setChecking(true);
      const toStart = Object.entries(services).filter(([k, v]) => v.selected && !v.active).map(([k]) => k);
      for (const svc of toStart) {
        try {
          await ThemisAPI.settings.update({ module: svc, enabled: true });
          setServices((s) => ({ ...s, [svc]: { ...s[svc], active: true, status: "starting" } }));
          addNotification("success", `${svc} started`);
        } catch (err) {
          addNotification("error", `Failed to start ${svc}`);
        }
      }
      setTimeout(fetchFullStatus, 1e3);
    };
    const handleStopSelected = async () => {
      if (!backendConnected) return;
      setChecking(true);
      const toStop = Object.entries(services).filter(([k, v]) => v.selected && v.active).map(([k]) => k);
      for (const svc of toStop) {
        await ThemisAPI.settings.update({ module: svc, enabled: false });
        setServices((s) => ({ ...s, [svc]: { ...s[svc], active: false, status: "stopped" } }));
      }
      setChecking(false);
    };
    const handleStopAll = async () => {
      if (!backendConnected) return;
      setChecking(true);
      for (const svc of Object.keys(services)) {
        await ThemisAPI.settings.update({ module: svc, enabled: false });
      }
      setServices((s) => Object.fromEntries(Object.entries(s).map(([k, v]) => [k, { ...v, active: false, status: "stopped" }])));
      setChecking(false);
    };
    const handleReconnectWS = () => {
      if (typeof themisWS !== "undefined" && themisWS.connect) {
        themisWS.connect();
        addNotification("info", "Reconnecting WebSocket...");
      }
    };
    const getStatusColor = (status) => {
      switch (status) {
        case "ready":
        case "running":
        case "ok":
          return "#22c55e";
        case "starting":
        case "warn":
          return "#f59e0b";
        case "error":
          return "#ef4444";
        default:
          return "#9ca3af";
      }
    };
    const getStatusText = (s) => {
      if (s.status === "starting") return "Starting...";
      if (s.active) return "Ready";
      return "Off";
    };
    const ServiceRow = ({ id, name, desc = null }) => {
      const s = services[id];
      const handleAction = async (action) => {
        if (!backendConnected) {
          addNotification("error", "Backend offline");
          return;
        }
        setChecking(true);
        setProgressActive(true);
        addNotification("warning", `${action === "start" ? "Starting" : action === "stop" ? "Stopping" : "Restarting"} ${name}...`);
        await new Promise((r) => setTimeout(r, 800));
        const result = await ThemisAPI.settings.toggleModule(id, action === "start");
        if (result === null) {
          addNotification("error", `API error: Failed to ${action} ${name}`);
          setChecking(false);
          setProgressActive(false);
          return;
        }
        if (action === "start") {
          setServices((prev) => ({ ...prev, [id]: { ...prev[id], active: true, status: "ready" } }));
          addNotification("success", `${name} started`);
        } else if (action === "stop") {
          setServices((prev) => ({ ...prev, [id]: { ...prev[id], active: false, status: "stopped" } }));
          addNotification("success", `${name} stopped`);
        } else if (action === "restart") {
          setServices((prev) => ({ ...prev, [id]: { ...prev[id], status: "starting" } }));
          await new Promise((r) => setTimeout(r, 1e3));
          setServices((prev) => ({ ...prev, [id]: { ...prev[id], active: true, status: "ready" } }));
          addNotification("success", `${name} restarted`);
        }
        setChecking(false);
        setProgressActive(false);
      };
      return h("div", { style: {
        display: "flex",
        alignItems: "center",
        padding: "10px 12px",
        borderBottom: "1px solid #f3f4f6",
        gap: "12px"
      }, children: [
        h("div", { style: {
          width: "10px",
          height: "10px",
          borderRadius: "50%",
          background: getStatusColor(s.status),
          flexShrink: 0
        } }),
        h("div", { style: { flex: 1, minWidth: 0 }, children: [
          h("div", { style: { fontSize: "13px", fontWeight: 500, color: s.active ? "#111827" : "#6b7280" }, children: name }),
          desc && h("div", { style: { fontSize: "10px", color: "#9ca3af" }, children: desc })
        ] }),
        h("div", { style: { fontSize: "11px", color: "#6b7280", marginRight: "8px" }, children: getStatusText(s) }),
        h("div", { style: { display: "flex", gap: "4px" }, children: !s.active ? h(
          "button",
          {
            onClick: () => handleAction("start"),
            disabled: checking,
            style: {
              width: "28px",
              height: "28px",
              border: "none",
              borderRadius: "6px",
              background: "#d1fae5",
              color: "#065f46",
              cursor: "pointer",
              fontSize: "14px",
              display: "flex",
              alignItems: "center",
              justifyContent: "center"
            },
            title: "Start",
            children: "\u25B6"
          }
        ) : h(React.Fragment, { children: [
          h(
            "button",
            {
              onClick: () => handleAction("restart"),
              disabled: checking,
              style: {
                width: "28px",
                height: "28px",
                border: "none",
                borderRadius: "6px",
                background: "#dbeafe",
                color: "#1d4ed8",
                cursor: "pointer",
                fontSize: "12px",
                display: "flex",
                alignItems: "center",
                justifyContent: "center"
              },
              title: "Restart",
              children: "\u21BB"
            }
          ),
          h(
            "button",
            {
              onClick: () => handleAction("stop"),
              disabled: checking,
              style: {
                width: "28px",
                height: "28px",
                border: "none",
                borderRadius: "6px",
                background: "#fee2e2",
                color: "#dc2626",
                cursor: "pointer",
                fontSize: "14px",
                display: "flex",
                alignItems: "center",
                justifyContent: "center"
              },
              title: "Stop",
              children: "\u25A0"
            }
          )
        ] }) })
      ] });
    };
    return h("div", { className: "modal-overlay open", onClick: closeModal, children: h("div", { className: "modal modal-lg", onClick: (e) => e.stopPropagation(), style: { maxWidth: "600px" }, children: [
      h("button", { className: "modal-close", onClick: closeModal, style: { position: "absolute", top: "16px", right: "16px", zIndex: 1 }, children: "\xD7" }),
      h("div", { className: "modal-body", style: { padding: "20px" }, children: [
        h("div", { style: { textAlign: "center", marginBottom: "20px" }, children: [
          h("div", { style: { fontSize: "24px", fontWeight: 700, color: "#2563eb", letterSpacing: "3px" }, children: "THEMIS-QS" }),
          h("div", { style: { fontSize: "12px", color: "#6b7280" }, children: "Forensic Document Analysis" }),
          h("div", { style: { fontSize: "10px", color: "#9ca3af", marginTop: "4px" }, children: "Service Dashboard v2.0" })
        ] }),
        h("div", { style: { display: "grid", gridTemplateColumns: "repeat(4, 1fr)", gap: "8px", marginBottom: "20px" }, children: [
          h("div", { style: { padding: "12px 8px", background: "#f9fafb", borderRadius: "8px", textAlign: "center" }, children: [
            h("div", { style: { fontSize: "16px", fontWeight: 700, color: "#111827" }, children: sessionTime }),
            h("div", { style: { fontSize: "10px", color: "#9ca3af" }, children: "Session" })
          ] }),
          h("div", { style: { padding: "12px 8px", background: "#f9fafb", borderRadius: "8px", textAlign: "center" }, children: [
            h("div", { style: { fontSize: "16px", fontWeight: 700, color: "#111827" }, children: messages.length }),
            h("div", { style: { fontSize: "10px", color: "#9ca3af" }, children: "Messages" })
          ] }),
          h("div", { style: { padding: "12px 8px", background: "#f9fafb", borderRadius: "8px", textAlign: "center" }, children: [
            h("div", { style: { fontSize: "16px", fontWeight: 700, color: "#111827" }, children: healthMetrics.requests }),
            h("div", { style: { fontSize: "10px", color: "#9ca3af" }, children: "Requests" })
          ] }),
          h("div", { style: { padding: "12px 8px", background: "#f9fafb", borderRadius: "8px", textAlign: "center" }, children: [
            h("div", { style: { fontSize: "16px", fontWeight: 700, color: healthMetrics.errors > 0 ? "#dc2626" : "#111827" }, children: healthMetrics.errors }),
            h("div", { style: { fontSize: "10px", color: "#9ca3af" }, children: "Errors" })
          ] })
        ] }),
        h("div", { style: { display: "flex", gap: "8px", marginBottom: "16px" }, children: [
          h("div", { style: { flex: 1, padding: "8px 12px", background: backendConnected ? "#dcfce7" : "#fee2e2", borderRadius: "6px", display: "flex", alignItems: "center", justifyContent: "space-between" }, children: [
            h("span", { style: { fontSize: "11px", fontWeight: 600, color: backendConnected ? "#166534" : "#991b1b" }, children: [
              "API ",
              backendConnected ? "Connected" : "Offline"
            ] }),
            h("span", { style: { fontSize: "10px", color: backendConnected ? "#166534" : "#991b1b" }, children: ":8765" })
          ] }),
          h("div", { style: { flex: 1, padding: "8px 12px", background: wsConnected ? "#dbeafe" : "#f3f4f6", borderRadius: "6px", display: "flex", alignItems: "center", justifyContent: "space-between" }, children: [
            h("span", { style: { fontSize: "11px", fontWeight: 600, color: wsConnected ? "#1e40af" : "#6b7280" }, children: [
              "WebSocket ",
              wsConnected ? "Live" : "Disconnected"
            ] }),
            !wsConnected && h("button", { onClick: handleReconnectWS, style: { fontSize: "9px", padding: "2px 6px", background: "#3b82f6", color: "#fff", border: "none", borderRadius: "3px", cursor: "pointer" }, children: "Reconnect" })
          ] })
        ] }),
        h("div", { style: { display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: "8px" }, children: [
          h("span", { style: { fontSize: "12px", fontWeight: 600, color: "#374151" }, children: "Services" }),
          h("div", { style: { display: "flex", alignItems: "center", gap: "8px" }, children: [
            checking && h("span", { style: { fontSize: "10px", color: "#6b7280" }, children: "Checking..." }),
            h("button", { onClick: fetchFullStatus, disabled: !backendConnected || checking, style: { fontSize: "10px", padding: "3px 8px", background: "#f3f4f6", border: "1px solid #e5e7eb", borderRadius: "4px", cursor: "pointer" }, children: "\u21BB Refresh" })
          ] })
        ] }),
        h("div", { style: { border: "1px solid #e5e7eb", borderRadius: "8px", overflow: "hidden", marginBottom: "16px" }, children: [
          h("div", { style: { display: "flex", alignItems: "center", padding: "10px 12px", background: backendConnected ? "#f0fdf4" : "#fef2f2", borderBottom: "1px solid #e5e7eb", gap: "12px" }, children: [
            h("div", { style: {
              width: "10px",
              height: "10px",
              borderRadius: "50%",
              background: backendConnected ? "#22c55e" : "#ef4444",
              flexShrink: 0
            } }),
            h("span", { style: { cursor: "pointer", color: "#6b7280", fontSize: "12px", fontWeight: 600 }, onClick: () => setExpanded(!expanded), children: expanded ? "\u25BC" : "\u25B6" }),
            h("div", { style: { flex: 1, minWidth: 0 }, children: [
              h("div", { style: { display: "flex", alignItems: "center", gap: "8px" }, children: [
                h("span", { style: { fontSize: "13px", fontWeight: 600, color: "#111827" }, children: "Backend Server" }),
                h("span", { style: { fontSize: "9px", color: "#6b7280", background: "#e5e7eb", padding: "2px 6px", borderRadius: "4px" }, children: [
                  "v",
                  healthMetrics.version || "?.?"
                ] }),
                wsConnected && h("span", { style: { fontSize: "9px", color: "#fff", background: "#3b82f6", padding: "2px 6px", borderRadius: "4px", fontWeight: 600 }, children: "WS" })
              ] }),
              h("div", { style: { fontSize: "10px", color: "#9ca3af" }, children: [
                backendConnected ? "Running" : "Stopped",
                " \xB7 launchd service"
              ] })
            ] }),
            h("div", { style: { display: "flex", gap: "4px" }, children: !backendConnected ? h(
              "button",
              {
                onClick: async () => {
                  setChecking(true);
                  setProgressActive(true);
                  addNotification("warning", "Starting backend...");
                  try {
                    await ThemisAPI.service.start();
                    setTimeout(async () => {
                      try {
                        const ok = await ThemisAPI.health();
                        if (ok) {
                          addNotification("success", "Backend started!");
                          fetchFullStatus();
                        } else {
                          addNotification("error", "Backend did not start");
                        }
                      } catch (e) {
                        addNotification("error", "Health check failed: " + e.message);
                      }
                      setChecking(false);
                      setProgressActive(false);
                    }, 2e3);
                  } catch (e) {
                    addNotification("error", "Start failed: " + e.message);
                    setChecking(false);
                    setProgressActive(false);
                  }
                },
                disabled: checking,
                style: {
                  width: "28px",
                  height: "28px",
                  border: "none",
                  borderRadius: "6px",
                  background: "#d1fae5",
                  color: "#065f46",
                  cursor: "pointer",
                  fontSize: "14px",
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "center"
                },
                title: "Start",
                children: "\u25B6"
              }
            ) : h(React.Fragment, { children: [
              h(
                "button",
                {
                  onClick: async () => {
                    setChecking(true);
                    setProgressActive(true);
                    addNotification("warning", "Restarting backend...");
                    try {
                      await ThemisAPI.service.restart();
                      setTimeout(async () => {
                        try {
                          const ok = await ThemisAPI.health();
                          if (ok) {
                            addNotification("success", "Backend restarted!");
                            fetchFullStatus();
                          } else {
                            addNotification("error", "Backend did not restart");
                          }
                        } catch (e) {
                          addNotification("error", "Health check failed: " + e.message);
                        }
                        setChecking(false);
                        setProgressActive(false);
                      }, 3e3);
                    } catch (e) {
                      addNotification("error", "Restart failed: " + e.message);
                      setChecking(false);
                      setProgressActive(false);
                    }
                  },
                  disabled: checking,
                  style: {
                    width: "28px",
                    height: "28px",
                    border: "none",
                    borderRadius: "6px",
                    background: "#dbeafe",
                    color: "#1d4ed8",
                    cursor: "pointer",
                    fontSize: "12px",
                    display: "flex",
                    alignItems: "center",
                    justifyContent: "center"
                  },
                  title: "Restart",
                  children: "\u21BB"
                }
              ),
              h(
                "button",
                {
                  onClick: async () => {
                    setChecking(true);
                    setProgressActive(true);
                    addNotification("warning", "Stopping backend...");
                    const result = await ThemisAPI.service.stop();
                    setTimeout(async () => {
                      if (result === null) {
                        addNotification("error", "Stop failed: API endpoint not available");
                      } else {
                        const stillRunning = await ThemisAPI.health();
                        if (stillRunning) {
                          addNotification("error", "Backend still running");
                        } else {
                          addNotification("success", "Backend stopped");
                        }
                      }
                      setChecking(false);
                      setProgressActive(false);
                    }, 2e3);
                  },
                  disabled: checking,
                  style: {
                    width: "28px",
                    height: "28px",
                    border: "none",
                    borderRadius: "6px",
                    background: "#fee2e2",
                    color: "#dc2626",
                    cursor: "pointer",
                    fontSize: "14px",
                    display: "flex",
                    alignItems: "center",
                    justifyContent: "center"
                  },
                  title: "Stop",
                  children: "\u25A0"
                }
              )
            ] }) })
          ] }),
          expanded && h("div", { children: [
            h("div", { style: { padding: "6px 12px", background: "#f9fafb", fontSize: "10px", fontWeight: 600, color: "#6b7280", borderBottom: "1px solid #e5e7eb" }, children: "CORE" }),
            h(ServiceRow, { id: "spotlight", name: "Spotlight Search", desc: `timeout: ${services.spotlight.safeguards?.timeout || 5e3}ms` }),
            h(ServiceRow, { id: "convert", name: "Document Converters", desc: "PDF, DOCX, XLSX, MSG" }),
            h(ServiceRow, { id: "websocket", name: "WebSocket Server", desc: wsConnected ? "Connected" : "Disconnected" }),
            h("div", { style: { padding: "6px 12px", background: "#f9fafb", fontSize: "10px", fontWeight: 600, color: "#6b7280", borderBottom: "1px solid #e5e7eb" }, children: "MLX" }),
            h(ServiceRow, { id: "mlx", name: "MLX Model", desc: services.mlx?.model || "Llama 3.2" }),
            h(ServiceRow, { id: "embeddings", name: "Embeddings", desc: "Text vectorization" }),
            h(ServiceRow, { id: "rag", name: "RAG Engine", desc: "Vector search" }),
            h("div", { style: { padding: "6px 12px", background: "#f9fafb", fontSize: "10px", fontWeight: 600, color: "#6b7280", borderBottom: "1px solid #e5e7eb" }, children: "ANALYSIS" }),
            h(ServiceRow, { id: "analysis", name: "Analysis Engine", desc: "Document processing" }),
            h(ServiceRow, { id: "delay", name: "Delay Analysis", desc: "TIA methods" }),
            h(ServiceRow, { id: "quantum", name: "Quantum Analysis", desc: "Cost calculation" }),
            h("div", { style: { padding: "6px 12px", background: "#f9fafb", fontSize: "10px", fontWeight: 600, color: "#6b7280", borderBottom: "1px solid #e5e7eb" }, children: "VSP" }),
            h(ServiceRow, { id: "vsp", name: "VSP Pipeline", desc: "Validation protocol" }),
            h(ServiceRow, { id: "timestamp", name: "Timestamp Service", desc: "RFC 3161" }),
            h(ServiceRow, { id: "forensic", name: "Forensic Audit", desc: "Hash verification" }),
            h("div", { style: { padding: "6px 12px", background: "#f9fafb", fontSize: "10px", fontWeight: 600, color: "#6b7280", borderBottom: "1px solid #e5e7eb" }, children: "PROTOCOL" }),
            h(ServiceRow, { id: "scl", name: "SCL Compliance", desc: "Protocol principles" }),
            h(ServiceRow, { id: "events", name: "Risk Events", desc: "Event tracking" }),
            h(ServiceRow, { id: "notices", name: "Notices", desc: "Contract notices" }),
            h(ServiceRow, { id: "quarantine", name: "Quarantine", desc: "Zero Trust staging" })
          ] })
        ] }),
        h("div", { style: { marginBottom: "16px" }, children: [
          h("div", { style: { display: "flex", justifyContent: "space-between", alignItems: "center", padding: "8px 0", cursor: "pointer" }, onClick: () => setApiExpanded(!apiExpanded), children: [
            h("span", { style: { fontSize: "12px", fontWeight: 600, color: "#374151" }, children: [
              apiExpanded ? "\u25BC" : "\u25B6",
              " API Endpoints"
            ] }),
            h("span", { style: { fontSize: "10px", color: "#6b7280" }, children: [
              apiEndpoints.length,
              " routes"
            ] })
          ] }),
          apiExpanded && h("div", { style: { border: "1px solid #e5e7eb", borderRadius: "6px", maxHeight: "200px", overflow: "auto" }, children: apiEndpoints.map((ep, i) => h("div", { style: { display: "flex", justifyContent: "space-between", alignItems: "center", padding: "6px 12px", borderBottom: "1px solid #f3f4f6", fontSize: "11px" }, children: [
            h("div", { style: { display: "flex", alignItems: "center", gap: "8px" }, children: [
              h("span", { style: {
                padding: "2px 6px",
                borderRadius: "3px",
                fontSize: "9px",
                fontWeight: 600,
                background: ep.method === "GET" ? "#dbeafe" : ep.method === "POST" ? "#dcfce7" : ep.method === "WS" ? "#fef3c7" : "#f3f4f6",
                color: ep.method === "GET" ? "#1e40af" : ep.method === "POST" ? "#166534" : ep.method === "WS" ? "#92400e" : "#374151"
              }, children: ep.method }),
              h("span", { style: { fontFamily: "monospace", color: "#374151" }, children: ep.path })
            ] }),
            h("div", { style: { display: "flex", alignItems: "center", gap: "6px" }, children: [
              h("span", { style: { fontSize: "9px", color: "#9ca3af" }, children: ep.category }),
              h("span", { style: { width: "6px", height: "6px", borderRadius: "50%", background: getStatusColor(ep.status) } })
            ] })
          ] }, i)) })
        ] })
      ] }),
      h("div", { className: "modal-copyright", style: { padding: "12px", borderTop: "1px solid #e5e7eb", textAlign: "center", fontSize: "10px", color: "#9ca3af" }, children: "T H E M i S - QS  \xB7  Installer v2.0  \xB7  Frontend v9.31 FIX7  \xB7  Backend v8.0.19" })
    ] }) });
  };
  var ConstraintsModal = () => {
    const { activeModal, currentCase, closeModal, addNotification } = useApp();
    const [constraints, setConstraints] = useState("");
    if (activeModal !== "constraints") return null;
    const templates = {
      fidic: "Contract type: FIDIC Yellow Book 1999\nApplicable law: International\nCurrency: USD\nDelay analysis: Time Impact Analysis (TIA)",
      nec: "Contract type: NEC4 Option A\nApplicable law: UK\nCurrency: GBP\nDelay analysis: Accepted Programme analysis",
      jct: "Contract type: JCT Design and Build 2016\nApplicable law: English Law\nCurrency: GBP\nExtension of time: Relevant Events",
      aia: "Contract type: AIA A201-2017\nApplicable law: US\nCurrency: USD\nDelay analysis: CPM Schedule Analysis",
      far: "Contract type: FAR/DFARS\nApplicable law: US Federal\nCurrency: USD\nDelay analysis: Schedule Analysis per FAR 52.242-17"
    };
    const applyTemplate = (key) => setConstraints(templates[key] || "");
    const saveConstraints = () => {
      addNotification("success", "Constraints saved");
      closeModal();
    };
    return h("div", { className: "modal-overlay open", onClick: closeModal, children: h("div", { className: "modal modal-lg", onClick: (e) => e.stopPropagation(), children: [
      h("button", { className: "modal-close", onClick: closeModal, children: "x" }),
      h("div", { style: { textAlign: "center", padding: "16px 0", borderBottom: "1px solid #e5e7eb" }, children: [
        h("div", { style: { fontSize: "24px", fontWeight: 700, color: "#2563eb" }, children: "Case Constraints" }),
        h("div", { style: { display: "inline-block", padding: "6px 16px", background: "#f3f4f6", borderRadius: "20px", marginTop: "8px", fontSize: "13px", fontWeight: 500 }, children: currentCase.name })
      ] }),
      h("div", { className: "modal-body", children: [
        h("div", { style: { padding: "16px", background: "#eff6ff", borderRadius: "8px", marginBottom: "16px" }, children: h("p", { style: { margin: 0, fontSize: "13px", color: "#1e40af" }, children: "Define analysis rules and constraints specific to this case. These instructions guide how the AI assistants process and analyze documents." }) }),
        h(
          "textarea",
          {
            value: constraints,
            onChange: (e) => setConstraints(e.target.value),
            placeholder: `Enter case-specific constraints...

Examples:
- Contract type: FIDIC Yellow Book 1999
- Applicable law: UK Construction Act 1996
- Currency: GBP
- Critical path method: CPM with float analysis
- Delay analysis: Time Impact Analysis (TIA)
- Key milestones to track: Substantial Completion, Final Completion
- Exclude: Provisional sums, Daywork rates
- Focus on: Extension of Time claims, Prolongation costs`,
            style: { width: "100%", minHeight: "150px", padding: "12px", border: "1px solid #e5e7eb", borderRadius: "8px", fontSize: "13px", fontFamily: "monospace", resize: "vertical" }
          }
        ),
        h("div", { style: { marginTop: "16px" }, children: [
          h("div", { style: { fontSize: "11px", fontWeight: 600, color: "#6b7280", marginBottom: "8px" }, children: "Quick Templates" }),
          h("div", { style: { display: "flex", gap: "8px", flexWrap: "wrap" }, children: Object.keys(templates).map((key) => h("button", { onClick: () => applyTemplate(key), style: { padding: "6px 12px", background: "#f3f4f6", border: "1px solid #e5e7eb", borderRadius: "6px", fontSize: "11px", fontWeight: 600, cursor: "pointer", textTransform: "uppercase" }, children: key }, key)) })
        ] })
      ] }),
      h("div", { className: "modal-footer", style: { justifyContent: "center" }, children: [
        h("button", { className: "btn btn-secondary", onClick: closeModal, children: "Cancel" }),
        h("button", { className: "btn btn-primary", onClick: saveConstraints, children: "Save Constraints" })
      ] }),
      h("div", { className: "modal-copyright", children: "T H E M i S - QS   (c) 2026" })
    ] }) });
  };
  var TagManagerModal = () => {
    const { activeModal, closeModal, evidence, currentCase, addTag, removeTag, bulkAddTag, addNotification, showTagLabels, toggleTagLabels, showEvidenceIds, toggleEvidenceIds } = useApp();
    const [selectedNs, setSelectedNs] = useState("all");
    const [newTagNs, setNewTagNs] = useState("type");
    const [newTagValue, setNewTagValue] = useState("");
    if (activeModal !== "tag-manager") return null;
    const NAMESPACES = [
      { id: "case", name: "Case", color: "#3b82f6", protected: true },
      { id: "type", name: "Type", color: "#8b5cf6" },
      { id: "fw", name: "Framework", color: "#22c55e" },
      { id: "meth", name: "Methodology", color: "#06b6d4" },
      { id: "valid", name: "Validation", color: "#eab308", protected: true },
      { id: "folder", name: "Folder", color: "#6b7280" },
      { id: "phase", name: "Phase", color: "#ec4899" },
      { id: "conv", name: "Context", color: "#f97316" },
      { id: "search", name: "Search", color: "#a1a1aa" }
    ];
    const TAG_TEMPLATES = {
      type: ["CONTRACT", "EOT", "VARIATION", "CLAIM", "MINUTES", "CORRESPONDENCE", "PROGRAMME", "INVOICE", "EXPERT_REPORT"],
      fw: ["RICS", "FIDIC", "NEC", "JCT", "FAR"],
      meth: ["SCL", "AACE", "TIA", "WINDOWS"],
      phase: ["pre-contract", "construction", "post-contract", "dispute"]
    };
    const allTags = [...new Set(evidence.flatMap((e) => e.tags))];
    const tagsByNamespace = NAMESPACES.reduce((acc, ns) => {
      acc[ns.id] = allTags.filter((t) => t.split(":")[1] === ns.id);
      return acc;
    }, {});
    const filteredTags = selectedNs === "all" ? allTags : tagsByNamespace[selectedNs] || [];
    const selectedCount = evidence.filter((e) => e.selected).length;
    const getTagCount = (tag) => evidence.filter((e) => e.tags.includes(tag)).length;
    const getNsColor = (nsId) => NAMESPACES.find((n) => n.id === nsId)?.color || "#6b7280";
    const applyTemplate = (ns, value) => {
      const tag = `THEMIS:${ns}:${value}`;
      const selected = evidence.filter((e) => e.selected);
      if (selected.length === 0) {
        addNotification("warning", "Select documents first");
        return;
      }
      bulkAddTag(selected.map((e) => e.id), tag);
      addNotification("success", `Applied to ${selected.length} doc(s)`);
    };
    const removeTagFromAll = (tag) => {
      const docs = evidence.filter((e) => e.tags.includes(tag));
      docs.forEach((doc) => removeTag(doc.id, tag));
      addNotification("info", `Removed from ${docs.length} doc(s)`);
    };
    return h("div", { className: "modal-overlay open", onClick: closeModal, children: h("div", { className: "modal", style: { width: "800px", maxWidth: "95vw", maxHeight: "85vh" }, onClick: (e) => e.stopPropagation(), children: [
      h("div", { className: "modal-header", style: { borderBottom: "1px solid #e5e7eb" }, children: [
        h("div", { style: { display: "flex", alignItems: "center", gap: "12px" }, children: [
          h("span", { className: "modal-title", style: { fontSize: "16px", fontWeight: 700 }, children: "TAG MANAGER" }),
          h("span", { style: { padding: "4px 10px", background: "#f3f4f6", borderRadius: "12px", fontSize: "11px", color: "#6b7280" }, children: [
            allTags.length,
            " tags in use"
          ] })
        ] }),
        h("div", { style: { display: "flex", alignItems: "center", gap: "16px" }, children: [
          h("div", { onClick: toggleEvidenceIds, style: { display: "flex", alignItems: "center", gap: "8px", cursor: "pointer" }, children: [
            h("span", { style: { fontSize: "12px", color: "#6b7280" }, children: "IDs" }),
            h("div", { style: { width: "36px", height: "20px", borderRadius: "10px", background: showEvidenceIds ? "#7c3aed" : "#d1d5db", position: "relative", transition: "0.2s" }, children: h("div", { style: { width: "16px", height: "16px", borderRadius: "50%", background: "white", position: "absolute", top: "2px", left: showEvidenceIds ? "18px" : "2px", transition: "0.2s", boxShadow: "0 1px 3px rgba(0,0,0,0.2)" } }) })
          ] }),
          h("div", { onClick: toggleTagLabels, style: { display: "flex", alignItems: "center", gap: "8px", cursor: "pointer" }, children: [
            h("span", { style: { fontSize: "12px", color: "#6b7280" }, children: "Labels" }),
            h("div", { style: { width: "36px", height: "20px", borderRadius: "10px", background: showTagLabels ? "#3b82f6" : "#d1d5db", position: "relative", transition: "0.2s" }, children: h("div", { style: { width: "16px", height: "16px", borderRadius: "50%", background: "white", position: "absolute", top: "2px", left: showTagLabels ? "18px" : "2px", transition: "0.2s", boxShadow: "0 1px 3px rgba(0,0,0,0.2)" } }) })
          ] }),
          h("button", { className: "modal-close", onClick: closeModal, children: "x" })
        ] })
      ] }),
      h("div", { style: { padding: "16px 20px", background: "#f8fafc", borderBottom: "1px solid #e5e7eb" }, children: [
        h("div", { style: { fontSize: "10px", fontWeight: 600, color: "#64748b", marginBottom: "12px" }, children: [
          "QUICK APPLY TO ",
          selectedCount > 0 ? `${selectedCount} SELECTED` : "SELECTED DOCUMENTS"
        ] }),
        h("div", { style: { display: "grid", gridTemplateColumns: "repeat(4, 1fr)", gap: "12px" }, children: Object.entries(TAG_TEMPLATES).map(([ns, values]) => h("div", { children: [
          h("div", { style: { fontSize: "9px", fontWeight: 600, color: getNsColor(ns), marginBottom: "6px", textTransform: "uppercase" }, children: ns }),
          h("div", { style: { display: "flex", flexWrap: "wrap", gap: "4px" }, children: values.slice(0, 5).map((v) => h("button", { onClick: () => applyTemplate(ns, v), style: { padding: "3px 8px", background: "white", border: "1px solid #e2e8f0", borderRadius: "4px", fontSize: "9px", cursor: "pointer" }, children: v }, v)) })
        ] }, ns)) })
      ] }),
      h("div", { style: { display: "flex", flex: 1, minHeight: "300px", maxHeight: "400px" }, children: [
        h("div", { style: { width: "180px", borderRight: "1px solid #e5e7eb", padding: "12px", overflow: "auto", background: "#fafafa" }, children: [
          h("div", { style: { fontSize: "9px", fontWeight: 600, color: "#6b7280", marginBottom: "8px", padding: "0 8px" }, children: "NAMESPACES" }),
          h("div", { onClick: () => setSelectedNs("all"), style: { padding: "8px 12px", borderRadius: "6px", cursor: "pointer", marginBottom: "4px", background: selectedNs === "all" ? "#eff6ff" : "", fontWeight: selectedNs === "all" ? 600 : 400, fontSize: "12px" }, children: [
            "All Tags ",
            h("span", { style: { color: "#9ca3af", fontSize: "10px" }, children: [
              "(",
              allTags.length,
              ")"
            ] })
          ] }),
          NAMESPACES.map((ns) => h("div", { onClick: () => setSelectedNs(ns.id), style: { display: "flex", alignItems: "center", gap: "8px", padding: "8px 12px", borderRadius: "6px", cursor: "pointer", marginBottom: "2px", background: selectedNs === ns.id ? "#eff6ff" : "" }, children: [
            h("span", { style: { width: "8px", height: "8px", borderRadius: "50%", background: ns.color } }),
            h("span", { style: { flex: 1, fontSize: "11px", fontWeight: selectedNs === ns.id ? 600 : 400 }, children: ns.name }),
            h("span", { style: { fontSize: "10px", color: "#9ca3af" }, children: tagsByNamespace[ns.id]?.length || 0 })
          ] }, ns.id))
        ] }),
        h("div", { style: { flex: 1, overflow: "auto", padding: "12px 16px" }, children: [
          h("div", { style: { fontSize: "9px", fontWeight: 600, color: "#6b7280", marginBottom: "10px" }, children: selectedNs === "all" ? "ALL TAGS IN USE" : `${NAMESPACES.find((n) => n.id === selectedNs)?.name.toUpperCase()} TAGS` }),
          filteredTags.length === 0 ? h("div", { style: { textAlign: "center", padding: "40px", color: "#9ca3af" }, children: [
            h("div", { style: { fontSize: "24px", marginBottom: "8px" }, children: " " }),
            h("div", { style: { fontSize: "11px" }, children: "No tags in this namespace" })
          ] }) : h("div", { style: { display: "flex", flexDirection: "column", gap: "4px" }, children: filteredTags.map((tag) => {
            const ns = tag.split(":")[1];
            const count = getTagCount(tag);
            const isProtected = NAMESPACES.find((n) => n.id === ns)?.protected;
            return h("div", { style: { display: "flex", alignItems: "center", gap: "10px", padding: "8px 10px", background: "#f9fafb", borderRadius: "6px" }, children: [
              h("span", { style: { width: "8px", height: "8px", borderRadius: "50%", background: getNsColor(ns) } }),
              h("span", { style: { flex: 1, fontSize: "11px", fontFamily: "monospace", color: "#374151" }, children: tag }),
              h("span", { style: { fontSize: "10px", color: "#6b7280", background: "#e5e7eb", padding: "2px 8px", borderRadius: "10px" }, children: [
                count,
                " doc",
                count !== 1 ? "s" : ""
              ] }),
              !isProtected && h("button", { onClick: () => removeTagFromAll(tag), style: { background: "none", border: "none", color: "#ef4444", fontSize: "10px", cursor: "pointer" }, children: "Remove all" })
            ] }, tag);
          }) })
        ] })
      ] }),
      h("div", { style: { padding: "12px 20px", borderTop: "1px solid #e5e7eb", background: "#f8fafc" }, children: [
        h("div", { style: { fontSize: "9px", fontWeight: 600, color: "#64748b", marginBottom: "8px" }, children: "ADD CUSTOM TAG TO SELECTED DOCUMENTS" }),
        h("div", { style: { display: "flex", gap: "8px", alignItems: "center" }, children: [
          h("select", { value: newTagNs, onChange: (e) => setNewTagNs(e.target.value), style: { padding: "8px 12px", border: "1px solid #e5e7eb", borderRadius: "6px", fontSize: "11px", background: "white" }, children: NAMESPACES.filter((ns) => !ns.protected).map((ns) => h("option", { value: ns.id, children: ns.name }, ns.id)) }),
          h("input", { type: "text", value: newTagValue, onChange: (e) => setNewTagValue(e.target.value), placeholder: "Tag value...", style: { flex: 1, padding: "8px 12px", border: "1px solid #e5e7eb", borderRadius: "6px", fontSize: "11px" } }),
          h("button", { onClick: () => {
            if (newTagValue.trim()) {
              applyTemplate(newTagNs, newTagValue.trim());
              setNewTagValue("");
            }
          }, className: "btn btn-primary btn-sm", children: "Apply" })
        ] })
      ] }),
      h("div", { className: "modal-footer", style: { borderTop: "1px solid #e5e7eb" }, children: [
        h("span", { style: { fontSize: "10px", color: "#9ca3af" }, children: [
          "Tags follow THEMIS format: THEMIS:",
          "{namespace}",
          ":",
          "{value}"
        ] }),
        h("button", { className: "btn btn-secondary", onClick: closeModal, children: "Close" })
      ] })
    ] }) });
  };
  var FileManagerModal = () => {
    const {
      activeModal,
      closeModal,
      currentVault,
      currentCase,
      evidence,
      uploadQueue,
      toggleEvidence,
      toggleSelectAllEvidence,
      queueFilesForUpload,
      cancelUpload,
      completeUpload,
      updateUploadProgress,
      removeEvidence,
      addTag,
      removeTag,
      setValidation,
      bulkAddTag,
      moveToFolder,
      addNotification,
      openPreview
    } = useApp();
    const [view, setView] = useState("list");
    const [searchQuery, setSearchQuery] = useState("");
    const [filterType, setFilterType] = useState("all");
    const [filterValidation, setFilterValidation] = useState("all");
    const [filterPhase, setFilterPhase] = useState("all");
    const [sortBy, setSortBy] = useState("date");
    const [sortOrder, setSortOrder] = useState("desc");
    const [showTagPanel, setShowTagPanel] = useState(false);
    const [selectedFileForTags, setSelectedFileForTags] = useState(null);
    const [showUploadZone, setShowUploadZone] = useState(false);
    const [dragOver, setDragOver] = useState(false);
    const fileInputRef = React.useRef(null);
    if (activeModal !== "file-manager") return null;
    const TAG_COLORS = {
      case: "#3b82f6",
      type: "#8b5cf6",
      fw: "#22c55e",
      valid: "#eab308",
      folder: "#6b7280",
      conv: "#f97316",
      meth: "#06b6d4",
      phase: "#ec4899",
      search: "#a1a1aa"
    };
    const VALIDATION_COLORS = {
      confirmed: "#22c55e",
      pending: "#eab308",
      rejected: "#ef4444"
    };
    const TYPE_ICONS = {
      pdf: { icon: "", color: "#ef4444" },
      docx: { icon: "", color: "#3b82f6" },
      xlsx: { icon: "", color: "#22c55e" },
      msg: { icon: "", color: "#f59e0b" },
      mpp: { icon: "...", color: "#8b5cf6" },
      png: { icon: "-", color: "#06b6d4" },
      jpg: { icon: "-", color: "#06b6d4" }
    };
    const formatSize = (bytes) => {
      if (bytes < 1024) return bytes + " B";
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + " KB";
      return (bytes / (1024 * 1024)).toFixed(1) + " MB";
    };
    const getTagColor = (tag) => {
      const ns = tag.split(":")[1];
      return TAG_COLORS[ns] || "#6b7280";
    };
    const getTagValue = (tag) => tag.split(":").slice(-1)[0];
    const getTypeInfo = (type) => TYPE_ICONS[type] || { icon: "", color: "#6b7280" };
    const selectedIds = evidence.filter((e) => e.selected).map((e) => e.id);
    const filteredEvidence = evidence.filter((e) => filterType === "all" || e.type === filterType).filter((e) => filterValidation === "all" || e.validation === filterValidation).filter((e) => {
      if (filterPhase === "all") return true;
      return e.tags.some((t) => t === `THEMIS:phase:${filterPhase}`);
    }).filter((e) => {
      if (!searchQuery) return true;
      const q = searchQuery.toLowerCase();
      return e.name.toLowerCase().includes(q) || e.tags.some((t) => t.toLowerCase().includes(q));
    }).sort((a, b) => {
      let cmp = 0;
      if (sortBy === "name") cmp = a.name.localeCompare(b.name);
      else if (sortBy === "date") cmp = a.date.localeCompare(b.date);
      else if (sortBy === "size") cmp = a.size - b.size;
      else if (sortBy === "type") cmp = a.type.localeCompare(b.type);
      else if (sortBy === "validation") cmp = (a.validation || "").localeCompare(b.validation || "");
      return sortOrder === "asc" ? cmp : -cmp;
    });
    const handleDragOver = (e) => {
      e.preventDefault();
      setDragOver(true);
    };
    const handleDragLeave = () => setDragOver(false);
    const handleDrop = (e) => {
      e.preventDefault();
      setDragOver(false);
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleFilesSelected(files);
      }
    };
    const handleFilesSelected = (files) => {
      queueFilesForUpload(files);
      setShowUploadZone(true);
      addNotification("info", `${files.length} file(s) queued for Zero Trust validation`);
      Array.from(files).forEach((file, i) => {
        const fileId = `upload-${Date.now()}-${i}`;
        setTimeout(() => simulateUpload(fileId, file), 500 + i * 200);
      });
    };
    const simulateUpload = (fileId, file) => {
      let progress = 0;
      const interval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress < 30) {
          updateUploadProgress(fileId, Math.min(progress, 30), "validating");
        } else if (progress < 70) {
          updateUploadProgress(fileId, Math.min(progress, 70), "validated");
        } else if (progress < 100) {
          updateUploadProgress(fileId, Math.min(progress, 95), "migrating");
        } else {
          clearInterval(interval);
          const newEvidence = {
            id: `EV-${String(Date.now()).slice(-6)}`,
            name: file.name,
            type: file.name.split(".").pop().toLowerCase(),
            size: file.size,
            date: (/* @__PURE__ */ new Date()).toISOString().split("T")[0],
            folder: "con",
            selected: false,
            pages: null,
            tags: [
              `THEMIS:case:${currentCase.id}`,
              "THEMIS:valid:pending",
              `THEMIS:fw:${currentCase.framework}`
            ],
            validation: "pending",
            preview: null
          };
          completeUpload(fileId, newEvidence);
          addNotification("success", `${file.name} imported to vault`);
        }
      }, 300);
    };
    const handleRemoveSelected = () => {
      if (selectedIds.length === 0) return;
      removeEvidence(selectedIds);
      addNotification("success", `${selectedIds.length} file(s) removed from vault`);
    };
    const handleBulkValidation = (status) => {
      selectedIds.forEach((id) => setValidation(id, status));
      addNotification("success", `${selectedIds.length} file(s) marked as ${status}`);
    };
    const TagPanel = ({ fileId, onClose }) => {
      const [newTagNs, setNewTagNs] = useState("type");
      const [newTagValue, setNewTagValue] = useState("");
      const file = evidence.find((e) => e.id === fileId);
      if (!file) return null;
      const handleAddTag = () => {
        if (!newTagValue.trim()) return;
        const tag = `THEMIS:${newTagNs}:${newTagValue.trim()}`;
        addTag(file.id, tag);
        setNewTagValue("");
        addNotification("success", "Tag added");
      };
      const handleRemoveTag = (tag) => {
        removeTag(file.id, tag);
        addNotification("info", "Tag removed");
      };
      return h("div", { style: { position: "absolute", top: 0, right: 0, width: "320px", height: "100%", background: "white", borderLeft: "1px solid #e5e7eb", display: "flex", flexDirection: "column", zIndex: 10 }, children: [
        h("div", { style: { padding: "16px", borderBottom: "1px solid #e5e7eb" }, children: [
          h("div", { style: { display: "flex", justifyContent: "space-between", alignItems: "center" }, children: [
            h("span", { style: { fontWeight: 600 }, children: "Evidence Tags" }),
            h("button", { onClick: onClose, style: { background: "none", border: "none", fontSize: "18px", cursor: "pointer", color: "#6b7280" }, children: "-" })
          ] }),
          h("div", { style: { fontSize: "12px", color: "#6b7280", marginTop: "4px" }, children: file.name }),
          h("div", { style: { fontSize: "11px", color: "#9ca3af" }, children: [
            file.id,
            " * ",
            formatSize(file.size)
          ] })
        ] }),
        h("div", { style: { flex: 1, overflow: "auto", padding: "16px" }, children: [
          h("div", { style: { marginBottom: "20px" }, children: [
            h("div", { style: { fontSize: "11px", fontWeight: 600, color: "#6b7280", marginBottom: "8px" }, children: "VALIDATION STATUS" }),
            h("div", { style: { display: "flex", gap: "6px" }, children: ["pending", "confirmed", "rejected"].map((status) => h(
              "button",
              {
                onClick: () => {
                  setValidation(file.id, status);
                  addNotification("success", `Validation: ${status}`);
                },
                style: {
                  flex: 1,
                  padding: "8px 4px",
                  borderRadius: "6px",
                  fontSize: "10px",
                  fontWeight: 600,
                  cursor: "pointer",
                  textTransform: "uppercase",
                  border: "none",
                  background: file.validation === status ? VALIDATION_COLORS[status] : "#f3f4f6",
                  color: file.validation === status ? "white" : "#6b7280"
                },
                children: status
              },
              status
            )) })
          ] }),
          h("div", { style: { marginBottom: "20px", padding: "12px", background: "linear-gradient(180deg, #f5f5f5 0%, #e8e8e8 100%)", borderRadius: "8px", border: "1px solid #d1d1d1" }, children: [
            h("div", { style: { fontSize: "10px", color: "#666", marginBottom: "6px", fontWeight: 500 }, children: "FINDER PREVIEW" }),
            h("div", { style: { display: "flex", flexWrap: "wrap", gap: "4px" }, children: file.tags.map((tag) => {
              const color = getTagColor(tag);
              return h("span", { style: {
                display: "inline-flex",
                alignItems: "center",
                gap: "4px",
                padding: "3px 8px",
                borderRadius: "10px",
                fontSize: "10px",
                background: `${color}22`,
                border: `1px solid ${color}44`,
                color
              }, children: [
                h("span", { style: { width: "8px", height: "8px", borderRadius: "50%", background: color } }),
                getTagValue(tag)
              ] }, tag);
            }) })
          ] }),
          h("div", { style: { marginBottom: "20px" }, children: [
            h("div", { style: { fontSize: "11px", fontWeight: 600, color: "#6b7280", marginBottom: "8px" }, children: [
              "THEMIS TAGS (",
              file.tags.length,
              ")"
            ] }),
            h("div", { style: { display: "flex", flexDirection: "column", gap: "6px" }, children: file.tags.map((tag) => h("div", { style: { display: "flex", alignItems: "center", gap: "8px", padding: "8px 10px", background: "#f9fafb", borderRadius: "6px", fontSize: "11px" }, children: [
              h("span", { style: { width: "10px", height: "10px", borderRadius: "50%", background: getTagColor(tag), flexShrink: 0 } }),
              h("span", { style: { flex: 1, fontFamily: "monospace", wordBreak: "break-all", fontSize: "10px" }, children: tag }),
              !tag.includes(":case:") && h("button", { onClick: () => handleRemoveTag(tag), style: { background: "none", border: "none", color: "#9ca3af", cursor: "pointer", fontSize: "14px" }, children: "-" })
            ] }, tag)) })
          ] }),
          h("div", { children: [
            h("div", { style: { fontSize: "11px", fontWeight: 600, color: "#6b7280", marginBottom: "8px" }, children: "ADD TAG" }),
            h("div", { style: { display: "flex", gap: "8px", marginBottom: "8px" }, children: [
              h("select", { value: newTagNs, onChange: (e) => setNewTagNs(e.target.value), style: { padding: "8px", border: "1px solid #e5e7eb", borderRadius: "6px", fontSize: "11px", background: "white" }, children: [
                h("option", { value: "type", children: "type" }),
                h("option", { value: "folder", children: "folder" }),
                h("option", { value: "phase", children: "phase" }),
                h("option", { value: "conv", children: "conv" }),
                h("option", { value: "fw", children: "fw (framework)" }),
                h("option", { value: "meth", children: "meth (methodology)" })
              ] }),
              h(
                "input",
                {
                  type: "text",
                  value: newTagValue,
                  onChange: (e) => setNewTagValue(e.target.value),
                  onKeyPress: (e) => e.key === "Enter" && handleAddTag(),
                  placeholder: "Value...",
                  style: { flex: 1, padding: "8px", border: "1px solid #e5e7eb", borderRadius: "6px", fontSize: "11px" }
                }
              )
            ] }),
            h("button", { onClick: handleAddTag, className: "btn btn-primary btn-sm", style: { width: "100%" }, children: "Add Tag" })
          ] })
        ] }),
        h("div", { style: { padding: "12px 16px", borderTop: "1px solid #e5e7eb", background: "#fafafa" }, children: h("button", { className: "btn btn-ghost btn-sm", style: { width: "100%" }, children: "Preview Document" }) })
      ] });
    };
    const UploadQueue = () => {
      if (uploadQueue.length === 0) return null;
      const statusLabels = {
        pending: "Queued",
        validating: "Zero Trust Check...",
        validated: "Validated [ok]",
        migrating: "Migrating to Vault...",
        complete: "Complete",
        error: "Error"
      };
      return h("div", { style: { borderBottom: "1px solid #e5e7eb", background: "#fefce8", padding: "12px 16px" }, children: [
        h("div", { style: { fontSize: "11px", fontWeight: 600, marginBottom: "8px", color: "#854d0e" }, children: [
          "UPLOAD QUEUE (",
          uploadQueue.length,
          ")"
        ] }),
        uploadQueue.map((file) => h("div", { style: { display: "flex", alignItems: "center", gap: "12px", padding: "8px 0", borderBottom: "1px solid #fef08a" }, children: [
          h("span", { style: { fontSize: "16px" }, children: getTypeInfo(file.type).icon }),
          h("div", { style: { flex: 1, minWidth: 0 }, children: [
            h("div", { style: { fontSize: "12px", fontWeight: 500, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }, children: file.name }),
            h("div", { style: { fontSize: "10px", color: "#854d0e" }, children: [
              statusLabels[file.status],
              " * ",
              Math.round(file.progress),
              "%"
            ] }),
            h("div", { style: { height: "3px", background: "#fef08a", borderRadius: "2px", marginTop: "4px" }, children: h("div", { style: { height: "100%", width: `${file.progress}%`, background: file.status === "error" ? "#ef4444" : "#22c55e", borderRadius: "2px", transition: "width 0.3s" } }) })
          ] }),
          h("button", { onClick: () => cancelUpload(file.id), style: { background: "none", border: "none", color: "#9ca3af", cursor: "pointer" }, children: "-" })
        ] }, file.id))
      ] });
    };
    return h("div", { className: "modal-overlay open", onClick: closeModal, children: h("div", { className: "modal", style: { width: "1000px", maxWidth: "95vw", height: "700px", maxHeight: "90vh", display: "flex", flexDirection: "column" }, onClick: (e) => e.stopPropagation(), children: [
      h("div", { className: "modal-header", style: { borderBottom: "1px solid #e5e7eb", flexShrink: 0 }, children: [
        h("div", { style: { display: "flex", alignItems: "center", gap: "12px" }, children: [
          h("span", { className: "modal-title", children: "File Manager" }),
          h("span", { style: { padding: "4px 10px", background: "#eff6ff", color: "#2563eb", fontSize: "11px", fontWeight: 600, borderRadius: "6px" }, children: currentVault.name }),
          h("span", { style: { padding: "4px 10px", background: "#f3f4f6", color: "#6b7280", fontSize: "11px", borderRadius: "6px" }, children: currentCase.id })
        ] }),
        h("button", { className: "modal-close", onClick: closeModal, children: "x" })
      ] }),
      h("div", { style: { display: "flex", alignItems: "center", gap: "8px", padding: "10px 16px", borderBottom: "1px solid #f3f4f6", background: "#fafafa", flexShrink: 0, flexWrap: "wrap" }, children: [
        h("button", { className: "btn btn-primary btn-sm", onClick: () => fileInputRef.current?.click(), children: "+ Import Files" }),
        h("input", { ref: fileInputRef, type: "file", multiple: true, hidden: true, onChange: (e) => handleFilesSelected(e.target.files) }),
        h("button", { className: "btn btn-secondary btn-sm", onClick: handleRemoveSelected, disabled: selectedIds.length === 0, children: [
          "Remove (",
          selectedIds.length,
          ")"
        ] }),
        selectedIds.length > 0 && h(React.Fragment, { children: [
          h("div", { style: { width: "1px", height: "20px", background: "#e5e7eb" } }),
          h("span", { style: { fontSize: "11px", color: "#6b7280" }, children: "Bulk:" }),
          h("button", { className: "btn btn-sm", style: { background: "#d1fae5", color: "#065f46" }, onClick: () => handleBulkValidation("confirmed"), children: "[ok] Confirm" }),
          h("button", { className: "btn btn-sm", style: { background: "#fee2e2", color: "#991b1b" }, onClick: () => handleBulkValidation("rejected"), children: "- Reject" })
        ] }),
        h("div", { style: { flex: 1 } }),
        h(
          "input",
          {
            type: "text",
            placeholder: "Search files or tags...",
            value: searchQuery,
            onChange: (e) => setSearchQuery(e.target.value),
            style: { width: "200px", padding: "6px 10px", border: "1px solid #e5e7eb", borderRadius: "6px", fontSize: "11px" }
          }
        ),
        h("select", { value: filterType, onChange: (e) => setFilterType(e.target.value), style: { padding: "6px", border: "1px solid #e5e7eb", borderRadius: "6px", fontSize: "11px" }, children: [
          h("option", { value: "all", children: "All Types" }),
          h("option", { value: "pdf", children: "PDF" }),
          h("option", { value: "docx", children: "Word" }),
          h("option", { value: "xlsx", children: "Excel" }),
          h("option", { value: "msg", children: "Email" })
        ] }),
        h("select", { value: filterValidation, onChange: (e) => setFilterValidation(e.target.value), style: { padding: "6px", border: "1px solid #e5e7eb", borderRadius: "6px", fontSize: "11px" }, children: [
          h("option", { value: "all", children: "All Status" }),
          h("option", { value: "pending", children: " Pending" }),
          h("option", { value: "confirmed", children: "[ok] Confirmed" }),
          h("option", { value: "rejected", children: "- Rejected" })
        ] }),
        h("select", { value: filterPhase, onChange: (e) => setFilterPhase(e.target.value), style: { padding: "6px", border: "1px solid #e5e7eb", borderRadius: "6px", fontSize: "11px" }, children: [
          h("option", { value: "all", children: "All Phases" }),
          h("option", { value: "pre-contract", children: "Pre-Contract" }),
          h("option", { value: "construction", children: "Construction" }),
          h("option", { value: "post-contract", children: "Post-Contract" }),
          h("option", { value: "dispute", children: "Dispute" })
        ] }),
        h("select", { value: `${sortBy}-${sortOrder}`, onChange: (e) => {
          const [by, ord] = e.target.value.split("-");
          setSortBy(by);
          setSortOrder(ord);
        }, style: { padding: "6px", border: "1px solid #e5e7eb", borderRadius: "6px", fontSize: "11px" }, children: [
          h("option", { value: "date-desc", children: "Newest First" }),
          h("option", { value: "date-asc", children: "Oldest First" }),
          h("option", { value: "name-asc", children: "Name A-Z" }),
          h("option", { value: "name-desc", children: "Name Z-A" }),
          h("option", { value: "size-desc", children: "Largest" }),
          h("option", { value: "size-asc", children: "Smallest" })
        ] }),
        h("div", { style: { display: "flex", border: "1px solid #e5e7eb", borderRadius: "6px", overflow: "hidden" }, children: [
          h("button", { onClick: () => setView("list"), style: { padding: "6px 10px", background: view === "list" ? "#eff6ff" : "white", border: "none", cursor: "pointer", fontSize: "12px" } }),
          h("button", { onClick: () => setView("grid"), style: { padding: "6px 10px", background: view === "grid" ? "#eff6ff" : "white", border: "none", cursor: "pointer", fontSize: "12px" }, children: "-" })
        ] })
      ] }),
      h(UploadQueue, {}),
      dragOver && h("div", { style: { position: "absolute", inset: 0, background: "rgba(59, 130, 246, 0.1)", border: "3px dashed #3b82f6", borderRadius: "12px", display: "flex", alignItems: "center", justifyContent: "center", zIndex: 100 }, children: h("div", { style: { textAlign: "center" }, children: [
        h("div", { style: { fontSize: "48px", marginBottom: "12px" } }),
        h("div", { style: { fontSize: "18px", fontWeight: 600, color: "#2563eb" }, children: "Drop files to import" }),
        h("div", { style: { fontSize: "12px", color: "#6b7280" }, children: "Zero Trust validation will be applied" })
      ] }) }),
      h(
        "div",
        {
          className: "modal-body",
          style: { flex: 1, overflow: "auto", padding: 0, position: "relative" },
          onDragOver: handleDragOver,
          onDragLeave: handleDragLeave,
          onDrop: handleDrop,
          children: [
            view === "list" ? h("table", { style: { width: "100%", borderCollapse: "collapse", fontSize: "12px" }, children: [
              h("thead", { children: h("tr", { style: { background: "#f9fafb", position: "sticky", top: 0 }, children: [
                h("th", { style: { padding: "10px 16px", textAlign: "left", fontWeight: 600, width: "40px" }, children: h("input", { type: "checkbox", checked: selectedIds.length === filteredEvidence.length && filteredEvidence.length > 0, onChange: toggleSelectAllEvidence }) }),
                h("th", { style: { padding: "10px 8px", textAlign: "left", fontWeight: 600 }, children: "Name" }),
                h("th", { style: { padding: "10px 8px", textAlign: "left", fontWeight: 600, width: "70px" }, children: "Type" }),
                h("th", { style: { padding: "10px 8px", textAlign: "left", fontWeight: 600, width: "80px" }, children: "Size" }),
                h("th", { style: { padding: "10px 8px", textAlign: "left", fontWeight: 600, width: "90px" }, children: "Date" }),
                h("th", { style: { padding: "10px 8px", textAlign: "left", fontWeight: 600 }, children: "Tags" }),
                h("th", { style: { padding: "10px 8px", textAlign: "center", fontWeight: 600, width: "70px" }, children: "Status" }),
                h("th", { style: { padding: "10px 16px", width: "50px" } })
              ] }) }),
              h("tbody", { children: filteredEvidence.map((file) => h(
                "tr",
                {
                  style: { borderBottom: "1px solid #f3f4f6", background: file.selected ? "#eff6ff" : "white", cursor: "pointer" },
                  onDoubleClick: () => openPreview(file.id),
                  title: "Double-click to preview",
                  children: [
                    h("td", { style: { padding: "10px 16px" }, children: h("input", { type: "checkbox", checked: file.selected, onChange: () => toggleEvidence(file.id) }) }),
                    h("td", { style: { padding: "10px 8px" }, children: h("div", { style: { display: "flex", alignItems: "center", gap: "8px" }, children: [
                      h("span", { style: { fontSize: "16px" }, children: getTypeInfo(file.type).icon }),
                      h("div", { children: [
                        h("div", { style: { fontWeight: 500 }, children: file.name }),
                        h("div", { style: { fontSize: "10px", color: "#9ca3af" }, children: file.id })
                      ] })
                    ] }) }),
                    h("td", { style: { padding: "10px 8px", textTransform: "uppercase", color: "#6b7280", fontSize: "10px", fontWeight: 600 }, children: file.type }),
                    h("td", { style: { padding: "10px 8px", color: "#6b7280" }, children: formatSize(file.size) }),
                    h("td", { style: { padding: "10px 8px", color: "#6b7280" }, children: file.date }),
                    h("td", { style: { padding: "10px 8px" }, children: h("div", { style: { display: "flex", gap: "4px", flexWrap: "wrap" }, children: [
                      file.tags.filter((t) => !t.includes(":valid:") && !t.includes(":case:")).slice(0, 3).map((tag) => h("span", { style: { padding: "2px 6px", background: "#f3f4f6", borderRadius: "3px", fontSize: "9px", fontFamily: "monospace" }, children: [
                        h("span", { style: { color: getTagColor(tag) }, children: "-" }),
                        " ",
                        getTagValue(tag)
                      ] }, tag)),
                      file.tags.length > 3 && h("span", { style: { fontSize: "9px", color: "#9ca3af" }, children: [
                        "+",
                        file.tags.length - 3
                      ] })
                    ] }) }),
                    h("td", { style: { padding: "10px 8px", textAlign: "center" }, children: h("span", { style: {
                      display: "inline-block",
                      padding: "3px 8px",
                      borderRadius: "12px",
                      fontSize: "9px",
                      fontWeight: 600,
                      textTransform: "uppercase",
                      background: file.validation === "confirmed" ? "#d1fae5" : file.validation === "rejected" ? "#fee2e2" : "#fef9c3",
                      color: file.validation === "confirmed" ? "#065f46" : file.validation === "rejected" ? "#991b1b" : "#854d0e"
                    }, children: file.validation }) }),
                    h("td", { style: { padding: "10px 16px" }, children: h("button", { onClick: () => {
                      setSelectedFileForTags(file);
                      setShowTagPanel(true);
                    }, style: { background: "none", border: "1px solid #e5e7eb", borderRadius: "4px", padding: "4px 8px", fontSize: "10px", cursor: "pointer" }, children: "Tags" }) })
                  ]
                },
                file.id
              )) })
            ] }) : h("div", { style: { display: "grid", gridTemplateColumns: "repeat(auto-fill, minmax(160px, 1fr))", gap: "12px", padding: "16px" }, children: filteredEvidence.map((file) => h(
              "div",
              {
                onClick: () => toggleEvidence(file.id),
                onDoubleClick: () => openPreview(file.id),
                style: {
                  padding: "12px",
                  border: file.selected ? "2px solid #3b82f6" : "1px solid #e5e7eb",
                  borderRadius: "10px",
                  cursor: "pointer",
                  background: file.selected ? "#eff6ff" : "white",
                  position: "relative"
                },
                title: "Double-click to preview",
                children: [
                  h("div", { style: { position: "absolute", top: "8px", right: "8px", width: "10px", height: "10px", borderRadius: "50%", background: VALIDATION_COLORS[file.validation] } }),
                  h("div", { style: { fontSize: "36px", textAlign: "center", marginBottom: "8px" }, children: getTypeInfo(file.type).icon }),
                  h("div", { style: { fontSize: "11px", fontWeight: 500, textAlign: "center", marginBottom: "2px", overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }, children: file.name }),
                  h("div", { style: { fontSize: "10px", color: "#6b7280", textAlign: "center", marginBottom: "8px" }, children: formatSize(file.size) }),
                  h("div", { style: { display: "flex", justifyContent: "center" }, children: h("button", { onClick: (e) => {
                    e.stopPropagation();
                    setSelectedFileForTags(file);
                    setShowTagPanel(true);
                  }, style: { fontSize: "10px", color: "#3b82f6", background: "none", border: "none", cursor: "pointer" }, children: [
                    file.tags.length,
                    " tags"
                  ] }) })
                ]
              },
              file.id
            )) }),
            filteredEvidence.length === 0 && h("div", { style: { padding: "60px 20px", textAlign: "center", color: "#9ca3af" }, children: [
              h("div", { style: { fontSize: "48px", marginBottom: "12px" } }),
              h("div", { style: { fontSize: "14px", fontWeight: 500 }, children: "No files match your filters" }),
              h("div", { style: { fontSize: "12px" }, children: "Try adjusting your search or filters" })
            ] }),
            showTagPanel && selectedFileForTags && h(TagPanel, { fileId: selectedFileForTags?.id, onClose: () => setShowTagPanel(false) })
          ]
        }
      ),
      h("div", { className: "modal-footer", style: { borderTop: "1px solid #e5e7eb", flexShrink: 0 }, children: [
        h("div", { style: { flex: 1, fontSize: "11px", color: "#6b7280" }, children: [
          filteredEvidence.length,
          " files * ",
          formatSize(filteredEvidence.reduce((sum, f) => sum + f.size, 0)),
          " total",
          selectedIds.length > 0 && h("span", { style: { marginLeft: "12px", color: "#2563eb", fontWeight: 500 }, children: [
            selectedIds.length,
            " selected"
          ] })
        ] }),
        h("button", { className: "btn btn-secondary", onClick: closeModal, children: "Close" })
      ] }),
      h("div", { className: "modal-copyright", children: "T H E M i S - QS   (c) 2026" })
    ] }) });
  };
  var ProgressBar = ({ active }) => h("div", { className: `page-progress ${active ? "active" : ""}`, children: h("div", { className: "page-progress-bar" }) });
  var NotificationBanner = () => {
    const { banner, dismissBanner, backendConnected, openModal, updateInfo, installUpdate } = useApp();
    const [installing, setInstalling] = useState(false);
    
    const handleBannerAction = async () => {
      if (banner.action === "Install Update" && updateInfo.update_available) {
        setInstalling(true);
        await installUpdate();
        setInstalling(false);
      } else if (banner.action === "Release Notes") {
        openModal("release-notes");
      } else if (banner.action) {
        openModal("dashboard");
      }
    };
    
    if (!backendConnected) {
      return h("div", { className: "notification-banner warning show", children: [
        h("div", { className: "banner-icon", children: "!" }),
        h("span", { className: "banner-text", children: "Backend Offline - Service unavailable" }),
        h("button", { className: "banner-action", onClick: () => openModal("dashboard"), style: { background: "#fff", color: "#92400e", fontWeight: 600 }, children: "Service Dashboard" })
      ] });
    }
    if (!banner.show) return null;
    return h("div", { className: `notification-banner ${banner.type} show`, children: [
      h("div", { className: "banner-icon", children: banner.type === "success" ? "[ok]" : banner.type === "warning" ? "üÜï" : "i" }),
      h("span", { className: "banner-text", children: banner.message }),
      banner.action && h("button", { className: "banner-action", onClick: handleBannerAction, disabled: installing, style: installing ? { opacity: 0.7 } : {}, children: installing ? "‚öôÔ∏è Installing..." : banner.action }),
      h("button", { className: "banner-dismiss", onClick: dismissBanner, children: "x" })
    ] });
  };
  var NotificationCenter = () => {
    const { notifications, dismissNotification } = useApp();
    return h("div", { className: "notification-center", children: notifications.map((n) => h("div", { className: `notification-item ${n.type} show`, children: [
      h("div", { className: "notification-icon", children: n.type === "success" ? "\u2713" : n.type === "error" ? "!" : n.type === "warning" ? "\u26A0" : "i" }),
      h("span", { className: "notification-text", children: n.message }),
      h("button", { className: "notification-close", onClick: () => dismissNotification(n.id), children: "\xD7" })
    ] }, n.id)) });
  };
  var Header = () => {
    const { currentCase, cases, currentBrand, caseDropdownOpen, settingsDropdownOpen, brandDropdownOpen, toggleCaseDropdown, toggleSettingsDropdown, toggleBrandDropdown, selectCase, selectBrand, openModal, theme, toggleTheme, closeDropdowns, backendConnected, wsConnected } = useApp();
    return h("header", { className: "header", children: [
      h("div", { className: "header-left", children: [
        h("div", { className: "dropdown", children: [
          h("div", { className: "logo", onClick: toggleBrandDropdown, style: { background: currentBrand.color, cursor: "pointer" }, title: "Select Brand" }),
          brandDropdownOpen && h("div", { className: "dropdown-menu show", style: { minWidth: "240px" }, children: [
            h("div", { className: "dropdown-header", children: "Select Brand" }),
            BRANDS.map((b) => h("div", { className: `brand-item ${currentBrand.id === b.id ? "selected" : ""}`, onClick: () => selectBrand(b), style: { display: "flex", alignItems: "center", gap: "12px", padding: "10px 14px", cursor: "pointer" }, children: [
              h("div", { style: { width: "32px", height: "32px", borderRadius: "6px", background: b.color } }),
              h("div", { children: [
                h("div", { style: { fontSize: "13px", fontWeight: 600 }, children: b.name }),
                h("div", { style: { fontSize: "11px", color: "#6b7280" }, children: b.desc })
              ] })
            ] }, b.id))
          ] })
        ] }),
        h("span", { className: "brand", children: [
          "T H E M ",
          h("strong", { children: "i" }),
          " S - QS"
        ] }),
        h("div", { style: { display: "flex", alignItems: "center", gap: "6px", marginLeft: "12px", padding: "4px 10px", background: backendConnected ? "#f0fdf4" : "#fef3c7", borderRadius: "12px", fontSize: "10px" }, children: [
          h("span", { style: { width: "6px", height: "6px", borderRadius: "50%", background: backendConnected ? "#22c55e" : "#f59e0b" } }),
          h("span", { style: { color: backendConnected ? "#166534" : "#92400e", fontWeight: 500 }, children: backendConnected ? "API" : "Offline" }),
          wsConnected && h("span", { style: { color: "#3b82f6", fontWeight: 500 }, children: "+ WS" })
        ] })
      ] }),
      h("div", { className: "header-center", children: h("div", { className: "dropdown", children: [
        h("button", { className: "case-selector", onClick: toggleCaseDropdown, children: [
          h("span", { className: "case-name", children: currentCase.name }),
          h("span", { className: "case-id-badge", children: currentCase.id }),
          h("span", { className: "case-arrow", children: "-" })
        ] }),
        caseDropdownOpen && h("div", { className: "dropdown-menu show", children: [
          h("div", { className: "dropdown-search", children: h("input", { type: "text", className: "dropdown-search-input", placeholder: "Search cases..." }) }),
          h("div", { className: "dropdown-header", children: "Recent Cases" }),
          cases.map((c) => h("div", { className: "case-item", onClick: () => selectCase(c), children: [
            h("span", { className: "case-item-name", children: c.name }),
            h("span", { className: `framework-badge ${c.framework.toLowerCase()}`, children: c.framework }),
            h("span", { className: "case-id-badge", children: c.id })
          ] }, c.id))
        ] })
      ] }) }),
      h("div", { className: "header-right", children: [
        h("button", { className: "header-btn", title: "Time Tracker", onClick: () => openModal("time-tracker"), children: h(Icons.Clock, {}) }),
        h("button", { className: "header-btn", title: "Share Case", children: h(Icons.Share, {}) }),
        h("div", { className: "dropdown", children: [
          h("button", { className: "avatar-btn", onClick: toggleSettingsDropdown, children: h("span", { className: "avatar-initials", children: "PH" }) }),
          settingsDropdownOpen && h("div", { className: "dropdown-menu settings-dropdown show", children: [
            h("div", { className: "dropdown-header", children: "Settings" }),
            h("div", { className: "settings-item", onClick: () => openModal("dashboard"), children: [
              h("span", { className: "settings-icon", children: h(Icons.Circle, {}) }),
              h("span", { className: "settings-label", children: "Services Dashboard" })
            ] }),
            h("div", { className: "settings-item", onClick: () => openModal("constraints"), children: [
              h("span", { className: "settings-icon", children: h(Icons.Settings, {}) }),
              h("span", { className: "settings-label", children: "Case Constraints" })
            ] }),
            h("div", { className: "settings-item", onClick: () => openModal("tag-manager"), children: [
              h("span", { className: "settings-icon", children: h(Icons.Hash, {}) }),
              h("span", { className: "settings-label", children: "Tag Manager" })
            ] }),
            h("div", { className: "settings-item", onClick: () => openModal("time-tracker"), children: [
              h("span", { className: "settings-icon", children: h(Icons.Clock, {}) }),
              h("span", { className: "settings-label", children: "Time Tracker" })
            ] }),
            h("div", { className: "settings-item", onClick: toggleTheme, children: [
              h("span", { className: "settings-icon", children: h(Icons.Moon, {}) }),
              h("span", { className: "settings-label", children: "Dark Mode" }),
              h("span", { className: "settings-toggle", children: theme === "dark" ? "ON" : "OFF" })
            ] }),
            h("div", { className: "settings-divider" }),
            h("div", { className: "settings-item", onClick: () => {
              closeDropdowns();
            }, children: [
              h("span", { className: "settings-icon", children: h(Icons.Power, {}) }),
              h("span", { className: "settings-label", children: "Sign Out" })
            ] })
          ] })
        ] })
      ] })
    ] });
  };
  var LeftPane = () => {
    const { leftCollapsed, toggleLeft, currentVault, currentCase, vaults, vaultDropdownOpen, toggleVaultDropdown, selectVault, expandedFolders, toggleFolder, expandedPhases, togglePhase, folders, folderPhases, documents, toggleDoc, openModal, evidence, mode, toggleEvidence, showEvidenceIds } = useApp();
    const selectedEvidence = evidence.filter((e) => e.selected);
    const getFolderCount = (folder) => {
      if (folder.count > 0) return folder.count;
      return evidence.filter((e) => {
        const folderTag = (e.tags || []).find((t) => t.startsWith("THEMIS:folder:"));
        if (folderTag) {
          const tagPath = folderTag.replace("THEMIS:folder:", "");
          return folder.path && (tagPath.includes(folder.name) || folder.path.includes(tagPath));
        }
        return false;
      }).length;
    };
    if (leftCollapsed) {
      return h("aside", { className: "pane pane-left collapsed", children: [
        h("div", { className: "pane-header pane-header-collapsed", children: h("button", { className: "collapse-btn", onClick: toggleLeft, children: h(Icons.ChevronRight, {}) }) }),
        h("div", { className: "pane-content collapsed-icons", children: [
          selectedEvidence.length > 0 && h("div", { className: "mini-icon", title: `${selectedEvidence.length} selected`, style: { background: "#3b82f6", color: "white", fontWeight: 700 }, children: selectedEvidence.length }),
          folderPhases.slice(0, selectedEvidence.length > 0 ? 5 : 6).map((p) => h("div", { className: "mini-icon blue", title: p.name, onClick: toggleLeft, children: p.number }, p.number))
        ] })
      ] });
    }
    return h("aside", { className: "pane pane-left", children: [
      h("div", { className: "pane-header", children: [
        h("button", { className: "collapse-btn collapse-btn-edge-left", onClick: toggleLeft, children: h(Icons.ChevronLeft, {}) }),
        h("div", { className: "pane-header-center", children: h("div", { className: "dropdown", children: [
          h("button", { className: "vault-selector", onClick: toggleVaultDropdown, children: [
            h("span", { className: "pane-title", children: currentVault.name }),
            h("span", { className: "vault-badge", children: currentVault.id }),
            h("span", { className: "vault-arrow", children: "-" })
          ] }),
          vaultDropdownOpen && h("div", { className: "dropdown-menu show", children: [
            h("div", { className: "dropdown-search", children: h("input", { type: "text", className: "dropdown-search-input", placeholder: "Search vaults..." }) }),
            h("div", { className: "dropdown-header", children: "Case Vaults" }),
            vaults.map((v) => h("div", { className: `vault-item ${v.id === currentVault.id ? "selected" : ""}`, onClick: () => selectVault(v), children: [
              h("span", { className: "vault-item-name", children: v.name }),
              h("span", { className: "vault-item-meta", children: [
                v.files,
                " files"
              ] }),
              h("span", { className: "vault-item-badge", children: v.id })
            ] }, v.id)),
            h("div", { className: "dropdown-footer", children: [
              h("button", { className: "dropdown-action-btn", onClick: () => openModal("file-manager"), children: [
                h("span", { className: "dropdown-action-icon" }),
                h("span", { children: "File Manager" })
              ] }),
              h("button", { className: "dropdown-action-btn", onClick: () => openModal("create-vault"), children: [
                h("span", { className: "dropdown-action-icon", children: "+" }),
                h("span", { children: "Add New Vault" })
              ] })
            ] })
          ] })
        ] }) })
      ] }),
      h("div", { className: "pane-content", children: mode === "analysis" && selectedEvidence.length > 0 ? h(React.Fragment, { children: [
        h("div", { className: "section-header", style: { display: "flex", justifyContent: "space-between", alignItems: "center" }, children: [
          h("span", { children: "USER CONTEXT" }),
          h("span", { style: { fontSize: "10px", background: "#3b82f6", color: "white", padding: "2px 8px", borderRadius: "10px", fontWeight: 600 }, children: selectedEvidence.length })
        ] }),
        h("div", { className: "items-list", children: selectedEvidence.map((doc) => h(Item, { icon: h(Icons.File, {}), iconType: `file ${doc.type}`, name: doc.name, desc: doc.type?.toUpperCase() + (doc.pages ? ` * ${doc.pages} pages` : ""), idBadge: showEvidenceIds ? doc.id : null, selected: true, checkbox: true, onClick: () => toggleEvidence(doc.id) }, doc.id)) }),
        h("div", { style: { padding: "12px", borderTop: "1px solid #e5e7eb", marginTop: "8px", display: "flex", justifyContent: "space-between", alignItems: "center" }, children: [
          h("span", { style: { fontSize: "11px", color: "#6b7280" }, children: "Analysis scope" }),
          h("button", { onClick: () => selectedEvidence.forEach((e) => toggleEvidence(e.id)), style: { fontSize: "11px", color: "#ef4444", background: "#fef2f2", border: "1px solid #fecaca", borderRadius: "6px", padding: "4px 10px", cursor: "pointer", fontWeight: 500 }, children: "Clear all" })
        ] })
      ] }) : h(React.Fragment, { children: h("div", { className: "items-list", children: folderPhases.map((phase) => {
        const phaseFolders = folders.filter((f) => f.phase === phase.number);
        const isPhaseOpen = expandedPhases.has(phase.number);
        return h("div", { children: [
          h("div", { className: "item", onClick: () => togglePhase(phase.number), style: { background: "#f8fafc", borderLeft: "3px solid #3b82f6" }, children: [
            h("div", { className: "item-icon folder", style: { background: "#dbeafe", color: "#3b82f6", fontSize: "10px", fontWeight: 700 }, children: phase.number }),
            h("div", { className: "item-info", children: [
              h("div", { className: "item-name", children: phase.name }),
              h("div", { className: "item-desc", children: [
                phaseFolders.length,
                " folders"
              ] })
            ] }),
            h("span", { style: { fontSize: "12px", color: "#6b7280" }, children: isPhaseOpen ? "v" : ">" })
          ] }),
          isPhaseOpen && h("div", { style: { marginLeft: "12px", borderLeft: "1px solid #e5e7eb", paddingLeft: "8px" }, children: phaseFolders.map((folder) => {
            const isOpen = expandedFolders.has(folder.id);
            const folderDocs = documents.filter((d) => d.folder === folder.id);
            const count = getFolderCount(folder);
            return h("div", { children: [
              h(Item, { icon: isOpen ? h(Icons.FolderOpen, {}) : h(Icons.Folder, {}), iconType: "folder", name: folder.name, desc: folder.farRef || "", badge: count > 0 ? count : null, onClick: () => toggleFolder(folder.id) }),
              isOpen && folderDocs.length > 0 && h("div", { style: { marginLeft: "12px", borderLeft: "1px solid #e5e7eb", paddingLeft: "8px" }, children: folderDocs.map((doc) => h(Item, { icon: h(Icons.File, {}), iconType: `file ${doc.type}`, name: doc.name, desc: doc.desc, idBadge: showEvidenceIds ? doc.id : null, selected: doc.selected, checkbox: true, onClick: () => toggleDoc(doc.id) }, doc.id)) })
            ] }, folder.id);
          }) })
        ] }, phase.number);
      }) }) }) }),
      h("div", { className: "pane-footer", style: { display: "flex", justifyContent: "space-between", alignItems: "center" }, children: [
        h("span", { className: "text-sm text-muted", children: selectedEvidence.length > 0 ? `${selectedEvidence.length} in context` : `${folders.length} Smart Folders` }),
        h("button", { onClick: () => openModal("file-manager"), style: { background: "none", border: "none", fontSize: "11px", color: "#3b82f6", cursor: "pointer" }, children: selectedEvidence.length > 0 ? "Add more" : "Open Files" })
      ] })
    ] });
  };
  var CenterPane = () => {
    const {
      mode,
      toggleMode,
      evidence,
      messages,
      addMessage,
      toggleEvidence,
      toggleSelectAllEvidence,
      currentCase,
      openModal,
      addTag,
      removeTag,
      setValidation,
      addNotification,
      showTagLabels,
      showEvidenceIds,
      backendConnected,
      wsConnected,
      streamingMessage,
      // Search state (T2.1)
      searchQuery,
      searchResults,
      searchLoading,
      searchHistory,
      executeSearch,
      clearSearch,
      replaySearch,
      // Highlight state (T2.5)
      searchHighlightEnabled,
      // Folder state (T2.3)
      activeFolderId,
      folderContents,
      selectFolder,
      clearFolderFilter,
      // Preview (v9.62)
      openPreview
    } = useApp();
    const [input, setInput] = useState("");
    const [liveSearchQuery, setLiveSearchQuery] = useState("");
    const [sending, setSending] = useState(false);
    
    // Sync input to liveSearchQuery when switching to search mode
    const prevModeRef = React.useRef(mode);
    React.useEffect(() => {
      if (prevModeRef.current === "analysis" && mode === "search" && input.trim()) {
        setLiveSearchQuery(input);
      }
      if (prevModeRef.current === "search" && mode === "analysis" && liveSearchQuery.trim()) {
        setInput(liveSearchQuery);
      }
      prevModeRef.current = mode;
    }, [mode]);
    const [sortMenuOpen, setSortMenuOpen] = useState(false);
    const [sortBy, setSortBy] = useState("name");
    const [sortOrder, setSortOrder] = useState("asc");
    const [filterType, setFilterType] = useState("all");
    const [activeTagMenu, setActiveTagMenu] = useState(null);
    const [tagFilterOpen, setTagFilterOpen] = useState(false);
    const [selectedFilterTags, setSelectedFilterTags] = useState([]);
    const [showSearchHistory, setShowSearchHistory] = useState(false);
    const [expandedMatches, setExpandedMatches] = useState(/* @__PURE__ */ new Set());
    const sortMenuRef = React.useRef(null);
    const tagFilterRef = React.useRef(null);
    
    // === SKILL LINTER STATE ===
    const [linterResult, setLinterResult] = useState(null);
    const [selectedSkill, setSelectedSkill] = useState(null);
    const [selectedRewrite, setSelectedRewrite] = useState(null);
    const [showSuggestions, setShowSuggestions] = useState(false);
    const linterTimeoutRef = React.useRef(null);
    
    // Debounced linting on input change
    React.useEffect(() => {
      if (mode !== "analysis" || !input.trim() || input.length < 3) {
        setLinterResult(null);
        setShowSuggestions(false);
        return;
      }
      
      // Debounce 300ms
      if (linterTimeoutRef.current) clearTimeout(linterTimeoutRef.current);
      linterTimeoutRef.current = setTimeout(async () => {
        try {
          if (typeof PromptLinter !== 'undefined' && PromptLinter.lintPromptAsync) {
            const result = await PromptLinter.lintPromptAsync(input);
            setLinterResult(result);
            // Show suggestions if we have skill matches or rewrites
            if ((result.skillMatches && result.skillMatches.length > 0) || 
                (result.rewrites && result.rewrites.length > 0)) {
              setShowSuggestions(true);
            }
          }
        } catch (e) {
          console.log("[THEMIS] Linter error:", e);
        }
      }, 300);
      
      return () => {
        if (linterTimeoutRef.current) clearTimeout(linterTimeoutRef.current);
      };
    }, [input, mode]);
    
    // Apply a rewrite suggestion
    const applyRewrite = (rewrite) => {
      setInput(rewrite.template);
      setSelectedSkill(rewrite.skill);
      setSelectedRewrite(rewrite);
      setShowSuggestions(false);
      addNotification && addNotification("success", "Applied " + rewrite.skill + " template");
    };
    
    // Select skill without applying rewrite
    const selectSkillOnly = (skill) => {
      setSelectedSkill(skill.skill);
      setSelectedRewrite(null);
      setShowSuggestions(false);
      addNotification && addNotification("info", "Using " + skill.skill + " skill");
    };
    
    // Clear skill selection
    const clearSkillSelection = () => {
      setSelectedSkill(null);
      setSelectedRewrite(null);
    };
    
    const CASE_TAGS = [
      { tag: "THEMIS:type:CONTRACT", label: "CONTRACT", ns: "type" },
      { tag: "THEMIS:type:EOT", label: "EOT", ns: "type" },
      { tag: "THEMIS:type:VARIATION", label: "VARIATION", ns: "type" },
      { tag: "THEMIS:type:CLAIM", label: "CLAIM", ns: "type" },
      { tag: "THEMIS:type:MINUTES", label: "MINUTES", ns: "type" },
      { tag: "THEMIS:type:CORRESPONDENCE", label: "CORRESPONDENCE", ns: "type" },
      { tag: "THEMIS:type:PROGRAMME", label: "PROGRAMME", ns: "type" },
      { tag: "THEMIS:type:INVOICE", label: "INVOICE", ns: "type" },
      { tag: "THEMIS:type:SITE_DIARY", label: "SITE_DIARY", ns: "type" },
      { tag: "THEMIS:type:EXPERT_REPORT", label: "EXPERT_REPORT", ns: "type" },
      { tag: "THEMIS:phase:pre-contract", label: "pre-contract", ns: "phase" },
      { tag: "THEMIS:phase:construction", label: "construction", ns: "phase" },
      { tag: "THEMIS:phase:post-contract", label: "post-contract", ns: "phase" },
      { tag: "THEMIS:phase:dispute", label: "dispute", ns: "phase" },
      { tag: "THEMIS:fw:RICS", label: "RICS", ns: "fw" },
      { tag: "THEMIS:fw:FIDIC", label: "FIDIC", ns: "fw" },
      { tag: "THEMIS:fw:NEC", label: "NEC", ns: "fw" },
      { tag: "THEMIS:meth:SCL", label: "SCL", ns: "meth" },
      { tag: "THEMIS:meth:AACE", label: "AACE", ns: "meth" }
    ];
    const highlightText = (text, query) => {
      if (!query || !text || !searchHighlightEnabled) return text;
      const searchWords = query.toLowerCase().split(/\s+/).filter((w) => w.length > 1);
      if (searchWords.length === 0) return text;
      const levenshtein = (a, b) => {
        if (a.length === 0) return b.length;
        if (b.length === 0) return a.length;
        const matrix = [];
        for (let i = 0; i <= b.length; i++) matrix[i] = [i];
        for (let j = 0; j <= a.length; j++) matrix[0][j] = j;
        for (let i = 1; i <= b.length; i++) {
          for (let j = 1; j <= a.length; j++) {
            const cost = a[j - 1] === b[i - 1] ? 0 : 1;
            matrix[i][j] = Math.min(
              matrix[i - 1][j] + 1,
              matrix[i][j - 1] + 1,
              matrix[i - 1][j - 1] + cost
            );
          }
        }
        return matrix[b.length][a.length];
      };
      const isExactMatch = (word) => searchWords.some((sw) => word.toLowerCase() === sw.toLowerCase());
      const isFuzzyMatch = (word) => {
        if (word.length < 3) return false;
        return searchWords.some((sw) => {
          if (sw.length < 3) return false;
          const dist = levenshtein(word.toLowerCase(), sw.toLowerCase());
          return dist > 0 && dist <= 2 && dist < Math.min(word.length, sw.length) / 2;
        });
      };
      const tokens = text.split(/(\s+|[.,;:!?()[\]{}'"/-])/);
      return tokens.map((token, i) => {
        if (/^\s*$/.test(token) || /^[.,;:!?()[\]{}'"/-]$/.test(token)) {
          return token;
        }
        if (isExactMatch(token)) {
          return React.createElement("mark", {
            key: i,
            style: {
              background: "#fef08a",
              color: "#854d0e",
              padding: "0 2px",
              borderRadius: "2px",
              fontWeight: 600
            },
            title: "Exact match"
          }, token);
        } else if (isFuzzyMatch(token)) {
          return React.createElement("mark", {
            key: i,
            style: {
              background: "#dbeafe",
              color: "#1e40af",
              padding: "0 2px",
              borderRadius: "2px",
              fontWeight: 500,
              fontStyle: "italic"
            },
            title: "Possible match (typo?)"
          }, token);
        }
        return token;
      });
    };
    React.useEffect(() => {
      const handleClickOutside = (e) => {
        if (sortMenuRef.current && !sortMenuRef.current.contains(e.target)) {
          setSortMenuOpen(false);
        }
        if (tagFilterRef.current && !tagFilterRef.current.contains(e.target) && !e.target.closest(".tag-filter-btn")) {
          setTagFilterOpen(false);
        }
        if (!e.target.closest(".tag-menu-container")) {
          setActiveTagMenu(null);
        }
      };
      document.addEventListener("mousedown", handleClickOutside);
      return () => document.removeEventListener("mousedown", handleClickOutside);
    }, []);
    const toggleFilterTag = (tag) => {
      setSelectedFilterTags(
        (prev) => prev.includes(tag) ? prev.filter((t) => t !== tag) : [...prev, tag]
      );
    };
    const clearFilterTags = () => setSelectedFilterTags([]);
const handleSend = async () => {
      if (!input.trim() || sending) return;
      const query = input.trim();
      
      // Build the message payload with skill context
      const messagePayload = {
        prompt: query,
        selected_skill: selectedSkill || null,
        selected_rewrite: selectedRewrite ? true : false,
        linter_result: linterResult ? {
          score: linterResult.score,
          taskType: linterResult.taskType,
          topSkill: linterResult.topSkill?.skill || null,
          skillMatches: (linterResult.skillMatches || []).slice(0, 3).map(s => ({
            skill: s.skill,
            score: s.score
          })),
          hasRewrites: linterResult.hasRewrites || false
        } : null
      };
      
      console.log("[THEMIS] Sending with skill context:", messagePayload);
      
      // Clear input and skill selection
      setInput("");
      setSelectedSkill(null);
      setSelectedRewrite(null);
      setLinterResult(null);
      setShowSuggestions(false);
      setSending(true);
      
      // Add user message to chat immediately
      if (mode !== "search" && addMessage) {
        addMessage("user", query, { skill: selectedSkill });
      }
      
      try {
        if (mode === "search") {
          await executeSearch(query);
        } else {
          // Send to LocalAgent API with skill context
          const response = await ThemisAPI.chat.send(query, currentCase?.id, {
            mode,
            selected_evidence: evidence.filter((e) => e.selected).map((e) => e.id),
            // Include skill context for Protocol injection
            skill_context: {
              selected_skill: messagePayload.selected_skill,
              selected_rewrite: messagePayload.selected_rewrite,
              linter_result: messagePayload.linter_result
            }
          });
          if (response) {
            // Add response to messages
            if (addMessage) {
              addMessage("assistant", response.response, { 
                va: response.ai_source === "mlx" ? "MLX" : "DA",
                skill_used: response.skill_used || messagePayload.selected_skill
              });
            }
          } else {
            addNotification && addNotification("warning", "No response from AI");
          }
        }
      } catch (err) {
        console.error("[CenterPane] handleSend error:", err);
        addNotification && addNotification("error", "Operation failed");
      }
      setSending(false);
    };
    const selectedCount = evidence.filter((d) => d.selected).length;
    const totalCount = evidence.length;
    const allSelected = evidence.length > 0 && evidence.every((d) => d.selected);
    const SAMPLE_EXCERPTS = [
      "The contractor submitted a formal notice of delay citing adverse weather conditions that prevented continuation of excavation works.",
      "Extension of time claim references multiple delay events during the foundation phase of construction.",
      "Meeting minutes recorded discussion of delay impacts on the critical path schedule.",
      "The delay analysis demonstrates concurrent delays between contractor and employer-caused events.",
      "Pursuant to clause 8.4, the contractor shall notify any delay within 28 days of becoming aware.",
      "The programme showed a 14-day delay to the completion milestone due to design changes.",
      "Witness statement confirms the delay was caused by late access to the site.",
      "Expert report concludes that the delay was on the critical path and not concurrent.",
      "The variation instruction resulted in a 21-day delay to steel erection works.",
      "Claims register entry for EOT-003 documents the delay event sequence."
    ];
    const highlightExcerptMulti = (text, searchTerms) => {
      if (!searchTerms || searchTerms.length === 0 || !text) return text;
      let result = text;
      const sortedTerms = [...searchTerms].sort((a, b) => b.length - a.length);
      sortedTerms.forEach((term) => {
        if (term.length < 2) return;
        const escaped = term.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
        const regex = new RegExp(`(\\S*${escaped}\\S*)`, "gi");
        result = result.replace(regex, (match) => {
          if (match.includes("**")) return match;
          return `**${match}**`;
        });
      });
      return result;
    };
    const generateMatchCards = (doc, query) => {
      if (!query || query.length < 2) return [];
      const words = query.toLowerCase().split(/\s+/).filter((w) => w.length > 1);
      if (words.length === 0) return [];
      const cards = [];
      const filenameMatches = words.filter((w) => doc.name.toLowerCase().includes(w));
      if (filenameMatches.length > 0) {
        cards.push({
          id: `${doc.id}-filename`,
          docId: doc.id,
          doc,
          matchType: "filename",
          matchWords: filenameMatches,
          page: null,
          section: null,
          line: null,
          excerpt: doc.name,
          excerptHighlight: highlightExcerptMulti(doc.name, filenameMatches)
        });
      }
      (doc.tags || []).forEach((tag) => {
        const tagVal = tag.split(":").slice(-1)[0];
        const tagMatches = words.filter((w) => tagVal.toLowerCase().includes(w));
        if (tagMatches.length > 0) {
          cards.push({
            id: `${doc.id}-tag-${tag}`,
            docId: doc.id,
            doc,
            matchType: "tag",
            matchWords: tagMatches,
            tag,
            page: null,
            section: null,
            line: null,
            excerpt: `Tag: ${tagVal}`,
            excerptHighlight: `Tag: ${highlightExcerptMulti(tagVal, tagMatches)}`
          });
        }
      });
      const numContentMatches = Math.min(doc.pages || 3, 5);
      for (let i = 0; i < numContentMatches; i++) {
        const excerpt = SAMPLE_EXCERPTS[Math.floor(Math.random() * SAMPLE_EXCERPTS.length)];
        const excerptMatches = words.filter((w) => excerpt.toLowerCase().includes(w));
        if (excerptMatches.length > 0) {
          const page = Math.floor(Math.random() * (doc.pages || 10)) + 1;
          const section = Math.floor(Math.random() * 5) + 1;
          const line = Math.floor(Math.random() * 40) + 1;
          cards.push({
            id: `${doc.id}-content-${i}`,
            docId: doc.id,
            doc,
            matchType: "content",
            matchWords: excerptMatches,
            page,
            section,
            line,
            excerpt,
            excerptHighlight: highlightExcerptMulti(excerpt, excerptMatches)
          });
        }
      }
      return cards;
    };
    const highlightExcerpt = (text, searchTerm) => {
      return highlightExcerptMulti(text, [searchTerm]);
    };
    const searchMatchCards = React.useMemo(() => {
      if (!liveSearchQuery || liveSearchQuery.length < 2) return [];
      const allCards = [];
      evidence.forEach((doc) => {
        const cards = generateMatchCards(doc, liveSearchQuery);
        allCards.push(...cards);
      });
      return allCards.sort((a, b) => {
        const nameCompare = a.doc.name.localeCompare(b.doc.name);
        if (nameCompare !== 0) return nameCompare;
        return (a.page || 0) - (b.page || 0);
      });
    }, [evidence, liveSearchQuery]);
    const isSearchMode = liveSearchQuery.length >= 2;
    const displayEvidence = isSearchMode ? [] : searchResults.length > 0 ? searchResults : evidence;
    const filteredDocs = displayEvidence.filter((d) => filterType === "all" || d.type === filterType).filter((d) => selectedFilterTags.length === 0 || selectedFilterTags.every((tag) => (d.tags || []).includes(tag))).sort((a, b) => {
      if (liveSearchQuery.length >= 2 && a.matchInfo && b.matchInfo) {
        const matchDiff = b.matchInfo.total - a.matchInfo.total;
        if (matchDiff !== 0) return matchDiff;
      }
      let cmp = 0;
      if (sortBy === "name") cmp = a.name.localeCompare(b.name);
      else if (sortBy === "type") cmp = a.type.localeCompare(b.type);
      else if (sortBy === "date") cmp = (a.date || "").localeCompare(b.date || "");
      else if (sortBy === "selected") cmp = (b.selected ? 1 : 0) - (a.selected ? 1 : 0);
      return sortOrder === "asc" ? cmp : -cmp;
    });
    const toggleMatchExpand = (docId) => {
      setExpandedMatches((prev) => {
        const next = new Set(prev);
        next.has(docId) ? next.delete(docId) : next.add(docId);
        return next;
      });
    };
    const handleSort = (by) => {
      if (sortBy === by) {
        setSortOrder((o) => o === "asc" ? "desc" : "asc");
      } else {
        setSortBy(by);
        setSortOrder("asc");
      }
    };
    const handleFilter = (type) => {
      setFilterType(type);
      setSortMenuOpen(false);
    };
    const typeCount = (type) => evidence.filter((d) => d.type === type).length;
    const formatSize = (bytes) => {
      if (!bytes) return "";
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + " KB";
      return (bytes / (1024 * 1024)).toFixed(1) + " MB";
    };
    const getValidationColor = (validation) => {
      if (validation === "confirmed") return "#22c55e";
      if (validation === "rejected") return "#ef4444";
      return "#eab308";
    };
    const getTagColor = (ns) => {
      const colors = { type: "#8b5cf6", fw: "#22c55e", valid: "#eab308", conv: "#f97316", phase: "#ec4899", meth: "#06b6d4", case: "#3b82f6", folder: "#6b7280" };
      return colors[ns] || "#6b7280";
    };
    const getMissingTags = (doc) => {
      return CASE_TAGS.filter((t) => !doc.tags.includes(t.tag));
    };
    return h("section", { className: "pane pane-center", children: [
      h("div", { className: "pane-header", children: [
        h("div", { className: "cpane-header-content", children: [
          h("span", { className: `framework-badge ${currentCase.framework.toLowerCase()}`, children: currentCase.framework }),
          h("span", { className: "pane-title", children: mode === "analysis" ? "Analysis" : "Search" }),
          searchResults.length > 0 && h(
            "span",
            {
              className: "search-results-badge",
              style: {
                background: "#dbeafe",
                color: "#1d4ed8",
                padding: "2px 8px",
                borderRadius: "4px",
                fontSize: "11px",
                fontWeight: 600,
                display: "flex",
                alignItems: "center",
                gap: "6px",
                cursor: "pointer"
              },
              onClick: clearSearch,
              title: "Click to clear search",
              children: [
                h("span", { children: [
                  searchResults.length,
                  " results"
                ] }),
                h("span", { style: { fontSize: "10px" }, children: "x" })
              ]
            }
          ),
          searchLoading && h("span", { style: { fontSize: "11px", color: "#6b7280" }, children: "Searching..." }),
          h("div", { className: "dropdown", style: { position: "relative" }, ref: sortMenuRef, children: [
            h(
              "span",
              {
                className: "cpane-workspace",
                onClick: () => setSortMenuOpen(!sortMenuOpen),
                style: { cursor: "pointer" },
                title: "Sort & Filter",
                children: [
                  "workspace",
                  h("span", { style: { marginLeft: "4px", fontSize: "8px" }, children: "v" })
                ]
              }
            ),
            sortMenuOpen && h("div", { className: "dropdown-menu show", style: { position: "absolute", top: "100%", left: "0", minWidth: "200px", marginTop: "8px", zIndex: 1e3 }, children: [
              h("div", { className: "dropdown-header", children: "Sort By" }),
              h("div", { className: "sort-item", onClick: () => handleSort("name"), style: { display: "flex", justifyContent: "space-between", padding: "8px 14px", cursor: "pointer", background: sortBy === "name" ? "#eff6ff" : "" }, children: [
                h("span", { children: "Name" }),
                sortBy === "name" && h("span", { style: { color: "#2563eb" }, children: sortOrder === "asc" ? "^" : "v" })
              ] }),
              h("div", { className: "sort-item", onClick: () => handleSort("type"), style: { display: "flex", justifyContent: "space-between", padding: "8px 14px", cursor: "pointer", background: sortBy === "type" ? "#eff6ff" : "" }, children: [
                h("span", { children: "Type" }),
                sortBy === "type" && h("span", { style: { color: "#2563eb" }, children: sortOrder === "asc" ? "^" : "v" })
              ] }),
              h("div", { className: "sort-item", onClick: () => handleSort("date"), style: { display: "flex", justifyContent: "space-between", padding: "8px 14px", cursor: "pointer", background: sortBy === "date" ? "#eff6ff" : "" }, children: [
                h("span", { children: "Date" }),
                sortBy === "date" && h("span", { style: { color: "#2563eb" }, children: sortOrder === "asc" ? "^" : "v" })
              ] }),
              h("div", { className: "sort-item", onClick: () => handleSort("selected"), style: { display: "flex", justifyContent: "space-between", padding: "8px 14px", cursor: "pointer", background: sortBy === "selected" ? "#eff6ff" : "" }, children: [
                h("span", { children: "Selected First" }),
                sortBy === "selected" && h("span", { style: { color: "#2563eb" }, children: "ok" })
              ] }),
              h("div", { style: { borderTop: "1px solid #e5e7eb", margin: "4px 0" } }),
              h("div", { className: "dropdown-header", children: "Filter By Type" }),
              h("div", { className: "filter-item", onClick: () => handleFilter("all"), style: { display: "flex", justifyContent: "space-between", padding: "8px 14px", cursor: "pointer", background: filterType === "all" ? "#eff6ff" : "" }, children: [
                h("span", { children: "All Types" }),
                h("span", { style: { color: "#6b7280", fontSize: "11px" }, children: evidence.length })
              ] }),
              h("div", { className: "filter-item", onClick: () => handleFilter("pdf"), style: { display: "flex", justifyContent: "space-between", padding: "8px 14px", cursor: "pointer", background: filterType === "pdf" ? "#eff6ff" : "" }, children: [
                h("span", { style: { display: "flex", alignItems: "center", gap: "8px" }, children: [
                  h("span", { style: { color: "#ef4444" }, children: "*" }),
                  " PDF"
                ] }),
                h("span", { style: { color: "#6b7280", fontSize: "11px" }, children: typeCount("pdf") })
              ] }),
              h("div", { className: "filter-item", onClick: () => handleFilter("xlsx"), style: { display: "flex", justifyContent: "space-between", padding: "8px 14px", cursor: "pointer", background: filterType === "xlsx" ? "#eff6ff" : "" }, children: [
                h("span", { style: { display: "flex", alignItems: "center", gap: "8px" }, children: [
                  h("span", { style: { color: "#22c55e" }, children: "*" }),
                  " Excel"
                ] }),
                h("span", { style: { color: "#6b7280", fontSize: "11px" }, children: typeCount("xlsx") })
              ] }),
              h("div", { className: "filter-item", onClick: () => handleFilter("docx"), style: { display: "flex", justifyContent: "space-between", padding: "8px 14px", cursor: "pointer", background: filterType === "docx" ? "#eff6ff" : "" }, children: [
                h("span", { style: { display: "flex", alignItems: "center", gap: "8px" }, children: [
                  h("span", { style: { color: "#3b82f6" }, children: "*" }),
                  " Word"
                ] }),
                h("span", { style: { color: "#6b7280", fontSize: "11px" }, children: typeCount("docx") })
              ] }),
              h("div", { className: "filter-item", onClick: () => handleFilter("mpp"), style: { display: "flex", justifyContent: "space-between", padding: "8px 14px", cursor: "pointer", background: filterType === "mpp" ? "#eff6ff" : "" }, children: [
                h("span", { style: { display: "flex", alignItems: "center", gap: "8px" }, children: [
                  h("span", { style: { color: "#8b5cf6" }, children: "*" }),
                  " Programme"
                ] }),
                h("span", { style: { color: "#6b7280", fontSize: "11px" }, children: typeCount("mpp") })
              ] })
            ] })
          ] }),
          h(
            "span",
            {
              className: "cpane-selection",
              onClick: () => openModal("evidence-inventory"),
              style: { cursor: "pointer" },
              title: "Open Evidence Inventory",
              children: [
                selectedCount,
                "/",
                totalCount,
                " selected"
              ]
            }
          )
        ] }),
        h("label", { className: "cpane-select-all", children: [
          h("input", { type: "checkbox", checked: allSelected, onChange: toggleSelectAllEvidence }),
          h("span", { children: "All" })
        ] })
      ] }),
      h("div", { className: "pane-content", children: [
        h("div", { className: "search-only search-idle", children: [
          isSearchMode && h("div", { className: "items-list", style: { gap: "8px" }, children: searchMatchCards.length === 0 ? h("div", { style: { padding: "40px 20px", textAlign: "center", color: "#9ca3af" }, children: [
            h("div", { style: { fontSize: "14px", marginBottom: "4px" }, children: "No matches found" }),
            h("div", { style: { fontSize: "11px" }, children: "Try different search terms" })
          ] }) : searchMatchCards.map((card) => h(
            "div",
            {
              onClick: () => openModal("doc-preview", { docId: card.docId, page: card.page }),
              style: {
                padding: "12px",
                background: card.matchType === "content" ? "#fffbeb" : card.matchType === "filename" ? "#eff6ff" : "#f5f3ff",
                border: `1px solid ${card.matchType === "content" ? "#fef08a" : card.matchType === "filename" ? "#bfdbfe" : "#ddd6fe"}`,
                borderRadius: "8px",
                cursor: "pointer",
                transition: "all 0.15s"
              },
              onMouseEnter: (e) => {
                e.currentTarget.style.transform = "translateX(4px)";
                e.currentTarget.style.boxShadow = "0 2px 8px rgba(0,0,0,0.1)";
              },
              onMouseLeave: (e) => {
                e.currentTarget.style.transform = "translateX(0)";
                e.currentTarget.style.boxShadow = "none";
              },
              children: [
                h("div", { style: { display: "flex", justifyContent: "space-between", alignItems: "flex-start", marginBottom: "8px" }, children: [
                  h("div", { style: { display: "flex", alignItems: "center", gap: "8px" }, children: [
                    h("span", { style: {
                      width: "24px",
                      height: "24px",
                      borderRadius: "4px",
                      background: card.doc.type === "pdf" ? "#fecaca" : card.doc.type === "docx" ? "#bfdbfe" : "#bbf7d0",
                      display: "flex",
                      alignItems: "center",
                      justifyContent: "center",
                      fontSize: "10px",
                      fontWeight: 600,
                      color: card.doc.type === "pdf" ? "#dc2626" : card.doc.type === "docx" ? "#2563eb" : "#16a34a"
                    }, children: card.doc.type?.toUpperCase().slice(0, 3) }),
                    h("span", { style: { fontSize: "12px", fontWeight: 600, color: "#374151" }, children: card.doc.name })
                  ] }),
                  card.page && h("span", { style: {
                    fontSize: "10px",
                    fontFamily: "monospace",
                    padding: "2px 8px",
                    borderRadius: "4px",
                    background: "#059669",
                    color: "white",
                    fontWeight: 500
                  }, children: [
                    "p",
                    card.page,
                    " S",
                    card.section,
                    " L",
                    card.line
                  ] }),
                  card.matchType === "filename" && h("span", { style: { fontSize: "10px", padding: "2px 8px", borderRadius: "4px", background: "#3b82f6", color: "white" }, children: "Filename" }),
                  card.matchType === "tag" && h("span", { style: { fontSize: "10px", padding: "2px 8px", borderRadius: "4px", background: "#8b5cf6", color: "white" }, children: "Tag" })
                ] }),
                h("div", { style: {
                  fontSize: "12px",
                  lineHeight: 1.5,
                  color: "#4b5563",
                  background: "white",
                  padding: "8px 10px",
                  borderRadius: "4px",
                  border: "1px solid #e5e7eb"
                }, children: (card.excerptHighlight || card.excerpt).split("**").map(
                  (part, i) => i % 2 === 1 ? h("mark", { style: {
                    background: "#fef08a",
                    color: "#854d0e",
                    padding: "0 2px",
                    borderRadius: "2px",
                    fontWeight: 600
                  }, children: part }, i) : part
                ) }),
                h("div", { style: { marginTop: "6px", display: "flex", alignItems: "center", gap: "6px", flexWrap: "wrap" }, children: [
                  h("span", { style: { fontSize: "10px", color: "#9ca3af" }, children: "Matched:" }),
                  (card.matchWords || [card.matchWord]).map((word, wi) => h("span", { style: {
                    fontSize: "10px",
                    padding: "1px 6px",
                    borderRadius: "4px",
                    background: "#fef08a",
                    color: "#854d0e",
                    fontWeight: 500
                  }, children: word }, wi)),
                  h("span", { style: { fontSize: "10px", color: "#9ca3af", marginLeft: "auto" }, children: "Click to preview" })
                ] })
              ]
            },
            card.id
          )) }),
          !isSearchMode && h("div", { className: "items-list", children: [
            filteredDocs.map((doc) => {
              const visibleTags = doc.tags.filter((t) => !t.includes(":case:") && !t.includes(":folder:"));
              const missingTags = getMissingTags(doc);
              const isTagMenuOpen = activeTagMenu === doc.id;
              return h(
                "div",
                {
                  className: `evidence-item ${doc.selected ? "selected" : ""}`,
                  style: {
                    display: "flex",
                    alignItems: "flex-start",
                    gap: "10px",
                    padding: "10px 12px",
                    cursor: "pointer",
                    borderRadius: "8px",
                    background: doc.selected ? "#eff6ff" : "transparent",
                    border: doc.selected ? "1px solid #bfdbfe" : "1px solid transparent",
                    marginBottom: "4px",
                    position: "relative"
                  },
                  onClick: () => toggleEvidence(doc.id),
                  onDoubleClick: () => openPreview(doc.id),
                  title: "Double-click to preview",
                  children: [
                    h("div", { style: { position: "relative", flexShrink: 0 }, children: [
                      h("div", { className: `item-icon file ${doc.type}`, style: { width: "32px", height: "32px" }, children: h(Icons.File, {}) }),
                      h("span", { style: {
                        position: "absolute",
                        bottom: "-2px",
                        right: "-2px",
                        width: "10px",
                        height: "10px",
                        borderRadius: "50%",
                        background: getValidationColor(doc.validation),
                        border: "2px solid white"
                      } })
                    ] }),
                    h("div", { style: { flex: 1, minWidth: 0 }, children: [
                      h("div", { style: { display: "flex", alignItems: "baseline", gap: "8px" }, children: [
                        h("span", { style: { fontWeight: 500, fontSize: "12px", overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }, children: doc.name }),
                        showEvidenceIds && h("span", { className: "evidence-id-badge", style: {
                          padding: "1px 6px",
                          background: "#f3e8ff",
                          color: "#7c3aed",
                          fontSize: "9px",
                          fontWeight: 700,
                          borderRadius: "4px",
                          flexShrink: 0
                        }, children: doc.id }),
                        h("span", { style: { fontSize: "10px", color: "#9ca3af", flexShrink: 0 }, children: formatSize(doc.size) })
                      ] }),
                      h("div", { style: { display: "flex", flexWrap: "wrap", gap: showTagLabels ? "4px" : "3px", marginTop: "4px", alignItems: "center" }, children: [
                        visibleTags.slice(0, showTagLabels ? 4 : 8).map((tag) => {
                          const ns = tag.split(":")[1];
                          const val = tag.split(":").slice(-1)[0];
                          const color = getTagColor(ns);
                          return showTagLabels ? h("span", { style: {
                            display: "inline-flex",
                            alignItems: "center",
                            gap: "3px",
                            padding: "1px 6px",
                            borderRadius: "8px",
                            fontSize: "9px",
                            background: `${color}18`,
                            color,
                            fontWeight: 500
                          }, children: [
                            h("span", { style: { width: "5px", height: "5px", borderRadius: "50%", background: color } }),
                            liveSearchQuery ? highlightText(val, liveSearchQuery) : searchQuery ? highlightText(val, searchQuery) : val
                          ] }, tag) : h("span", { title: `${ns}: ${val}`, style: {
                            width: "8px",
                            height: "8px",
                            borderRadius: "50%",
                            background: color
                          } }, tag);
                        }),
                        visibleTags.length > (showTagLabels ? 4 : 8) && h("span", { style: { fontSize: "9px", color: "#9ca3af" }, children: [
                          "+",
                          visibleTags.length - (showTagLabels ? 4 : 8)
                        ] }),
                        missingTags.length > 0 && h("div", { className: "tag-menu-container", style: { position: "relative", display: "inline-block" }, children: [
                          h(
                            "button",
                            {
                              className: "add-tag-btn",
                              onClick: (e) => {
                                e.stopPropagation();
                                setActiveTagMenu(isTagMenuOpen ? null : doc.id);
                              },
                              style: {
                                opacity: 0,
                                padding: "1px 6px",
                                fontSize: "9px",
                                background: isTagMenuOpen ? "#3b82f6" : "#f3f4f6",
                                border: "1px dashed #d1d5db",
                                borderRadius: "8px",
                                color: isTagMenuOpen ? "white" : "#6b7280",
                                cursor: "pointer",
                                transition: "opacity 0.15s"
                              },
                              children: "+"
                            }
                          ),
                          isTagMenuOpen && h("div", { style: {
                            position: "absolute",
                            top: "100%",
                            left: 0,
                            marginTop: "4px",
                            background: "white",
                            borderRadius: "8px",
                            boxShadow: "0 4px 20px rgba(0,0,0,0.15)",
                            border: "1px solid #e5e7eb",
                            zIndex: 1e3,
                            minWidth: "160px",
                            padding: "4px",
                            maxHeight: "240px",
                            overflow: "auto"
                          }, children: [
                            missingTags.map((t) => h(
                              "div",
                              {
                                onClick: (e) => {
                                  e.stopPropagation();
                                  addTag(doc.id, t.tag);
                                  addNotification("success", `Added: ${t.label}`);
                                  setActiveTagMenu(null);
                                },
                                style: {
                                  padding: "6px 10px",
                                  cursor: "pointer",
                                  borderRadius: "4px",
                                  fontSize: "10px",
                                  display: "flex",
                                  alignItems: "center",
                                  gap: "6px"
                                },
                                onMouseEnter: (e) => e.target.style.background = "#f3f4f6",
                                onMouseLeave: (e) => e.target.style.background = "transparent",
                                children: [
                                  h("span", { style: { width: "6px", height: "6px", borderRadius: "50%", background: getTagColor(t.ns) } }),
                                  t.label
                                ]
                              },
                              t.tag
                            )),
                            h("div", { style: { borderTop: "1px solid #e5e7eb", margin: "4px 0" } }),
                            h(
                              "div",
                              {
                                onClick: (e) => {
                                  e.stopPropagation();
                                  const newTag = prompt("Enter new tag (e.g., WITNESS_STATEMENT or THEMIS:type:WITNESS_STATEMENT)");
                                  if (newTag && newTag.trim()) {
                                    let tag = newTag.trim();
                                    if (!tag.startsWith("THEMIS:")) {
                                      tag = `THEMIS:type:${tag}`;
                                    }
                                    addTag(doc.id, tag);
                                    addNotification("success", `Created & added: ${tag.split(":").pop()}`);
                                  }
                                  setActiveTagMenu(null);
                                },
                                style: {
                                  padding: "6px 10px",
                                  cursor: "pointer",
                                  borderRadius: "4px",
                                  fontSize: "10px",
                                  display: "flex",
                                  alignItems: "center",
                                  gap: "6px",
                                  color: "#3b82f6",
                                  fontWeight: 500
                                },
                                onMouseEnter: (e) => e.target.style.background = "#eff6ff",
                                onMouseLeave: (e) => e.target.style.background = "transparent",
                                children: [
                                  h("span", { style: { fontSize: "12px" }, children: "+" }),
                                  "Create new tag..."
                                ]
                              }
                            )
                          ] })
                        ] })
                      ] })
                    ] }),
                    h(
                      "input",
                      {
                        type: "checkbox",
                        checked: doc.selected,
                        onChange: () => toggleEvidence(doc.id),
                        onClick: (e) => e.stopPropagation(),
                        style: { flexShrink: 0, width: "16px", height: "16px", marginTop: "2px" }
                      }
                    )
                  ]
                },
                doc.id
              );
            }),
            filteredDocs.length === 0 && h("div", { style: { padding: "20px", textAlign: "center", color: "#9ca3af", fontSize: "12px" }, children: "No documents match filter" })
          ] })
        ] }),
        h("div", { className: "analysis-only-flex", style: { flexDirection: "column", flex: 1, position: "relative", overflow: "hidden" }, children: [
          h("iframe", { 
            id: "localagent-chat",
            src: "/modules/ai-chat-module-pro/chat-pro-standalone.html?theme=light&project=THEMIS&case=" + (currentCase?.id || "") + "&v=10527",
            style: { 
              width: "100%", 
              height: "100%", 
              border: "none",
              borderRadius: "8px",
              position: "relative",
              zIndex: 50,
              pointerEvents: "auto"
            },
            allow: "clipboard-read; clipboard-write"
          }),
          selectedCount > 0 && h("div", { style: {
            position: "absolute",
            top: "12px",
            left: "12px",
            right: "12px",
            display: "flex",
            alignItems: "center",
            justifyContent: "space-between",
            padding: "8px 16px",
            background: "rgba(239, 246, 255, 0.95)",
            border: "1px solid #bfdbfe",
            borderRadius: "8px",
            zIndex: 100,
            boxShadow: "0 2px 8px rgba(59, 130, 246, 0.2)",
            backdropFilter: "blur(4px)"
          }, children: [
            h("span", { style: { fontSize: "13px", color: "#2563eb", fontWeight: 500 }, children: [
              selectedCount,
              " documents in context"
            ] }),
            h("button", { className: "btn btn-ghost btn-sm", children: "Manage" })
          ] })
        ] })
      ] }),
      
      /* Skill suggestions are now handled inside the iframe chat module */
      
      h("div", { className: "chat-input-wrapper", children: h("div", { className: "chat-input", children: [
        h(
          "input",
          {
            value: mode === "search" ? liveSearchQuery : input,
            onChange: (e) => {
              if (mode === "search") {
                setLiveSearchQuery(e.target.value);
              } else {
                setInput(e.target.value);
              }
            },
            onKeyDown: (e) => {
              if (e.key === "Enter" && !e.shiftKey) {
                if (mode === "analysis") {
                  handleSend();
                }
              }
              if (e.key === "Escape" && mode === "search") {
                setLiveSearchQuery("");
              }
            },
            placeholder: mode === "search" ? "Type to search documents... (live filtering)" : wsConnected ? "Ask about your documents..." : "Chat available when backend connected...",
            disabled: sending
          }
        ),
        h("div", { className: "chat-btns", children: [
          mode === "search" && liveSearchQuery.length > 0 && h(React.Fragment, { children: [
            h(
              "button",
              {
                onClick: () => setLiveSearchQuery(""),
                className: "chat-btn",
                style: {
                  background: "#fee2e2",
                  border: "none",
                  color: "#dc2626",
                  fontWeight: 600,
                  fontSize: "12px",
                  padding: "6px 12px",
                  borderRadius: "6px",
                  display: "flex",
                  alignItems: "center",
                  gap: "4px",
                  cursor: "pointer"
                },
                title: "Clear search (Esc)",
                children: "x Clear"
              }
            ),
            liveSearchQuery.length >= 2 && h("span", { style: {
              fontSize: "11px",
              color: "#059669",
              fontWeight: 600,
              background: "#d1fae5",
              padding: "6px 12px",
              borderRadius: "6px"
            }, children: [
              searchMatchCards.length,
              " match",
              searchMatchCards.length !== 1 ? "es" : ""
            ] }),
            h("div", { className: "chat-divider" })
          ] }),
          h(
            "button",
            {
              className: `chat-btn context-toggle ${mode}`,
              onClick: toggleMode,
              title: mode === "search" ? "Switch to Analysis (chat with AI)" : "Switch to Search (browse files)",
              style: {
                minWidth: "36px",
                fontWeight: 700,
                fontSize: "14px"
              },
              children: mode === "search" ? "A" : "S"
            }
          ),
          h("div", { className: "chat-divider" }),
          h("div", { style: { position: "relative" }, ref: tagFilterRef, children: [
            h(
              "button",
              {
                className: `chat-btn tag-filter-btn ${selectedFilterTags.length > 0 ? "active" : ""}`,
                onClick: () => setTagFilterOpen(!tagFilterOpen),
                style: {
                  background: selectedFilterTags.length > 0 ? "#3b82f6" : "",
                  color: selectedFilterTags.length > 0 ? "white" : ""
                },
                children: [
                  h(Icons.Hash, {}),
                  selectedFilterTags.length > 0 && h("span", { style: {
                    position: "absolute",
                    top: "-4px",
                    right: "-4px",
                    background: "#ef4444",
                    color: "white",
                    fontSize: "9px",
                    width: "16px",
                    height: "16px",
                    borderRadius: "50%",
                    display: "flex",
                    alignItems: "center",
                    justifyContent: "center"
                  }, children: selectedFilterTags.length })
                ]
              }
            ),
            tagFilterOpen && h("div", { style: {
              position: "absolute",
              bottom: "100%",
              left: "50%",
              transform: "translateX(-50%)",
              marginBottom: "8px",
              width: "180px",
              background: "white",
              borderRadius: "8px",
              boxShadow: "0 4px 20px rgba(0,0,0,0.15)",
              border: "1px solid #e5e7eb",
              zIndex: 1e3,
              maxHeight: "280px",
              overflow: "auto",
              padding: "4px"
            }, children: [
              CASE_TAGS.map((t) => {
                const isSelected = selectedFilterTags.includes(t.tag);
                const color = getTagColor(t.ns);
                return h(
                  "div",
                  {
                    onClick: () => toggleFilterTag(t.tag),
                    style: {
                      padding: "8px 12px",
                      cursor: "pointer",
                      borderRadius: "4px",
                      fontSize: "12px",
                      display: "flex",
                      alignItems: "center",
                      gap: "8px",
                      background: isSelected ? `${color}15` : "transparent"
                    },
                    onMouseEnter: (e) => {
                      if (!isSelected) e.currentTarget.style.background = "#f3f4f6";
                    },
                    onMouseLeave: (e) => {
                      if (!isSelected) e.currentTarget.style.background = "transparent";
                    },
                    children: [
                      h("span", { style: { width: "8px", height: "8px", borderRadius: "50%", background: color } }),
                      h("span", { style: { flex: 1, color: isSelected ? color : "#374151", fontWeight: isSelected ? 500 : 400 }, children: t.label }),
                      isSelected && h("span", { style: { color, fontSize: "14px" }, children: "[ok]" })
                    ]
                  },
                  t.tag
                );
              }),
              selectedFilterTags.length > 0 && h(React.Fragment, { children: [
                h("div", { style: { borderTop: "1px solid #e5e7eb", margin: "4px 0" } }),
                h(
                  "div",
                  {
                    onClick: clearFilterTags,
                    style: { padding: "8px 12px", cursor: "pointer", borderRadius: "4px", fontSize: "11px", color: "#ef4444", textAlign: "center" },
                    onMouseEnter: (e) => e.currentTarget.style.background = "#fef2f2",
                    onMouseLeave: (e) => e.currentTarget.style.background = "transparent",
                    children: "Clear filters"
                  }
                )
              ] })
            ] })
          ] }),
          h("div", { style: { position: "relative" }, children: [
            h(
              "button",
              {
                className: `chat-btn ${searchHistory.length > 0 ? "has-history" : ""}`,
                onClick: () => setShowSearchHistory(!showSearchHistory),
                title: "Search History",
                style: {
                  background: showSearchHistory ? "#dbeafe" : "",
                  color: showSearchHistory ? "#1d4ed8" : ""
                },
                children: [
                  h(Icons.Search, {}),
                  searchHistory.length > 0 && h("span", { style: {
                    position: "absolute",
                    top: "-4px",
                    right: "-4px",
                    background: "#3b82f6",
                    color: "white",
                    fontSize: "8px",
                    width: "14px",
                    height: "14px",
                    borderRadius: "50%",
                    display: "flex",
                    alignItems: "center",
                    justifyContent: "center"
                  }, children: searchHistory.length })
                ]
              }
            ),
            showSearchHistory && searchHistory.length > 0 && h("div", { style: {
              position: "absolute",
              bottom: "100%",
              right: 0,
              marginBottom: "8px",
              width: "280px",
              background: "white",
              borderRadius: "8px",
              boxShadow: "0 4px 20px rgba(0,0,0,0.15)",
              border: "1px solid #e5e7eb",
              zIndex: 1e3,
              maxHeight: "320px",
              overflow: "auto"
            }, children: [
              h("div", { style: { padding: "10px 12px", borderBottom: "1px solid #e5e7eb", display: "flex", justifyContent: "space-between", alignItems: "center" }, children: [
                h("span", { style: { fontSize: "11px", fontWeight: 600, color: "#374151" }, children: "SEARCH HISTORY" }),
                h("span", { style: { fontSize: "10px", color: "#9ca3af" }, children: [
                  searchHistory.length,
                  " searches"
                ] })
              ] }),
              [...searchHistory].reverse().map((h, i) => h(
                "div",
                {
                  onClick: () => {
                    replaySearch(h.hash);
                    setShowSearchHistory(false);
                  },
                  style: {
                    padding: "10px 12px",
                    cursor: "pointer",
                    borderBottom: "1px solid #f3f4f6",
                    display: "flex",
                    flexDirection: "column",
                    gap: "4px"
                  },
                  onMouseEnter: (e) => e.currentTarget.style.background = "#f8fafc",
                  onMouseLeave: (e) => e.currentTarget.style.background = "transparent",
                  children: [
                    h("div", { style: { display: "flex", justifyContent: "space-between", alignItems: "center" }, children: [
                      h("span", { style: { fontSize: "12px", color: "#111827", fontWeight: 500, maxWidth: "180px", overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }, children: h.query }),
                      h("span", { style: {
                        fontSize: "10px",
                        padding: "2px 6px",
                        borderRadius: "10px",
                        background: h.count > 0 ? "#d1fae5" : "#fef3c7",
                        color: h.count > 0 ? "#065f46" : "#92400e"
                      }, children: [
                        h.count,
                        " results"
                      ] })
                    ] }),
                    h("div", { style: { display: "flex", justifyContent: "space-between", alignItems: "center" }, children: [
                      h("span", { style: { fontSize: "10px", color: "#9ca3af", fontFamily: "monospace" }, children: [
                        h.hash?.slice(0, 12),
                        "..."
                      ] }),
                      h("span", { style: { fontSize: "10px", color: "#9ca3af" }, children: new Date(h.timestamp).toLocaleTimeString() })
                    ] })
                  ]
                },
                h.hash || i
              )),
              h(
                "div",
                {
                  onClick: () => {
                    setShowSearchHistory(false);
                  },
                  style: { padding: "8px 12px", cursor: "pointer", fontSize: "11px", color: "#6b7280", textAlign: "center", borderTop: "1px solid #e5e7eb" },
                  onMouseEnter: (e) => e.currentTarget.style.background = "#f8fafc",
                  onMouseLeave: (e) => e.currentTarget.style.background = "transparent",
                  children: "Close"
                }
              )
            ] }),
            showSearchHistory && searchHistory.length === 0 && h("div", { style: {
              position: "absolute",
              bottom: "100%",
              right: 0,
              marginBottom: "8px",
              width: "200px",
              background: "white",
              borderRadius: "8px",
              boxShadow: "0 4px 20px rgba(0,0,0,0.15)",
              border: "1px solid #e5e7eb",
              padding: "16px",
              textAlign: "center"
            }, children: [
              h("div", { style: { fontSize: "11px", color: "#9ca3af" }, children: "No search history yet" }),
              h("div", { style: { fontSize: "10px", color: "#d1d5db", marginTop: "4px" }, children: "Searches are tracked for reproducibility" })
            ] })
          ] }),
          h("button", { className: "chat-btn", onClick: handleSend, disabled: !input.trim() || sending, style: { opacity: input.trim() ? 1 : 0.5 }, children: h(Icons.Send, {}) })
        ] })
      ] }) })
    ] });
  };
  var RightPane = () => {
    const {
      rightCollapsed,
      toggleRight,
      backendConnected,
      wsConnected,
      evidence,
      currentCase,
      addNotification,
      ztPipeline,
      tier3Reports,
      verifyProvenance,
      // Protocol data and loaders
      loadSCLPrinciples,
      loadRiskEvents,
      loadNotices,
      loadQuarantine,
      riskEvents,
      noticesOverdue,
      quarantineEntries
    } = useApp();
    const [expanded, setExpanded] = useState(true);
    const [runningTool, setRunningTool] = useState(null);
    const handleToolClick = async (toolId) => {
      if (["scl", "events", "notices", "quarantine"].includes(toolId)) {
        if (!backendConnected) {
          addNotification("warning", "Backend offline");
          return;
        }
        setRunningTool(toolId);
        try {
          switch (toolId) {
            case "scl":
              await loadSCLPrinciples();
              addNotification("success", "SCL principles loaded");
              break;
            case "events":
              await loadRiskEvents();
              addNotification("success", `${riskEvents?.length || 0} risk events loaded`);
              break;
            case "notices":
              await loadNotices();
              addNotification("success", `Notices loaded (${noticesOverdue?.length || 0} overdue)`);
              break;
            case "quarantine":
              await loadQuarantine();
              addNotification("success", `${quarantineEntries?.length || 0} items in quarantine`);
              break;
          }
        } catch (err) {
          addNotification("error", `Failed to load ${toolId}`);
        }
        setRunningTool(null);
        return;
      }
      const selectedEvidence = evidence.filter((e) => e.selected).map((e) => e.id);
      if (toolId === "provenance") {
        if (selectedEvidence.length === 0) {
          addNotification("warning", "Select files first");
          return;
        }
        await verifyProvenance(selectedEvidence);
        return;
      }
      if (!backendConnected) {
        addNotification("warning", "Backend offline");
        return;
      }
      if (selectedEvidence.length === 0 && ["delay", "quantum", "review", "extract"].includes(toolId)) {
        addNotification("warning", "Please select evidence items first");
        return;
      }
      setRunningTool(toolId);
      addNotification("info", `Starting ${toolId} analysis...`);
      try {
        let result;
        switch (toolId) {
          case "delay":
            result = await ThemisAPI.analysis.delay({ case_id: currentCase?.id, evidence_ids: selectedEvidence, method: "as-planned-vs-as-built" });
            break;
          case "extract":
            result = await ThemisAPI.analysis.extract(currentCase?.id, selectedEvidence);
            break;
          case "review":
          case "quantum":
          case "timeline":
          case "compare":
            if (wsConnected) {
              await themisWS.send("analysis.run", { type: toolId, case_id: currentCase?.id, evidence_ids: selectedEvidence });
            }
            break;
        }
        if (result) {
          addNotification("success", `${toolId} analysis complete`);
        }
      } catch (err) {
        addNotification("error", `${toolId} analysis failed`);
      }
      setRunningTool(null);
    };
    const ztCount = (ztPipeline?.staging?.length || 0) + (ztPipeline?.validated?.length || 0);
    if (rightCollapsed) {
      return h("aside", { className: "pane pane-right collapsed", children: [
        h("div", { className: "pane-header pane-header-collapsed", children: h("button", { className: "collapse-btn", onClick: toggleRight, children: h(Icons.ChevronLeft, {}) }) }),
        h("div", { className: "pane-content collapsed-icons", children: TOOLS.slice(0, 6).map((t) => h("div", { className: "mini-icon blue", title: t.name, onClick: toggleRight, children: h(t.Icon, {}) }, t.id)) })
      ] });
    }
    return h("aside", { className: "pane pane-right", children: [
      h("div", { className: "pane-header", children: [
        h("div", { className: "pane-header-center rpane-title-clickable", onClick: () => setExpanded(!expanded), children: [
          h("span", { className: "pane-title", children: "QS - Toolbox" }),
          h("span", { className: "rpane-expand-indicator", children: expanded ? "-" : "+" })
        ] }),
        h("button", { className: "collapse-btn collapse-btn-edge-right", onClick: toggleRight, children: h(Icons.ChevronRight, {}) })
      ] }),
      h("div", { className: "pane-content", children: [
        ztCount > 0 && h(React.Fragment, { children: [
          h("div", { className: "section-header", style: { color: "#2563eb" }, children: "ZERO TRUST PIPELINE" }),
          h("div", { style: { padding: "8px 16px", background: "#eff6ff", borderRadius: "6px", margin: "0 12px 12px", fontSize: "11px" }, children: [
            h("div", { style: { display: "flex", justifyContent: "space-between" }, children: [
              h("span", { children: "Staging" }),
              h("span", { style: { fontWeight: 600 }, children: ztPipeline?.staging?.length || 0 })
            ] }),
            h("div", { style: { display: "flex", justifyContent: "space-between" }, children: [
              h("span", { children: "Validated" }),
              h("span", { style: { fontWeight: 600, color: "#16a34a" }, children: ztPipeline?.validated?.length || 0 })
            ] })
          ] })
        ] }),
        expanded && h(React.Fragment, { children: [
          h("div", { className: "items-list", children: TOOLS.map((tool) => h(
            Item,
            {
              icon: h(tool.Icon, {}),
              iconType: "tool",
              name: tool.name,
              desc: runningTool === tool.id ? "Running..." : tool.desc,
              onClick: () => handleToolClick(tool.id)
            },
            tool.id
          )) }),
          h("div", { className: "section-header", children: "TIER 3 - PROTOCOL" }),
          h("div", { className: "items-list", children: [
            h(Item, { icon: h(Icons.Scale, {}), iconType: "tool", name: "SCL Compliance", desc: "Protocol principles", onClick: () => handleToolClick("scl") }),
            h(Item, { icon: h(Icons.Zap, {}), iconType: "tool", name: "Risk Events", desc: "Event timeline", onClick: () => handleToolClick("events") }),
            h(Item, { icon: h(Icons.File, {}), iconType: "tool", name: "Notices", desc: "Contract notices", onClick: () => handleToolClick("notices") }),
            h(Item, { icon: h(Icons.Clock, {}), iconType: "tool", name: "Quarantine", desc: "Pending files", onClick: () => handleToolClick("quarantine") })
          ] }),
          h("div", { className: "section-header", children: "TIER 3 - ANALYSIS" }),
          h("div", { className: "items-list", children: [
            h(Item, { icon: h(Icons.Zap, {}), iconType: "tool", name: "R and O Report", desc: tier3Reports?.roReport ? `${tier3Reports.roReport.summary?.totalRisks || 0}R / ${tier3Reports.roReport.summary?.totalOpportunities || 0}O` : "No data" }),
            h(Item, { icon: h(Icons.Grid, {}), iconType: "tool", name: "Verify Provenance", desc: "Check VSP hashes", onClick: () => handleToolClick("provenance") })
          ] })
        ] }),
        h("div", { className: "section-header", children: "OUTPUTS" }),
        h("div", { className: "items-list", children: OUTPUTS.map((output) => h(Item, { icon: h(Icons.File, {}), iconType: "output", name: output.name, desc: output.desc }, output.id)) })
      ] }),
      h("div", { className: "pane-footer", children: h("span", { className: "text-xs text-muted", children: "T H E M i S - QS" }) })
    ] });
  };
  var App = () => {
    const { showLanding, banner, progressActive, backendConnected, closeDropdowns, closeModal, activeModal } = useApp();
    React.useEffect(() => {
      const handleGlobalClick = (e) => {
        if (!e.target.closest(".dropdown")) {
          closeDropdowns();
        }
      };
      document.addEventListener("click", handleGlobalClick);
      return () => document.removeEventListener("click", handleGlobalClick);
    }, [closeDropdowns]);
    React.useEffect(() => {
      const handleEscape = (e) => {
        if (e.key === "Escape") {
          closeDropdowns();
          if (activeModal) closeModal();
        }
      };
      document.addEventListener("keydown", handleEscape);
      return () => document.removeEventListener("keydown", handleEscape);
    }, [closeDropdowns, closeModal, activeModal]);
    return h(React.Fragment, { children: [
      h(LandingOverlay, {}),
      h(ProgressBar, { active: progressActive || !backendConnected }),
      h(NotificationBanner, {}),
      h(NotificationCenter, {}),
      h(EvidenceModal, {}),
      h(TimeTrackerModal, {}),
      h(CreateCaseWizard, {}),
      h(CreateVaultModal, {}),
      h(ReleaseNotesModal, {}),
      h(DashboardModal, {}),
      h(ConstraintsModal, {}),
      h(TagManagerModal, {}),
      h(FileManagerModal, {}),
      h(EvidenceInventoryModal, {}),
      h(PreviewContainer, {}),
      !showLanding && h("div", { className: "app", children: [
        h(Header, {}),
        h("main", { className: "main", children: [
          h(LeftPane, {}),
          h(CenterPane, {}),
          h(RightPane, {})
        ] })
      ] })
    ] });
  };
  var AppWrapper = () => h(AppProvider, { children: h(App, {}) });
  ReactDOM.createRoot(document.getElementById("root")).render(h(AppWrapper, {}));
})();
    </script>
    <script>
    // Click anywhere on banner to dismiss
    document.addEventListener("click", function(e) {
        var b = e.target.closest(".notification-banner");
        if (b) b.style.display = "none";
    });
    
    // Listen for mode toggle from chat module iframe
    window.addEventListener("message", function(e) {
        if (e.data && e.data.type === "toggle-mode") {
            // Call React setMode if available
            if (window.__themisSetMode) {
                window.__themisSetMode(e.data.mode);
            } else {
                // Fallback to body class only
                var body = document.body;
                var framework = body.className.match(/framework-\w+/)?.[0] || "framework-rics";
                if (e.data.mode === "search") {
                    body.className = "mode-search " + framework;
                } else {
                    body.className = "mode-analysis " + framework;
                }
            }
        }
    });
    </script>
</body>
</html>
